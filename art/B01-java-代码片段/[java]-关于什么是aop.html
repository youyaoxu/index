<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.10/dist/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.11.1/styles/default.min.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.18.10/dist/browser/index.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.10/dist/index.js"></script><script>(r => {
              setTimeout(r);
            })(function renderToolbar() {
  const {
    markmap,
    mm
  } = window;
  const {
    el
  } = markmap.Toolbar.create(mm);
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, root2, jsonOptions) => {
              const markmap = getMarkmap();
              window.mm = markmap.Markmap.create(
                "svg#mindmap",
                (getOptions || markmap.deriveOptions)(jsonOptions),
                root2
              );
            })(() => window.markmap,null,{"content":"[java]-&#x5173;&#x4e8e;&#x4ec0;&#x4e48;&#x662f;aop","children":[{"content":"<pre data-lines=\"2,35\"><code class=\"language-java\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">RoleCheckAspect</span>{\n  <span class=\"hljs-meta\">@Pointcut(&quot;@annotation(com.dia.bri.annotation.RequiresRoles)&quot;)</span>\n  <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title function_\">pointcut</span><span class=\"hljs-params\">()</span>{\n\n  }\n  <span class=\"hljs-meta\">@Around(&quot;pointcut()&quot;)</span>\n  <span class=\"hljs-keyword\">public</span> Object <span class=\"hljs-title function_\">around</span><span class=\"hljs-params\">(ProceedingJoinPoint joinPoint)</span> thorws Throwable{\n    checktMethod(joinPoint);\n    <span class=\"hljs-keyword\">return</span> joinPoint.processed();\n  }\n\n  <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title function_\">checkMethod</span><span class=\"hljs-params\">(ProceedingJoinPoint joinPoint)</span> <span class=\"hljs-keyword\">throws</span> Throwable{\n    checkMethod(joinPoint);\n    <span class=\"hljs-keyword\">return</span> joinPoint.proceed();\n  }\n\n  <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title function_\">checkMethod</span><span class=\"hljs-params\">(ProceedingJoinPoint joinPoint)</span>{\n    MethodSignature signature= (MethodSignature)jointPoint.getSignature();\n    Method method=signature.getMethod();\n\n    String requestParams=JSON.toJSONString(joinPoint.getArgs[<span class=\"hljs-number\">0</span>]);\n    log.info(<span class=\"hljs-string\">&quot;&#x62e6;&#x622a;&#x8bf7;&#x6c42;&#x53c2;&#x6570;:{}&quot;</span>,requestParams);\n    String roleCode=(String)jsonParam.get(<span class=\"hljs-string\">&quot;roleCode&quot;</span>);\n\n    RequiresRoles requiresRoles=method.getAnnotation(RequiresRoles.class);\n    List&lt;String&gt; requireRoleCodes=Arrays.asList(requiresRoles.value());\n    <span class=\"hljs-keyword\">if</span>(!requireRoleCodes.contains(roleCode)){\n      thorw <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">BadRequestAlertException</span>(BadRequestAlertException.Type.C01000002)\n    }\n  }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"2,35"}},{"content":"<pre data-lines=\"36,123\"><code class=\"language-java\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">ThirdRetryAspect</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title class_\">EnvironmentAware</span>{\n  Environment environment;\n\n  <span class=\"hljs-meta\">@Autowired</span>\n  <span class=\"hljs-keyword\">private</span> ThirdRequestLogService thirdRequestLogService;\n\n  <span class=\"hljs-meta\">@Pointcut(&quot;@annotation(com.dia.bri.annotation.ThirdRetry)&quot;)</span>\n  <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title function_\">servicePointcut</span><span class=\"hljs-params\">()</span>{}\n\n  <span class=\"hljs-meta\">@Before(value=&quot;servicePointcut()&quot;)</span>\n  <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title function_\">doBefore</span><span class=\"hljs-params\">(JoinPoint joinPoint)</span>{log.info(<span class=\"hljs-string\">&quot;&#x5ba2;&#x6d41;aop&#x62e6;&#x622a;&quot;</span>)}\n\n  <span class=\"hljs-meta\">@Around(&quot;servicePointcut()&quot;)</span>\n  <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title function_\">doAround</span><span class=\"hljs-params\">(ProceedingJoinPoint joinPoint)</span> <span class=\"hljs-keyword\">throws</span> Throwable{\n    Class&lt;?&gt; clazz=joinPoint.getTarget().getClass();\n    String clazzName=joinPoint.getTarget().getClass().getName();\n\n    String methodName=joinPoint.getSignature().getName();\n    Object[] args=joinPoint.getArgs();\n    Class[] argClz=((MethodSignature) joinPoint.getSignature()).getParameterTypes();\n    Method method=clazz.getDeclaredMethod(methodName,argClz);\n    Object proceed=<span class=\"hljs-literal\">null</span>;\n    <span class=\"hljs-keyword\">if</span>(method.isAnnotationPresent(ThirdRetry.class)){\n      ThirdRetry annotation=method.getAnotation(ThirdRetry.class);\n      String bussinessCode=annotation.bussinessCode();\n      String url=environment.resolvePlaceholders(annotation.requestUrl());\n      log.info(<span class=\"hljs-string\">&quot;url:{}&quot;</span>,url);\n\n      String requestBody=JSON.toJSONString(args[<span class=\"hljs-number\">0</span>]);\n      String functionDescCode=<span class=\"hljs-literal\">null</span>;\n      <span class=\"hljs-keyword\">if</span>(ThirdServiceCodeConstants.SHUCE_CUSTOMER_FLOW.equals(bussinessCode)){\n        <span class=\"hljs-keyword\">if</span>(StringUtils.isNotBlank(requestBody)){\n          List&lt;ShuCeCustomerOrderDataDto&gt; list=JSONArray.parseArray(requestBody,ShuCeCustomerOrderDataDto.class);\n          <span class=\"hljs-keyword\">if</span>(!CollectionUtils.isEmpty(list)){\n            functionDescCode=list.get(<span class=\"hljs-number\">0</span>).getOrderId();\n          }\n        }\n      }\n      ThirdRequestLog requestLog=ThirdRequestLog.builder()\n        .clientName(ClientServerEnum.DIA.name())\n        .serverName(ClientServerEnum.SHUCE.name())\n        .serviceCode(bussinessCode)\n        .lastModifiedDate(Instant.now())\n        .functionDesc(StringUtils.isNotBlank(functionDescCode) ? functionDescCode:bussinessCode)\n        .retryCount(<span class=\"hljs-number\">0</span>)\n        .requestUrl(url)\n        .success(<span class=\"hljs-literal\">false</span>)\n        .requestParams(requestBody)\n        .build();\n\n      log.info(<span class=\"hljs-string\">&quot;aop &#x62e6;&#x622a;&#x540c;&#x6b65;&#x7ed9;&#x6570;&#x7b56;&#x8bf7;&#x6c42;:{}&quot;</span>,JSON.toJSONString(requestLog));\n\n      <span class=\"hljs-keyword\">try</span>{\n        proceed=jointPoint.proceed();\n\n        ShuCeResponse response=(ShuCeResponse) proceed;\n\n        requestLog.setSuccess(response.isSuccess());\n        requestLog.setReturnResult(JSON.toJSONString(response));\n\n        log.info(<span class=\"hljs-string\">&quot;&#x540c;&#x6b65;&#x7ed9;&#x6570;&#x7b56;&#x65e5;&#x5fd7;&#x8bb0;&#x5f55;:{}&quot;</span>,JSON.toJSONString(requestLog));\n      }.<span class=\"hljs-keyword\">catch</span>(Exception e){\n        log.error(<span class=\"hljs-string\">&quot;&#x53d1;&#x9001;&#x8bf7;&#x6c42;&#x6d88;&#x606f;&#x5f02;&#x5e38;: bussinessCode:{},&#x6d88;&#x606f;&#x5185;&#x5bb9;:{},&#x5f02;&#x5e38;&#x4fe1;&#x606f;:{}&quot;</span>,bussinessCode,requestBody,e.getMessage());\n      }<span class=\"hljs-keyword\">finally</span>{\n        log.info(<span class=\"hljs-string\">&quot;&#x540c;&#x6b65;&#x6570;&#x636e;&#x4fdd;&#x5b58;&quot;</span>);\n        thirdRequestLogService.saveThirdRequestLog(requestLog);\n      }\n    }\n  }\n\n  <span class=\"hljs-meta\">@After(value=&quot;servicePointcut()&quot;)</span>\n  <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> doAfter{\n    log.info(<span class=\"hljs-string\">&quot;third retry Finish time:&quot;</span>+System.currentTimeMillis());\n  }\n\n  <span class=\"hljs-meta\">@AfterReturning(value=&quot;servicePointcut&quot;,returning=&quot;returnValue&quot;)</span>\n  <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title function_\">doAfterReturning</span><span class=\"hljs-params\">(JoinPoint joinPoint,Object returnValue)</span>{\n    log.info(<span class=\"hljs-string\">&quot;third retry returned value:&quot;</span>+returnValue);\n  }\n\n  <span class=\"hljs-meta\">@Override</span>\n  <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title function_\">setEnvironment</span><span class=\"hljs-params\">(Environment environment)</span>{\n    <span class=\"hljs-built_in\">this</span>.environment=environment;\n  }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"36,123"}}],"payload":{"tag":"h1","lines":"0,1"}},{})</script>
</body>
</html>
