<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.10/dist/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.11.1/styles/default.min.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.18.10/dist/browser/index.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.10/dist/index.js"></script><script>(r => {
              setTimeout(r);
            })(function renderToolbar() {
  const {
    markmap,
    mm
  } = window;
  const {
    el
  } = markmap.Toolbar.create(mm);
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, root2, jsonOptions) => {
              const markmap = getMarkmap();
              window.mm = markmap.Markmap.create(
                "svg#mindmap",
                (getOptions || markmap.deriveOptions)(jsonOptions),
                root2
              );
            })(() => window.markmap,null,{"content":"&#x767b;&#x5f55;&#x7528;&#x6237;&#x652f;&#x6301;&#x591a;&#x8868;&#x5b58;&#x50a8;","children":[{"content":"&#x7528;&#x6237;&#x4e0e;&#x5ba2;&#x6237;","children":[{"content":"<pre data-lines=\"10,12\"><code>*   TOB &#x7528;&#x6237;&#xff0c;&#x6307;&#x7684;&#x662f;&#x901a;&#x8fc7; PIG &#x767b;&#x5f55;&#x540e;&#x53f0;&#x5b8c;&#x6210;&#x4e1a;&#x52a1;&#x80fd;&#x529b;&#x7684;&#x7528;&#x6237;&#xff08;&#x6bd4;&#x5982;&#x6dd8;&#x5b9d;&#x7684;&#x540e;&#x53f0;&#x7ba1;&#x7406;&#x5458;&#x7b49;&#xff09;&#xff0c;&#x6b64;&#x90e8;&#x5206;&#x7528;&#x6237;&#x4fdd;&#x5b58;&#x5728; **sys\\_user** &#x8868;&#x3002;\n*   TOC &#x5ba2;&#x6237;&#xff0c;&#x6307;&#x7684;&#x662f;&#x9762;&#x5411;&#x5927;&#x4f17;&#x7684;&#x5ba2;&#x6237;&#xff08;&#x6bd4;&#x5982;&#x5728;&#x6dd8;&#x5b9d;&#x8d2d;&#x4e70;&#x4e1c;&#x897f;&#x7684;&#x5ba2;&#x6237;&#xff09;&#xff0c;&#x6b64;&#x90e8;&#x5206;&#x5ba2;&#x6237;&#x72ec;&#x7acb;&#x5b58;&#x5728;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"10,12"}}],"payload":{"tag":"h2","lines":"7,9"}},{"content":"&#x5feb;&#x901f;&#x4e0a;&#x624b;","children":[{"content":"&#x65b0;&#x589e; TOC &#x5ba2;&#x6237;&#x8868;","children":[{"content":"<pre data-lines=\"19,20\"><code>1.  &#x6b64;&#x8868;&#x5bf9;&#x5e94;&#x7684;&#x5b9e;&#x4f53;&#x90fd;&#x4f1a;&#x653e;&#x5728; upms &#x6a21;&#x5757;&#xff0c;&#x6240;&#x4ee5;&#x8868;&#x4e5f;&#x8981;&#x548c;&#x539f;&#x6709; sys\\_user &#x5728;&#x540c;&#x4e00;&#x4e2a;&#x6570;&#x636e;&#x5e93;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"19,20"}},{"content":"<pre data-lines=\"23,34\"><code data-lines=\"23,34\"><span class=\"hljs-keyword\">CREATE</span> TABLE <span class=\"hljs-symbol\">`toc_custom`</span> (\n <span class=\"hljs-symbol\">`id`</span> int(<span class=\"hljs-number\">11</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span> AUTO_INCREMENT,\n <span class=\"hljs-symbol\">`nickname`</span> varchar(<span class=\"hljs-number\">255</span>) <span class=\"hljs-keyword\">COLLATE</span> utf8mb4_general_ci DEFAULT <span class=\"hljs-literal\">NULL</span>,\n <span class=\"hljs-symbol\">`username`</span> varchar(<span class=\"hljs-number\">255</span>) <span class=\"hljs-keyword\">COLLATE</span> utf8mb4_general_ci <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n <span class=\"hljs-symbol\">`password`</span> varchar(<span class=\"hljs-number\">255</span>) <span class=\"hljs-keyword\">COLLATE</span> utf8mb4_general_ci <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n <span class=\"hljs-keyword\">PRIMARY</span> <span class=\"hljs-keyword\">KEY</span> (<span class=\"hljs-symbol\">`id`</span>)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 <span class=\"hljs-keyword\">COLLATE</span>=utf8mb4_general_ci COMMENT=<span class=\"hljs-string\">&apos;&#x5ba2;&#x6237;&#x8868;&apos;</span>;\n\n<span class=\"hljs-keyword\">INSERT</span> <span class=\"hljs-keyword\">INTO</span> <span class=\"hljs-symbol\">`toc_custom`</span>(<span class=\"hljs-symbol\">`id`</span>, <span class=\"hljs-symbol\">`nickname`</span>, <span class=\"hljs-symbol\">`username`</span>, <span class=\"hljs-symbol\">`password`</span>) <span class=\"hljs-keyword\">VALUES</span> (<span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&apos;lengleng&apos;</span>, <span class=\"hljs-string\">&apos;lengleng&apos;</span>, <span class=\"hljs-string\">&apos;123456&apos;</span>); \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"23,34"}},{"content":"<pre data-lines=\"35,36\"><code>2.  pig-upms-api &#x65b0;&#x589e; TocCustom &#x5b9e;&#x4f53;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"35,36"}},{"content":"<pre data-lines=\"39,49\"><code data-lines=\"39,49\"><span class=\"hljs-meta\">@Data</span>\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-title class_\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">TocCustom</span> <span class=\"hljs-keyword\"><span class=\"hljs-keyword\">implements</span> <span class=\"hljs-type\">Serializable</span></span> </span>{\n <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">final</span> long serialVersionUID = <span class=\"hljs-number\">1</span>L;\n <span class=\"hljs-keyword\">private</span> Long id;\n <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">String</span> nickname;\n <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">String</span> username;\n <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">String</span> password;\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"39,49"}},{"content":"<pre data-lines=\"50,51\"><code>3.  pig-upms-biz &#x65b0;&#x589e; TocCustomMapper &#x67e5;&#x8be2;&#x5de5;&#x5177;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"50,51"}},{"content":"<pre data-lines=\"54,59\"><code data-lines=\"54,59\">@Mapper\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">interface</span> <span class=\"hljs-symbol\">TocCustomMapper</span> <span class=\"hljs-symbol\">extends</span> <span class=\"hljs-symbol\">BaseMapper</span>&lt;<span class=\"hljs-symbol\">TocCustom</span>&gt; {\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"54,59"}},{"content":"<pre data-lines=\"60,61\"><code>4.  pig-upms-biz &#x65b0;&#x589e; custom &#x67e5;&#x8be2;&#x63a5;&#x53e3;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"60,61"}},{"content":"<pre data-lines=\"64,73\"><code data-lines=\"64,73\"><span class=\"hljs-variable\">@Inner</span>\n<span class=\"hljs-variable\">@GetMapping</span>(<span class=\"hljs-string\">&quot;/custom/{username}&quot;</span>)\npublic R customInfo(<span class=\"hljs-variable\">@PathVariable</span> String username) {\n TocCustom custom = customMapper.selectOne(Wrappers.&lt;TocCustom&gt;lambdaQuery()\n .e<span class=\"hljs-string\">q(TocCustom::getUsername, username)</span>);\n <span class=\"hljs-keyword\">return</span> R.ok(custom);\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"64,73"}},{"content":"<pre data-lines=\"74,75\"><code>5.  feign-client &#x589e;&#x52a0;&#x8c03;&#x7528; custom &#x63a5;&#x53e3;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"74,75"}},{"content":"<pre data-lines=\"78,85\"><code data-lines=\"78,85\"><span class=\"hljs-variable\">@FeignClient</span>(contextId = <span class=\"hljs-string\">&quot;remoteUserService&quot;</span>, value = ServiceNameConstants.UPMS_SERVICE)\npublic interface RemoteUserService {\n <span class=\"hljs-variable\">@GetMapping</span>(<span class=\"hljs-string\">&quot;/user/custom/{username}&quot;</span>)\n R&lt;TocCustom&gt; <span class=\"hljs-built_in\">custom</span>(<span class=\"hljs-variable\">@PathVariable</span>(<span class=\"hljs-string\">&quot;username&quot;</span>) String username, <span class=\"hljs-variable\">@RequestHeader</span>(SecurityConstants.FROM) String from);\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"78,85"}}],"payload":{"tag":"h3","lines":"17,18"}},{"content":"&#x4fee;&#x6539;&#x8ba4;&#x8bc1;&#x4e2d;&#x5fc3;&#x4ee3;&#x7801;","children":[{"content":"<pre data-lines=\"88,89\"><code>1.  &#x589e;&#x52a0; custom &#x5ba2;&#x6237;&#x7aef;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"88,89"}},{"content":"<pre data-lines=\"92,95\"><code data-lines=\"92,95\">INSERT INTO `sys_oauth_client_details` (`id`,`client_id`,`resource_ids`,`client_secret`,`scope`,`authorized_grant_types`,`web_server_redirect_uri`,`authorities`,`access_token_validity`,`refresh_token_validity`,`additional_information`,`autoapprove`) VALUES (<span class=\"hljs-number\">20000</span>,&apos;custom&apos;,NULL,&apos;custom&apos;,&apos;server&apos;,&apos;password,refresh_token&apos;,NULL,NULL,<span class=\"hljs-number\">10000</span>,<span class=\"hljs-number\">11111111</span>,&apos;&apos;,&apos;<span class=\"hljs-literal\">true</span>&apos;)<span class=\"hljs-comment\">; </span>\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"92,95"}},{"content":"<pre data-lines=\"96,97\"><code>2.  &#x4fee;&#x6539;&#x6574;&#x4e2a;&#x6846;&#x67b6;&#x6700;&#x6838;&#x5fc3;&#x7684;&#x4ee3;&#x7801; **custom &#x5ba2;&#x6237;&#x7aef;&#x7684;&#x4e13;&#x7528; UserDetailsService**\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"96,97"}},{"content":"<pre data-lines=\"100,145\"><code data-lines=\"100,145\"><span class=\"hljs-meta\">@Slf4j</span>\n<span class=\"hljs-meta\">@RequiredArgsConstructor</span>\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">PigCustomUserDetailsServiceImpl</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title class_\">PigUserDetailsService</span> {\n\n <span class=\"hljs-keyword\">private</span> final <span class=\"hljs-title class_\">RemoteUserService</span> remoteUserService;\n <span class=\"hljs-keyword\">private</span> final <span class=\"hljs-title class_\">CacheManager</span> cacheManager;\n\n <span class=\"hljs-comment\">/**\n * &#x7528;&#x6237;&#x540d;&#x5bc6;&#x7801;&#x767b;&#x5f55;\n * <span class=\"hljs-doctag\">@param</span> username &#x7528;&#x6237;&#x540d;\n * <span class=\"hljs-doctag\">@return</span>\n */</span>\n <span class=\"hljs-meta\">@Override</span>\n <span class=\"hljs-meta\">@SneakyThrows</span>\n <span class=\"hljs-keyword\">public</span> <span class=\"hljs-title class_\">UserDetails</span> <span class=\"hljs-title function_\">loadUserByUsername</span>(<span class=\"hljs-params\"><span class=\"hljs-title class_\">String</span> username</span>) {\n R&lt;<span class=\"hljs-title class_\">TocCustom</span>&gt; result = remoteUserService.<span class=\"hljs-title function_\">custom</span>(username, <span class=\"hljs-title class_\">SecurityConstants</span>.<span class=\"hljs-property\">FROM_IN</span>);\n <span class=\"hljs-comment\">// &#x6839;&#x636e; result &#x6784;&#x5efa; security &#x6846;&#x67b6;&#x9700;&#x8981;&#x7684; &#x7528;&#x6237;&#x5bf9;&#x8c61;</span>\n <span class=\"hljs-title class_\">TocCustom</span> custom = result.<span class=\"hljs-title function_\">getData</span>();\n <span class=\"hljs-keyword\">if</span> (custom == <span class=\"hljs-literal\">null</span>) {\n <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">UsernameNotFoundException</span>(<span class=\"hljs-string\">&quot;&#x7528;&#x6237;&#x4e0d;&#x5b58;&#x5728;&quot;</span>);\n }\n\n <span class=\"hljs-comment\">// &#x6784;&#x9020; security &#x7528;&#x6237;</span>\n <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">PigUser</span>(custom.<span class=\"hljs-title function_\">getId</span>(), <span class=\"hljs-literal\">null</span>, custom.<span class=\"hljs-title function_\">getUsername</span>(), <span class=\"hljs-string\">&quot;{noop}&quot;</span> + custom.<span class=\"hljs-title function_\">getPassword</span>(), <span class=\"hljs-literal\">null</span>, <span class=\"hljs-literal\">true</span>, <span class=\"hljs-literal\">true</span>,\n <span class=\"hljs-literal\">true</span>, <span class=\"hljs-literal\">true</span>, <span class=\"hljs-title class_\">AuthorityUtils</span>.<span class=\"hljs-property\">NO_AUTHORITIES</span>);\n }\n\n <span class=\"hljs-comment\">/**\n * &#x662f;&#x5426;&#x652f;&#x6301;&#x6b64;&#x5ba2;&#x6237;&#x7aef;&#x6821;&#x9a8c;\n * <span class=\"hljs-doctag\">@param</span> clientId &#x76ee;&#x6807;&#x5ba2;&#x6237;&#x7aef;\n * <span class=\"hljs-doctag\">@param</span> <span class=\"hljs-variable\">grantType</span>\n * <span class=\"hljs-doctag\">@return</span> true/false\n */</span>\n <span class=\"hljs-meta\">@Override</span>\n <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">boolean</span> <span class=\"hljs-title function_\">support</span>(<span class=\"hljs-params\"><span class=\"hljs-title class_\">String</span> clientId, <span class=\"hljs-title class_\">String</span> grantType</span>) {\n <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">&quot;custom&quot;</span>.<span class=\"hljs-title function_\">equals</span>(clientId);\n }\n\n <span class=\"hljs-meta\">@Override</span>\n <span class=\"hljs-keyword\">public</span> int <span class=\"hljs-title function_\">getOrder</span>(<span class=\"hljs-params\"></span>) {\n <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title class_\">Integer</span>.<span class=\"hljs-property\">MIN_VALUE</span> + <span class=\"hljs-number\">1</span>;\n }\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"100,145"}},{"content":"<pre data-lines=\"146,147\"><code>3.  &#x914d;&#x7f6e; SPI &#x52a0;&#x8f7d; **CustomUserDetailsService**\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"146,147"}},{"content":"<img src=\"https://mintlify.s3.us-west-1.amazonaws.com/xzcxz/images/1643514028039-ba3a2ac9-a3f2-473f-b799-c2809e8124a2.png\" alt>","children":[],"payload":{"tag":"img","lines":"148,149"}},{"content":"<pre data-lines=\"150,151\"><code>&#x91cd;&#x70b9;&#x8bf4;&#x660e;&#x4ee5;&#x4e0a;&#x6539;&#x52a8;&#x4ee3;&#x7801;&#x51fa;&#x73b0;&#x7684;&#x91cd;&#x8981;&#x53c2;&#x6570;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"150,151"}},{"content":"<table data-lines=\"152,156\">\n<thead data-lines=\"152,153\">\n<tr data-lines=\"152,153\">\n<th>&#x53c2;&#x6570;</th>\n<th>&#x8bf4;&#x660e;</th>\n</tr>\n</thead>\n<tbody data-lines=\"154,156\">\n<tr data-lines=\"154,155\">\n<td>clientId</td>\n<td>&#x8fd9;&#x91cc;&#x6839;&#x636e;&#x524d;&#x7aef;&#x767b;&#x5f55;&#x8bf7;&#x6c42;&#x5199;&#x7684;&#x7684; clientId &#x533a;&#x5206;&#x662f;&#x5426;&#x662f; toc &#x8bf7;&#x6c42;&#x8fd8;&#x662f; tob &#x8bf7;&#x6c42;&#x3002;&#x8fd9;&#x91cc;&#x9009;&#x62e9; test &#x5ba2;&#x6237;&#x7aef;</td>\n</tr>\n<tr data-lines=\"155,156\">\n<td>AuthorityUtils.NO_AUTHORITIES</td>\n<td>&#x8fd9;&#x91cc;&#x8bf4;&#x660e; toc &#x7528;&#x6237;&#x6ca1;&#x6709;&#x89d2;&#x8272;&#x8fd9;&#x4e00;&#x8bf4;&#xff0c;&#x5f53;&#x7136;&#x4f60;&#x53ef;&#x4ee5;&#x901a;&#x8fc7;&#x540e;&#x53f0;&#x521b;&#x5efa;&#x4e00;&#x4e2a;&#x89d2;&#x8272; &#x201c;ROLE_CUSTOM&#x201d; &#x8d4b;&#x503c;&#x7ed9;&#x5b83;</td>\n</tr>\n</tbody>\n</table>","children":[],"payload":{"tag":"table","lines":"152,156"}}],"payload":{"tag":"h3","lines":"86,87"}}],"payload":{"tag":"h2","lines":"14,16"}},{"content":"&#x8c03;&#x7528;&#x6d4b;&#x8bd5;","children":[{"content":"<pre data-lines=\"163,172\"><code data-lines=\"163,172\"><span class=\"hljs-string\">curl</span> <span class=\"hljs-built_in\">--location</span> <span class=\"hljs-built_in\">--request</span> <span class=\"hljs-string\">POST</span> <span class=\"hljs-string\">&apos;http://127.0.0.1:3000/oauth2/token&apos;</span> \\\n<span class=\"hljs-built_in\">--header</span> <span class=\"hljs-string\">&apos;Authorization: Basic Y3VzdG9tOmN1c3RvbQ==&apos;</span> \\\n<span class=\"hljs-built_in\">--header</span> <span class=\"hljs-string\">&apos;Content-Type: application/x-www-form-urlencoded&apos;</span> \\\n<span class=\"hljs-built_in\">--data-urlencode</span> <span class=\"hljs-string\">&apos;username=lengleng&apos;</span> \\\n<span class=\"hljs-built_in\">--data-urlencode</span> <span class=\"hljs-string\">&apos;password=YehdBPev&apos;</span> \\\n<span class=\"hljs-built_in\">--data-urlencode</span> <span class=\"hljs-string\">&apos;scope=server&apos;</span> \\\n<span class=\"hljs-built_in\">--data-urlencode</span> <span class=\"hljs-string\">&apos;grant_type=password&apos;</span> \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"163,172"}}],"payload":{"tag":"h2","lines":"158,160"}}],"payload":{"tag":"h1","lines":"0,2"}},{})</script>
</body>
</html>
