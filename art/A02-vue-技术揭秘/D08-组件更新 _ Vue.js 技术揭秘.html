<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.10/dist/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.11.1/styles/default.min.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.18.10/dist/browser/index.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.10/dist/index.js"></script><script>(r => {
              setTimeout(r);
            })(function renderToolbar() {
  const {
    markmap,
    mm
  } = window;
  const {
    el
  } = markmap.Toolbar.create(mm);
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, root2, jsonOptions) => {
              const markmap = getMarkmap();
              window.mm = markmap.Markmap.create(
                "svg#mindmap",
                (getOptions || markmap.deriveOptions)(jsonOptions),
                root2
              );
            })(() => window.markmap,null,{"content":"<a href=\"#%E7%BB%84%E4%BB%B6%E6%9B%B4%E6%96%B0\">#</a> &#x7ec4;&#x4ef6;&#x66f4;&#x65b0;","children":[{"content":"<a href=\"#%E6%96%B0%E6%97%A7%E8%8A%82%E7%82%B9%E4%B8%8D%E5%90%8C\">#</a> &#x65b0;&#x65e7;&#x8282;&#x70b9;&#x4e0d;&#x540c;","children":[{"content":"<pre data-lines=\"149,152\"><code>&#x5982;&#x679c;&#x65b0;&#x65e7; `vnode` &#x4e0d;&#x540c;&#xff0c;&#x90a3;&#x4e48;&#x66f4;&#x65b0;&#x7684;&#x903b;&#x8f91;&#x975e;&#x5e38;&#x7b80;&#x5355;&#xff0c;&#x5b83;&#x672c;&#x8d28;&#x4e0a;&#x662f;&#x8981;&#x66ff;&#x6362;&#x5df2;&#x5b58;&#x5728;&#x7684;&#x8282;&#x70b9;&#xff0c;&#x5927;&#x81f4;&#x5206;&#x4e3a; 3 &#x6b65;\n\n*   &#x521b;&#x5efa;&#x65b0;&#x8282;&#x70b9;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"149,152"}},{"content":"<pre data-lines=\"153,167\"><code data-lines=\"153,167\"><span class=\"hljs-keyword\">const</span> oldElm = oldVnode.elm\n<span class=\"hljs-keyword\">const</span> parentElm = nodeOps.parentNode(oldElm)\n<span class=\"hljs-comment\">// create new node</span>\ncreateElm(\n  vnode,\n  insertedVnodeQueue,\n  <span class=\"hljs-comment\">// extremely rare edge case: do not insert if old element is in a</span>\n  <span class=\"hljs-comment\">// leaving transition. Only happens when combining  transition +</span>\n  <span class=\"hljs-comment\">// keep-alive + HOCs. (#4590)</span>\n  oldElm._leaveCb ? <span class=\"hljs-literal\">null</span> : parentElm,\n  nodeOps.nextSibling(oldElm)\n) \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"153,167"}},{"content":"<pre data-lines=\"168,171\"><code>&#x4ee5;&#x5f53;&#x524d;&#x65e7;&#x8282;&#x70b9;&#x4e3a;&#x53c2;&#x8003;&#x8282;&#x70b9;&#xff0c;&#x521b;&#x5efa;&#x65b0;&#x7684;&#x8282;&#x70b9;&#xff0c;&#x5e76;&#x63d2;&#x5165;&#x5230; DOM &#x4e2d;&#xff0c;`createElm` &#x7684;&#x903b;&#x8f91;&#x6211;&#x4eec;&#x4e4b;&#x524d;&#x5206;&#x6790;&#x8fc7;&#x3002;\n\n*   &#x66f4;&#x65b0;&#x7236;&#x7684;&#x5360;&#x4f4d;&#x7b26;&#x8282;&#x70b9;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"168,171"}},{"content":"<pre data-lines=\"172,203\"><code data-lines=\"172,203\"><span class=\"hljs-comment\">// update parent placeholder node element, recursively</span>\n<span class=\"hljs-keyword\">if</span> (isDef(vnode.parent)) {\n  let ancestor = vnode.parent\n  const patchable = isPatchable(vnode)\n  <span class=\"hljs-keyword\">while</span> (ancestor) {\n    <span class=\"hljs-keyword\">for</span> (let i = <span class=\"hljs-number\">0</span>; i &lt; cbs.destroy.<span class=\"hljs-built_in\">length</span>; ++i) {\n      cbs.destroy[i](ancestor)\n    }\n    ancestor.elm = vnode.elm\n    <span class=\"hljs-keyword\">if</span> (patchable) {\n      <span class=\"hljs-keyword\">for</span> (let i = <span class=\"hljs-number\">0</span>; i &lt; cbs.create.<span class=\"hljs-built_in\">length</span>; ++i) {\n        cbs.create[i](emptyNode, ancestor)\n      }\n      <span class=\"hljs-comment\">// #6513</span>\n      <span class=\"hljs-comment\">// invoke insert hooks that may have been merged by create hooks.</span>\n      <span class=\"hljs-comment\">// e.g. for directives that uses the &quot;inserted&quot; hook.</span>\n      const <span class=\"hljs-built_in\">insert</span> = ancestor.data.hook.<span class=\"hljs-built_in\">insert</span>\n      <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">insert</span>.merged) {\n        <span class=\"hljs-comment\">// start at index 1 to avoid re-invoking component mounted hook</span>\n        <span class=\"hljs-keyword\">for</span> (let i = <span class=\"hljs-number\">1</span>; i &lt; <span class=\"hljs-built_in\">insert</span>.fns.<span class=\"hljs-built_in\">length</span>; i++) {\n          <span class=\"hljs-built_in\">insert</span>.fns[i]()\n        }\n      }\n    } <span class=\"hljs-keyword\">else</span> {\n      registerRef(ancestor)\n    }\n    ancestor = ancestor.parent\n  }\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"172,203"}},{"content":"<pre data-lines=\"204,207\"><code>&#x6211;&#x4eec;&#x53ea;&#x5173;&#x6ce8;&#x4e3b;&#x8981;&#x903b;&#x8f91;&#x5373;&#x53ef;&#xff0c;&#x627e;&#x5230;&#x5f53;&#x524d; `vnode` &#x7684;&#x7236;&#x7684;&#x5360;&#x4f4d;&#x7b26;&#x8282;&#x70b9;&#xff0c;&#x5148;&#x6267;&#x884c;&#x5404;&#x4e2a; `module` &#x7684; `destroy` &#x7684;&#x94a9;&#x5b50;&#x51fd;&#x6570;&#xff0c;&#x5982;&#x679c;&#x5f53;&#x524d;&#x5360;&#x4f4d;&#x7b26;&#x662f;&#x4e00;&#x4e2a;&#x53ef;&#x6302;&#x8f7d;&#x7684;&#x8282;&#x70b9;&#xff0c;&#x5219;&#x6267;&#x884c; `module` &#x7684; `create` &#x94a9;&#x5b50;&#x51fd;&#x6570;&#x3002;&#x5bf9;&#x4e8e;&#x8fd9;&#x4e9b;&#x94a9;&#x5b50;&#x51fd;&#x6570;&#x7684;&#x4f5c;&#x7528;&#xff0c;&#x5728;&#x4e4b;&#x540e;&#x7684;&#x7ae0;&#x8282;&#x4f1a;&#x8be6;&#x7ec6;&#x4ecb;&#x7ecd;&#x3002;\n\n*   &#x5220;&#x9664;&#x65e7;&#x8282;&#x70b9;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"204,207"}},{"content":"<pre data-lines=\"208,216\"><code data-lines=\"208,216\"><span class=\"hljs-comment\">// destroy old node</span>\nif (isDef(parentElm)) {\n  <span class=\"hljs-built_in\">removeVnodes</span>(parentElm, [oldVnode], <span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">0</span>)\n} else if (isDef(oldVnode.tag)) {\n  <span class=\"hljs-built_in\">invokeDestroyHook</span>(oldVnode)\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"208,216"}},{"content":"<pre data-lines=\"217,218\"><code>&#x628a; `oldVnode` &#x4ece;&#x5f53;&#x524d; DOM &#x6811;&#x4e2d;&#x5220;&#x9664;&#xff0c;&#x5982;&#x679c;&#x7236;&#x8282;&#x70b9;&#x5b58;&#x5728;&#xff0c;&#x5219;&#x6267;&#x884c; `removeVnodes` &#x65b9;&#x6cd5;&#xff1a;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"217,218"}},{"content":"<pre data-lines=\"219,277\"><code data-lines=\"219,277\"><span class=\"hljs-function\">function <span class=\"hljs-title\">removeVnodes</span> (<span class=\"hljs-params\">parentElm, vnodes, startIdx, endIdx</span>)</span> {\n  <span class=\"hljs-keyword\">for</span> (; startIdx &lt;= endIdx; ++startIdx) {\n    <span class=\"hljs-keyword\">const</span> ch = vnodes[startIdx]\n    <span class=\"hljs-keyword\">if</span> (isDef(ch)) {\n      <span class=\"hljs-keyword\">if</span> (isDef(ch.tag)) {\n        removeAndInvokeRemoveHook(ch)\n        invokeDestroyHook(ch)\n      } <span class=\"hljs-keyword\">else</span> { <span class=\"hljs-comment\">// Text node</span>\n        removeNode(ch.elm)\n      }\n    }\n  }\n}\n\n<span class=\"hljs-function\">function <span class=\"hljs-title\">removeAndInvokeRemoveHook</span> (<span class=\"hljs-params\">vnode, rm</span>)</span> {\n  <span class=\"hljs-keyword\">if</span> (isDef(rm) || isDef(vnode.data)) {\n    <span class=\"hljs-keyword\">let</span> i\n    <span class=\"hljs-keyword\">const</span> listeners = cbs.<span class=\"hljs-keyword\">remove</span>.length + <span class=\"hljs-number\">1</span>\n    <span class=\"hljs-keyword\">if</span> (isDef(rm)) {\n      <span class=\"hljs-comment\">// we have a recursively passed down rm callback</span>\n      <span class=\"hljs-comment\">// increase the listeners count</span>\n      rm.listeners += listeners\n    } <span class=\"hljs-keyword\">else</span> {\n      <span class=\"hljs-comment\">// directly removing</span>\n      rm = createRmCb(vnode.elm, listeners)\n    }\n    <span class=\"hljs-comment\">// recursively invoke hooks on child component root node</span>\n    <span class=\"hljs-keyword\">if</span> (isDef(i = vnode.componentInstance) &amp;&amp; isDef(i = i._vnode) &amp;&amp; isDef(i.data)) {\n      removeAndInvokeRemoveHook(i, rm)\n    }\n    <span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>; i &lt; cbs.<span class=\"hljs-keyword\">remove</span>.length; ++i) {\n      cbs.<span class=\"hljs-keyword\">remove</span>[i](vnode, rm)\n    }\n    <span class=\"hljs-keyword\">if</span> (isDef(i = vnode.data.hook) &amp;&amp; isDef(i = i.<span class=\"hljs-keyword\">remove</span>)) {\n      i(vnode, rm)\n    } <span class=\"hljs-keyword\">else</span> {\n      rm()\n    }\n  } <span class=\"hljs-keyword\">else</span> {\n    removeNode(vnode.elm)\n  }\n}\n\n<span class=\"hljs-function\">function <span class=\"hljs-title\">invokeDestroyHook</span> (<span class=\"hljs-params\">vnode</span>)</span> {\n  <span class=\"hljs-keyword\">let</span> i, j\n  <span class=\"hljs-keyword\">const</span> data = vnode.<span class=\"hljs-function\">data\n  <span class=\"hljs-title\">if</span> (<span class=\"hljs-params\">isDef(data</span>))</span> {\n    <span class=\"hljs-keyword\">if</span> (isDef(i = data.hook) &amp;&amp; isDef(i = i.destroy)) i(vnode)\n    <span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>; i &lt; cbs.destroy.length; ++i) cbs.destroy[i](vnode)\n  }\n  <span class=\"hljs-keyword\">if</span> (isDef(i = vnode.children)) {\n    <span class=\"hljs-keyword\">for</span> (j = <span class=\"hljs-number\">0</span>; j &lt; vnode.children.length; ++j) {\n      invokeDestroyHook(vnode.children[j])\n    }\n  }\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"219,277"}},{"content":"<pre data-lines=\"278,281\"><code>&#x5220;&#x9664;&#x8282;&#x70b9;&#x903b;&#x8f91;&#x5f88;&#x7b80;&#x5355;&#xff0c;&#x5c31;&#x662f;&#x904d;&#x5386;&#x5f85;&#x5220;&#x9664;&#x7684; `vnodes` &#x505a;&#x5220;&#x9664;&#xff0c;&#x5176;&#x4e2d; `removeAndInvokeRemoveHook` &#x7684;&#x4f5c;&#x7528;&#x662f;&#x4ece; DOM &#x4e2d;&#x79fb;&#x9664;&#x8282;&#x70b9;&#x5e76;&#x6267;&#x884c; `module` &#x7684; `remove` &#x94a9;&#x5b50;&#x51fd;&#x6570;&#xff0c;&#x5e76;&#x5bf9;&#x5b83;&#x7684;&#x5b50;&#x8282;&#x70b9;&#x9012;&#x5f52;&#x8c03;&#x7528; `removeAndInvokeRemoveHook` &#x51fd;&#x6570;&#xff1b;`invokeDestroyHook` &#x662f;&#x6267;&#x884c; `module` &#x7684; `destory` &#x94a9;&#x5b50;&#x51fd;&#x6570;&#x4ee5;&#x53ca; `vnode` &#x7684; `destory` &#x94a9;&#x5b50;&#x51fd;&#x6570;&#xff0c;&#x5e76;&#x5bf9;&#x5b83;&#x7684;&#x5b50; `vnode` &#x9012;&#x5f52;&#x8c03;&#x7528; `invokeDestroyHook` &#x51fd;&#x6570;&#xff1b;`removeNode` &#x5c31;&#x662f;&#x8c03;&#x7528;&#x5e73;&#x53f0;&#x7684; DOM API &#x53bb;&#x628a;&#x771f;&#x6b63;&#x7684; DOM &#x8282;&#x70b9;&#x79fb;&#x9664;&#x3002;\n\n&#x5728;&#x4e4b;&#x524d;&#x4ecb;&#x7ecd;&#x7ec4;&#x4ef6;&#x751f;&#x547d;&#x5468;&#x671f;&#x7684;&#x65f6;&#x5019;&#x63d0;&#x5230; `beforeDestroy &amp; destroyed` &#x8fd9;&#x4e24;&#x4e2a;&#x751f;&#x547d;&#x5468;&#x671f;&#x94a9;&#x5b50;&#x51fd;&#x6570;&#xff0c;&#x5b83;&#x4eec;&#x5c31;&#x662f;&#x5728;&#x6267;&#x884c; `invokeDestroyHook` &#x8fc7;&#x7a0b;&#x4e2d;&#xff0c;&#x6267;&#x884c;&#x4e86; `vnode` &#x7684; `destory` &#x94a9;&#x5b50;&#x51fd;&#x6570;&#xff0c;&#x5b83;&#x7684;&#x5b9a;&#x4e49;&#x5728; `src/core/vdom/create-component.js` &#x4e2d;&#xff1a;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"278,281"}},{"content":"<pre data-lines=\"282,296\"><code data-lines=\"282,296\"><span class=\"hljs-keyword\">const</span> <span class=\"hljs-variable constant_\">componentVNodeHooks</span> = {\n  <span class=\"hljs-title function_ invoke__\">destroy</span> (<span class=\"hljs-attr\">vnode</span>: MountedComponentVNode) {\n    <span class=\"hljs-keyword\">const</span> { componentInstance } = vnode\n    <span class=\"hljs-keyword\">if</span> (!componentInstance._isDestroyed) {\n      <span class=\"hljs-keyword\">if</span> (!vnode.data.keepAlive) {\n        componentInstance.<span class=\"hljs-variable\">&#x24;destroy</span>()\n      } <span class=\"hljs-keyword\">else</span> {\n        <span class=\"hljs-title function_ invoke__\">deactivateChildComponent</span>(componentInstance, <span class=\"hljs-literal\">true</span> <span class=\"hljs-comment\">/* direct */</span>)\n      }\n    }\n  }\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"282,296"}},{"content":"<pre data-lines=\"297,298\"><code>&#x5f53;&#x7ec4;&#x4ef6;&#x5e76;&#x4e0d;&#x662f; `keepAlive` &#x7684;&#x65f6;&#x5019;&#xff0c;&#x4f1a;&#x6267;&#x884c; `componentInstance.&#x24;destroy()` &#x65b9;&#x6cd5;&#xff0c;&#x7136;&#x540e;&#x5c31;&#x4f1a;&#x6267;&#x884c; `beforeDestroy &amp; destroyed` &#x4e24;&#x4e2a;&#x94a9;&#x5b50;&#x51fd;&#x6570;&#x3002;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"297,298"}}],"payload":{"tag":"h2","lines":"146,148"}},{"content":"<a href=\"#%E6%96%B0%E6%97%A7%E8%8A%82%E7%82%B9%E7%9B%B8%E5%90%8C\">#</a> &#x65b0;&#x65e7;&#x8282;&#x70b9;&#x76f8;&#x540c;","children":[{"content":"<pre data-lines=\"302,303\"><code>&#x5bf9;&#x4e8e;&#x65b0;&#x65e7;&#x8282;&#x70b9;&#x4e0d;&#x540c;&#x7684;&#x60c5;&#x51b5;&#xff0c;&#x8fd9;&#x79cd;&#x521b;&#x5efa;&#x65b0;&#x8282;&#x70b9; -&gt; &#x66f4;&#x65b0;&#x5360;&#x4f4d;&#x7b26;&#x8282;&#x70b9; -\\&gt; &#x5220;&#x9664;&#x65e7;&#x8282;&#x70b9;&#x7684;&#x903b;&#x8f91;&#x662f;&#x5f88;&#x5bb9;&#x6613;&#x7406;&#x89e3;&#x7684;&#x3002;&#x8fd8;&#x6709;&#x4e00;&#x79cd;&#x7ec4;&#x4ef6; `vnode` &#x7684;&#x66f4;&#x65b0;&#x60c5;&#x51b5;&#x662f;&#x65b0;&#x65e7;&#x8282;&#x70b9;&#x76f8;&#x540c;&#xff0c;&#x5b83;&#x4f1a;&#x8c03;&#x7528; `patchVNode` &#x65b9;&#x6cd5;&#xff0c;&#x5b83;&#x7684;&#x5b9a;&#x4e49;&#x5728; `src/core/vdom/patch.js` &#x4e2d;&#xff1a;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"302,303"}},{"content":"<pre data-lines=\"304,365\"><code data-lines=\"304,365\">function patchVnode (oldVnode, vnode, insertedVnodeQueue, removeOnly) {\n  <span class=\"hljs-keyword\">if</span> (oldVnode === vnode) {\n    <span class=\"hljs-keyword\">return</span>\n  }\n\n  <span class=\"hljs-keyword\">const</span> elm = vnode.elm = oldVnode.elm\n\n  <span class=\"hljs-keyword\">if</span> (isTrue(oldVnode.isAsyncPlaceholder)) {\n    <span class=\"hljs-keyword\">if</span> (isDef(vnode.asyncFactory.resolved)) {\n      hydrate(oldVnode.elm, vnode, insertedVnodeQueue)\n    } <span class=\"hljs-keyword\">else</span> {\n      vnode.isAsyncPlaceholder = <span class=\"hljs-literal\">true</span>\n    }\n    <span class=\"hljs-keyword\">return</span>\n  }\n\n  <span class=\"hljs-comment\">// reuse element for static trees.</span>\n  <span class=\"hljs-comment\">// note we only do this if the vnode is cloned -</span>\n  <span class=\"hljs-comment\">// if the new node is not cloned it means the render functions have been</span>\n  <span class=\"hljs-comment\">// reset by the hot-reload-api and we need to do a proper re-render.</span>\n  <span class=\"hljs-keyword\">if</span> (isTrue(vnode.isStatic) &amp;&amp;\n    isTrue(oldVnode.isStatic) &amp;&amp;\n    vnode.key === oldVnode.key &amp;&amp;\n    (isTrue(vnode.isCloned) || isTrue(vnode.isOnce))\n  ) {\n    vnode.componentInstance = oldVnode.componentInstance\n    <span class=\"hljs-keyword\">return</span>\n  }\n\n  let i\n  <span class=\"hljs-keyword\">const</span> <span class=\"hljs-keyword\">data</span> = vnode.<span class=\"hljs-keyword\">data</span>\n  <span class=\"hljs-keyword\">if</span> (isDef(<span class=\"hljs-keyword\">data</span>) &amp;&amp; isDef(i = <span class=\"hljs-keyword\">data</span>.hook) &amp;&amp; isDef(i = i.prepatch)) {\n    i(oldVnode, vnode)\n  }\n\n  <span class=\"hljs-keyword\">const</span> oldCh = oldVnode.children\n  <span class=\"hljs-keyword\">const</span> ch = vnode.children\n  <span class=\"hljs-keyword\">if</span> (isDef(<span class=\"hljs-keyword\">data</span>) &amp;&amp; isPatchable(vnode)) {\n    <span class=\"hljs-keyword\">for</span> (i = <span class=\"hljs-number\">0</span>; i &lt; cbs.update.length; ++i) cbs.update[i](oldVnode, vnode)\n    <span class=\"hljs-keyword\">if</span> (isDef(i = <span class=\"hljs-keyword\">data</span>.hook) &amp;&amp; isDef(i = i.update)) i(oldVnode, vnode)\n  }\n  <span class=\"hljs-keyword\">if</span> (isUndef(vnode.text)) {\n    <span class=\"hljs-keyword\">if</span> (isDef(oldCh) &amp;&amp; isDef(ch)) {\n      <span class=\"hljs-keyword\">if</span> (oldCh !== ch) updateChildren(elm, oldCh, ch, insertedVnodeQueue, removeOnly)\n    } <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (isDef(ch)) {\n      <span class=\"hljs-keyword\">if</span> (isDef(oldVnode.text)) nodeOps.setTextContent(elm, <span class=\"hljs-string\">&apos;&apos;</span>)\n      addVnodes(elm, <span class=\"hljs-literal\">null</span>, ch, <span class=\"hljs-number\">0</span>, ch.length - <span class=\"hljs-number\">1</span>, insertedVnodeQueue)\n    } <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (isDef(oldCh)) {\n      removeVnodes(elm, oldCh, <span class=\"hljs-number\">0</span>, oldCh.length - <span class=\"hljs-number\">1</span>)\n    } <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (isDef(oldVnode.text)) {\n      nodeOps.setTextContent(elm, <span class=\"hljs-string\">&apos;&apos;</span>)\n    }\n  } <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (oldVnode.text !== vnode.text) {\n    nodeOps.setTextContent(elm, vnode.text)\n  }\n  <span class=\"hljs-keyword\">if</span> (isDef(<span class=\"hljs-keyword\">data</span>)) {\n    <span class=\"hljs-keyword\">if</span> (isDef(i = <span class=\"hljs-keyword\">data</span>.hook) &amp;&amp; isDef(i = i.postpatch)) i(oldVnode, vnode)\n  }\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"304,365"}},{"content":"<pre data-lines=\"366,369\"><code>`patchVnode` &#x7684;&#x4f5c;&#x7528;&#x5c31;&#x662f;&#x628a;&#x65b0;&#x7684; `vnode` `patch` &#x5230;&#x65e7;&#x7684; `vnode` &#x4e0a;&#xff0c;&#x8fd9;&#x91cc;&#x6211;&#x4eec;&#x53ea;&#x5173;&#x6ce8;&#x5173;&#x952e;&#x7684;&#x6838;&#x5fc3;&#x903b;&#x8f91;&#xff0c;&#x6211;&#x628a;&#x5b83;&#x62c6;&#x6210;&#x56db;&#x6b65;&#x9aa4;&#xff1a;\n\n*   &#x6267;&#x884c; `prepatch` &#x94a9;&#x5b50;&#x51fd;&#x6570;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"366,369"}},{"content":"<pre data-lines=\"370,377\"><code data-lines=\"370,377\">let <span class=\"hljs-selector-tag\">i</span>\nconst data = vnode<span class=\"hljs-selector-class\">.data</span>\n<span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">isDef</span>(data) &amp;&amp; <span class=\"hljs-built_in\">isDef</span>(<span class=\"hljs-selector-tag\">i</span> = data.hook) &amp;&amp; <span class=\"hljs-built_in\">isDef</span>(<span class=\"hljs-selector-tag\">i</span> = <span class=\"hljs-selector-tag\">i</span>.prepatch)) {\n  <span class=\"hljs-selector-tag\">i</span>(oldVnode, vnode)\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"370,377"}},{"content":"<pre data-lines=\"378,379\"><code>&#x5f53;&#x66f4;&#x65b0;&#x7684; `vnode` &#x662f;&#x4e00;&#x4e2a;&#x7ec4;&#x4ef6; `vnode` &#x7684;&#x65f6;&#x5019;&#xff0c;&#x4f1a;&#x6267;&#x884c; `prepatch` &#x7684;&#x65b9;&#x6cd5;&#xff0c;&#x5b83;&#x7684;&#x5b9a;&#x4e49;&#x5728; `src/core/vdom/create-component.js` &#x4e2d;&#xff1a;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"378,379"}},{"content":"<pre data-lines=\"380,395\"><code data-lines=\"380,395\">const componentVNodeHooks = {\n  prepatch (oldVnode: MountedComponentVNode, vnode: MountedComponentVNode) {\n    const options = vnode<span class=\"hljs-selector-class\">.componentOptions</span>\n    const child = vnode<span class=\"hljs-selector-class\">.componentInstance</span> = oldVnode<span class=\"hljs-selector-class\">.componentInstance</span>\n    <span class=\"hljs-built_in\">updateChildComponent</span>(\n      child,\n      options<span class=\"hljs-selector-class\">.propsData</span>, <span class=\"hljs-comment\">// updated props</span>\n      options<span class=\"hljs-selector-class\">.listeners</span>, <span class=\"hljs-comment\">// updated listeners</span>\n      vnode, <span class=\"hljs-comment\">// new parent vnode</span>\n      options<span class=\"hljs-selector-class\">.children</span> <span class=\"hljs-comment\">// new children</span>\n    )\n  }\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"380,395"}},{"content":"<pre data-lines=\"396,397\"><code>`prepatch` &#x65b9;&#x6cd5;&#x5c31;&#x662f;&#x62ff;&#x5230;&#x65b0;&#x7684; `vnode` &#x7684;&#x7ec4;&#x4ef6;&#x914d;&#x7f6e;&#x4ee5;&#x53ca;&#x7ec4;&#x4ef6;&#x5b9e;&#x4f8b;&#xff0c;&#x53bb;&#x6267;&#x884c; `updateChildComponent` &#x65b9;&#x6cd5;&#xff0c;&#x5b83;&#x7684;&#x5b9a;&#x4e49;&#x5728; `src/core/instance/lifecycle.js` &#x4e2d;&#xff1a;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"396,397"}},{"content":"<pre data-lines=\"398,465\"><code data-lines=\"398,465\">export <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">updateChildComponent</span> (<span class=\"hljs-params\">\n  vm: Component,\n  propsData: ?Object,\n  listeners: ?Object,\n  parentVnode: MountedComponentVNode,\n  renderChildren: ?Array&lt;VNode&gt;\n</span>) </span>{\n  <span class=\"hljs-keyword\">if</span> (process.env.NODE_ENV !== <span class=\"hljs-string\">&apos;production&apos;</span>) {\n    isUpdatingChildComponent = <span class=\"hljs-literal\">true</span>\n  }\n\n  <span class=\"hljs-comment\">// determine whether component has slot children</span>\n  <span class=\"hljs-comment\">// we need to do this before overwriting &#x24;options._renderChildren</span>\n  <span class=\"hljs-keyword\">const</span> <span class=\"hljs-variable constant_\">hasChildren</span> = !!(\n    renderChildren ||               <span class=\"hljs-comment\">// has new static slots</span>\n    vm.<span class=\"hljs-variable\">&#x24;options</span>._renderChildren ||  <span class=\"hljs-comment\">// has old static slots</span>\n    parentVnode.data.scopedSlots || <span class=\"hljs-comment\">// has new scoped slots</span>\n    vm.<span class=\"hljs-variable\">&#x24;scopedSlots</span> !== emptyObject <span class=\"hljs-comment\">// has old scoped slots</span>\n  )\n\n  vm.<span class=\"hljs-variable\">&#x24;options</span>._parentVnode = parentVnode\n  vm.<span class=\"hljs-variable\">&#x24;vnode</span> = parentVnode <span class=\"hljs-comment\">// update vm&apos;s placeholder node without re-render</span>\n\n  <span class=\"hljs-keyword\">if</span> (vm._vnode) { <span class=\"hljs-comment\">// update child tree&apos;s parent</span>\n    vm._vnode.<span class=\"hljs-built_in\">parent</span> = parentVnode\n  }\n  vm.<span class=\"hljs-variable\">&#x24;options</span>._renderChildren = renderChildren\n\n  <span class=\"hljs-comment\">// update &#x24;attrs and &#x24;listeners hash</span>\n  <span class=\"hljs-comment\">// these are also reactive so they may trigger child update if the child</span>\n  <span class=\"hljs-comment\">// used them during render</span>\n  vm.<span class=\"hljs-variable\">&#x24;attrs</span> = parentVnode.data.attrs || emptyObject\n  vm.<span class=\"hljs-variable\">&#x24;listeners</span> = listeners || emptyObject\n\n  <span class=\"hljs-comment\">// update props</span>\n  <span class=\"hljs-keyword\">if</span> (propsData &amp;&amp; vm.<span class=\"hljs-variable\">&#x24;options</span>.props) {\n    <span class=\"hljs-title function_ invoke__\">toggleObserving</span>(<span class=\"hljs-literal\">false</span>)\n    <span class=\"hljs-keyword\">const</span> <span class=\"hljs-variable constant_\">props</span> = vm._props\n    <span class=\"hljs-keyword\">const</span> <span class=\"hljs-variable constant_\">propKeys</span> = vm.<span class=\"hljs-variable\">&#x24;options</span>._propKeys || []\n    <span class=\"hljs-keyword\">for</span> (let i = <span class=\"hljs-number\">0</span>; i &lt; propKeys.length; i++) {\n      <span class=\"hljs-keyword\">const</span> <span class=\"hljs-variable constant_\">key</span> = propKeys[i]\n      <span class=\"hljs-keyword\">const</span> <span class=\"hljs-variable constant_\">propOptions</span>: any = vm.<span class=\"hljs-variable\">&#x24;options</span>.props <span class=\"hljs-comment\">// wtf flow?</span>\n      props[key] = <span class=\"hljs-title function_ invoke__\">validateProp</span>(key, propOptions, propsData, vm)\n    }\n    <span class=\"hljs-title function_ invoke__\">toggleObserving</span>(<span class=\"hljs-literal\">true</span>)\n    <span class=\"hljs-comment\">// keep a copy of raw propsData</span>\n    vm.<span class=\"hljs-variable\">&#x24;options</span>.propsData = propsData\n  }\n\n  <span class=\"hljs-comment\">// update listeners</span>\n  listeners = listeners || emptyObject\n  <span class=\"hljs-keyword\">const</span> <span class=\"hljs-variable constant_\">oldListeners</span> = vm.<span class=\"hljs-variable\">&#x24;options</span>._parentListeners\n  vm.<span class=\"hljs-variable\">&#x24;options</span>._parentListeners = listeners\n  <span class=\"hljs-title function_ invoke__\">updateComponentListeners</span>(vm, listeners, oldListeners)\n\n  <span class=\"hljs-comment\">// resolve slots + force update if has children</span>\n  <span class=\"hljs-keyword\">if</span> (hasChildren) {\n    vm.<span class=\"hljs-variable\">&#x24;slots</span> = <span class=\"hljs-title function_ invoke__\">resolveSlots</span>(renderChildren, parentVnode.context)\n    vm.<span class=\"hljs-variable\">&#x24;forceUpdate</span>()\n  }\n\n  <span class=\"hljs-keyword\">if</span> (process.env.NODE_ENV !== <span class=\"hljs-string\">&apos;production&apos;</span>) {\n    isUpdatingChildComponent = <span class=\"hljs-literal\">false</span>\n  }\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"398,465"}},{"content":"<pre data-lines=\"466,469\"><code>`updateChildComponent` &#x7684;&#x903b;&#x8f91;&#x4e5f;&#x975e;&#x5e38;&#x7b80;&#x5355;&#xff0c;&#x7531;&#x4e8e;&#x66f4;&#x65b0;&#x4e86; `vnode`&#xff0c;&#x90a3;&#x4e48; `vnode` &#x5bf9;&#x5e94;&#x7684;&#x5b9e;&#x4f8b; `vm` &#x7684;&#x4e00;&#x7cfb;&#x5217;&#x5c5e;&#x6027;&#x4e5f;&#x4f1a;&#x53d1;&#x751f;&#x53d8;&#x5316;&#xff0c;&#x5305;&#x62ec;&#x5360;&#x4f4d;&#x7b26; `vm.&#x24;vnode` &#x7684;&#x66f4;&#x65b0;&#x3001;`slot` &#x7684;&#x66f4;&#x65b0;&#xff0c;`listeners` &#x7684;&#x66f4;&#x65b0;&#xff0c;`props` &#x7684;&#x66f4;&#x65b0;&#x7b49;&#x7b49;&#x3002;\n\n*   &#x6267;&#x884c; `update` &#x94a9;&#x5b50;&#x51fd;&#x6570;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"466,469"}},{"content":"<pre data-lines=\"470,476\"><code data-lines=\"470,476\">if (isDef(data) &amp;&amp; <span class=\"hljs-built_in\">isPatchable</span>(vnode)) {\n  for (i = <span class=\"hljs-number\">0</span>; i &lt; cbs.update.length; ++i) cbs<span class=\"hljs-selector-class\">.update</span><span class=\"hljs-selector-attr\">[i]</span>(oldVnode, vnode)\n  if (isDef(i = data.hook) &amp;&amp; <span class=\"hljs-built_in\">isDef</span>(i = i.update)) <span class=\"hljs-selector-tag\">i</span>(oldVnode, vnode)\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"470,476"}},{"content":"<pre data-lines=\"477,480\"><code>&#x56de;&#x5230; `patchVNode` &#x51fd;&#x6570;&#xff0c;&#x5728;&#x6267;&#x884c;&#x5b8c;&#x65b0;&#x7684; `vnode` &#x7684; `prepatch` &#x94a9;&#x5b50;&#x51fd;&#x6570;&#xff0c;&#x4f1a;&#x6267;&#x884c;&#x6240;&#x6709; `module` &#x7684; `update` &#x94a9;&#x5b50;&#x51fd;&#x6570;&#x4ee5;&#x53ca;&#x7528;&#x6237;&#x81ea;&#x5b9a;&#x4e49; `update` &#x94a9;&#x5b50;&#x51fd;&#x6570;&#xff0c;&#x5bf9;&#x4e8e; `module` &#x7684;&#x94a9;&#x5b50;&#x51fd;&#x6570;&#xff0c;&#x4e4b;&#x540e;&#x6211;&#x4eec;&#x4f1a;&#x6709;&#x5177;&#x4f53;&#x7684;&#x7ae0;&#x8282;&#x9488;&#x5bf9;&#x4e00;&#x4e9b;&#x5177;&#x4f53;&#x7684; case &#x5206;&#x6790;&#x3002;\n\n*   &#x5b8c;&#x6210; `patch` &#x8fc7;&#x7a0b;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"477,480"}},{"content":"<pre data-lines=\"481,503\"><code data-lines=\"481,503\">const oldCh = oldVnode.children\nconst ch = vnode.children\n<span class=\"hljs-function\"><span class=\"hljs-title\">if</span> <span class=\"hljs-params\">(isDef(data) &amp;&amp; isPatchable(vnode))</span> {\n  <span class=\"hljs-title\">for</span> <span class=\"hljs-params\">(i = <span class=\"hljs-number\">0</span>; i &lt; cbs.update.length; ++i)</span> <span class=\"hljs-title\">cbs</span>.<span class=\"hljs-title\">update</span>[<span class=\"hljs-title\">i</span>]<span class=\"hljs-params\">(oldVnode, vnode)</span>\n  <span class=\"hljs-title\">if</span> <span class=\"hljs-params\">(isDef(i = data.hook) &amp;&amp; isDef(i = i.update))</span> <span class=\"hljs-title\">i</span><span class=\"hljs-params\">(oldVnode, vnode)</span>\n}\n<span class=\"hljs-title\">if</span> <span class=\"hljs-params\">(isUndef(vnode.text))</span> {\n  <span class=\"hljs-title\">if</span> <span class=\"hljs-params\">(isDef(oldCh) &amp;&amp; isDef(ch))</span> {\n    <span class=\"hljs-title\">if</span> <span class=\"hljs-params\">(oldCh !== ch)</span> <span class=\"hljs-title\">updateChildren</span><span class=\"hljs-params\">(elm, oldCh, ch, insertedVnodeQueue, removeOnly)</span>\n  } <span class=\"hljs-title\">else</span> <span class=\"hljs-title\">if</span> <span class=\"hljs-params\">(isDef(ch))</span> {\n    <span class=\"hljs-title\">if</span> <span class=\"hljs-params\">(isDef(oldVnode.text))</span> <span class=\"hljs-title\">nodeOps</span>.<span class=\"hljs-title\">setTextContent</span><span class=\"hljs-params\">(elm, &apos;&apos;)</span>\n    <span class=\"hljs-title\">addVnodes</span><span class=\"hljs-params\">(elm, null, ch, <span class=\"hljs-number\">0</span>, ch.length - <span class=\"hljs-number\">1</span>, insertedVnodeQueue)</span>\n  } <span class=\"hljs-title\">else</span> <span class=\"hljs-title\">if</span> <span class=\"hljs-params\">(isDef(oldCh))</span> {\n    <span class=\"hljs-title\">removeVnodes</span><span class=\"hljs-params\">(elm, oldCh, <span class=\"hljs-number\">0</span>, oldCh.length - <span class=\"hljs-number\">1</span>)</span>\n  } <span class=\"hljs-title\">else</span> <span class=\"hljs-title\">if</span> <span class=\"hljs-params\">(isDef(oldVnode.text))</span> {\n    <span class=\"hljs-title\">nodeOps</span>.<span class=\"hljs-title\">setTextContent</span><span class=\"hljs-params\">(elm, &apos;&apos;)</span>\n  }\n} <span class=\"hljs-title\">else</span> <span class=\"hljs-title\">if</span> <span class=\"hljs-params\">(oldVnode.text !== vnode.text)</span> {\n  <span class=\"hljs-title\">nodeOps</span>.<span class=\"hljs-title\">setTextContent</span><span class=\"hljs-params\">(elm, vnode.text)</span>\n} \n</span></code></pre>","children":[],"payload":{"tag":"pre","lines":"481,503"}},{"content":"<pre data-lines=\"504,515\"><code>&#x5982;&#x679c; `vnode` &#x662f;&#x4e2a;&#x6587;&#x672c;&#x8282;&#x70b9;&#x4e14;&#x65b0;&#x65e7;&#x6587;&#x672c;&#x4e0d;&#x76f8;&#x540c;&#xff0c;&#x5219;&#x76f4;&#x63a5;&#x66ff;&#x6362;&#x6587;&#x672c;&#x5185;&#x5bb9;&#x3002;&#x5982;&#x679c;&#x4e0d;&#x662f;&#x6587;&#x672c;&#x8282;&#x70b9;&#xff0c;&#x5219;&#x5224;&#x65ad;&#x5b83;&#x4eec;&#x7684;&#x5b50;&#x8282;&#x70b9;&#xff0c;&#x5e76;&#x5206;&#x4e86;&#x51e0;&#x79cd;&#x60c5;&#x51b5;&#x5904;&#x7406;&#xff1a;\n\n1.  `oldCh` &#x4e0e; `ch` &#x90fd;&#x5b58;&#x5728;&#x4e14;&#x4e0d;&#x76f8;&#x540c;&#x65f6;&#xff0c;&#x4f7f;&#x7528; `updateChildren` &#x51fd;&#x6570;&#x6765;&#x66f4;&#x65b0;&#x5b50;&#x8282;&#x70b9;&#xff0c;&#x8fd9;&#x4e2a;&#x540e;&#x9762;&#x91cd;&#x70b9;&#x8bb2;&#x3002;\n\n2.&#x5982;&#x679c;&#x53ea;&#x6709; `ch` &#x5b58;&#x5728;&#xff0c;&#x8868;&#x793a;&#x65e7;&#x8282;&#x70b9;&#x4e0d;&#x9700;&#x8981;&#x4e86;&#x3002;&#x5982;&#x679c;&#x65e7;&#x7684;&#x8282;&#x70b9;&#x662f;&#x6587;&#x672c;&#x8282;&#x70b9;&#x5219;&#x5148;&#x5c06;&#x8282;&#x70b9;&#x7684;&#x6587;&#x672c;&#x6e05;&#x9664;&#xff0c;&#x7136;&#x540e;&#x901a;&#x8fc7; `addVnodes` &#x5c06; `ch` &#x6279;&#x91cf;&#x63d2;&#x5165;&#x5230;&#x65b0;&#x8282;&#x70b9; `elm` &#x4e0b;&#x3002;\n\n3.&#x5982;&#x679c;&#x53ea;&#x6709; `oldCh` &#x5b58;&#x5728;&#xff0c;&#x8868;&#x793a;&#x66f4;&#x65b0;&#x7684;&#x662f;&#x7a7a;&#x8282;&#x70b9;&#xff0c;&#x5219;&#x9700;&#x8981;&#x5c06;&#x65e7;&#x7684;&#x8282;&#x70b9;&#x901a;&#x8fc7; `removeVnodes` &#x5168;&#x90e8;&#x6e05;&#x9664;&#x3002;\n\n4.&#x5f53;&#x53ea;&#x6709;&#x65e7;&#x8282;&#x70b9;&#x662f;&#x6587;&#x672c;&#x8282;&#x70b9;&#x7684;&#x65f6;&#x5019;&#xff0c;&#x5219;&#x6e05;&#x9664;&#x5176;&#x8282;&#x70b9;&#x6587;&#x672c;&#x5185;&#x5bb9;&#x3002;\n\n*   &#x6267;&#x884c; `postpatch` &#x94a9;&#x5b50;&#x51fd;&#x6570;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"504,515"}},{"content":"<pre data-lines=\"516,521\"><code data-lines=\"516,521\"><span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">isDef</span>(data)) {\n  <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">isDef</span>(<span class=\"hljs-selector-tag\">i</span> = data.hook) &amp;&amp; <span class=\"hljs-built_in\">isDef</span>(<span class=\"hljs-selector-tag\">i</span> = <span class=\"hljs-selector-tag\">i</span>.postpatch)) <span class=\"hljs-selector-tag\">i</span>(oldVnode, vnode)\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"516,521"}},{"content":"<pre data-lines=\"522,525\"><code>&#x518d;&#x6267;&#x884c;&#x5b8c; `patch` &#x8fc7;&#x7a0b;&#x540e;&#xff0c;&#x4f1a;&#x6267;&#x884c; `postpatch` &#x94a9;&#x5b50;&#x51fd;&#x6570;&#xff0c;&#x5b83;&#x662f;&#x7ec4;&#x4ef6;&#x81ea;&#x5b9a;&#x4e49;&#x7684;&#x94a9;&#x5b50;&#x51fd;&#x6570;&#xff0c;&#x6709;&#x5219;&#x6267;&#x884c;&#x3002;\n\n&#x90a3;&#x4e48;&#x5728;&#x6574;&#x4e2a; `pathVnode` &#x8fc7;&#x7a0b;&#x4e2d;&#xff0c;&#x6700;&#x590d;&#x6742;&#x7684;&#x5c31;&#x662f; `updateChildren` &#x65b9;&#x6cd5;&#x4e86;&#xff0c;&#x4e0b;&#x9762;&#x6211;&#x4eec;&#x6765;&#x5355;&#x72ec;&#x4ecb;&#x7ecd;&#x5b83;&#x3002;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"522,525"}}],"payload":{"tag":"h2","lines":"299,301"}},{"content":"<a href=\"#updatechildren\">#</a> updateChildren","children":[{"content":"<pre data-lines=\"529,602\"><code data-lines=\"529,602\">function <span class=\"hljs-title function_\">updateChildren</span> <span class=\"hljs-params\">(parentElm, oldCh, newCh, insertedVnodeQueue, removeOnly)</span> {\n  <span class=\"hljs-type\">let</span> <span class=\"hljs-variable\">oldStartIdx</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">0</span>\n  <span class=\"hljs-type\">let</span> <span class=\"hljs-variable\">newStartIdx</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">0</span>\n  <span class=\"hljs-type\">let</span> <span class=\"hljs-variable\">oldEndIdx</span> <span class=\"hljs-operator\">=</span> oldCh.length - <span class=\"hljs-number\">1</span>\n  <span class=\"hljs-type\">let</span> <span class=\"hljs-variable\">oldStartVnode</span> <span class=\"hljs-operator\">=</span> oldCh[<span class=\"hljs-number\">0</span>]\n  <span class=\"hljs-type\">let</span> <span class=\"hljs-variable\">oldEndVnode</span> <span class=\"hljs-operator\">=</span> oldCh[oldEndIdx]\n  <span class=\"hljs-type\">let</span> <span class=\"hljs-variable\">newEndIdx</span> <span class=\"hljs-operator\">=</span> newCh.length - <span class=\"hljs-number\">1</span>\n  <span class=\"hljs-type\">let</span> <span class=\"hljs-variable\">newStartVnode</span> <span class=\"hljs-operator\">=</span> newCh[<span class=\"hljs-number\">0</span>]\n  <span class=\"hljs-type\">let</span> <span class=\"hljs-variable\">newEndVnode</span> <span class=\"hljs-operator\">=</span> newCh[newEndIdx]\n  let oldKeyToIdx, idxInOld, vnodeToMove, refElm\n\n  <span class=\"hljs-comment\">// removeOnly is a special flag used only by &lt;transition-group&gt;</span>\n  <span class=\"hljs-comment\">// to ensure removed elements stay in correct relative positions</span>\n  <span class=\"hljs-comment\">// during leaving transitions</span>\n  <span class=\"hljs-type\">const</span> <span class=\"hljs-variable\">canMove</span> <span class=\"hljs-operator\">=</span> !removeOnly\n\n  <span class=\"hljs-title function_\">if</span> <span class=\"hljs-params\">(process.env.NODE_ENV !== <span class=\"hljs-string\">&apos;production&apos;</span>)</span> {\n    checkDuplicateKeys(newCh)\n  }\n\n  <span class=\"hljs-keyword\">while</span> (oldStartIdx &lt;= oldEndIdx &amp;&amp; newStartIdx &lt;= newEndIdx) {\n    <span class=\"hljs-keyword\">if</span> (isUndef(oldStartVnode)) {\n      oldStartVnode = oldCh[++oldStartIdx] <span class=\"hljs-comment\">// Vnode has been moved left</span>\n    } <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (isUndef(oldEndVnode)) {\n      oldEndVnode = oldCh[--oldEndIdx]\n    } <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (sameVnode(oldStartVnode, newStartVnode)) {\n      patchVnode(oldStartVnode, newStartVnode, insertedVnodeQueue)\n      oldStartVnode = oldCh[++oldStartIdx]\n      newStartVnode = newCh[++newStartIdx]\n    } <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (sameVnode(oldEndVnode, newEndVnode)) {\n      patchVnode(oldEndVnode, newEndVnode, insertedVnodeQueue)\n      oldEndVnode = oldCh[--oldEndIdx]\n      newEndVnode = newCh[--newEndIdx]\n    } <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (sameVnode(oldStartVnode, newEndVnode)) { <span class=\"hljs-comment\">// Vnode moved right</span>\n      patchVnode(oldStartVnode, newEndVnode, insertedVnodeQueue)\n      canMove &amp;&amp; nodeOps.insertBefore(parentElm, oldStartVnode.elm, nodeOps.nextSibling(oldEndVnode.elm))\n      oldStartVnode = oldCh[++oldStartIdx]\n      newEndVnode = newCh[--newEndIdx]\n    } <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (sameVnode(oldEndVnode, newStartVnode)) { <span class=\"hljs-comment\">// Vnode moved left</span>\n      patchVnode(oldEndVnode, newStartVnode, insertedVnodeQueue)\n      canMove &amp;&amp; nodeOps.insertBefore(parentElm, oldEndVnode.elm, oldStartVnode.elm)\n      oldEndVnode = oldCh[--oldEndIdx]\n      newStartVnode = newCh[++newStartIdx]\n    } <span class=\"hljs-keyword\">else</span> {\n      <span class=\"hljs-keyword\">if</span> (isUndef(oldKeyToIdx)) oldKeyToIdx = createKeyToOldIdx(oldCh, oldStartIdx, oldEndIdx)\n      idxInOld = isDef(newStartVnode.key)\n        ? oldKeyToIdx[newStartVnode.key]\n        : findIdxInOld(newStartVnode, oldCh, oldStartIdx, oldEndIdx)\n      <span class=\"hljs-keyword\">if</span> (isUndef(idxInOld)) { <span class=\"hljs-comment\">// New element</span>\n        createElm(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.elm, <span class=\"hljs-literal\">false</span>, newCh, newStartIdx)\n      } <span class=\"hljs-keyword\">else</span> {\n        vnodeToMove = oldCh[idxInOld]\n        <span class=\"hljs-keyword\">if</span> (sameVnode(vnodeToMove, newStartVnode)) {\n          patchVnode(vnodeToMove, newStartVnode, insertedVnodeQueue)\n          oldCh[idxInOld] = undefined\n          canMove &amp;&amp; nodeOps.insertBefore(parentElm, vnodeToMove.elm, oldStartVnode.elm)\n        } <span class=\"hljs-keyword\">else</span> {\n          <span class=\"hljs-comment\">// same key but different element. treat as new element</span>\n          createElm(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.elm, <span class=\"hljs-literal\">false</span>, newCh, newStartIdx)\n        }\n      }\n      newStartVnode = newCh[++newStartIdx]\n    }\n  }\n  <span class=\"hljs-keyword\">if</span> (oldStartIdx &gt; oldEndIdx) {\n    refElm = isUndef(newCh[newEndIdx + <span class=\"hljs-number\">1</span>]) ? <span class=\"hljs-literal\">null</span> : newCh[newEndIdx + <span class=\"hljs-number\">1</span>].elm\n    <span class=\"hljs-title function_\">addVnodes</span><span class=\"hljs-params\">(parentElm, refElm, newCh, newStartIdx, newEndIdx, insertedVnodeQueue)</span>\n  } <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (newStartIdx &gt; newEndIdx) {\n    removeVnodes(parentElm, oldCh, oldStartIdx, oldEndIdx)\n  }\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"529,602"}},{"content":"<pre data-lines=\"603,604\"><code>`updateChildren` &#x7684;&#x903b;&#x8f91;&#x6bd4;&#x8f83;&#x590d;&#x6742;&#xff0c;&#x76f4;&#x63a5;&#x8bfb;&#x6e90;&#x7801;&#x6bd4;&#x8f83;&#x6666;&#x6da9;&#xff0c;&#x6211;&#x4eec;&#x53ef;&#x4ee5;&#x901a;&#x8fc7;&#x4e00;&#x4e2a;&#x5177;&#x4f53;&#x7684;&#x793a;&#x4f8b;&#x6765;&#x5206;&#x6790;&#x5b83;&#x3002;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"603,604"}},{"content":"<pre data-lines=\"605,638\"><code data-lines=\"605,638\"><span class=\"language-xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">template</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">&quot;app&quot;</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span>&gt;</span>\n      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">ul</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">li</span> <span class=\"hljs-attr\">v-for</span>=<span class=\"hljs-string\">&quot;item in items&quot;</span> <span class=\"hljs-attr\">:key</span>=<span class=\"hljs-string\">&quot;item.id&quot;</span>&gt;</span></span><span class=\"hljs-template-variable\">{{ <span class=\"hljs-name\">item.val</span> }}</span><span class=\"language-xml\"><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">li</span>&gt;</span>\n      <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">ul</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">button</span> @<span class=\"hljs-attr\">click</span>=<span class=\"hljs-string\">&quot;change&quot;</span>&gt;</span>change<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">button</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">template</span>&gt;</span>\n\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span>&gt;</span><span class=\"language-javascript\">\n  <span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> {\n    <span class=\"hljs-attr\">name</span>: <span class=\"hljs-string\">&apos;App&apos;</span>,\n    <span class=\"hljs-title function_\">data</span>(<span class=\"hljs-params\"></span>) {\n      <span class=\"hljs-keyword\">return</span> {\n        <span class=\"hljs-attr\">items</span>: [\n          {<span class=\"hljs-attr\">id</span>: <span class=\"hljs-number\">0</span>, <span class=\"hljs-attr\">val</span>: <span class=\"hljs-string\">&apos;A&apos;</span>},\n          {<span class=\"hljs-attr\">id</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-attr\">val</span>: <span class=\"hljs-string\">&apos;B&apos;</span>},\n          {<span class=\"hljs-attr\">id</span>: <span class=\"hljs-number\">2</span>, <span class=\"hljs-attr\">val</span>: <span class=\"hljs-string\">&apos;C&apos;</span>},\n          {<span class=\"hljs-attr\">id</span>: <span class=\"hljs-number\">3</span>, <span class=\"hljs-attr\">val</span>: <span class=\"hljs-string\">&apos;D&apos;</span>}\n        ]\n      }\n    },\n    <span class=\"hljs-attr\">methods</span>: {\n      <span class=\"hljs-title function_\">change</span>(<span class=\"hljs-params\"></span>) {\n        <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">items</span>.<span class=\"hljs-title function_\">reverse</span>().<span class=\"hljs-title function_\">push</span>({<span class=\"hljs-attr\">id</span>: <span class=\"hljs-number\">4</span>, <span class=\"hljs-attr\">val</span>: <span class=\"hljs-string\">&apos;E&apos;</span>})\n      }\n    }\n  }\n</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span> \n</span></code></pre>","children":[],"payload":{"tag":"pre","lines":"605,638"}},{"content":"<pre data-lines=\"639,652\"><code>&#x5f53;&#x6211;&#x4eec;&#x70b9;&#x51fb; `change` &#x6309;&#x94ae;&#x53bb;&#x6539;&#x53d8;&#x6570;&#x636e;&#xff0c;&#x6700;&#x7ec8;&#x4f1a;&#x6267;&#x884c;&#x5230; `updateChildren` &#x53bb;&#x66f4;&#x65b0; `li` &#x90e8;&#x5206;&#x7684;&#x5217;&#x8868;&#x6570;&#x636e;&#xff0c;&#x6211;&#x4eec;&#x901a;&#x8fc7;&#x56fe;&#x7684;&#x65b9;&#x5f0f;&#x6765;&#x63cf;&#x8ff0;&#x4e00;&#x4e0b;&#x5b83;&#x7684;&#x66f4;&#x65b0;&#x8fc7;&#x7a0b;&#xff1a;\n\n&#x7b2c;&#x4e00;&#x6b65;&#xff1a; ![](https://ustbhuangyi.github.io/vue-analysis/assets/update-children-1.png)\n\n&#x7b2c;&#x4e8c;&#x6b65;&#xff1a; ![](https://ustbhuangyi.github.io/vue-analysis/assets/update-children-2.png)\n\n&#x7b2c;&#x4e09;&#x6b65;&#xff1a; ![](https://ustbhuangyi.github.io/vue-analysis/assets/update-children-3.png)\n\n&#x7b2c;&#x56db;&#x6b65;&#xff1a; ![](https://ustbhuangyi.github.io/vue-analysis/assets/update-children-4.png)\n\n&#x7b2c;&#x4e94;&#x6b65;&#xff1a; ![](https://ustbhuangyi.github.io/vue-analysis/assets/update-children-5.png)\n\n&#x7b2c;&#x516d;&#x6b65;&#xff1a; ![](https://ustbhuangyi.github.io/vue-analysis/assets/update-children-6.png)\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"639,652"}}],"payload":{"tag":"h2","lines":"526,528"}},{"content":"<a href=\"#%E6%80%BB%E7%BB%93\">#</a> &#x603b;&#x7ed3;","children":[{"content":"<pre data-lines=\"656,657\"><code>&#x7ec4;&#x4ef6;&#x66f4;&#x65b0;&#x7684;&#x8fc7;&#x7a0b;&#x6838;&#x5fc3;&#x5c31;&#x662f;&#x65b0;&#x65e7; vnode diff&#xff0c;&#x5bf9;&#x65b0;&#x65e7;&#x8282;&#x70b9;&#x76f8;&#x540c;&#x4ee5;&#x53ca;&#x4e0d;&#x540c;&#x7684;&#x60c5;&#x51b5;&#x5206;&#x522b;&#x505a;&#x4e0d;&#x540c;&#x7684;&#x5904;&#x7406;&#x3002;&#x65b0;&#x65e7;&#x8282;&#x70b9;&#x4e0d;&#x540c;&#x7684;&#x66f4;&#x65b0;&#x6d41;&#x7a0b;&#x662f;&#x521b;&#x5efa;&#x65b0;&#x8282;&#x70b9;-&gt;&#x66f4;&#x65b0;&#x7236;&#x5360;&#x4f4d;&#x7b26;&#x8282;&#x70b9;-&gt;&#x5220;&#x9664;&#x65e7;&#x8282;&#x70b9;&#xff1b;&#x800c;&#x65b0;&#x65e7;&#x8282;&#x70b9;&#x76f8;&#x540c;&#x7684;&#x66f4;&#x65b0;&#x6d41;&#x7a0b;&#x662f;&#x53bb;&#x83b7;&#x53d6;&#x5b83;&#x4eec;&#x7684; children&#xff0c;&#x6839;&#x636e;&#x4e0d;&#x540c;&#x60c5;&#x51b5;&#x505a;&#x4e0d;&#x540c;&#x7684;&#x66f4;&#x65b0;&#x903b;&#x8f91;&#x3002;&#x6700;&#x590d;&#x6742;&#x7684;&#x60c5;&#x51b5;&#x662f;&#x65b0;&#x65e7;&#x8282;&#x70b9;&#x76f8;&#x540c;&#x4e14;&#x5b83;&#x4eec;&#x90fd;&#x5b58;&#x5728;&#x5b50;&#x8282;&#x70b9;&#xff0c;&#x90a3;&#x4e48;&#x4f1a;&#x6267;&#x884c; `updateChildren` &#x903b;&#x8f91;&#xff0c;&#x8fd9;&#x5757;&#x513f;&#x53ef;&#x4ee5;&#x501f;&#x52a9;&#x753b;&#x56fe;&#x7684;&#x65b9;&#x5f0f;&#x914d;&#x5408;&#x7406;&#x89e3;&#x3002;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"656,657"}}],"payload":{"tag":"h2","lines":"653,655"}}],"payload":{"tag":"h1","lines":"0,2"}},{})</script>
</body>
</html>
