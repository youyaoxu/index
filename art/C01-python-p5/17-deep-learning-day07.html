<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.10/dist/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.11.1/styles/default.min.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.18.10/dist/browser/index.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.10/dist/index.js"></script><script>(r => {
              setTimeout(r);
            })(function renderToolbar() {
  const {
    markmap,
    mm
  } = window;
  const {
    el
  } = markmap.Toolbar.create(mm);
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, root2, jsonOptions) => {
              const markmap = getMarkmap();
              window.mm = markmap.Markmap.create(
                "svg#mindmap",
                (getOptions || markmap.deriveOptions)(jsonOptions),
                root2
              );
            })(() => window.markmap,null,{"content":"Deep-Learning","children":[{"content":"&#x793a;&#x4f8b;","children":[{"content":"<pre data-lines=\"6,266\"><code class=\"language-python\"><span class=\"hljs-comment\"># 01_news_classfiy.py</span>\n<span class=\"hljs-comment\"># &#x65b0;&#x95fb;&#x8d44;&#x8baf;&#x5206;&#x7c7b;&#x793a;&#x4f8b;</span>\n<span class=\"hljs-comment\"># &#x4efb;&#x52a1;&#xff1a;&#x6839;&#x636e;&#x6837;&#x672c;&#xff0c;&#x8bad;&#x7ec3;&#x6a21;&#x578b;&#xff0c;&#x5c06;&#x65b0;&#x7684;&#x6587;&#x672c;&#x5212;&#x5206;&#x5230;&#x6b63;&#x786e;&#x7684;&#x7c7b;&#x522b;</span>\n<span class=\"hljs-string\">&apos;&apos;&apos;\n&#x6570;&#x636e;&#x6765;&#x6e90;&#xff1a;&#x4ece;&#x7f51;&#x7ad9;&#x4e0a;&#x722c;&#x53d6;56821&#x6761;&#x4e2d;&#x6587;&#x65b0;&#x95fb;&#x6458;&#x8981;\n&#x6570;&#x636e;&#x7c7b;&#x5bb9;&#xff1a;&#x5305;&#x542b;10&#x7c7b;(&#x56fd;&#x9645;&#x3001;&#x6587;&#x5316;&#x3001;&#x5a31;&#x4e50;&#x3001;&#x4f53;&#x80b2;&#x3001;&#x8d22;&#x7ecf;&#x3001;&#x6c7d;&#x8f66;&#x3001;&#x6559;&#x80b2;&#x3001;&#x79d1;&#x6280;&#x3001;&#x623f;&#x4ea7;&#x3001;&#x8bc1;&#x5238;)\n&apos;&apos;&apos;</span>\n\n<span class=\"hljs-comment\">################################## &#x9884;&#x5904;&#x7406; ##########################################</span>\n<span class=\"hljs-keyword\">import</span> os\n<span class=\"hljs-keyword\">from</span> multiprocessing <span class=\"hljs-keyword\">import</span> cpu_count\n<span class=\"hljs-keyword\">import</span> numpy <span class=\"hljs-keyword\">as</span> np\n<span class=\"hljs-keyword\">import</span> paddle\n<span class=\"hljs-keyword\">import</span> paddle.fluid <span class=\"hljs-keyword\">as</span> fluid\n\n<span class=\"hljs-comment\"># &#x5b9a;&#x4e49;&#x516c;&#x5171;&#x53d8;&#x91cf;</span>\ndata_root = <span class=\"hljs-string\">&quot;data/news_classify/&quot;</span>  <span class=\"hljs-comment\"># &#x6570;&#x636e;&#x96c6;&#x6240;&#x5728;&#x76ee;&#x5f55;</span>\ndata_file = <span class=\"hljs-string\">&quot;news_classify_data.txt&quot;</span>  <span class=\"hljs-comment\"># &#x539f;&#x59cb;&#x6837;&#x672c;&#x6587;&#x4ef6;&#x540d;&#x79f0;</span>\ntest_file = <span class=\"hljs-string\">&quot;test_list.txt&quot;</span>  <span class=\"hljs-comment\"># &#x6d4b;&#x8bd5;&#x96c6;&#x6587;&#x4ef6;&#x540d;</span>\ntrain_file = <span class=\"hljs-string\">&quot;train_list.txt&quot;</span>  <span class=\"hljs-comment\"># &#x8bad;&#x7ec3;&#x96c6;&#x6587;&#x4ef6;&#x540d;</span>\ndict_file = <span class=\"hljs-string\">&quot;dict_txt.txt&quot;</span>  <span class=\"hljs-comment\"># &#x7f16;&#x7801;&#x540e;&#x7684;&#x5b57;&#x5178;&#x6587;&#x4ef6;</span>\n\ndata_file_path = data_root + data_file  <span class=\"hljs-comment\"># &#x6837;&#x672c;&#x6587;&#x4ef6;&#x5b8c;&#x6574;&#x8def;&#x5f84;</span>\ndict_file_path = data_root + dict_file  <span class=\"hljs-comment\"># &#x7f16;&#x7801;&#x540e;&#x7684;&#x5b57;&#x5178;&#x6587;&#x4ef6;&#x5b8c;&#x6574;&#x8def;&#x5f84;</span>\ntest_file_path = data_root + test_file  <span class=\"hljs-comment\"># &#x6d4b;&#x8bd5;&#x96c6;&#x6587;&#x4ef6;&#x540d;&#x5b8c;&#x6574;&#x8def;&#x5f84;</span>\ntrain_file_path = data_root + train_file  <span class=\"hljs-comment\"># &#x8bad;&#x7ec3;&#x96c6;&#x6587;&#x4ef6;&#x540d;&#x5b8c;&#x6574;&#x8def;&#x5f84;</span>\n\n\n<span class=\"hljs-comment\"># &#x751f;&#x6210;&#x5b57;&#x5178;&#x6587;&#x4ef6;&#xff0c;&#x628a;&#x6bcf;&#x4e2a;&#x5b57;&#x7f16;&#x7801;&#x6210;&#x4e00;&#x4e2a;&#x6570;&#x5b57;&#xff0c;&#x5e76;&#x5b58;&#x5165;&#x6587;&#x4ef6;</span>\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">create_dict</span>():\n    dict_set = <span class=\"hljs-built_in\">set</span>()  <span class=\"hljs-comment\"># &#x96c6;&#x5408;&#xff0c;&#x5bf9;&#x6c49;&#x5b57;&#x53bb;&#x91cd;</span>\n\n    <span class=\"hljs-keyword\">with</span> <span class=\"hljs-built_in\">open</span>(data_file_path, <span class=\"hljs-string\">&quot;r&quot;</span>, encoding=<span class=\"hljs-string\">&quot;utf-8&quot;</span>) <span class=\"hljs-keyword\">as</span> f:  <span class=\"hljs-comment\"># &#x5148;&#x8bfb;&#x53d6;&#x6837;&#x672c;&#x4e2d;&#x6240;&#x6709;&#x6570;&#x636e;</span>\n        lines = f.readlines()\n\n    <span class=\"hljs-comment\"># &#x904d;&#x5386;&#x6bcf;&#x884c;&#xff0c;&#x8fdb;&#x884c;&#x5904;&#x7406;</span>\n    <span class=\"hljs-keyword\">for</span> line <span class=\"hljs-keyword\">in</span> lines:\n        title = line.split(<span class=\"hljs-string\">&quot;_!_&quot;</span>)[-<span class=\"hljs-number\">1</span>].replace(<span class=\"hljs-string\">&quot;\\n&quot;</span>, <span class=\"hljs-string\">&quot;&quot;</span>)  <span class=\"hljs-comment\"># &#x53d6;&#x51fa;&#x6807;&#x9898;&#x90e8;&#x5206;&#xff0c;&#x53bb;&#x9664;&#x6362;&#x884c;&#x7b26;</span>\n        <span class=\"hljs-keyword\">for</span> w <span class=\"hljs-keyword\">in</span> title:  <span class=\"hljs-comment\"># &#x53d6;&#x51fa;&#x6807;&#x9898;&#x4e2d;&#x7684;&#x6bcf;&#x4e2a;&#x5b57;</span>\n            dict_set.add(w)  <span class=\"hljs-comment\"># &#x5c06;&#x6bcf;&#x4e2a;&#x5b57;&#x63a8;&#x5230;&#x96c6;&#x5408;&#x4e2d;&#x53bb;&#x91cd;</span>\n\n    <span class=\"hljs-comment\"># &#x904d;&#x5386;&#x96c6;&#x5408;&#xff0c;&#x6bcf;&#x4e2a;&#x5b57;&#x7b26;&#x5206;&#x914d;&#x4e00;&#x4e2a;&#x7f16;&#x7801;&#x503c;</span>\n    dict_list = []\n    i = <span class=\"hljs-number\">0</span>  <span class=\"hljs-comment\"># &#x7f16;&#x7801;&#x8ba1;&#x6570;&#x5668;</span>\n    <span class=\"hljs-keyword\">for</span> s <span class=\"hljs-keyword\">in</span> dict_set:\n        dict_list.append([s, i])  <span class=\"hljs-comment\"># &#x6c49;&#x5b57;-&#x7f16;&#x7801; &#x952e;&#x503c;&#x5bf9;&#x5148;&#x5b58;&#x5165;&#x4e34;&#x65f6;&#x5217;&#x8868;</span>\n        i += <span class=\"hljs-number\">1</span>\n\n    dict_txt = <span class=\"hljs-built_in\">dict</span>(dict_list)  <span class=\"hljs-comment\"># &#x5c06;&#x5217;&#x8868;&#x8f6c;&#x6362;&#x4e3a;&#x5b57;&#x5178;&#x5bf9;&#x8c61;</span>\n    end_dict = {<span class=\"hljs-string\">&quot;&lt;unk&gt;&quot;</span>: i}  <span class=\"hljs-comment\"># &#x672a;&#x77e5;&#x5b57;&#x7b26;&#xff0c;&#x9632;&#x6b62;&#x67d0;&#x4e9b;&#x6c49;&#x5b57;&#x6ca1;&#x6709;&#x7f16;&#x7801;&#x5bfc;&#x81f4;&#x7684;&#x9519;&#x8bef;</span>\n    dict_txt.update(end_dict)  <span class=\"hljs-comment\"># &#x5c06;&#x672a;&#x77e5;&#x5b57;&#x7b26;&#x53ca;&#x7f16;&#x7801;&#x6dfb;&#x52a0;&#x5230;&#x5b57;&#x5178;&#x4e2d;</span>\n\n    <span class=\"hljs-comment\"># &#x5c06;&#x5b57;&#x5178;&#x4e2d;&#x7684;&#x5185;&#x5bb9;&#x4fdd;&#x5b58;&#x5230;&#x6587;&#x4ef6;&#x4e2d;</span>\n    <span class=\"hljs-keyword\">with</span> <span class=\"hljs-built_in\">open</span>(dict_file_path, <span class=\"hljs-string\">&quot;w&quot;</span>, encoding=<span class=\"hljs-string\">&quot;utf-8&quot;</span>) <span class=\"hljs-keyword\">as</span> f:\n        f.write(<span class=\"hljs-built_in\">str</span>(dict_txt))  <span class=\"hljs-comment\"># &#x5c06;&#x5b57;&#x5178;&#x8f6c;&#x6362;&#x4e3a;&#x5b57;&#x7b26;&#x4e32;&#x76f4;&#x63a5;&#x5199;&#x5165;&#x6587;&#x4ef6;</span>\n\n    <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">&quot;&#x751f;&#x6210;&#x5b57;&#x5178;&#x5b8c;&#x6210;!&quot;</span>)\n\n\n<span class=\"hljs-comment\"># &#x5bf9;&#x4e00;&#x884c;&#x6807;&#x9898;&#x8fdb;&#x884c;&#x7f16;&#x7801;</span>\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">line_encoding</span>(<span class=\"hljs-params\">title, dict_txt, label</span>):\n    new_line = <span class=\"hljs-string\">&quot;&quot;</span>  <span class=\"hljs-comment\"># &#x7f16;&#x7801;&#x540e;&#x7684;&#x7ed3;&#x679c;</span>\n    <span class=\"hljs-keyword\">for</span> w <span class=\"hljs-keyword\">in</span> title:  <span class=\"hljs-comment\"># &#x904d;&#x5386;title&#xff0c;&#x53d6;&#x51fa;&#x6bcf;&#x4e2a;&#x5b57;</span>\n        <span class=\"hljs-keyword\">if</span> w <span class=\"hljs-keyword\">in</span> dict_txt:  <span class=\"hljs-comment\"># &#x8be5;&#x5b57;&#x5728;&#x5b57;&#x5178;&#x4e2d;&#xff0c;&#x76f4;&#x63a5;&#x53d6;&#x51fa;&#x7f16;&#x7801;&#x503c;</span>\n            code = <span class=\"hljs-built_in\">str</span>(dict_txt[w])\n        <span class=\"hljs-keyword\">else</span>:  <span class=\"hljs-comment\"># &#x6ca1;&#x6709;&#x5728;&#x5b57;&#x5178;&#x4e2d;&#xff0c;&#x53d6;&#x672a;&#x77e5;&#x5b57;&#x7b26;&#x7684;&#x7f16;&#x7801;</span>\n            code = <span class=\"hljs-built_in\">str</span>(dict_txt[<span class=\"hljs-string\">&quot;&lt;unk&gt;&quot;</span>])\n        new_line = new_line + code + <span class=\"hljs-string\">&quot;,&quot;</span>  <span class=\"hljs-comment\"># &#x5c06;&#x7f16;&#x7801;&#x503c;&#x6dfb;&#x52a0;&#x5230;&#x5b57;&#x7b26;&#x4e32;&#x540e;&#x9762;</span>\n\n    new_line = new_line[:-<span class=\"hljs-number\">1</span>]  <span class=\"hljs-comment\"># &#x53bb;&#x6389;&#x6700;&#x540e;&#x591a;&#x4f59;&#x7684;&#x4e00;&#x4e2a;&#x9017;&#x53f7;</span>\n    new_line = new_line + <span class=\"hljs-string\">&quot;\\t&quot;</span> + label + <span class=\"hljs-string\">&quot;\\n&quot;</span>  <span class=\"hljs-comment\"># &#x5c06;&#x7f16;&#x7801;&#x540e;&#x7684;&#x5b57;&#x7b26;&#x4e32;&#x3001;&#x7c7b;&#x522b;&#x62fc;&#x6210;&#x4e00;&#x884c;</span>\n\n    <span class=\"hljs-keyword\">return</span> new_line\n\n\n<span class=\"hljs-comment\"># &#x8bfb;&#x53d6;&#x539f;&#x59cb;&#x6837;&#x672c;&#x4e2d;&#x7684;&#x6bcf;&#x4e2a;&#x53e5;&#x5b50;&#xff0c;&#x53d6;&#x51fa;&#x6807;&#x9898;&#x90e8;&#x5206;&#x3001;&#x7c7b;&#x522b;&#x8fdb;&#x884c;&#x7f16;&#x7801;</span>\n<span class=\"hljs-comment\"># &#x4ea7;&#x751f;&#x7f16;&#x7801;&#x540e;&#x7684;&#x6837;&#x672c;&#x6587;&#x4ef6;&#xff0c;&#x5e76;&#x5212;&#x5206;&#x6d4b;&#x8bd5;&#x96c6;&#x3001;&#x8bad;&#x7ec3;&#x96c6;</span>\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">crreate_data_list</span>():\n    <span class=\"hljs-comment\"># &#x6e05;&#x7a7a;&#x8bad;&#x7ec3;&#x96c6;&#x3001;&#x6d4b;&#x8bd5;&#x96c6;&#x6587;&#x4ef6;</span>\n    <span class=\"hljs-keyword\">with</span> <span class=\"hljs-built_in\">open</span>(test_file_path, <span class=\"hljs-string\">&quot;w&quot;</span>) <span class=\"hljs-keyword\">as</span> f:\n        <span class=\"hljs-keyword\">pass</span>\n    <span class=\"hljs-keyword\">with</span> <span class=\"hljs-built_in\">open</span>(train_file_path, <span class=\"hljs-string\">&quot;w&quot;</span>) <span class=\"hljs-keyword\">as</span> f:\n        <span class=\"hljs-keyword\">pass</span>\n\n    <span class=\"hljs-comment\"># &#x6253;&#x5f00;&#x539f;&#x59cb;&#x6837;&#x672c;&#xff0c;&#x53d6;&#x51fa;&#x6807;&#x9898;&#x90e8;&#x5206;&#x8fdb;&#x884c;&#x7f16;&#x7801;</span>\n    <span class=\"hljs-keyword\">with</span> <span class=\"hljs-built_in\">open</span>(dict_file_path, <span class=\"hljs-string\">&quot;r&quot;</span>, encoding=<span class=\"hljs-string\">&quot;utf-8&quot;</span>) <span class=\"hljs-keyword\">as</span> f_dict:\n        <span class=\"hljs-comment\"># &#x8bfb;&#x53d6;&#x6587;&#x4ef6;&#x5185;&#x5bb9;&#xff0c;&#x53d6;&#x51fa;&#x7b2c;&#x4e00;&#x884c;(&#x53ea;&#x6709;&#x4e00;&#x884c;)&#xff0c;&#x901a;&#x8fc7;&#x8c03;&#x7528;eval&#x6267;&#x884c;&#x5b57;&#x7b26;&#x4e32;&#xff0c;&#x751f;&#x6210;&#x4e00;&#x4e2a;&#x5b57;&#x5178;&#x5bf9;&#x8c61;</span>\n        dict_txt = <span class=\"hljs-built_in\">eval</span>(f_dict.readlines()[<span class=\"hljs-number\">0</span>])\n\n    <span class=\"hljs-keyword\">with</span> <span class=\"hljs-built_in\">open</span>(data_file_path, <span class=\"hljs-string\">&quot;r&quot;</span>, encoding=<span class=\"hljs-string\">&quot;utf-8&quot;</span>) <span class=\"hljs-keyword\">as</span> f_data:\n        lines = f_data.readlines()\n\n    <span class=\"hljs-comment\"># &#x53d6;&#x51fa;&#x6807;&#x9898;&#x90e8;&#x5206;&#x8fdb;&#x884c;&#x7f16;&#x7801;</span>\n    i = <span class=\"hljs-number\">0</span>\n    <span class=\"hljs-keyword\">for</span> line <span class=\"hljs-keyword\">in</span> lines:\n        words = line.replace(<span class=\"hljs-string\">&quot;\\n&quot;</span>, <span class=\"hljs-string\">&quot;&quot;</span>).split(<span class=\"hljs-string\">&quot;_!_&quot;</span>)\n        label = words[<span class=\"hljs-number\">1</span>]  <span class=\"hljs-comment\"># &#x5206;&#x7c7b;&#x6570;&#x5b57;</span>\n        title = words[<span class=\"hljs-number\">3</span>]  <span class=\"hljs-comment\"># &#x6807;&#x9898;&#x90e8;&#x5206;</span>\n\n        new_line = line_encoding(title, dict_txt, label)  <span class=\"hljs-comment\"># &#x6267;&#x884c;&#x7f16;&#x7801;</span>\n        <span class=\"hljs-keyword\">if</span> i % <span class=\"hljs-number\">10</span> == <span class=\"hljs-number\">0</span>:\n            <span class=\"hljs-keyword\">with</span> <span class=\"hljs-built_in\">open</span>(test_file_path, <span class=\"hljs-string\">&quot;a&quot;</span>, encoding=<span class=\"hljs-string\">&quot;utf-8&quot;</span>) <span class=\"hljs-keyword\">as</span> f:\n                f.write(new_line)\n        <span class=\"hljs-keyword\">else</span>:\n            <span class=\"hljs-keyword\">with</span> <span class=\"hljs-built_in\">open</span>(train_file_path, <span class=\"hljs-string\">&quot;a&quot;</span>, encoding=<span class=\"hljs-string\">&quot;utf-8&quot;</span>) <span class=\"hljs-keyword\">as</span> f:\n                f.write(new_line)\n        i += <span class=\"hljs-number\">1</span>\n    <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">&quot;&#x751f;&#x6210;&#x6d4b;&#x8bd5;&#x96c6;&#x3001;&#x8bad;&#x7ec3;&#x96c6;&#x7ed3;&#x675f;.&quot;</span>)\n\n\ncreate_dict()  <span class=\"hljs-comment\"># &#x751f;&#x6210;&#x5b57;&#x5178;</span>\ncrreate_data_list()  <span class=\"hljs-comment\"># &#x6837;&#x672c;&#x7f16;&#x7801;</span>\n\n<span class=\"hljs-comment\">############################ &#x6a21;&#x578b;&#x642d;&#x5efa;/&#x8bad;&#x7ec3;/&#x8bc4;&#x4f30;/&#x4fdd;&#x5b58; #################################</span>\n<span class=\"hljs-comment\"># &#x8bfb;&#x53d6;&#x5b57;&#x5178;&#x6587;&#x4ef6;&#xff0c;&#x5e76;&#x8fd4;&#x56de;&#x5b57;&#x5178;&#x957f;&#x5ea6;</span>\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">get_dict_len</span>(<span class=\"hljs-params\">dict_path</span>):\n    <span class=\"hljs-keyword\">with</span> <span class=\"hljs-built_in\">open</span>(dict_path, <span class=\"hljs-string\">&quot;r&quot;</span>, encoding=<span class=\"hljs-string\">&quot;utf-8&quot;</span>) <span class=\"hljs-keyword\">as</span> f:\n        line = <span class=\"hljs-built_in\">eval</span>(f.readlines()[<span class=\"hljs-number\">0</span>])  <span class=\"hljs-comment\"># &#x8bfb;&#x53d6;&#x5b57;&#x5178;&#x6587;&#x4ef6;&#x5185;&#x5bb9;&#xff0c;&#x5e76;&#x8fd4;&#x56de;&#x4e00;&#x4e2a;&#x5b57;&#x5178;&#x5bf9;&#x8c61;</span>\n\n    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">len</span>(line.keys())\n\n\n<span class=\"hljs-comment\"># &#x5b9a;&#x4e49;data_mapper&#xff0c;&#x5c06;reader&#x8bfb;&#x53d6;&#x7684;&#x6570;&#x636e;&#x8fdb;&#x884c;&#x4e8c;&#x6b21;&#x5904;&#x7406;</span>\n<span class=\"hljs-comment\"># &#x5c06;&#x4f20;&#x5165;&#x7684;&#x5b57;&#x7b26;&#x4e32;&#x8f6c;&#x6362;&#x4e3a;&#x6574;&#x578b;&#x5e76;&#x8fd4;&#x56de;</span>\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">data_mapper</span>(<span class=\"hljs-params\">sample</span>):\n    data, label = sample  <span class=\"hljs-comment\"># &#x5c06;sample&#x5143;&#x7ec4;&#x62c6;&#x5206;&#x5230;&#x4e24;&#x4e2a;&#x53d8;&#x91cf;</span>\n    <span class=\"hljs-comment\"># &#x62c6;&#x5206;&#x53e5;&#x5b50;&#xff0c;&#x5c06;&#x6bcf;&#x4e2a;&#x7f16;&#x7801;&#x8f6c;&#x6362;&#x4e3a;&#x6570;&#x5b57;, &#x5e76;&#x5b58;&#x5165;&#x4e00;&#x4e2a;&#x5217;&#x8868;&#x4e2d;</span>\n    val = [<span class=\"hljs-built_in\">int</span>(w) <span class=\"hljs-keyword\">for</span> w <span class=\"hljs-keyword\">in</span> data.split(<span class=\"hljs-string\">&quot;,&quot;</span>)]\n    <span class=\"hljs-keyword\">return</span> val, <span class=\"hljs-built_in\">int</span>(label)  <span class=\"hljs-comment\"># &#x8fd4;&#x56de;&#x6574;&#x6570;&#x5217;&#x8868;&#xff0c;&#x6807;&#x7b7e;(&#x8f6c;&#x6362;&#x6210;&#x6574;&#x6570;)</span>\n\n\n<span class=\"hljs-comment\"># &#x5b9a;&#x4e49;reader</span>\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">train_reader</span>(<span class=\"hljs-params\">train_file_path</span>):\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">reader</span>():\n        <span class=\"hljs-keyword\">with</span> <span class=\"hljs-built_in\">open</span>(train_file_path, <span class=\"hljs-string\">&quot;r&quot;</span>) <span class=\"hljs-keyword\">as</span> f:\n            lines = f.readlines()  <span class=\"hljs-comment\"># &#x8bfb;&#x53d6;&#x6240;&#x6709;&#x7684;&#x884c;</span>\n            np.random.shuffle(lines)  <span class=\"hljs-comment\"># &#x6253;&#x4e71;&#x6240;&#x6709;&#x6837;&#x672c;</span>\n\n            <span class=\"hljs-keyword\">for</span> line <span class=\"hljs-keyword\">in</span> lines:\n                data, label = line.split(<span class=\"hljs-string\">&quot;\\t&quot;</span>)  <span class=\"hljs-comment\"># &#x62c6;&#x5206;&#x6837;&#x672c;&#x5230;&#x4e24;&#x4e2a;&#x53d8;&#x91cf;&#x4e2d;</span>\n                <span class=\"hljs-keyword\">yield</span> data, label\n\n    <span class=\"hljs-keyword\">return</span> paddle.reader.xmap_readers(data_mapper,  <span class=\"hljs-comment\"># reader&#x8bfb;&#x53d6;&#x7684;&#x6570;&#x636e;&#x8fdb;&#x884c;&#x4e0b;&#x4e00;&#x6b65;&#x5904;&#x7406;&#x51fd;&#x6570;</span>\n                                      reader,  <span class=\"hljs-comment\"># &#x8bfb;&#x53d6;&#x6837;&#x672c;&#x7684;reader</span>\n                                      cpu_count(),  <span class=\"hljs-comment\"># &#x7ebf;&#x7a0b;&#x6570;</span>\n                                      <span class=\"hljs-number\">1024</span>)  <span class=\"hljs-comment\"># &#x7f13;&#x51b2;&#x533a;&#x5927;&#x5c0f;</span>\n\n\n<span class=\"hljs-comment\"># &#x8bfb;&#x53d6;&#x6d4b;&#x8bd5;&#x96c6;reader</span>\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">test_reader</span>(<span class=\"hljs-params\">test_file_path</span>):\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">reader</span>():\n        <span class=\"hljs-keyword\">with</span> <span class=\"hljs-built_in\">open</span>(test_file_path, <span class=\"hljs-string\">&quot;r&quot;</span>) <span class=\"hljs-keyword\">as</span> f:\n            lines = f.readlines()\n\n            <span class=\"hljs-keyword\">for</span> line <span class=\"hljs-keyword\">in</span> lines:\n                data, label = line.split(<span class=\"hljs-string\">&quot;\\t&quot;</span>)\n                <span class=\"hljs-keyword\">yield</span> data, label\n\n    <span class=\"hljs-keyword\">return</span> paddle.reader.xmap_readers(data_mapper,\n                                      reader,\n                                      cpu_count(),\n                                      <span class=\"hljs-number\">1024</span>)\n\n<span class=\"hljs-comment\"># &#x5b9a;&#x4e49;&#x7f51;&#x7edc;</span>\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">CNN_net</span>(<span class=\"hljs-params\">data, dict_dim, class_dim=<span class=\"hljs-number\">10</span>, emb_dim=<span class=\"hljs-number\">128</span>, hid_dim=<span class=\"hljs-number\">128</span>, hid_dim2=<span class=\"hljs-number\">98</span></span>):\n    <span class=\"hljs-comment\"># &#x8bcd;&#x5d4c;&#x5165;&#x5c42;&#xff1a;&#x751f;&#x6210;&#x8bcd;&#x5411;&#x91cf;&#xff0c;&#x5f97;&#x5230;&#x4e00;&#x4e2a;&#x65b0;&#x7684;&#x7c98;&#x7a20;&#x7684;&#x5b9e;&#x5411;&#x91cf;</span>\n    emb = fluid.layers.embedding(<span class=\"hljs-built_in\">input</span>=data, size=[dict_dim, emb_dim])\n\n    <span class=\"hljs-comment\"># &#x5e76;&#x5217;&#x4e24;&#x7ec4;&#x5377;&#x79ef;&#x3001;&#x6c60;&#x5316;&#x5c42;</span>\n    conv1 = fluid.nets.sequence_conv_pool(<span class=\"hljs-built_in\">input</span>=emb, <span class=\"hljs-comment\"># &#x8f93;&#x5165;&#xff0c;&#x8bcd;&#x5d4c;&#x5165;&#x5c42;&#x8f93;&#x51fa;&#x4f5c;&#x4e3a;&#x8f93;&#x5165;</span>\n                                          num_filters=hid_dim, <span class=\"hljs-comment\"># &#x5377;&#x79ef;&#x6838;&#x6570;&#x91cf;</span>\n                                          filter_size=<span class=\"hljs-number\">3</span>, <span class=\"hljs-comment\"># &#x5377;&#x79ef;&#x6838;&#x5927;&#x5c0f;</span>\n                                          act=<span class=\"hljs-string\">&quot;tanh&quot;</span>, <span class=\"hljs-comment\"># &#x6fc0;&#x6d3b;&#x51fd;&#x6570;</span>\n                                          pool_type=<span class=\"hljs-string\">&quot;sqrt&quot;</span>) <span class=\"hljs-comment\"># &#x6c60;&#x5316;&#x7c7b;&#x578b;</span>\n\n    conv2 = fluid.nets.sequence_conv_pool(<span class=\"hljs-built_in\">input</span>=emb, <span class=\"hljs-comment\"># &#x8f93;&#x5165;&#xff0c;&#x8bcd;&#x5d4c;&#x5165;&#x5c42;&#x8f93;&#x51fa;&#x4f5c;&#x4e3a;&#x8f93;&#x5165;</span>\n                                          num_filters=hid_dim2, <span class=\"hljs-comment\"># &#x5377;&#x79ef;&#x6838;&#x6570;&#x91cf;</span>\n                                          filter_size=<span class=\"hljs-number\">4</span>, <span class=\"hljs-comment\"># &#x5377;&#x79ef;&#x6838;&#x5927;&#x5c0f;</span>\n                                          act=<span class=\"hljs-string\">&quot;tanh&quot;</span>, <span class=\"hljs-comment\"># &#x6fc0;&#x6d3b;&#x51fd;&#x6570;</span>\n                                          pool_type=<span class=\"hljs-string\">&quot;sqrt&quot;</span>) <span class=\"hljs-comment\"># &#x6c60;&#x5316;&#x7c7b;&#x578b;</span>\n    output = fluid.layers.fc(<span class=\"hljs-built_in\">input</span>=[conv1, conv2], <span class=\"hljs-comment\"># &#x8f93;&#x5165;&#xff1a;&#x524d;&#x9762;&#x4e24;&#x4e2a;&#x5377;&#x79ef;&#x6c60;&#x5316;&#x8f93;&#x51fa;&#x4f5c;&#x4e3a;&#x8f93;&#x5165;</span>\n                             size=class_dim, <span class=\"hljs-comment\"># &#x8f93;&#x51fa;&#x7c7b;&#x522b;&#x6570;&#x91cf;</span>\n                             act=<span class=\"hljs-string\">&quot;softmax&quot;</span>) <span class=\"hljs-comment\"># &#x6fc0;&#x6d3b;&#x51fd;&#x6570;</span>\n    <span class=\"hljs-keyword\">return</span> output\n\nwords = fluid.layers.data(name=<span class=\"hljs-string\">&quot;words&quot;</span>, shape=[<span class=\"hljs-number\">1</span>], dtype=<span class=\"hljs-string\">&quot;int64&quot;</span>,\n                          lod_level=<span class=\"hljs-number\">1</span>) <span class=\"hljs-comment\"># &#x5f20;&#x91cf;&#x5c42;&#x7ea7;</span>\nlabel = fluid.layers.data(name=<span class=\"hljs-string\">&quot;label&quot;</span>, shape=[<span class=\"hljs-number\">1</span>], dtype=<span class=\"hljs-string\">&quot;int64&quot;</span>)\n\ndict_dim = get_dict_len(dict_file_path) <span class=\"hljs-comment\"># &#x83b7;&#x53d6;&#x5b57;&#x5178;&#x957f;&#x5ea6;</span>\n<span class=\"hljs-comment\"># &#x8c03;&#x7528;&#x51fd;&#x6570;&#x521b;&#x5efa;CNN</span>\nmodel = CNN_net(words, dict_dim)\n<span class=\"hljs-comment\"># &#x5b9a;&#x4e49;&#x635f;&#x5931;&#x51fd;&#x6570;</span>\ncost = fluid.layers.cross_entropy(<span class=\"hljs-built_in\">input</span>=model, <span class=\"hljs-comment\"># &#x9884;&#x6d4b;&#x7ed3;&#x679c;</span>\n                                  label=label) <span class=\"hljs-comment\"># &#x771f;&#x5b9e;&#x7ed3;&#x679c;</span>\navg_cost = fluid.layers.mean(cost) <span class=\"hljs-comment\"># &#x6c42;&#x635f;&#x5931;&#x51fd;&#x6570;&#x5747;&#x503c;</span>\n<span class=\"hljs-comment\"># &#x51c6;&#x786e;&#x7387;</span>\nacc = fluid.layers.accuracy(<span class=\"hljs-built_in\">input</span>=model, <span class=\"hljs-comment\"># &#x9884;&#x6d4b;&#x7ed3;&#x679c;</span>\n                            label=label) <span class=\"hljs-comment\"># &#x771f;&#x5b9e;&#x7ed3;&#x679c;</span>\n<span class=\"hljs-comment\"># &#x514b;&#x9686;program&#x7528;&#x4e8e;&#x6a21;&#x578b;&#x6d4b;&#x8bd5;&#x8bc4;&#x4f30;</span>\n<span class=\"hljs-comment\"># for_test&#x5982;&#x679c;&#x4e3a;True&#xff0c;&#x4f1a;&#x5c11;&#x4e00;&#x4e9b;&#x4f18;&#x5316;</span>\ntest_program = fluid.default_main_program().clone(for_test=<span class=\"hljs-literal\">True</span>)\n<span class=\"hljs-comment\"># &#x5b9a;&#x4e49;&#x4f18;&#x5316;&#x5668;</span>\noptimizer = fluid.optimizer.AdagradOptimizer(learning_rate=<span class=\"hljs-number\">0.001</span>)\noptimizer.minimize(avg_cost)\n\n<span class=\"hljs-comment\"># &#x5b9a;&#x4e49;&#x6267;&#x884c;&#x5668;</span>\nplace = fluid.CPUPlace()\nexe = fluid.Executor(place)\nexe.run(fluid.default_startup_program())\n\n<span class=\"hljs-comment\"># &#x51c6;&#x5907;&#x6570;&#x636e;</span>\ntr_reader = train_reader(train_file_path)\nbatch_train_reader = paddle.batch(reader=tr_reader, batch_size=<span class=\"hljs-number\">128</span>)\n\nts_reader = test_reader(test_file_path)\nbatch_test_reader = paddle.batch(reader=ts_reader, batch_size=<span class=\"hljs-number\">128</span>)\n\nfeeder = fluid.DataFeeder(place=place, feed_list=[words, label]) <span class=\"hljs-comment\"># feeder</span>\n\n<span class=\"hljs-comment\"># &#x5f00;&#x59cb;&#x8bad;&#x7ec3;</span>\n<span class=\"hljs-keyword\">for</span> pass_id <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(<span class=\"hljs-number\">20</span>):\n    <span class=\"hljs-keyword\">for</span> batch_id, data <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">enumerate</span>(batch_train_reader()):\n        train_cost, train_acc = exe.run(program=fluid.default_main_program(),\n                                        feed=feeder.feed(data), <span class=\"hljs-comment\"># &#x5582;&#x5165;&#x6570;&#x636e;</span>\n                                        fetch_list=[avg_cost, acc]) <span class=\"hljs-comment\"># &#x8981;&#x83b7;&#x53d6;&#x7684;&#x7ed3;&#x679c;</span>\n        <span class=\"hljs-comment\"># &#x6253;&#x5370;</span>\n        <span class=\"hljs-keyword\">if</span> batch_id % <span class=\"hljs-number\">100</span> == <span class=\"hljs-number\">0</span>:\n            <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">&quot;pass_id:%d, batch_id:%d, cost:%f, acc:%f&quot;</span> %\n                  (pass_id, batch_id, train_cost[<span class=\"hljs-number\">0</span>], train_acc[<span class=\"hljs-number\">0</span>]))\n\n    <span class=\"hljs-comment\"># &#x6bcf;&#x8f6e;&#x6b21;&#x8bad;&#x7ec3;&#x5b8c;&#x6210;&#x540e;&#xff0c;&#x8fdb;&#x884c;&#x6a21;&#x578b;&#x8bc4;&#x4f30;</span>\n    test_costs_list = []  <span class=\"hljs-comment\"># &#x5b58;&#x653e;&#x6240;&#x6709;&#x7684;&#x635f;&#x5931;&#x503c;</span>\n    test_accs_list = []  <span class=\"hljs-comment\"># &#x5b58;&#x653e;&#x51c6;&#x786e;&#x7387;</span>\n\n    <span class=\"hljs-keyword\">for</span> batch_id, data <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">enumerate</span>(batch_test_reader()):\n        test_cost, test_acc = exe.run(program=test_program, <span class=\"hljs-comment\"># &#x6267;&#x884c;test_program</span>\n                                      feed=feeder.feed(data),\n                                      fetch_list=[avg_cost, acc])\n        test_costs_list.append(test_cost[<span class=\"hljs-number\">0</span>]) <span class=\"hljs-comment\"># &#x8bb0;&#x5f55;&#x6d4b;&#x8bd5;&#x635f;&#x5931;&#x503c;</span>\n        test_accs_list.append(test_acc[<span class=\"hljs-number\">0</span>]) <span class=\"hljs-comment\"># &#x8bb0;&#x5f55;&#x6d4b;&#x8bd5;&#x51c6;&#x786e;&#x7387;</span>\n\n    <span class=\"hljs-comment\"># &#x8ba1;&#x7b97;&#x5e73;&#x5747;&#x635f;&#x5931;&#x503c;&#x3001;&#x51c6;&#x786e;&#x7387;</span>\n    avg_test_cost = <span class=\"hljs-built_in\">sum</span>(test_costs_list) / <span class=\"hljs-built_in\">len</span>(test_costs_list)\n    avg_test_acc = <span class=\"hljs-built_in\">sum</span>(test_accs_list) / <span class=\"hljs-built_in\">len</span>(test_accs_list)\n\n<span class=\"hljs-comment\"># &#x4fdd;&#x5b58;&#x6a21;&#x578b;</span>\nmodel_save_dir = <span class=\"hljs-string\">&quot;model/news_classify/&quot;</span>\n<span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">not</span> os.path.exists(model_save_dir):\n    os.makedirs(model_save_dir)\nfluid.io.save_inference_model(model_save_dir, <span class=\"hljs-comment\"># &#x6a21;&#x578b;&#x4fdd;&#x5b58;&#x8def;&#x5f84;</span>\n                              feeded_var_names=[words.name], <span class=\"hljs-comment\"># &#x4f7f;&#x7528;&#x6a21;&#x578b;&#x65f6;&#x9700;&#x4f20;&#x5165;&#x7684;&#x53c2;&#x6570;</span>\n                              target_vars=[model], <span class=\"hljs-comment\"># &#x9884;&#x6d4b;&#x7ed3;&#x679c;</span>\n                              executor=exe) <span class=\"hljs-comment\"># &#x6267;&#x884c;&#x5668;</span>\n<span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">&quot;&#x6a21;&#x578b;&#x4fdd;&#x5b58;&#x5b8c;&#x6210;.&quot;</span>)\n\n<span class=\"hljs-comment\">##################################### &#x9884;&#x6d4b; ########################################</span>\n\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"6,266"}},{"content":"<pre data-lines=\"267,1469\"><code class=\"language-python\"><span class=\"hljs-comment\"># -*- coding: UTF-8 -*-</span>\n<span class=\"hljs-string\">&quot;&quot;&quot;\n&#x8bad;&#x7ec3;&#x5e38;&#x57fa;&#x4e8e;dark-net&#x7684;YOLOv3&#x7f51;&#x7edc;&#xff0c;&#x76ee;&#x6807;&#x68c0;&#x6d4b;\n&quot;&quot;&quot;</span>\n<span class=\"hljs-keyword\">from</span> __future__ <span class=\"hljs-keyword\">import</span> absolute_import\n<span class=\"hljs-keyword\">from</span> __future__ <span class=\"hljs-keyword\">import</span> division\n<span class=\"hljs-keyword\">from</span> __future__ <span class=\"hljs-keyword\">import</span> print_function\n<span class=\"hljs-keyword\">import</span> os\n\nos.environ[<span class=\"hljs-string\">&quot;FLAGS_fraction_of_gpu_memory_to_use&quot;</span>] = <span class=\"hljs-string\">&apos;0.82&apos;</span>\n\n<span class=\"hljs-keyword\">import</span> uuid\n<span class=\"hljs-keyword\">import</span> numpy <span class=\"hljs-keyword\">as</span> np\n<span class=\"hljs-keyword\">import</span> time\n<span class=\"hljs-keyword\">import</span> six\n<span class=\"hljs-keyword\">import</span> math\n<span class=\"hljs-keyword\">import</span> random\n<span class=\"hljs-keyword\">import</span> paddle\n<span class=\"hljs-keyword\">import</span> paddle.fluid <span class=\"hljs-keyword\">as</span> fluid\n<span class=\"hljs-keyword\">import</span> logging\n<span class=\"hljs-keyword\">import</span> xml.etree.ElementTree\n<span class=\"hljs-keyword\">import</span> codecs\n<span class=\"hljs-keyword\">import</span> json\n\n<span class=\"hljs-keyword\">from</span> paddle.fluid.initializer <span class=\"hljs-keyword\">import</span> MSRA\n<span class=\"hljs-keyword\">from</span> paddle.fluid.param_attr <span class=\"hljs-keyword\">import</span> ParamAttr\n<span class=\"hljs-keyword\">from</span> paddle.fluid.regularizer <span class=\"hljs-keyword\">import</span> L2Decay\n<span class=\"hljs-keyword\">from</span> PIL <span class=\"hljs-keyword\">import</span> Image, ImageEnhance, ImageDraw\n\nlogger = <span class=\"hljs-literal\">None</span>  <span class=\"hljs-comment\"># &#x65e5;&#x5fd7;&#x5bf9;&#x8c61;</span>\n\ntrain_params = {\n    <span class=\"hljs-string\">&quot;data_dir&quot;</span>: <span class=\"hljs-string\">&quot;data/data6045&quot;</span>,  <span class=\"hljs-comment\"># &#x6570;&#x636e;&#x76ee;&#x5f55;</span>\n    <span class=\"hljs-string\">&quot;train_list&quot;</span>: <span class=\"hljs-string\">&quot;train.txt&quot;</span>,  <span class=\"hljs-comment\"># &#x8bad;&#x7ec3;&#x96c6;&#x6587;&#x4ef6;</span>\n    <span class=\"hljs-string\">&quot;eval_list&quot;</span>: <span class=\"hljs-string\">&quot;eval.txt&quot;</span>, <span class=\"hljs-comment\"># &#x8bc4;&#x4f30;&#x6570;&#x636e;&#x96c6;</span>\n    <span class=\"hljs-string\">&quot;class_dim&quot;</span>: -<span class=\"hljs-number\">1</span>,\n    <span class=\"hljs-string\">&quot;label_dict&quot;</span>: {},  <span class=\"hljs-comment\"># &#x6807;&#x7b7e;&#x5b57;&#x5178;</span>\n    <span class=\"hljs-string\">&quot;num_dict&quot;</span>: {},\n    <span class=\"hljs-string\">&quot;image_count&quot;</span>: -<span class=\"hljs-number\">1</span>,\n    <span class=\"hljs-string\">&quot;continue_train&quot;</span>: <span class=\"hljs-literal\">True</span>,  <span class=\"hljs-comment\"># &#x662f;&#x5426;&#x52a0;&#x8f7d;&#x524d;&#x4e00;&#x6b21;&#x7684;&#x8bad;&#x7ec3;&#x53c2;&#x6570;&#xff0c;&#x63a5;&#x7740;&#x8bad;&#x7ec3;</span>\n    <span class=\"hljs-string\">&quot;pretrained&quot;</span>: <span class=\"hljs-literal\">False</span>,  <span class=\"hljs-comment\"># &#x662f;&#x5426;&#x9884;&#x8bad;&#x7ec3;</span>\n    <span class=\"hljs-string\">&quot;pretrained_model_dir&quot;</span>: <span class=\"hljs-string\">&quot;./pretrained-model&quot;</span>,\n    <span class=\"hljs-string\">&quot;save_model_dir&quot;</span>: <span class=\"hljs-string\">&quot;./yolo-model&quot;</span>,  <span class=\"hljs-comment\"># &#x589e;&#x91cf;&#x6a21;&#x578b;&#x4fdd;&#x5b58;&#x76ee;&#x5f55;</span>\n    <span class=\"hljs-string\">&quot;model_prefix&quot;</span>: <span class=\"hljs-string\">&quot;yolo-v3&quot;</span>,  <span class=\"hljs-comment\"># &#x6a21;&#x578b;&#x524d;&#x7f00;</span>\n    <span class=\"hljs-string\">&quot;freeze_dir&quot;</span>: <span class=\"hljs-string\">&quot;freeze_model&quot;</span>,  <span class=\"hljs-comment\"># &#x6a21;&#x578b;&#x56fa;&#x5316;&#x76ee;&#x5f55;(&#x771f;&#x6b63;&#x6267;&#x884c;&#x9884;&#x6d4b;&#x7684;&#x6a21;&#x578b;)</span>\n    <span class=\"hljs-string\">&quot;use_tiny&quot;</span>: <span class=\"hljs-literal\">True</span>,  <span class=\"hljs-comment\"># &#x662f;&#x5426;&#x4f7f;&#x7528;&#x7cbe;&#x7b80;&#x7248;YOLO&#x6a21;&#x578b;</span>\n    <span class=\"hljs-string\">&quot;max_box_num&quot;</span>: <span class=\"hljs-number\">20</span>,  <span class=\"hljs-comment\"># &#x4e00;&#x5e45;&#x56fe;&#x4e0a;&#x6700;&#x591a;&#x6709;&#x591a;&#x5c11;&#x4e2a;&#x76ee;&#x6807;</span>\n    <span class=\"hljs-string\">&quot;num_epochs&quot;</span>: <span class=\"hljs-number\">80</span>,  <span class=\"hljs-comment\"># &#x8bad;&#x7ec3;&#x8f6e;&#x6b21;</span>\n    <span class=\"hljs-string\">&quot;train_batch_size&quot;</span>: <span class=\"hljs-number\">32</span>,  <span class=\"hljs-comment\"># &#x5bf9;&#x4e8e;&#x5b8c;&#x6574;yolov3&#xff0c;&#x6bcf;&#x4e00;&#x6279;&#x7684;&#x8bad;&#x7ec3;&#x6837;&#x672c;&#x4e0d;&#x80fd;&#x592a;&#x591a;&#xff0c;&#x5185;&#x5b58;&#x4f1a;&#x70b8;&#x6389;&#xff1b;&#x5982;&#x679c;&#x4f7f;&#x7528;tiny&#xff0c;&#x53ef;&#x4ee5;&#x9002;&#x5f53;&#x5927;&#x4e00;&#x4e9b;</span>\n    <span class=\"hljs-string\">&quot;use_gpu&quot;</span>: <span class=\"hljs-literal\">True</span>,  <span class=\"hljs-comment\"># &#x662f;&#x5426;&#x4f7f;&#x7528;GPU</span>\n    <span class=\"hljs-string\">&quot;yolo_cfg&quot;</span>: {  <span class=\"hljs-comment\"># YOLO&#x6a21;&#x578b;&#x53c2;&#x6570;</span>\n        <span class=\"hljs-string\">&quot;input_size&quot;</span>: [<span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">448</span>, <span class=\"hljs-number\">448</span>],  <span class=\"hljs-comment\"># &#x539f;&#x7248;&#x7684;&#x8fb9;&#x957f;&#x5927;&#x5c0f;&#x4e3a;608&#xff0c;&#x4e3a;&#x4e86;&#x63d0;&#x9ad8;&#x8bad;&#x7ec3;&#x901f;&#x5ea6;&#x548c;&#x9884;&#x6d4b;&#x901f;&#x5ea6;&#xff0c;&#x6b64;&#x5904;&#x538b;&#x7f29;&#x4e3a;448</span>\n        <span class=\"hljs-string\">&quot;anchors&quot;</span>: [<span class=\"hljs-number\">7</span>, <span class=\"hljs-number\">10</span>, <span class=\"hljs-number\">12</span>, <span class=\"hljs-number\">22</span>, <span class=\"hljs-number\">24</span>, <span class=\"hljs-number\">17</span>, <span class=\"hljs-number\">22</span>, <span class=\"hljs-number\">45</span>, <span class=\"hljs-number\">46</span>, <span class=\"hljs-number\">33</span>, <span class=\"hljs-number\">43</span>, <span class=\"hljs-number\">88</span>, <span class=\"hljs-number\">85</span>, <span class=\"hljs-number\">66</span>, <span class=\"hljs-number\">115</span>, <span class=\"hljs-number\">146</span>, <span class=\"hljs-number\">275</span>, <span class=\"hljs-number\">240</span>],  <span class=\"hljs-comment\"># &#x951a;&#x70b9;??</span>\n        <span class=\"hljs-string\">&quot;anchor_mask&quot;</span>: [[<span class=\"hljs-number\">6</span>, <span class=\"hljs-number\">7</span>, <span class=\"hljs-number\">8</span>], [<span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">4</span>, <span class=\"hljs-number\">5</span>], [<span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">2</span>]]\n    },\n    <span class=\"hljs-string\">&quot;yolo_tiny_cfg&quot;</span>: {  <span class=\"hljs-comment\"># YOLO tiny &#x6a21;&#x578b;&#x53c2;&#x6570;</span>\n        <span class=\"hljs-string\">&quot;input_size&quot;</span>: [<span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">256</span>, <span class=\"hljs-number\">256</span>],\n        <span class=\"hljs-string\">&quot;anchors&quot;</span>: [<span class=\"hljs-number\">6</span>, <span class=\"hljs-number\">8</span>, <span class=\"hljs-number\">13</span>, <span class=\"hljs-number\">15</span>, <span class=\"hljs-number\">22</span>, <span class=\"hljs-number\">34</span>, <span class=\"hljs-number\">48</span>, <span class=\"hljs-number\">50</span>, <span class=\"hljs-number\">81</span>, <span class=\"hljs-number\">100</span>, <span class=\"hljs-number\">205</span>, <span class=\"hljs-number\">191</span>],\n        <span class=\"hljs-string\">&quot;anchor_mask&quot;</span>: [[<span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">4</span>, <span class=\"hljs-number\">5</span>], [<span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">2</span>]]\n    },\n    <span class=\"hljs-string\">&quot;ignore_thresh&quot;</span>: <span class=\"hljs-number\">0.7</span>,\n    <span class=\"hljs-string\">&quot;mean_rgb&quot;</span>: [<span class=\"hljs-number\">127.5</span>, <span class=\"hljs-number\">127.5</span>, <span class=\"hljs-number\">127.5</span>], <span class=\"hljs-comment\"># &#x6570;&#x636e;&#x589e;&#x5f3a;&#x4f7f;&#x7528;&#x7684;&#x7070;&#x5ea6;&#x503c;</span>\n    <span class=\"hljs-string\">&quot;mode&quot;</span>: <span class=\"hljs-string\">&quot;train&quot;</span>,\n    <span class=\"hljs-string\">&quot;multi_data_reader_count&quot;</span>: <span class=\"hljs-number\">4</span>,\n    <span class=\"hljs-string\">&quot;apply_distort&quot;</span>: <span class=\"hljs-literal\">True</span>,  <span class=\"hljs-comment\"># &#x662f;&#x5426;&#x505a;&#x56fe;&#x50cf;&#x626d;&#x66f2;&#x589e;&#x5f3a;</span>\n    <span class=\"hljs-string\">&quot;nms_top_k&quot;</span>: <span class=\"hljs-number\">300</span>,\n    <span class=\"hljs-string\">&quot;nms_pos_k&quot;</span>: <span class=\"hljs-number\">300</span>,\n    <span class=\"hljs-string\">&quot;valid_thresh&quot;</span>: <span class=\"hljs-number\">0.01</span>,\n    <span class=\"hljs-string\">&quot;nms_thresh&quot;</span>: <span class=\"hljs-number\">0.45</span>,  <span class=\"hljs-comment\"># &#x975e;&#x6700;&#x5927;&#x503c;&#x6291;&#x5236;&#x9608;&#x503c;</span>\n    <span class=\"hljs-string\">&quot;image_distort_strategy&quot;</span>: {  <span class=\"hljs-comment\"># &#x56fe;&#x50cf;&#x626d;&#x66f2;&#x7b56;&#x7565;</span>\n        <span class=\"hljs-string\">&quot;expand_prob&quot;</span>: <span class=\"hljs-number\">0.5</span>,  <span class=\"hljs-comment\"># &#x6269;&#x5c55;&#x6bd4;&#x7387;</span>\n        <span class=\"hljs-string\">&quot;expand_max_ratio&quot;</span>: <span class=\"hljs-number\">4</span>,\n        <span class=\"hljs-string\">&quot;hue_prob&quot;</span>: <span class=\"hljs-number\">0.5</span>,  <span class=\"hljs-comment\"># &#x8272;&#x8c03;</span>\n        <span class=\"hljs-string\">&quot;hue_delta&quot;</span>: <span class=\"hljs-number\">18</span>,\n        <span class=\"hljs-string\">&quot;contrast_prob&quot;</span>: <span class=\"hljs-number\">0.5</span>,  <span class=\"hljs-comment\"># &#x5bf9;&#x6bd4;&#x5ea6;</span>\n        <span class=\"hljs-string\">&quot;contrast_delta&quot;</span>: <span class=\"hljs-number\">0.5</span>,\n        <span class=\"hljs-string\">&quot;saturation_prob&quot;</span>: <span class=\"hljs-number\">0.5</span>,  <span class=\"hljs-comment\"># &#x9971;&#x548c;&#x5ea6;</span>\n        <span class=\"hljs-string\">&quot;saturation_delta&quot;</span>: <span class=\"hljs-number\">0.5</span>,\n        <span class=\"hljs-string\">&quot;brightness_prob&quot;</span>: <span class=\"hljs-number\">0.5</span>,  <span class=\"hljs-comment\"># &#x4eae;&#x5ea6;</span>\n        <span class=\"hljs-string\">&quot;brightness_delta&quot;</span>: <span class=\"hljs-number\">0.125</span>\n    },\n    <span class=\"hljs-string\">&quot;sgd_strategy&quot;</span>: {  <span class=\"hljs-comment\"># &#x68af;&#x5ea6;&#x4e0b;&#x964d;&#x914d;&#x7f6e;</span>\n        <span class=\"hljs-string\">&quot;learning_rate&quot;</span>: <span class=\"hljs-number\">0.002</span>,\n        <span class=\"hljs-string\">&quot;lr_epochs&quot;</span>: [<span class=\"hljs-number\">30</span>, <span class=\"hljs-number\">50</span>, <span class=\"hljs-number\">65</span>],  <span class=\"hljs-comment\"># &#x5b66;&#x4e60;&#x7387;&#x8870;&#x51cf;&#x5206;&#x6bb5;&#xff08;3&#x4e2a;&#x6570;&#x5b57;&#x5206;&#x4e3a;4&#x6bb5;&#xff09;</span>\n        <span class=\"hljs-string\">&quot;lr_decay&quot;</span>: [<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">0.5</span>, <span class=\"hljs-number\">0.25</span>, <span class=\"hljs-number\">0.1</span>]  <span class=\"hljs-comment\"># &#x6bcf;&#x6bb5;&#x91c7;&#x7528;&#x7684;&#x5b66;&#x4e60;&#x7387;&#xff0c;&#x5bf9;&#x5e94;lr_epochs&#x53c2;&#x6570;4&#x6bb5;</span>\n    },\n    <span class=\"hljs-string\">&quot;early_stop&quot;</span>: {\n        <span class=\"hljs-string\">&quot;sample_frequency&quot;</span>: <span class=\"hljs-number\">50</span>,\n        <span class=\"hljs-string\">&quot;successive_limit&quot;</span>: <span class=\"hljs-number\">3</span>,\n        <span class=\"hljs-string\">&quot;min_loss&quot;</span>: <span class=\"hljs-number\">2.5</span>,\n        <span class=\"hljs-string\">&quot;min_curr_map&quot;</span>: <span class=\"hljs-number\">0.84</span>\n    }\n}\n\n\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">init_train_parameters</span>():\n    <span class=\"hljs-string\">&quot;&quot;&quot;\n    &#x521d;&#x59cb;&#x5316;&#x8bad;&#x7ec3;&#x53c2;&#x6570;&#xff0c;&#x4e3b;&#x8981;&#x662f;&#x521d;&#x59cb;&#x5316;&#x56fe;&#x7247;&#x6570;&#x91cf;&#xff0c;&#x7c7b;&#x522b;&#x6570;\n    :return:\n    &quot;&quot;&quot;</span>\n    file_list = os.path.join(train_params[<span class=\"hljs-string\">&apos;data_dir&apos;</span>], train_params[<span class=\"hljs-string\">&apos;train_list&apos;</span>])  <span class=\"hljs-comment\"># &#x8bad;&#x7ec3;&#x96c6;</span>\n    label_list = os.path.join(train_params[<span class=\"hljs-string\">&apos;data_dir&apos;</span>], <span class=\"hljs-string\">&quot;label_list&quot;</span>)  <span class=\"hljs-comment\"># &#x6807;&#x7b7e;&#x6587;&#x4ef6;</span>\n    index = <span class=\"hljs-number\">0</span>\n\n    <span class=\"hljs-comment\"># codecs&#x662f;&#x4e13;&#x95e8;&#x7528;&#x4f5c;&#x7f16;&#x7801;&#x8f6c;&#x6362;&#x901a;&#x7528;&#x6a21;&#x5757;</span>\n    <span class=\"hljs-keyword\">with</span> codecs.<span class=\"hljs-built_in\">open</span>(label_list, encoding=<span class=\"hljs-string\">&apos;utf-8&apos;</span>) <span class=\"hljs-keyword\">as</span> flist:\n        lines = [line.strip() <span class=\"hljs-keyword\">for</span> line <span class=\"hljs-keyword\">in</span> flist]\n        <span class=\"hljs-keyword\">for</span> line <span class=\"hljs-keyword\">in</span> lines:\n            train_params[<span class=\"hljs-string\">&apos;num_dict&apos;</span>][index] = line.strip()\n            train_params[<span class=\"hljs-string\">&apos;label_dict&apos;</span>][line.strip()] = index\n            index += <span class=\"hljs-number\">1</span>\n        train_params[<span class=\"hljs-string\">&apos;class_dim&apos;</span>] = index\n\n    <span class=\"hljs-keyword\">with</span> codecs.<span class=\"hljs-built_in\">open</span>(file_list, encoding=<span class=\"hljs-string\">&apos;utf-8&apos;</span>) <span class=\"hljs-keyword\">as</span> flist:\n        lines = [line.strip() <span class=\"hljs-keyword\">for</span> line <span class=\"hljs-keyword\">in</span> flist]\n        train_params[<span class=\"hljs-string\">&apos;image_count&apos;</span>] = <span class=\"hljs-built_in\">len</span>(lines)  <span class=\"hljs-comment\"># &#x56fe;&#x7247;&#x6570;&#x91cf;</span>\n\n\n<span class=\"hljs-comment\"># &#x65e5;&#x5fd7;&#x76f8;&#x5173;&#x914d;&#x7f6e;</span>\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">init_log_config</span>():  <span class=\"hljs-comment\"># &#x521d;&#x59cb;&#x5316;&#x65e5;&#x5fd7;&#x76f8;&#x5173;&#x914d;&#x7f6e;</span>\n    <span class=\"hljs-keyword\">global</span> logger\n\n    logger = logging.getLogger()  <span class=\"hljs-comment\"># &#x521b;&#x5efa;&#x65e5;&#x5fd7;&#x5bf9;&#x8c61;</span>\n    logger.setLevel(logging.INFO)  <span class=\"hljs-comment\"># &#x8bbe;&#x7f6e;&#x65e5;&#x5fd7;&#x7ea7;&#x522b;</span>\n    log_path = os.path.join(os.getcwd(), <span class=\"hljs-string\">&apos;logs&apos;</span>)\n\n    <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">not</span> os.path.exists(log_path):  <span class=\"hljs-comment\"># &#x521b;&#x5efa;&#x65e5;&#x5fd7;&#x8def;&#x5f84;</span>\n        os.makedirs(log_path)\n\n    log_name = os.path.join(log_path, <span class=\"hljs-string\">&apos;train.log&apos;</span>)  <span class=\"hljs-comment\"># &#x8bad;&#x7ec3;&#x65e5;&#x5fd7;&#x6587;&#x4ef6;</span>\n    fh = logging.FileHandler(log_name, mode=<span class=\"hljs-string\">&apos;w&apos;</span>)  <span class=\"hljs-comment\"># &#x6253;&#x5f00;&#x6587;&#x4ef6;&#x53e5;&#x67c4;</span>\n    fh.setLevel(logging.DEBUG)  <span class=\"hljs-comment\"># &#x8bbe;&#x7f6e;&#x7ea7;&#x522b;</span>\n\n    formatter = logging.Formatter(<span class=\"hljs-string\">&quot;%(asctime)s - %(filename)s[line:%(lineno)d] - %(levelname)s: %(message)s&quot;</span>)\n    fh.setFormatter(formatter)\n    logger.addHandler(fh)\n\n\ninit_log_config()\n\n\n<span class=\"hljs-comment\"># &#x5b9a;&#x4e49;YOLO3&#x7f51;&#x7edc;&#x7ed3;&#x6784;&#xff1a;darknet-53</span>\n<span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">YOLOv3</span>(<span class=\"hljs-title class_ inherited__\">object</span>):\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">__init__</span>(<span class=\"hljs-params\">self, class_num, anchors, anchor_mask</span>):\n        <span class=\"hljs-variable language_\">self</span>.outputs = []  <span class=\"hljs-comment\"># &#x7f51;&#x7edc;&#x6700;&#x7ec8;&#x6a21;&#x578b;</span>\n        <span class=\"hljs-variable language_\">self</span>.downsample_ratio = <span class=\"hljs-number\">1</span>  <span class=\"hljs-comment\"># &#x4e0b;&#x91c7;&#x6837;&#x7387;</span>\n        <span class=\"hljs-variable language_\">self</span>.anchor_mask = anchor_mask  <span class=\"hljs-comment\"># &#x8ba1;&#x7b97;&#x5377;&#x79ef;&#x6838;&#xff1f;&#xff1f;&#xff1f;</span>\n        <span class=\"hljs-variable language_\">self</span>.anchors = anchors  <span class=\"hljs-comment\"># &#x951a;&#x70b9;</span>\n        <span class=\"hljs-variable language_\">self</span>.class_num = class_num  <span class=\"hljs-comment\"># &#x7c7b;&#x522b;&#x6570;&#x91cf;</span>\n\n        <span class=\"hljs-variable language_\">self</span>.yolo_anchors = []\n        <span class=\"hljs-variable language_\">self</span>.yolo_classes = []\n\n        <span class=\"hljs-keyword\">for</span> mask_pair <span class=\"hljs-keyword\">in</span> <span class=\"hljs-variable language_\">self</span>.anchor_mask:\n            mask_anchors = []\n            <span class=\"hljs-keyword\">for</span> mask <span class=\"hljs-keyword\">in</span> mask_pair:\n                mask_anchors.append(<span class=\"hljs-variable language_\">self</span>.anchors[<span class=\"hljs-number\">2</span> * mask])\n                mask_anchors.append(<span class=\"hljs-variable language_\">self</span>.anchors[<span class=\"hljs-number\">2</span> * mask + <span class=\"hljs-number\">1</span>])\n            <span class=\"hljs-variable language_\">self</span>.yolo_anchors.append(mask_anchors)\n            <span class=\"hljs-variable language_\">self</span>.yolo_classes.append(class_num)\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">name</span>(<span class=\"hljs-params\">self</span>):\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">&apos;YOLOv3&apos;</span>\n\n    <span class=\"hljs-comment\"># &#x83b7;&#x53d6;anchors</span>\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">get_anchors</span>(<span class=\"hljs-params\">self</span>):\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-variable language_\">self</span>.anchors\n\n    <span class=\"hljs-comment\"># &#x83b7;&#x53d6;anchor_mask</span>\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">get_anchor_mask</span>(<span class=\"hljs-params\">self</span>):\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-variable language_\">self</span>.anchor_mask\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">get_class_num</span>(<span class=\"hljs-params\">self</span>):\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-variable language_\">self</span>.class_num\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">get_downsample_ratio</span>(<span class=\"hljs-params\">self</span>):\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-variable language_\">self</span>.downsample_ratio\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">get_yolo_anchors</span>(<span class=\"hljs-params\">self</span>):\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-variable language_\">self</span>.yolo_anchors\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">get_yolo_classes</span>(<span class=\"hljs-params\">self</span>):\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-variable language_\">self</span>.yolo_classes\n\n    <span class=\"hljs-comment\"># &#x5377;&#x79ef;/&#x6279;&#x91cf;&#x6b63;&#x5219;&#x5316;&#x51fd;&#x6570;: &#x5377;&#x79ef;&#x3001;&#x6279;&#x91cf;&#x6b63;&#x5219;&#x5316;&#x5904;&#x7406;&#x3001;leakrelu</span>\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">conv_bn</span>(<span class=\"hljs-params\">self,\n                <span class=\"hljs-built_in\">input</span>,  <span class=\"hljs-comment\"># &#x8f93;&#x5165;</span>\n                num_filters,  <span class=\"hljs-comment\"># &#x5377;&#x79ef;&#x6838;&#x6570;&#x91cf;</span>\n                filter_size,  <span class=\"hljs-comment\"># &#x5377;&#x79ef;&#x6838;&#x5927;&#x5c0f;</span>\n                stride,  <span class=\"hljs-comment\"># &#x6b65;&#x5e45;</span>\n                padding,  <span class=\"hljs-comment\"># &#x586b;&#x5145;</span>\n                use_cudnn=<span class=\"hljs-literal\">True</span></span>):\n        <span class=\"hljs-comment\"># 2d&#x5377;&#x79ef;&#x64cd;&#x4f5c;</span>\n        conv = fluid.layers.conv2d(<span class=\"hljs-built_in\">input</span>=<span class=\"hljs-built_in\">input</span>,\n                                   num_filters=num_filters,\n                                   filter_size=filter_size,\n                                   stride=stride,\n                                   padding=padding,\n                                   act=<span class=\"hljs-literal\">None</span>,\n                                   use_cudnn=use_cudnn,  <span class=\"hljs-comment\"># &#x662f;&#x5426;&#x4f7f;&#x7528;cudnn&#xff0c;cudnn&#x5229;&#x7528;cuda&#x8fdb;&#x884c;&#x4e86;&#x52a0;&#x901f;&#x5904;&#x7406;</span>\n                                   param_attr=ParamAttr(initializer=fluid.initializer.Normal(<span class=\"hljs-number\">0.</span>, <span class=\"hljs-number\">0.02</span>)),\n                                   bias_attr=<span class=\"hljs-literal\">False</span>)\n\n        <span class=\"hljs-comment\"># batch_norm&#x4e2d;&#x7684;&#x53c2;&#x6570;&#x4e0d;&#x9700;&#x8981;&#x53c2;&#x4e0e;&#x6b63;&#x5219;&#x5316;&#xff0c;&#x6240;&#x4ee5;&#x4e3b;&#x52a8;&#x4f7f;&#x7528;&#x6b63;&#x5219;&#x7cfb;&#x6570;&#x4e3a;0&#x7684;&#x6b63;&#x5219;&#x9879;&#x5c4f;&#x853d;&#x6389;</span>\n        <span class=\"hljs-comment\"># &#x5728;batch_norm&#x4e2d;&#x4f7f;&#x7528;leaky&#x7684;&#x8bdd;&#xff0c;&#x53ea;&#x80fd;&#x4f7f;&#x7528;&#x9ed8;&#x8ba4;&#x7684;alpha=0.02&#xff1b;&#x5982;&#x679c;&#x9700;&#x8981;&#x8bbe;&#x503c;&#xff0c;&#x5fc5;&#x987b;&#x63d0;&#x51fa;&#x53bb;&#x5355;&#x72ec;&#x6765;</span>\n        <span class=\"hljs-comment\"># &#x6b63;&#x5219;&#x5316;&#x7684;&#x76ee;&#x7684;&#xff0c;&#x662f;&#x4e3a;&#x4e86;&#x9632;&#x6b62;&#x8fc7;&#x62df;&#x5408;&#xff0c;&#x8f83;&#x5c0f;&#x7684;L2&#x503c;&#x80fd;&#x9632;&#x6b62;&#x8fc7;&#x62df;&#x5408;</span>\n        param_attr = ParamAttr(initializer=fluid.initializer.Normal(<span class=\"hljs-number\">0.</span>, <span class=\"hljs-number\">0.02</span>),\n                               regularizer=L2Decay(<span class=\"hljs-number\">0.</span>))\n        bias_attr = ParamAttr(initializer=fluid.initializer.Constant(<span class=\"hljs-number\">0.0</span>),\n                              regularizer=L2Decay(<span class=\"hljs-number\">0.</span>))\n        out = fluid.layers.batch_norm(<span class=\"hljs-built_in\">input</span>=conv, act=<span class=\"hljs-literal\">None</span>,\n                                      param_attr=param_attr,\n                                      bias_attr=bias_attr)\n\n        <span class=\"hljs-comment\"># leaky_relu: Leaky ReLU&#x662f;&#x7ed9;&#x6240;&#x6709;&#x8d1f;&#x503c;&#x8d4b;&#x4e88;&#x4e00;&#x4e2a;&#x975e;&#x96f6;&#x659c;&#x7387;</span>\n        out = fluid.layers.leaky_relu(out, <span class=\"hljs-number\">0.1</span>)\n        <span class=\"hljs-keyword\">return</span> out\n\n    <span class=\"hljs-comment\"># &#x901a;&#x8fc7;&#x5377;&#x79ef;&#x5b9e;&#x73b0;&#x964d;&#x91c7;&#x6837;</span>\n    <span class=\"hljs-comment\"># &#x5982;&#xff1a;&#x539f;&#x59cb;&#x56fe;&#x7247;&#x5927;&#x5c0f;448*448&#xff0c;&#x964d;&#x91c7;&#x6837;&#x540e;&#x5927;&#x5c0f;&#x4e3a; ((448+2)-3)/2 + 1 = 224</span>\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">down_sample</span>(<span class=\"hljs-params\">self, <span class=\"hljs-built_in\">input</span>, num_filters, filter_size=<span class=\"hljs-number\">3</span>, stride=<span class=\"hljs-number\">2</span>, padding=<span class=\"hljs-number\">1</span></span>):\n        <span class=\"hljs-variable language_\">self</span>.downsample_ratio *= <span class=\"hljs-number\">2</span>  <span class=\"hljs-comment\"># &#x964d;&#x91c7;&#x6837;&#x7387;</span>\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-variable language_\">self</span>.conv_bn(<span class=\"hljs-built_in\">input</span>,\n                            num_filters=num_filters,\n                            filter_size=filter_size,\n                            stride=stride,\n                            padding=padding)\n\n    <span class=\"hljs-comment\"># &#x57fa;&#x672c;&#x5757;&#xff1a;&#x5305;&#x542b;&#x4e24;&#x4e2a;&#x5377;&#x79ef;/&#x6b63;&#x5219;&#x5316;&#x5c42;&#xff0c;&#x4e00;&#x4e2a;&#x6b8b;&#x5dee;&#x5757;</span>\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">basic_block</span>(<span class=\"hljs-params\">self, <span class=\"hljs-built_in\">input</span>, num_filters</span>):\n        conv1 = <span class=\"hljs-variable language_\">self</span>.conv_bn(<span class=\"hljs-built_in\">input</span>, num_filters, filter_size=<span class=\"hljs-number\">1</span>, stride=<span class=\"hljs-number\">1</span>, padding=<span class=\"hljs-number\">0</span>)\n        conv2 = <span class=\"hljs-variable language_\">self</span>.conv_bn(conv1, num_filters * <span class=\"hljs-number\">2</span>, filter_size=<span class=\"hljs-number\">3</span>, stride=<span class=\"hljs-number\">1</span>, padding=<span class=\"hljs-number\">1</span>)\n        out = fluid.layers.elementwise_add(x=<span class=\"hljs-built_in\">input</span>, y=conv2, act=<span class=\"hljs-literal\">None</span>)  <span class=\"hljs-comment\"># &#x8ba1;&#x7b97;H(x)=F(x)+x</span>\n        <span class=\"hljs-keyword\">return</span> out\n\n    <span class=\"hljs-comment\"># &#x521b;&#x5efa;&#x591a;&#x4e2a;basic_block</span>\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">layer_warp</span>(<span class=\"hljs-params\">self, <span class=\"hljs-built_in\">input</span>, num_filters, count</span>):\n        res_out = <span class=\"hljs-variable language_\">self</span>.basic_block(<span class=\"hljs-built_in\">input</span>, num_filters)\n\n        <span class=\"hljs-keyword\">for</span> j <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(<span class=\"hljs-number\">1</span>, count):\n            res_out = <span class=\"hljs-variable language_\">self</span>.basic_block(res_out, num_filters)\n\n        <span class=\"hljs-keyword\">return</span> res_out\n\n    <span class=\"hljs-comment\"># &#x4e0a;&#x91c7;&#x6837;</span>\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">up_sample</span>(<span class=\"hljs-params\">self, <span class=\"hljs-built_in\">input</span>, scale=<span class=\"hljs-number\">2</span></span>):\n        <span class=\"hljs-comment\"># get dynamic upsample output shape</span>\n        shape_nchw = fluid.layers.shape(<span class=\"hljs-built_in\">input</span>)  <span class=\"hljs-comment\"># &#x83b7;&#x53d6;input&#x7684;&#x5f62;&#x72b6;</span>\n        shape_hw = fluid.layers.<span class=\"hljs-built_in\">slice</span>(shape_nchw, axes=[<span class=\"hljs-number\">0</span>], starts=[<span class=\"hljs-number\">2</span>], ends=[<span class=\"hljs-number\">4</span>])\n        shape_hw.stop_gradient = <span class=\"hljs-literal\">True</span>\n        in_shape = fluid.layers.cast(shape_hw, dtype=<span class=\"hljs-string\">&apos;int32&apos;</span>)\n        out_shape = in_shape * scale  <span class=\"hljs-comment\"># &#x8ba1;&#x7b97;&#x8f93;&#x51fa;&#x6570;&#x636e;&#x5f62;&#x72b6;</span>\n        out_shape.stop_gradient = <span class=\"hljs-literal\">True</span>\n\n        <span class=\"hljs-comment\"># reisze by actual_shape</span>\n        <span class=\"hljs-comment\"># &#x77e9;&#x9635;&#x653e;&#x5927;(&#x6700;&#x90bb;&#x63d2;&#x503c;&#x6cd5;)</span>\n        out = fluid.layers.resize_nearest(<span class=\"hljs-built_in\">input</span>=<span class=\"hljs-built_in\">input</span>,\n                                          scale=scale,\n                                          actual_shape=out_shape)\n        <span class=\"hljs-keyword\">return</span> out\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">yolo_detection_block</span>(<span class=\"hljs-params\">self, <span class=\"hljs-built_in\">input</span>, num_filters</span>):\n        <span class=\"hljs-keyword\">assert</span> num_filters % <span class=\"hljs-number\">2</span> == <span class=\"hljs-number\">0</span>, <span class=\"hljs-string\">&quot;num_filters {} cannot be divided by 2&quot;</span>.<span class=\"hljs-built_in\">format</span>(num_filters)\n\n        conv = <span class=\"hljs-built_in\">input</span>\n        <span class=\"hljs-keyword\">for</span> j <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(<span class=\"hljs-number\">2</span>):\n            conv = <span class=\"hljs-variable language_\">self</span>.conv_bn(conv, num_filters, filter_size=<span class=\"hljs-number\">1</span>, stride=<span class=\"hljs-number\">1</span>, padding=<span class=\"hljs-number\">0</span>)\n            conv = <span class=\"hljs-variable language_\">self</span>.conv_bn(conv, num_filters * <span class=\"hljs-number\">2</span>, filter_size=<span class=\"hljs-number\">3</span>, stride=<span class=\"hljs-number\">1</span>, padding=<span class=\"hljs-number\">1</span>)\n        route = <span class=\"hljs-variable language_\">self</span>.conv_bn(conv, num_filters, filter_size=<span class=\"hljs-number\">1</span>, stride=<span class=\"hljs-number\">1</span>, padding=<span class=\"hljs-number\">0</span>)\n        tip = <span class=\"hljs-variable language_\">self</span>.conv_bn(route, num_filters * <span class=\"hljs-number\">2</span>, filter_size=<span class=\"hljs-number\">3</span>, stride=<span class=\"hljs-number\">1</span>, padding=<span class=\"hljs-number\">1</span>)\n        <span class=\"hljs-keyword\">return</span> route, tip\n\n    <span class=\"hljs-comment\"># &#x642d;&#x5efa;&#x7f51;&#x7edc;&#x6a21;&#x578b; darknet-53</span>\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">net</span>(<span class=\"hljs-params\">self, img</span>):\n        stages = [<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">8</span>, <span class=\"hljs-number\">8</span>, <span class=\"hljs-number\">4</span>]\n        <span class=\"hljs-keyword\">assert</span> <span class=\"hljs-built_in\">len</span>(<span class=\"hljs-variable language_\">self</span>.anchor_mask) &lt;= <span class=\"hljs-built_in\">len</span>(stages), <span class=\"hljs-string\">&quot;anchor masks can&apos;t bigger than down_sample times&quot;</span>\n        <span class=\"hljs-comment\"># &#x7b2c;&#x4e00;&#x4e2a;&#x5377;&#x79ef;&#x5c42;: 256*256</span>\n        conv1 = <span class=\"hljs-variable language_\">self</span>.conv_bn(img, num_filters=<span class=\"hljs-number\">32</span>, filter_size=<span class=\"hljs-number\">3</span>, stride=<span class=\"hljs-number\">1</span>, padding=<span class=\"hljs-number\">1</span>)\n        <span class=\"hljs-comment\"># &#x7b2c;&#x4e8c;&#x4e2a;&#x5377;&#x79ef;&#x5c42;&#xff1a;128*128</span>\n        downsample_ = <span class=\"hljs-variable language_\">self</span>.down_sample(conv1, conv1.shape[<span class=\"hljs-number\">1</span>] * <span class=\"hljs-number\">2</span>)  <span class=\"hljs-comment\"># &#x7b2c;&#x4e8c;&#x4e2a;&#x53c2;&#x6570;&#x4e3a;&#x5377;&#x79ef;&#x6838;&#x6570;&#x91cf;</span>\n        blocks = []\n\n        <span class=\"hljs-comment\"># &#x5faa;&#x73af;&#x521b;&#x5efa;basic_block&#x7ec4;</span>\n        <span class=\"hljs-keyword\">for</span> i, stage_count <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">enumerate</span>(stages):\n            block = <span class=\"hljs-variable language_\">self</span>.layer_warp(downsample_,  <span class=\"hljs-comment\"># &#x8f93;&#x5165;&#x6570;&#x636e;</span>\n                                    <span class=\"hljs-number\">32</span> * (<span class=\"hljs-number\">2</span> ** i),  <span class=\"hljs-comment\"># &#x5377;&#x79ef;&#x6838;&#x6570;&#x91cf;</span>\n                                    stage_count)  <span class=\"hljs-comment\"># &#x57fa;&#x672c;&#x5757;&#x6570;&#x91cf;</span>\n            blocks.append(block)\n            <span class=\"hljs-keyword\">if</span> i &lt; <span class=\"hljs-built_in\">len</span>(stages) - <span class=\"hljs-number\">1</span>:  <span class=\"hljs-comment\"># &#x5982;&#x679c;&#x4e0d;&#x662f;&#x6700;&#x540e;&#x4e00;&#x7ec4;&#xff0c;&#x505a;&#x964d;&#x91c7;&#x6837;</span>\n                downsample_ = <span class=\"hljs-variable language_\">self</span>.down_sample(block, block.shape[<span class=\"hljs-number\">1</span>] * <span class=\"hljs-number\">2</span>)\n        blocks = blocks[-<span class=\"hljs-number\">1</span>:-<span class=\"hljs-number\">4</span>:-<span class=\"hljs-number\">1</span>]  <span class=\"hljs-comment\"># &#x53d6;&#x5012;&#x6570;&#x4e09;&#x5c42;&#xff0c;&#x5e76;&#x4e14;&#x9006;&#x5e8f;&#xff0c;&#x540e;&#x9762;&#x8de8;&#x5c42;&#x7ea7;&#x8054;&#x9700;&#x8981;</span>\n\n        <span class=\"hljs-comment\"># yolo detector</span>\n        <span class=\"hljs-keyword\">for</span> i, block <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">enumerate</span>(blocks):\n            <span class=\"hljs-comment\"># yolo&#x4e2d;&#x8de8;&#x89c6;&#x57df;&#x94fe;&#x63a5;</span>\n            <span class=\"hljs-keyword\">if</span> i &gt; <span class=\"hljs-number\">0</span>:\n                block = fluid.layers.concat(<span class=\"hljs-built_in\">input</span>=[route, block], axis=<span class=\"hljs-number\">1</span>)  <span class=\"hljs-comment\"># &#x8fde;&#x63a5;route&#x548c;block&#xff0c;&#x6309;&#x884c;</span>\n\n            route, tip = <span class=\"hljs-variable language_\">self</span>.yolo_detection_block(block,  <span class=\"hljs-comment\"># &#x8f93;&#x5165;</span>\n                                                   num_filters=<span class=\"hljs-number\">512</span> // (<span class=\"hljs-number\">2</span> ** i))  <span class=\"hljs-comment\"># &#x5377;&#x79ef;&#x6838;&#x6570;&#x91cf;</span>\n\n            param_attr = ParamAttr(initializer=fluid.initializer.Normal(<span class=\"hljs-number\">0.</span>, <span class=\"hljs-number\">0.02</span>))\n            bias_attr = ParamAttr(initializer=fluid.initializer.Constant(<span class=\"hljs-number\">0.0</span>), regularizer=L2Decay(<span class=\"hljs-number\">0.</span>))\n            block_out = fluid.layers.conv2d(<span class=\"hljs-built_in\">input</span>=tip,\n                                            <span class=\"hljs-comment\"># 5 elements represent x|y|h|w|score</span>\n                                            num_filters=<span class=\"hljs-built_in\">len</span>(<span class=\"hljs-variable language_\">self</span>.anchor_mask[i]) * (<span class=\"hljs-variable language_\">self</span>.class_num + <span class=\"hljs-number\">5</span>),\n                                            filter_size=<span class=\"hljs-number\">1</span>,\n                                            stride=<span class=\"hljs-number\">1</span>,\n                                            padding=<span class=\"hljs-number\">0</span>,\n                                            act=<span class=\"hljs-literal\">None</span>,\n                                            param_attr=param_attr,\n                                            bias_attr=bias_attr)\n            <span class=\"hljs-variable language_\">self</span>.outputs.append(block_out)\n\n            <span class=\"hljs-comment\"># &#x4e3a;&#x4e86;&#x8de8;&#x89c6;&#x57df;&#x94fe;&#x63a5;&#xff0c;&#x5dee;&#x503c;&#x65b9;&#x5f0f;&#x63d0;&#x5347;&#x7279;&#x5f81;&#x56fe;&#x5c3a;&#x5bf8;</span>\n            <span class=\"hljs-keyword\">if</span> i &lt; <span class=\"hljs-built_in\">len</span>(blocks) - <span class=\"hljs-number\">1</span>:\n                route = <span class=\"hljs-variable language_\">self</span>.conv_bn(route, <span class=\"hljs-number\">256</span> // (<span class=\"hljs-number\">2</span> ** i), filter_size=<span class=\"hljs-number\">1</span>, stride=<span class=\"hljs-number\">1</span>, padding=<span class=\"hljs-number\">0</span>)\n                route = <span class=\"hljs-variable language_\">self</span>.up_sample(route)  <span class=\"hljs-comment\"># &#x4e0a;&#x91c7;&#x6837;</span>\n\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-variable language_\">self</span>.outputs\n\n\n<span class=\"hljs-comment\"># Tiny(&#x7cbe;&#x7b80;&#x7248;)YOLO&#x6a21;&#x578b;</span>\n<span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">YOLOv3Tiny</span>(<span class=\"hljs-title class_ inherited__\">object</span>):\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">__init__</span>(<span class=\"hljs-params\">self, class_num, anchors, anchor_mask</span>):\n        <span class=\"hljs-variable language_\">self</span>.outputs = []\n        <span class=\"hljs-variable language_\">self</span>.downsample_ratio = <span class=\"hljs-number\">1</span>\n        <span class=\"hljs-variable language_\">self</span>.anchor_mask = anchor_mask\n        <span class=\"hljs-variable language_\">self</span>.anchors = anchors\n        <span class=\"hljs-variable language_\">self</span>.class_num = class_num\n\n        <span class=\"hljs-variable language_\">self</span>.yolo_anchors = []\n        <span class=\"hljs-variable language_\">self</span>.yolo_classes = []\n        <span class=\"hljs-keyword\">for</span> mask_pair <span class=\"hljs-keyword\">in</span> <span class=\"hljs-variable language_\">self</span>.anchor_mask:\n            mask_anchors = []\n            <span class=\"hljs-keyword\">for</span> mask <span class=\"hljs-keyword\">in</span> mask_pair:\n                mask_anchors.append(<span class=\"hljs-variable language_\">self</span>.anchors[<span class=\"hljs-number\">2</span> * mask])\n                mask_anchors.append(<span class=\"hljs-variable language_\">self</span>.anchors[<span class=\"hljs-number\">2</span> * mask + <span class=\"hljs-number\">1</span>])\n            <span class=\"hljs-variable language_\">self</span>.yolo_anchors.append(mask_anchors)\n            <span class=\"hljs-variable language_\">self</span>.yolo_classes.append(class_num)\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">name</span>(<span class=\"hljs-params\">self</span>):\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">&apos;YOLOv3-tiny&apos;</span>\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">get_anchors</span>(<span class=\"hljs-params\">self</span>):\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-variable language_\">self</span>.anchors\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">get_anchor_mask</span>(<span class=\"hljs-params\">self</span>):\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-variable language_\">self</span>.anchor_mask\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">get_class_num</span>(<span class=\"hljs-params\">self</span>):\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-variable language_\">self</span>.class_num\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">get_downsample_ratio</span>(<span class=\"hljs-params\">self</span>):\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-variable language_\">self</span>.downsample_ratio\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">get_yolo_anchors</span>(<span class=\"hljs-params\">self</span>):\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-variable language_\">self</span>.yolo_anchors\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">get_yolo_classes</span>(<span class=\"hljs-params\">self</span>):\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-variable language_\">self</span>.yolo_classes\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">conv_bn</span>(<span class=\"hljs-params\">self,\n                <span class=\"hljs-built_in\">input</span>,\n                num_filters,\n                filter_size,\n                stride,\n                padding,\n                num_groups=<span class=\"hljs-number\">1</span>,\n                use_cudnn=<span class=\"hljs-literal\">True</span></span>):\n        conv = fluid.layers.conv2d(\n            <span class=\"hljs-built_in\">input</span>=<span class=\"hljs-built_in\">input</span>,\n            num_filters=num_filters,\n            filter_size=filter_size,\n            stride=stride,\n            padding=padding,\n            act=<span class=\"hljs-literal\">None</span>,\n            groups=num_groups,\n            use_cudnn=use_cudnn,\n            param_attr=ParamAttr(initializer=fluid.initializer.Normal(<span class=\"hljs-number\">0.</span>, <span class=\"hljs-number\">0.02</span>)),\n            bias_attr=<span class=\"hljs-literal\">False</span>)\n\n        <span class=\"hljs-comment\"># batch_norm&#x4e2d;&#x7684;&#x53c2;&#x6570;&#x4e0d;&#x9700;&#x8981;&#x53c2;&#x4e0e;&#x6b63;&#x5219;&#x5316;&#xff0c;&#x6240;&#x4ee5;&#x4e3b;&#x52a8;&#x4f7f;&#x7528;&#x6b63;&#x5219;&#x7cfb;&#x6570;&#x4e3a;0&#x7684;&#x6b63;&#x5219;&#x9879;&#x5c4f;&#x853d;&#x6389;</span>\n        out = fluid.layers.batch_norm(\n            <span class=\"hljs-built_in\">input</span>=conv, act=<span class=\"hljs-string\">&apos;relu&apos;</span>,\n            param_attr=ParamAttr(initializer=fluid.initializer.Normal(<span class=\"hljs-number\">0.</span>, <span class=\"hljs-number\">0.02</span>), regularizer=L2Decay(<span class=\"hljs-number\">0.</span>)),\n            bias_attr=ParamAttr(initializer=fluid.initializer.Constant(<span class=\"hljs-number\">0.0</span>), regularizer=L2Decay(<span class=\"hljs-number\">0.</span>)))\n\n        <span class=\"hljs-keyword\">return</span> out\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">depthwise_conv_bn</span>(<span class=\"hljs-params\">self, <span class=\"hljs-built_in\">input</span>, filter_size=<span class=\"hljs-number\">3</span>, stride=<span class=\"hljs-number\">1</span>, padding=<span class=\"hljs-number\">1</span></span>):\n        num_filters = <span class=\"hljs-built_in\">input</span>.shape[<span class=\"hljs-number\">1</span>]\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-variable language_\">self</span>.conv_bn(<span class=\"hljs-built_in\">input</span>,\n                            num_filters=num_filters,\n                            filter_size=filter_size,\n                            stride=stride,\n                            padding=padding,\n                            num_groups=num_filters)\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">down_sample</span>(<span class=\"hljs-params\">self, <span class=\"hljs-built_in\">input</span>, pool_size=<span class=\"hljs-number\">2</span>, pool_stride=<span class=\"hljs-number\">2</span></span>):\n        <span class=\"hljs-variable language_\">self</span>.downsample_ratio *= <span class=\"hljs-number\">2</span>\n        <span class=\"hljs-keyword\">return</span> fluid.layers.pool2d(<span class=\"hljs-built_in\">input</span>=<span class=\"hljs-built_in\">input</span>, pool_type=<span class=\"hljs-string\">&apos;max&apos;</span>, pool_size=pool_size,\n                                   pool_stride=pool_stride)\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">basic_block</span>(<span class=\"hljs-params\">self, <span class=\"hljs-built_in\">input</span>, num_filters</span>):\n        conv1 = <span class=\"hljs-variable language_\">self</span>.conv_bn(<span class=\"hljs-built_in\">input</span>, num_filters, filter_size=<span class=\"hljs-number\">3</span>, stride=<span class=\"hljs-number\">1</span>, padding=<span class=\"hljs-number\">1</span>)\n        out = <span class=\"hljs-variable language_\">self</span>.down_sample(conv1)\n        <span class=\"hljs-keyword\">return</span> out\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">up_sample</span>(<span class=\"hljs-params\">self, <span class=\"hljs-built_in\">input</span>, scale=<span class=\"hljs-number\">2</span></span>):\n        <span class=\"hljs-comment\"># get dynamic upsample output shape</span>\n        shape_nchw = fluid.layers.shape(<span class=\"hljs-built_in\">input</span>)\n        shape_hw = fluid.layers.<span class=\"hljs-built_in\">slice</span>(shape_nchw, axes=[<span class=\"hljs-number\">0</span>], starts=[<span class=\"hljs-number\">2</span>], ends=[<span class=\"hljs-number\">4</span>])\n        shape_hw.stop_gradient = <span class=\"hljs-literal\">True</span>\n        in_shape = fluid.layers.cast(shape_hw, dtype=<span class=\"hljs-string\">&apos;int32&apos;</span>)\n        out_shape = in_shape * scale\n        out_shape.stop_gradient = <span class=\"hljs-literal\">True</span>\n\n        <span class=\"hljs-comment\"># reisze by actual_shape</span>\n        out = fluid.layers.resize_nearest(\n            <span class=\"hljs-built_in\">input</span>=<span class=\"hljs-built_in\">input</span>,\n            scale=scale,\n            actual_shape=out_shape)\n        <span class=\"hljs-keyword\">return</span> out\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">yolo_detection_block</span>(<span class=\"hljs-params\">self, <span class=\"hljs-built_in\">input</span>, num_filters</span>):\n        route = <span class=\"hljs-variable language_\">self</span>.conv_bn(<span class=\"hljs-built_in\">input</span>, num_filters, filter_size=<span class=\"hljs-number\">1</span>, stride=<span class=\"hljs-number\">1</span>, padding=<span class=\"hljs-number\">0</span>)\n        tip = <span class=\"hljs-variable language_\">self</span>.conv_bn(route, num_filters * <span class=\"hljs-number\">2</span>, filter_size=<span class=\"hljs-number\">3</span>, stride=<span class=\"hljs-number\">1</span>, padding=<span class=\"hljs-number\">1</span>)\n        <span class=\"hljs-keyword\">return</span> route, tip\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">net</span>(<span class=\"hljs-params\">self, img</span>):\n        <span class=\"hljs-comment\"># darknet-tiny</span>\n        stages = [<span class=\"hljs-number\">16</span>, <span class=\"hljs-number\">32</span>, <span class=\"hljs-number\">64</span>, <span class=\"hljs-number\">128</span>, <span class=\"hljs-number\">256</span>, <span class=\"hljs-number\">512</span>]\n        <span class=\"hljs-keyword\">assert</span> <span class=\"hljs-built_in\">len</span>(<span class=\"hljs-variable language_\">self</span>.anchor_mask) &lt;= <span class=\"hljs-built_in\">len</span>(stages), <span class=\"hljs-string\">&quot;anchor masks can&apos;t bigger than down_sample times&quot;</span>\n        <span class=\"hljs-comment\"># 256x256</span>\n        tmp = img\n        blocks = []\n        <span class=\"hljs-keyword\">for</span> i, stage_count <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">enumerate</span>(stages):\n            <span class=\"hljs-keyword\">if</span> i == <span class=\"hljs-built_in\">len</span>(stages) - <span class=\"hljs-number\">1</span>:\n                block = <span class=\"hljs-variable language_\">self</span>.conv_bn(tmp, stage_count, filter_size=<span class=\"hljs-number\">3</span>, stride=<span class=\"hljs-number\">1</span>, padding=<span class=\"hljs-number\">1</span>)\n                blocks.append(block)\n                block = <span class=\"hljs-variable language_\">self</span>.depthwise_conv_bn(blocks[-<span class=\"hljs-number\">1</span>])\n                block = <span class=\"hljs-variable language_\">self</span>.depthwise_conv_bn(blocks[-<span class=\"hljs-number\">1</span>])\n                block = <span class=\"hljs-variable language_\">self</span>.conv_bn(blocks[-<span class=\"hljs-number\">1</span>], stage_count * <span class=\"hljs-number\">2</span>, filter_size=<span class=\"hljs-number\">1</span>, stride=<span class=\"hljs-number\">1</span>, padding=<span class=\"hljs-number\">0</span>)\n                blocks.append(block)\n            <span class=\"hljs-keyword\">else</span>:\n                tmp = <span class=\"hljs-variable language_\">self</span>.basic_block(tmp, stage_count)\n                blocks.append(tmp)\n\n        blocks = [blocks[-<span class=\"hljs-number\">1</span>], blocks[<span class=\"hljs-number\">3</span>]]\n\n        <span class=\"hljs-comment\"># yolo detector</span>\n        <span class=\"hljs-keyword\">for</span> i, block <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">enumerate</span>(blocks):\n            <span class=\"hljs-comment\"># yolo &#x4e2d;&#x8de8;&#x89c6;&#x57df;&#x94fe;&#x63a5;</span>\n            <span class=\"hljs-keyword\">if</span> i &gt; <span class=\"hljs-number\">0</span>:\n                block = fluid.layers.concat(<span class=\"hljs-built_in\">input</span>=[route, block], axis=<span class=\"hljs-number\">1</span>)\n            <span class=\"hljs-keyword\">if</span> i &lt; <span class=\"hljs-number\">1</span>:\n                route, tip = <span class=\"hljs-variable language_\">self</span>.yolo_detection_block(block, num_filters=<span class=\"hljs-number\">256</span> // (<span class=\"hljs-number\">2</span> ** i))\n            <span class=\"hljs-keyword\">else</span>:\n                tip = <span class=\"hljs-variable language_\">self</span>.conv_bn(block, num_filters=<span class=\"hljs-number\">256</span>, filter_size=<span class=\"hljs-number\">3</span>, stride=<span class=\"hljs-number\">1</span>, padding=<span class=\"hljs-number\">1</span>)\n\n            param_attr = ParamAttr(initializer=fluid.initializer.Normal(<span class=\"hljs-number\">0.</span>, <span class=\"hljs-number\">0.02</span>))\n            bias_attr = ParamAttr(initializer=fluid.initializer.Constant(<span class=\"hljs-number\">0.0</span>), regularizer=L2Decay(<span class=\"hljs-number\">0.</span>))\n            block_out = fluid.layers.conv2d(<span class=\"hljs-built_in\">input</span>=tip,\n                                            <span class=\"hljs-comment\"># 5 elements represent x|y|h|w|score</span>\n                                            num_filters=<span class=\"hljs-built_in\">len</span>(<span class=\"hljs-variable language_\">self</span>.anchor_mask[i]) * (<span class=\"hljs-variable language_\">self</span>.class_num + <span class=\"hljs-number\">5</span>),\n                                            filter_size=<span class=\"hljs-number\">1</span>,\n                                            stride=<span class=\"hljs-number\">1</span>,\n                                            padding=<span class=\"hljs-number\">0</span>,\n                                            act=<span class=\"hljs-literal\">None</span>,\n                                            param_attr=param_attr,\n                                            bias_attr=bias_attr)\n            <span class=\"hljs-variable language_\">self</span>.outputs.append(block_out)\n            <span class=\"hljs-comment\"># &#x4e3a;&#x4e86;&#x8de8;&#x89c6;&#x57df;&#x94fe;&#x63a5;&#xff0c;&#x5dee;&#x503c;&#x65b9;&#x5f0f;&#x63d0;&#x5347;&#x7279;&#x5f81;&#x56fe;&#x5c3a;&#x5bf8;</span>\n            <span class=\"hljs-keyword\">if</span> i &lt; <span class=\"hljs-built_in\">len</span>(blocks) - <span class=\"hljs-number\">1</span>:\n                route = <span class=\"hljs-variable language_\">self</span>.conv_bn(route, <span class=\"hljs-number\">128</span> // (<span class=\"hljs-number\">2</span> ** i), filter_size=<span class=\"hljs-number\">1</span>, stride=<span class=\"hljs-number\">1</span>, padding=<span class=\"hljs-number\">0</span>)\n                route = <span class=\"hljs-variable language_\">self</span>.up_sample(route)\n\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-variable language_\">self</span>.outputs\n\n\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">get_yolo</span>(<span class=\"hljs-params\">is_tiny, class_num, anchors, anchor_mask</span>):\n    <span class=\"hljs-keyword\">if</span> is_tiny:\n        <span class=\"hljs-keyword\">return</span> YOLOv3Tiny(class_num, anchors, anchor_mask)\n    <span class=\"hljs-keyword\">else</span>:\n        <span class=\"hljs-keyword\">return</span> YOLOv3(class_num, anchors, anchor_mask)\n\n\n<span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">Sampler</span>(<span class=\"hljs-title class_ inherited__\">object</span>):\n    <span class=\"hljs-string\">&quot;&quot;&quot;\n    &#x91c7;&#x6837;&#x5668;&#xff0c;&#x7528;&#x4e8e;&#x6263;&#x53d6;&#x91c7;&#x6837;\n    &quot;&quot;&quot;</span>\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">__init__</span>(<span class=\"hljs-params\">self, max_sample, max_trial, min_scale, max_scale,\n                 min_aspect_ratio, max_aspect_ratio, min_jaccard_overlap,\n                 max_jaccard_overlap</span>):\n        <span class=\"hljs-variable language_\">self</span>.max_sample = max_sample\n        <span class=\"hljs-variable language_\">self</span>.max_trial = max_trial\n        <span class=\"hljs-variable language_\">self</span>.min_scale = min_scale\n        <span class=\"hljs-variable language_\">self</span>.max_scale = max_scale\n        <span class=\"hljs-variable language_\">self</span>.min_aspect_ratio = min_aspect_ratio\n        <span class=\"hljs-variable language_\">self</span>.max_aspect_ratio = max_aspect_ratio\n        <span class=\"hljs-variable language_\">self</span>.min_jaccard_overlap = min_jaccard_overlap\n        <span class=\"hljs-variable language_\">self</span>.max_jaccard_overlap = max_jaccard_overlap\n\n\n<span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">bbox</span>(<span class=\"hljs-title class_ inherited__\">object</span>):\n    <span class=\"hljs-string\">&quot;&quot;&quot;\n    &#x5916;&#x754c;&#x77e9;&#x5f62;&#x6846;\n    &quot;&quot;&quot;</span>\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">__init__</span>(<span class=\"hljs-params\">self, xmin, ymin, xmax, ymax</span>):\n        <span class=\"hljs-variable language_\">self</span>.xmin = xmin\n        <span class=\"hljs-variable language_\">self</span>.ymin = ymin\n        <span class=\"hljs-variable language_\">self</span>.xmax = xmax\n        <span class=\"hljs-variable language_\">self</span>.ymax = ymax\n\n\n<span class=\"hljs-comment\"># &#x5750;&#x6807;&#x8f6c;&#x6362;&#xff0c;&#x7531;[x1, y1, w, h]&#x8f6c;&#x6362;&#x4e3a;[center_x, center_y, w, h]</span>\n<span class=\"hljs-comment\"># &#x5e76;&#x8f6c;&#x6362;&#x4e3a;&#x8303;&#x56f4;&#x5728;[0, 1]&#x4e4b;&#x95f4;&#x7684;&#x76f8;&#x5bf9;&#x5750;&#x6807;</span>\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">box_to_center_relative</span>(<span class=\"hljs-params\">box, img_height, img_width</span>):\n    <span class=\"hljs-string\">&quot;&quot;&quot;\n    Convert COCO annotations box with format [x1, y1, w, h] to\n    center mode [center_x, center_y, w, h] and divide image width\n    and height to get relative value in range[0, 1]\n    &quot;&quot;&quot;</span>\n    <span class=\"hljs-keyword\">assert</span> <span class=\"hljs-built_in\">len</span>(box) == <span class=\"hljs-number\">4</span>, <span class=\"hljs-string\">&quot;box should be a len(4) list or tuple&quot;</span>\n    x, y, w, h = box\n\n    x1 = <span class=\"hljs-built_in\">max</span>(x, <span class=\"hljs-number\">0</span>)\n    x2 = <span class=\"hljs-built_in\">min</span>(x + w - <span class=\"hljs-number\">1</span>, img_width - <span class=\"hljs-number\">1</span>)\n    y1 = <span class=\"hljs-built_in\">max</span>(y, <span class=\"hljs-number\">0</span>)\n    y2 = <span class=\"hljs-built_in\">min</span>(y + h - <span class=\"hljs-number\">1</span>, img_height - <span class=\"hljs-number\">1</span>)\n\n    x = (x1 + x2) / <span class=\"hljs-number\">2</span> / img_width  <span class=\"hljs-comment\"># x&#x4e2d;&#x5fc3;&#x5750;&#x6807;</span>\n    y = (y1 + y2) / <span class=\"hljs-number\">2</span> / img_height  <span class=\"hljs-comment\"># y&#x4e2d;&#x5fc3;&#x5750;&#x6807;</span>\n    w = (x2 - x1) / img_width  <span class=\"hljs-comment\"># &#x6846;&#x5bbd;&#x5ea6;/&#x56fe;&#x7247;&#x603b;&#x5bbd;&#x5ea6;</span>\n    h = (y2 - y1) / img_height  <span class=\"hljs-comment\"># &#x6846;&#x9ad8;&#x5ea6;/&#x56fe;&#x7247;&#x603b;&#x9ad8;&#x5ea6;</span>\n\n    <span class=\"hljs-keyword\">return</span> np.array([x, y, w, h])\n\n\n<span class=\"hljs-comment\"># &#x8c03;&#x6574;&#x56fe;&#x50cf;&#x5927;&#x5c0f;</span>\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">resize_img</span>(<span class=\"hljs-params\">img, sampled_labels, input_size</span>):\n    target_size = input_size\n    img = img.resize((target_size[<span class=\"hljs-number\">1</span>], target_size[<span class=\"hljs-number\">2</span>]), Image.BILINEAR)  <span class=\"hljs-comment\"># &#x91cd;&#x7f6e;&#x5927;&#x5c0f;&#xff0c;&#x53cc;&#x7ebf;&#x6027;&#x63d2;&#x503c;</span>\n    <span class=\"hljs-keyword\">return</span> img\n\n\n<span class=\"hljs-comment\"># &#x8ba1;&#x7b97;&#x4ea4;&#x5e76;&#x6bd4;</span>\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">box_iou_xywh</span>(<span class=\"hljs-params\">box1, box2</span>):\n    <span class=\"hljs-keyword\">assert</span> box1.shape[-<span class=\"hljs-number\">1</span>] == <span class=\"hljs-number\">4</span>, <span class=\"hljs-string\">&quot;Box1 shape[-1] should be 4.&quot;</span>\n    <span class=\"hljs-keyword\">assert</span> box2.shape[-<span class=\"hljs-number\">1</span>] == <span class=\"hljs-number\">4</span>, <span class=\"hljs-string\">&quot;Box2 shape[-1] should be 4.&quot;</span>\n\n    <span class=\"hljs-comment\"># &#x53d6;&#x4e24;&#x4e2a;&#x6846;&#x7684;&#x5750;&#x6807;</span>\n    b1_x1, b1_x2 = box1[:, <span class=\"hljs-number\">0</span>] - box1[:, <span class=\"hljs-number\">2</span>] / <span class=\"hljs-number\">2</span>, box1[:, <span class=\"hljs-number\">0</span>] + box1[:, <span class=\"hljs-number\">2</span>] / <span class=\"hljs-number\">2</span>\n    b1_y1, b1_y2 = box1[:, <span class=\"hljs-number\">1</span>] - box1[:, <span class=\"hljs-number\">3</span>] / <span class=\"hljs-number\">2</span>, box1[:, <span class=\"hljs-number\">1</span>] + box1[:, <span class=\"hljs-number\">3</span>] / <span class=\"hljs-number\">2</span>\n    b2_x1, b2_x2 = box2[:, <span class=\"hljs-number\">0</span>] - box2[:, <span class=\"hljs-number\">2</span>] / <span class=\"hljs-number\">2</span>, box2[:, <span class=\"hljs-number\">0</span>] + box2[:, <span class=\"hljs-number\">2</span>] / <span class=\"hljs-number\">2</span>\n    b2_y1, b2_y2 = box2[:, <span class=\"hljs-number\">1</span>] - box2[:, <span class=\"hljs-number\">3</span>] / <span class=\"hljs-number\">2</span>, box2[:, <span class=\"hljs-number\">1</span>] + box2[:, <span class=\"hljs-number\">3</span>] / <span class=\"hljs-number\">2</span>\n\n    inter_x1 = np.maximum(b1_x1, b2_x1)\n    inter_x2 = np.minimum(b1_x2, b2_x2)\n    inter_y1 = np.maximum(b1_y1, b2_y1)\n    inter_y2 = np.minimum(b1_y2, b2_y2)\n    inter_w = inter_x2 - inter_x1 + <span class=\"hljs-number\">1</span>  <span class=\"hljs-comment\"># &#x76f8;&#x4ea4;&#x90e8;&#x5206;&#x5bbd;&#x5ea6;</span>\n    inter_h = inter_y2 - inter_y1 + <span class=\"hljs-number\">1</span>  <span class=\"hljs-comment\"># &#x76f8;&#x4ea4;&#x90e8;&#x5206;&#x9ad8;&#x5ea6;</span>\n    inter_w[inter_w &lt; <span class=\"hljs-number\">0</span>] = <span class=\"hljs-number\">0</span>\n    inter_h[inter_h &lt; <span class=\"hljs-number\">0</span>] = <span class=\"hljs-number\">0</span>\n\n    inter_area = inter_w * inter_h  <span class=\"hljs-comment\"># &#x76f8;&#x4ea4;&#x9762;&#x79ef;</span>\n    b1_area = (b1_x2 - b1_x1 + <span class=\"hljs-number\">1</span>) * (b1_y2 - b1_y1 + <span class=\"hljs-number\">1</span>)  <span class=\"hljs-comment\"># &#x6846;1&#x7684;&#x9762;&#x79ef;</span>\n    b2_area = (b2_x2 - b2_x1 + <span class=\"hljs-number\">1</span>) * (b2_y2 - b2_y1 + <span class=\"hljs-number\">1</span>)  <span class=\"hljs-comment\"># &#x6846;2&#x7684;&#x9762;&#x79ef;</span>\n\n    <span class=\"hljs-keyword\">return</span> inter_area / (b1_area + b2_area - inter_area)  <span class=\"hljs-comment\"># &#x76f8;&#x96c6;&#x9762;&#x79ef;/&#x5e76;&#x96c6;&#x9762;&#x79ef;</span>\n\n\n<span class=\"hljs-comment\"># box&#x88c1;&#x526a;</span>\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">box_crop</span>(<span class=\"hljs-params\">boxes, labels, crop, img_shape</span>):\n    x, y, w, h = <span class=\"hljs-built_in\">map</span>(<span class=\"hljs-built_in\">float</span>, crop)\n    im_w, im_h = <span class=\"hljs-built_in\">map</span>(<span class=\"hljs-built_in\">float</span>, img_shape)\n\n    boxes = boxes.copy()\n    boxes[:, <span class=\"hljs-number\">0</span>], boxes[:, <span class=\"hljs-number\">2</span>] = (boxes[:, <span class=\"hljs-number\">0</span>] - boxes[:, <span class=\"hljs-number\">2</span>] / <span class=\"hljs-number\">2</span>) * im_w, (boxes[:, <span class=\"hljs-number\">0</span>] + boxes[:, <span class=\"hljs-number\">2</span>] / <span class=\"hljs-number\">2</span>) * im_w\n    boxes[:, <span class=\"hljs-number\">1</span>], boxes[:, <span class=\"hljs-number\">3</span>] = (boxes[:, <span class=\"hljs-number\">1</span>] - boxes[:, <span class=\"hljs-number\">3</span>] / <span class=\"hljs-number\">2</span>) * im_h, (boxes[:, <span class=\"hljs-number\">1</span>] + boxes[:, <span class=\"hljs-number\">3</span>] / <span class=\"hljs-number\">2</span>) * im_h\n\n    crop_box = np.array([x, y, x + w, y + h])\n    centers = (boxes[:, :<span class=\"hljs-number\">2</span>] + boxes[:, <span class=\"hljs-number\">2</span>:]) / <span class=\"hljs-number\">2.0</span>\n    mask = np.logical_and(crop_box[:<span class=\"hljs-number\">2</span>] &lt;= centers, centers &lt;= crop_box[<span class=\"hljs-number\">2</span>:]).<span class=\"hljs-built_in\">all</span>(axis=<span class=\"hljs-number\">1</span>)\n\n    boxes[:, :<span class=\"hljs-number\">2</span>] = np.maximum(boxes[:, :<span class=\"hljs-number\">2</span>], crop_box[:<span class=\"hljs-number\">2</span>])\n    boxes[:, <span class=\"hljs-number\">2</span>:] = np.minimum(boxes[:, <span class=\"hljs-number\">2</span>:], crop_box[<span class=\"hljs-number\">2</span>:])\n    boxes[:, :<span class=\"hljs-number\">2</span>] -= crop_box[:<span class=\"hljs-number\">2</span>]\n    boxes[:, <span class=\"hljs-number\">2</span>:] -= crop_box[:<span class=\"hljs-number\">2</span>]\n\n    mask = np.logical_and(mask, (boxes[:, :<span class=\"hljs-number\">2</span>] &lt; boxes[:, <span class=\"hljs-number\">2</span>:]).<span class=\"hljs-built_in\">all</span>(axis=<span class=\"hljs-number\">1</span>))\n    boxes = boxes * np.expand_dims(mask.astype(<span class=\"hljs-string\">&apos;float32&apos;</span>), axis=<span class=\"hljs-number\">1</span>)\n    labels = labels * mask.astype(<span class=\"hljs-string\">&apos;float32&apos;</span>)\n    boxes[:, <span class=\"hljs-number\">0</span>], boxes[:, <span class=\"hljs-number\">2</span>] = (boxes[:, <span class=\"hljs-number\">0</span>] + boxes[:, <span class=\"hljs-number\">2</span>]) / <span class=\"hljs-number\">2</span> / w, (boxes[:, <span class=\"hljs-number\">2</span>] - boxes[:, <span class=\"hljs-number\">0</span>]) / w\n    boxes[:, <span class=\"hljs-number\">1</span>], boxes[:, <span class=\"hljs-number\">3</span>] = (boxes[:, <span class=\"hljs-number\">1</span>] + boxes[:, <span class=\"hljs-number\">3</span>]) / <span class=\"hljs-number\">2</span> / h, (boxes[:, <span class=\"hljs-number\">3</span>] - boxes[:, <span class=\"hljs-number\">1</span>]) / h\n\n    <span class=\"hljs-keyword\">return</span> boxes, labels, mask.<span class=\"hljs-built_in\">sum</span>()\n\n\n<span class=\"hljs-comment\"># &#x56fe;&#x50cf;&#x589e;&#x52a0;&#xff1a;&#x5bf9;&#x6bd4;&#x5ea6;&#xff0c;&#x9971;&#x548c;&#x5ea6;&#xff0c;&#x660e;&#x6697;&#xff0c;&#x989c;&#x8272;&#xff0c;&#x6269;&#x5f20;</span>\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">random_brightness</span>(<span class=\"hljs-params\">img</span>):  <span class=\"hljs-comment\"># &#x4eae;&#x5ea6;</span>\n    prob = np.random.uniform(<span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">1</span>)\n\n    <span class=\"hljs-keyword\">if</span> prob &lt; train_params[<span class=\"hljs-string\">&apos;image_distort_strategy&apos;</span>][<span class=\"hljs-string\">&apos;brightness_prob&apos;</span>]:\n        brightness_delta = train_params[<span class=\"hljs-string\">&apos;image_distort_strategy&apos;</span>][<span class=\"hljs-string\">&apos;brightness_delta&apos;</span>]  <span class=\"hljs-comment\"># &#x9ed8;&#x8ba4;&#x503c;0.125</span>\n        delta = np.random.uniform(-brightness_delta, brightness_delta) + <span class=\"hljs-number\">1</span>  <span class=\"hljs-comment\"># &#x4ea7;&#x751f;&#x5747;&#x5300;&#x5206;&#x5e03;&#x968f;&#x673a;&#x503c;</span>\n        img = ImageEnhance.Brightness(img).enhance(delta)  <span class=\"hljs-comment\"># &#x8c03;&#x6574;&#x56fe;&#x50cf;&#x4eae;&#x5ea6;</span>\n\n    <span class=\"hljs-keyword\">return</span> img\n\n\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">random_contrast</span>(<span class=\"hljs-params\">img</span>):  <span class=\"hljs-comment\"># &#x5bf9;&#x6bd4;&#x5ea6;</span>\n    prob = np.random.uniform(<span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">1</span>)\n\n    <span class=\"hljs-keyword\">if</span> prob &lt; train_params[<span class=\"hljs-string\">&apos;image_distort_strategy&apos;</span>][<span class=\"hljs-string\">&apos;contrast_prob&apos;</span>]:\n        contrast_delta = train_params[<span class=\"hljs-string\">&apos;image_distort_strategy&apos;</span>][<span class=\"hljs-string\">&apos;contrast_delta&apos;</span>]\n        delta = np.random.uniform(-contrast_delta, contrast_delta) + <span class=\"hljs-number\">1</span>\n        img = ImageEnhance.Contrast(img).enhance(delta)\n\n    <span class=\"hljs-keyword\">return</span> img\n\n\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">random_saturation</span>(<span class=\"hljs-params\">img</span>):  <span class=\"hljs-comment\"># &#x9971;&#x548c;&#x5ea6;</span>\n    prob = np.random.uniform(<span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">1</span>)\n\n    <span class=\"hljs-keyword\">if</span> prob &lt; train_params[<span class=\"hljs-string\">&apos;image_distort_strategy&apos;</span>][<span class=\"hljs-string\">&apos;saturation_prob&apos;</span>]:\n        saturation_delta = train_params[<span class=\"hljs-string\">&apos;image_distort_strategy&apos;</span>][<span class=\"hljs-string\">&apos;saturation_delta&apos;</span>]\n        delta = np.random.uniform(-saturation_delta, saturation_delta) + <span class=\"hljs-number\">1</span>\n        img = ImageEnhance.Color(img).enhance(delta)\n\n    <span class=\"hljs-keyword\">return</span> img\n\n\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">random_hue</span>(<span class=\"hljs-params\">img</span>):  <span class=\"hljs-comment\"># &#x8272;&#x8c03;</span>\n    prob = np.random.uniform(<span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">1</span>)\n\n    <span class=\"hljs-keyword\">if</span> prob &lt; train_params[<span class=\"hljs-string\">&apos;image_distort_strategy&apos;</span>][<span class=\"hljs-string\">&apos;hue_prob&apos;</span>]:\n        hue_delta = train_params[<span class=\"hljs-string\">&apos;image_distort_strategy&apos;</span>][<span class=\"hljs-string\">&apos;hue_delta&apos;</span>]\n        delta = np.random.uniform(-hue_delta, hue_delta)\n        img_hsv = np.array(img.convert(<span class=\"hljs-string\">&apos;HSV&apos;</span>))\n        img_hsv[:, :, <span class=\"hljs-number\">0</span>] = img_hsv[:, :, <span class=\"hljs-number\">0</span>] + delta\n        img = Image.fromarray(img_hsv, mode=<span class=\"hljs-string\">&apos;HSV&apos;</span>).convert(<span class=\"hljs-string\">&apos;RGB&apos;</span>)\n\n    <span class=\"hljs-keyword\">return</span> img\n\n\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">distort_image</span>(<span class=\"hljs-params\">img</span>):  <span class=\"hljs-comment\"># &#x56fe;&#x50cf;&#x626d;&#x66f2;</span>\n    prob = np.random.uniform(<span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">1</span>)\n    <span class=\"hljs-comment\"># Apply different distort order</span>\n    <span class=\"hljs-keyword\">if</span> prob &gt; <span class=\"hljs-number\">0.5</span>:\n        img = random_brightness(img)\n        img = random_contrast(img)\n        img = random_saturation(img)\n        img = random_hue(img)\n    <span class=\"hljs-keyword\">else</span>:\n        img = random_brightness(img)\n        img = random_saturation(img)\n        img = random_hue(img)\n        img = random_contrast(img)\n    <span class=\"hljs-keyword\">return</span> img\n\n\n<span class=\"hljs-comment\"># &#x968f;&#x673a;&#x88c1;&#x526a;</span>\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">random_crop</span>(<span class=\"hljs-params\">img, boxes, labels, scales=[<span class=\"hljs-number\">0.3</span>, <span class=\"hljs-number\">1.0</span>], max_ratio=<span class=\"hljs-number\">2.0</span>, constraints=<span class=\"hljs-literal\">None</span>, max_trial=<span class=\"hljs-number\">50</span></span>):\n    <span class=\"hljs-keyword\">if</span> random.random() &gt; <span class=\"hljs-number\">0.6</span>:\n        <span class=\"hljs-keyword\">return</span> img, boxes, labels\n    <span class=\"hljs-keyword\">if</span> <span class=\"hljs-built_in\">len</span>(boxes) == <span class=\"hljs-number\">0</span>:\n        <span class=\"hljs-keyword\">return</span> img, boxes, labels\n\n    <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">not</span> constraints:\n        constraints = [(<span class=\"hljs-number\">0.1</span>, <span class=\"hljs-number\">1.0</span>),\n                       (<span class=\"hljs-number\">0.3</span>, <span class=\"hljs-number\">1.0</span>),\n                       (<span class=\"hljs-number\">0.5</span>, <span class=\"hljs-number\">1.0</span>),\n                       (<span class=\"hljs-number\">0.7</span>, <span class=\"hljs-number\">1.0</span>),\n                       (<span class=\"hljs-number\">0.9</span>, <span class=\"hljs-number\">1.0</span>),\n                       (<span class=\"hljs-number\">0.0</span>, <span class=\"hljs-number\">1.0</span>)]  <span class=\"hljs-comment\"># &#x6700;&#x5c0f;/&#x6700;&#x5927;&#x4ea4;&#x5e76;&#x6bd4;&#x503c;</span>\n\n    w, h = img.size\n    crops = [(<span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">0</span>, w, h)]\n\n    <span class=\"hljs-keyword\">for</span> min_iou, max_iou <span class=\"hljs-keyword\">in</span> constraints:\n        <span class=\"hljs-keyword\">for</span> _ <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(max_trial):\n            scale = random.uniform(scales[<span class=\"hljs-number\">0</span>], scales[<span class=\"hljs-number\">1</span>])\n            aspect_ratio = random.uniform(<span class=\"hljs-built_in\">max</span>(<span class=\"hljs-number\">1</span> / max_ratio, scale * scale), \\\n                                          <span class=\"hljs-built_in\">min</span>(max_ratio, <span class=\"hljs-number\">1</span> / scale / scale))\n            crop_h = <span class=\"hljs-built_in\">int</span>(h * scale / np.sqrt(aspect_ratio))\n            crop_w = <span class=\"hljs-built_in\">int</span>(w * scale * np.sqrt(aspect_ratio))\n            crop_x = random.randrange(w - crop_w)\n            crop_y = random.randrange(h - crop_h)\n            crop_box = np.array([[\n                (crop_x + crop_w / <span class=\"hljs-number\">2.0</span>) / w,\n                (crop_y + crop_h / <span class=\"hljs-number\">2.0</span>) / h,\n                crop_w / <span class=\"hljs-built_in\">float</span>(w),\n                crop_h / <span class=\"hljs-built_in\">float</span>(h)\n            ]])\n\n            iou = box_iou_xywh(crop_box, boxes)\n            <span class=\"hljs-keyword\">if</span> min_iou &lt;= iou.<span class=\"hljs-built_in\">min</span>() <span class=\"hljs-keyword\">and</span> max_iou &gt;= iou.<span class=\"hljs-built_in\">max</span>():\n                crops.append((crop_x, crop_y, crop_w, crop_h))\n                <span class=\"hljs-keyword\">break</span>\n\n    <span class=\"hljs-keyword\">while</span> crops:\n        crop = crops.pop(np.random.randint(<span class=\"hljs-number\">0</span>, <span class=\"hljs-built_in\">len</span>(crops)))\n        crop_boxes, crop_labels, box_num = box_crop(boxes, labels, crop, (w, h))\n        <span class=\"hljs-keyword\">if</span> box_num &lt; <span class=\"hljs-number\">1</span>:\n            <span class=\"hljs-keyword\">continue</span>\n        img = img.crop((crop[<span class=\"hljs-number\">0</span>], crop[<span class=\"hljs-number\">1</span>], crop[<span class=\"hljs-number\">0</span>] + crop[<span class=\"hljs-number\">2</span>],\n                        crop[<span class=\"hljs-number\">1</span>] + crop[<span class=\"hljs-number\">3</span>])).resize(img.size, Image.LANCZOS)\n        <span class=\"hljs-keyword\">return</span> img, crop_boxes, crop_labels\n    <span class=\"hljs-keyword\">return</span> img, boxes, labels\n\n\n<span class=\"hljs-comment\"># &#x6269;&#x5f20;</span>\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">random_expand</span>(<span class=\"hljs-params\">img, gtboxes, keep_ratio=<span class=\"hljs-literal\">True</span></span>):\n    <span class=\"hljs-keyword\">if</span> np.random.uniform(<span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">1</span>) &lt; train_params[<span class=\"hljs-string\">&apos;image_distort_strategy&apos;</span>][<span class=\"hljs-string\">&apos;expand_prob&apos;</span>]:\n        <span class=\"hljs-keyword\">return</span> img, gtboxes\n\n    max_ratio = train_params[<span class=\"hljs-string\">&apos;image_distort_strategy&apos;</span>][<span class=\"hljs-string\">&apos;expand_max_ratio&apos;</span>]\n    w, h = img.size\n    c = <span class=\"hljs-number\">3</span>\n    ratio_x = random.uniform(<span class=\"hljs-number\">1</span>, max_ratio)\n    <span class=\"hljs-keyword\">if</span> keep_ratio:\n        ratio_y = ratio_x\n    <span class=\"hljs-keyword\">else</span>:\n        ratio_y = random.uniform(<span class=\"hljs-number\">1</span>, max_ratio)\n    oh = <span class=\"hljs-built_in\">int</span>(h * ratio_y)\n    ow = <span class=\"hljs-built_in\">int</span>(w * ratio_x)\n    off_x = random.randint(<span class=\"hljs-number\">0</span>, ow - w)\n    off_y = random.randint(<span class=\"hljs-number\">0</span>, oh - h)\n\n    out_img = np.zeros((oh, ow, c), np.uint8)\n    <span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(c):\n        out_img[:, :, i] = train_params[<span class=\"hljs-string\">&apos;mean_rgb&apos;</span>][i]\n\n    out_img[off_y: off_y + h, off_x: off_x + w, :] = img\n    gtboxes[:, <span class=\"hljs-number\">0</span>] = ((gtboxes[:, <span class=\"hljs-number\">0</span>] * w) + off_x) / <span class=\"hljs-built_in\">float</span>(ow)\n    gtboxes[:, <span class=\"hljs-number\">1</span>] = ((gtboxes[:, <span class=\"hljs-number\">1</span>] * h) + off_y) / <span class=\"hljs-built_in\">float</span>(oh)\n    gtboxes[:, <span class=\"hljs-number\">2</span>] = gtboxes[:, <span class=\"hljs-number\">2</span>] / ratio_x\n    gtboxes[:, <span class=\"hljs-number\">3</span>] = gtboxes[:, <span class=\"hljs-number\">3</span>] / ratio_y\n\n    <span class=\"hljs-keyword\">return</span> Image.fromarray(out_img), gtboxes\n\n\n<span class=\"hljs-comment\"># &#x9884;&#x5904;&#x7406;&#xff1a;&#x56fe;&#x50cf;&#x6837;&#x672c;&#x589e;&#x5f3a;&#xff0c;&#x7ef4;&#x5ea6;&#x8f6c;&#x6362;</span>\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">preprocess</span>(<span class=\"hljs-params\">img, bbox_labels, input_size, mode</span>):\n    img_width, img_height = img.size\n    sample_labels = np.array(bbox_labels)\n\n    <span class=\"hljs-keyword\">if</span> mode == <span class=\"hljs-string\">&apos;train&apos;</span>:\n        <span class=\"hljs-keyword\">if</span> train_params[<span class=\"hljs-string\">&apos;apply_distort&apos;</span>]:  <span class=\"hljs-comment\"># &#x662f;&#x5426;&#x626d;&#x66f2;&#x589e;&#x5f3a;</span>\n            img = distort_image(img)\n\n        img, gtboxes = random_expand(img, sample_labels[:, <span class=\"hljs-number\">1</span>:<span class=\"hljs-number\">5</span>])  <span class=\"hljs-comment\"># &#x6269;&#x5c55;&#x589e;&#x5f3a;</span>\n        img, gtboxes, gtlabels = random_crop(img, gtboxes, sample_labels[:, <span class=\"hljs-number\">0</span>])  <span class=\"hljs-comment\"># &#x968f;&#x673a;&#x88c1;&#x526a;</span>\n        sample_labels[:, <span class=\"hljs-number\">0</span>] = gtlabels\n        sample_labels[:, <span class=\"hljs-number\">1</span>:<span class=\"hljs-number\">5</span>] = gtboxes\n\n    img = resize_img(img, sample_labels, input_size)\n    img = np.array(img).astype(<span class=\"hljs-string\">&apos;float32&apos;</span>)\n    img -= train_params[<span class=\"hljs-string\">&apos;mean_rgb&apos;</span>]\n    img = img.transpose((<span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">1</span>))  <span class=\"hljs-comment\"># HWC to CHW</span>\n    img *= <span class=\"hljs-number\">0.007843</span>\n    <span class=\"hljs-keyword\">return</span> img, sample_labels\n\n\n<span class=\"hljs-comment\"># &#x6570;&#x636e;&#x8bfb;&#x53d6;&#x5668;</span>\n<span class=\"hljs-comment\"># &#x6839;&#x636e;&#x6837;&#x672c;&#x6587;&#x4ef6;&#xff0c;&#x8bfb;&#x53d6;&#x56fe;&#x7247;&#x3001;&#x5e76;&#x505a;&#x6570;&#x636e;&#x589e;&#x5f3a;&#xff0c;&#x8fd4;&#x56de;&#x56fe;&#x7247;&#x6570;&#x636e;&#x3001;&#x8fb9;&#x6846;&#x3001;&#x6807;&#x7b7e;</span>\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">custom_reader</span>(<span class=\"hljs-params\">file_list, data_dir, input_size, mode</span>):\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">reader</span>():\n        np.random.shuffle(file_list)  <span class=\"hljs-comment\"># &#x6253;&#x4e71;&#x6587;&#x4ef6;&#x5217;&#x8868;</span>\n\n        <span class=\"hljs-keyword\">for</span> line <span class=\"hljs-keyword\">in</span> file_list:  <span class=\"hljs-comment\"># &#x8bfb;&#x53d6;&#x884c;&#xff0c;&#x6bcf;&#x884c;&#x4e00;&#x4e2a;&#x56fe;&#x7247;&#x53ca;&#x6807;&#x6ce8;</span>\n            <span class=\"hljs-keyword\">if</span> mode == <span class=\"hljs-string\">&apos;train&apos;</span> <span class=\"hljs-keyword\">or</span> mode == <span class=\"hljs-string\">&apos;eval&apos;</span>:\n                <span class=\"hljs-comment\">######################  &#x4ee5;&#x4e0b;&#x53ef;&#x80fd;&#x662f;&#x9700;&#x8981;&#x81ea;&#x5b9a;&#x4e49;&#x4fee;&#x6539;&#x7684;&#x90e8;&#x5206;   ############################</span>\n                parts = line.split(<span class=\"hljs-string\">&apos;\\t&apos;</span>)  <span class=\"hljs-comment\"># &#x6309;&#x7167;tab&#x952e;&#x62c6;&#x5206;</span>\n                image_path = parts[<span class=\"hljs-number\">0</span>]\n\n                img = Image.<span class=\"hljs-built_in\">open</span>(os.path.join(data_dir, image_path))  <span class=\"hljs-comment\"># &#x8bfb;&#x53d6;&#x56fe;&#x50cf;&#x6570;&#x636e;</span>\n                <span class=\"hljs-keyword\">if</span> img.mode != <span class=\"hljs-string\">&apos;RGB&apos;</span>:\n                    img = img.convert(<span class=\"hljs-string\">&apos;RGB&apos;</span>)\n                im_width, im_height = img.size\n\n                <span class=\"hljs-comment\"># bbox &#x7684;&#x5217;&#x8868;&#xff0c;&#x6bcf;&#x4e00;&#x4e2a;&#x5143;&#x7d20;&#x4e3a;&#x8fd9;&#x6837;</span>\n                <span class=\"hljs-comment\"># layout: label | x-center | y-cneter | width | height | difficult</span>\n                bbox_labels = []\n                <span class=\"hljs-keyword\">for</span> object_str <span class=\"hljs-keyword\">in</span> parts[<span class=\"hljs-number\">1</span>:]:  <span class=\"hljs-comment\"># &#x5faa;&#x73af;&#x5904;&#x7406;&#x6bcf;&#x4e00;&#x4e2a;&#x76ee;&#x6807;&#x6807;&#x6ce8;&#x4fe1;&#x606f;</span>\n                    <span class=\"hljs-keyword\">if</span> <span class=\"hljs-built_in\">len</span>(object_str) &lt;= <span class=\"hljs-number\">1</span>:\n                        <span class=\"hljs-keyword\">continue</span>\n\n                    bbox_sample = []\n                    <span class=\"hljs-built_in\">object</span> = json.loads(object_str)\n                    bbox_sample.append(<span class=\"hljs-built_in\">float</span>(train_params[<span class=\"hljs-string\">&apos;label_dict&apos;</span>][<span class=\"hljs-built_in\">object</span>[<span class=\"hljs-string\">&apos;value&apos;</span>]]))\n                    bbox = <span class=\"hljs-built_in\">object</span>[<span class=\"hljs-string\">&apos;coordinate&apos;</span>]  <span class=\"hljs-comment\"># &#x83b7;&#x53d6;&#x6846;&#x5750;&#x6807;</span>\n                    <span class=\"hljs-comment\"># &#x8ba1;&#x7b97;x,y,w,h</span>\n                    box = [bbox[<span class=\"hljs-number\">0</span>][<span class=\"hljs-number\">0</span>], bbox[<span class=\"hljs-number\">0</span>][<span class=\"hljs-number\">1</span>], bbox[<span class=\"hljs-number\">1</span>][<span class=\"hljs-number\">0</span>] - bbox[<span class=\"hljs-number\">0</span>][<span class=\"hljs-number\">0</span>], bbox[<span class=\"hljs-number\">1</span>][<span class=\"hljs-number\">1</span>] - bbox[<span class=\"hljs-number\">0</span>][<span class=\"hljs-number\">1</span>]]\n                    bbox = box_to_center_relative(box, im_height, im_width)  <span class=\"hljs-comment\"># &#x5750;&#x6807;&#x8f6c;&#x6362;</span>\n                    bbox_sample.append(<span class=\"hljs-built_in\">float</span>(bbox[<span class=\"hljs-number\">0</span>]))\n                    bbox_sample.append(<span class=\"hljs-built_in\">float</span>(bbox[<span class=\"hljs-number\">1</span>]))\n                    bbox_sample.append(<span class=\"hljs-built_in\">float</span>(bbox[<span class=\"hljs-number\">2</span>]))\n                    bbox_sample.append(<span class=\"hljs-built_in\">float</span>(bbox[<span class=\"hljs-number\">3</span>]))\n                    difficult = <span class=\"hljs-built_in\">float</span>(<span class=\"hljs-number\">0</span>)\n                    bbox_sample.append(difficult)\n                    bbox_labels.append(bbox_sample)\n                <span class=\"hljs-comment\">######################  &#x53ef;&#x80fd;&#x9700;&#x8981;&#x81ea;&#x5b9a;&#x4e49;&#x4fee;&#x6539;&#x90e8;&#x5206;&#x7ed3;&#x675f;   ############################</span>\n\n                <span class=\"hljs-keyword\">if</span> <span class=\"hljs-built_in\">len</span>(bbox_labels) == <span class=\"hljs-number\">0</span>:\n                    <span class=\"hljs-keyword\">continue</span>\n\n                img, sample_labels = preprocess(img, bbox_labels, input_size, mode)  <span class=\"hljs-comment\"># &#x9884;&#x5904;&#x7406;</span>\n                <span class=\"hljs-comment\"># sample_labels = np.array(sample_labels)</span>\n                <span class=\"hljs-keyword\">if</span> <span class=\"hljs-built_in\">len</span>(sample_labels) == <span class=\"hljs-number\">0</span>:\n                    <span class=\"hljs-keyword\">continue</span>\n\n                boxes = sample_labels[:, <span class=\"hljs-number\">1</span>:<span class=\"hljs-number\">5</span>]  <span class=\"hljs-comment\"># &#x5750;&#x6807;</span>\n                lbls = sample_labels[:, <span class=\"hljs-number\">0</span>].astype(<span class=\"hljs-string\">&apos;int32&apos;</span>)  <span class=\"hljs-comment\"># &#x6807;&#x7b7e;</span>\n                difficults = sample_labels[:, -<span class=\"hljs-number\">1</span>].astype(<span class=\"hljs-string\">&apos;int32&apos;</span>)\n                max_box_num = train_params[<span class=\"hljs-string\">&apos;max_box_num&apos;</span>]  <span class=\"hljs-comment\"># &#x4e00;&#x526f;&#x56fe;&#x50cf;&#x6700;&#x591a;&#x591a;&#x5c11;&#x4e2a;&#x76ee;&#x6807;&#x7269;&#x4f53;</span>\n                cope_size = max_box_num <span class=\"hljs-keyword\">if</span> <span class=\"hljs-built_in\">len</span>(boxes) &gt;= max_box_num <span class=\"hljs-keyword\">else</span> <span class=\"hljs-built_in\">len</span>(boxes)  <span class=\"hljs-comment\"># &#x63a7;&#x5236;&#x6700;&#x5927;&#x76ee;&#x6807;&#x6570;&#x91cf;</span>\n                ret_boxes = np.zeros((max_box_num, <span class=\"hljs-number\">4</span>), dtype=np.float32)\n                ret_lbls = np.zeros((max_box_num), dtype=np.int32)\n                ret_difficults = np.zeros((max_box_num), dtype=np.int32)\n                ret_boxes[<span class=\"hljs-number\">0</span>: cope_size] = boxes[<span class=\"hljs-number\">0</span>: cope_size]\n                ret_lbls[<span class=\"hljs-number\">0</span>: cope_size] = lbls[<span class=\"hljs-number\">0</span>: cope_size]\n                ret_difficults[<span class=\"hljs-number\">0</span>: cope_size] = difficults[<span class=\"hljs-number\">0</span>: cope_size]\n\n                <span class=\"hljs-keyword\">yield</span> img, ret_boxes, ret_lbls  <span class=\"hljs-comment\"># &#x8fd4;&#x56de;&#x56fe;&#x50cf;&#x3001;&#x8fb9;&#x6846;&#x3001;&#x6807;&#x7b7e;</span>\n\n            <span class=\"hljs-keyword\">elif</span> mode == <span class=\"hljs-string\">&apos;test&apos;</span>:\n                img_path = os.path.join(line)\n\n                <span class=\"hljs-keyword\">yield</span> Image.<span class=\"hljs-built_in\">open</span>(img_path)\n\n    <span class=\"hljs-keyword\">return</span> reader\n\n\n<span class=\"hljs-comment\"># &#x6279;&#x91cf;&#x3001;&#x968f;&#x673a;&#x6570;&#x636e;&#x8bfb;&#x53d6;&#x5668;</span>\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">single_custom_reader</span>(<span class=\"hljs-params\">file_path, data_dir, input_size, mode</span>):\n    file_path = os.path.join(data_dir, file_path)\n\n    images = [line.strip() <span class=\"hljs-keyword\">for</span> line <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">open</span>(file_path)]\n    reader = custom_reader(images, data_dir, input_size, mode)\n    reader = paddle.reader.shuffle(reader, train_params[<span class=\"hljs-string\">&apos;train_batch_size&apos;</span>])\n    reader = paddle.batch(reader, train_params[<span class=\"hljs-string\">&apos;train_batch_size&apos;</span>])\n\n    <span class=\"hljs-keyword\">return</span> reader\n\n\n<span class=\"hljs-comment\"># &#x5b9a;&#x4e49;&#x4f18;&#x5316;&#x5668;</span>\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">optimizer_sgd_setting</span>():\n    batch_size = train_params[<span class=\"hljs-string\">&quot;train_batch_size&quot;</span>]  <span class=\"hljs-comment\"># batch&#x5927;&#x5c0f;</span>\n    iters = train_params[<span class=\"hljs-string\">&quot;image_count&quot;</span>] // batch_size  <span class=\"hljs-comment\"># &#x8ba1;&#x7b97;&#x8f6e;&#x6b21;</span>\n    iters = <span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">if</span> iters &lt; <span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">else</span> iters\n    learning_strategy = train_params[<span class=\"hljs-string\">&apos;sgd_strategy&apos;</span>]\n    lr = learning_strategy[<span class=\"hljs-string\">&apos;learning_rate&apos;</span>]  <span class=\"hljs-comment\"># &#x5b66;&#x4e60;&#x7387;</span>\n\n    boundaries = [i * iters <span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> learning_strategy[<span class=\"hljs-string\">&quot;lr_epochs&quot;</span>]]\n    values = [i * lr <span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> learning_strategy[<span class=\"hljs-string\">&quot;lr_decay&quot;</span>]]\n    logger.info(<span class=\"hljs-string\">&quot;origin learning rate: {0} boundaries: {1}  values: {2}&quot;</span>.<span class=\"hljs-built_in\">format</span>(lr, boundaries, values))\n\n    optimizer = fluid.optimizer.SGDOptimizer(\n        learning_rate=fluid.layers.piecewise_decay(boundaries, values),  <span class=\"hljs-comment\"># &#x5206;&#x6bb5;&#x8870;&#x51cf;&#x5b66;&#x4e60;&#x7387;</span>\n        regularization=fluid.regularizer.L2Decay(<span class=\"hljs-number\">0.00005</span>))  <span class=\"hljs-comment\"># L2&#x6743;&#x91cd;&#x8870;&#x51cf;&#x6b63;&#x5219;&#x5316;</span>\n\n    <span class=\"hljs-keyword\">return</span> optimizer\n\n\n<span class=\"hljs-comment\"># &#x521b;&#x5efa;program, feeder&#x53ca;yolo&#x6a21;&#x578b;</span>\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">build_program_with_feeder</span>(<span class=\"hljs-params\">main_prog, startup_prog, place</span>):\n    max_box_num = train_params[<span class=\"hljs-string\">&apos;max_box_num&apos;</span>]\n    ues_tiny = train_params[<span class=\"hljs-string\">&apos;use_tiny&apos;</span>]  <span class=\"hljs-comment\"># &#x83b7;&#x53d6;&#x662f;&#x5426;&#x4f7f;&#x7528;tiny yolo&#x53c2;&#x6570;</span>\n    yolo_config = train_params[<span class=\"hljs-string\">&apos;yolo_tiny_cfg&apos;</span>] <span class=\"hljs-keyword\">if</span> ues_tiny <span class=\"hljs-keyword\">else</span> train_params[<span class=\"hljs-string\">&apos;yolo_cfg&apos;</span>]\n\n    <span class=\"hljs-keyword\">with</span> fluid.program_guard(main_prog, startup_prog):  <span class=\"hljs-comment\"># &#x66f4;&#x6539;&#x5168;&#x5c40;&#x4e3b;&#x7a0b;&#x5e8f;&#x548c;&#x542f;&#x52a8;&#x7a0b;&#x5e8f;</span>\n        img = fluid.layers.data(name=<span class=\"hljs-string\">&apos;img&apos;</span>, shape=yolo_config[<span class=\"hljs-string\">&apos;input_size&apos;</span>], dtype=<span class=\"hljs-string\">&apos;float32&apos;</span>)  <span class=\"hljs-comment\"># &#x56fe;&#x50cf;</span>\n        gt_box = fluid.layers.data(name=<span class=\"hljs-string\">&apos;gt_box&apos;</span>, shape=[max_box_num, <span class=\"hljs-number\">4</span>], dtype=<span class=\"hljs-string\">&apos;float32&apos;</span>)  <span class=\"hljs-comment\"># &#x8fb9;&#x6846;</span>\n        gt_label = fluid.layers.data(name=<span class=\"hljs-string\">&apos;gt_label&apos;</span>, shape=[max_box_num], dtype=<span class=\"hljs-string\">&apos;int32&apos;</span>)  <span class=\"hljs-comment\"># &#x6807;&#x7b7e;</span>\n\n        feeder = fluid.DataFeeder(feed_list=[img, gt_box, gt_label],\n                                  place=place,\n                                  program=main_prog)  <span class=\"hljs-comment\"># &#x5b9a;&#x4e49;feeder</span>\n        reader = single_custom_reader(train_params[<span class=\"hljs-string\">&apos;train_list&apos;</span>],\n                                      train_params[<span class=\"hljs-string\">&apos;data_dir&apos;</span>],\n                                      yolo_config[<span class=\"hljs-string\">&apos;input_size&apos;</span>], <span class=\"hljs-string\">&apos;train&apos;</span>)  <span class=\"hljs-comment\"># &#x8bfb;&#x53d6;&#x5668;</span>\n        <span class=\"hljs-comment\"># &#x83b7;&#x53d6;yolo&#x53c2;&#x6570;</span>\n        ues_tiny = train_params[<span class=\"hljs-string\">&apos;use_tiny&apos;</span>]\n        yolo_config = train_params[<span class=\"hljs-string\">&apos;yolo_tiny_cfg&apos;</span>] <span class=\"hljs-keyword\">if</span> ues_tiny <span class=\"hljs-keyword\">else</span> train_params[<span class=\"hljs-string\">&apos;yolo_cfg&apos;</span>]\n\n        <span class=\"hljs-keyword\">with</span> fluid.unique_name.guard():\n            <span class=\"hljs-comment\"># &#x521b;&#x5efa;yolo&#x6a21;&#x578b;</span>\n            model = get_yolo(ues_tiny, train_params[<span class=\"hljs-string\">&apos;class_dim&apos;</span>], yolo_config[<span class=\"hljs-string\">&apos;anchors&apos;</span>],\n                             yolo_config[<span class=\"hljs-string\">&apos;anchor_mask&apos;</span>])\n            outputs = model.net(img)\n        <span class=\"hljs-keyword\">return</span> feeder, reader, get_loss(model, outputs, gt_box, gt_label)\n\n\n<span class=\"hljs-comment\"># &#x635f;&#x5931;&#x51fd;&#x6570;</span>\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">get_loss</span>(<span class=\"hljs-params\">model, outputs, gt_box, gt_label</span>):\n    losses = []\n    downsample_ratio = model.get_downsample_ratio()\n\n    <span class=\"hljs-keyword\">with</span> fluid.unique_name.guard(<span class=\"hljs-string\">&apos;train&apos;</span>):\n        <span class=\"hljs-keyword\">for</span> i, out <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">enumerate</span>(outputs):\n            loss = fluid.layers.yolov3_loss(x=out,\n                                            gt_box=gt_box,  <span class=\"hljs-comment\"># &#x771f;&#x5b9e;&#x8fb9;&#x6846;</span>\n                                            gt_label=gt_label,  <span class=\"hljs-comment\"># &#x6807;&#x7b7e;</span>\n                                            anchors=model.get_anchors(),  <span class=\"hljs-comment\"># &#x951a;&#x70b9;</span>\n                                            anchor_mask=model.get_anchor_mask()[i],\n                                            class_num=model.get_class_num(),\n                                            ignore_thresh=train_params[<span class=\"hljs-string\">&apos;ignore_thresh&apos;</span>],\n                                            <span class=\"hljs-comment\"># &#x5bf9;&#x4e8e;&#x7c7b;&#x522b;&#x4e0d;&#x591a;&#x7684;&#x60c5;&#x51b5;&#xff0c;&#x8bbe;&#x7f6e;&#x4e3a; False &#x4f1a;&#x66f4;&#x5408;&#x9002;&#x4e00;&#x4e9b;&#xff0c;&#x4e0d;&#x7136; score &#x4f1a;&#x5f88;&#x5c0f;</span>\n                                            use_label_smooth=<span class=\"hljs-literal\">False</span>,\n                                            downsample_ratio=downsample_ratio)\n            losses.append(fluid.layers.reduce_mean(loss))\n            downsample_ratio //= <span class=\"hljs-number\">2</span>\n\n        loss = <span class=\"hljs-built_in\">sum</span>(losses)\n        optimizer = optimizer_sgd_setting()\n        optimizer.minimize(loss)\n        <span class=\"hljs-keyword\">return</span> loss\n\n\n<span class=\"hljs-comment\"># &#x6301;&#x4e45;&#x5316;&#x53c2;&#x6570;&#x52a0;&#x8f7d;</span>\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">load_pretrained_params</span>(<span class=\"hljs-params\">exe, program</span>):\n    <span class=\"hljs-keyword\">if</span> train_params[<span class=\"hljs-string\">&apos;continue_train&apos;</span>] <span class=\"hljs-keyword\">and</span> os.path.exists(train_params[<span class=\"hljs-string\">&apos;save_model_dir&apos;</span>]):\n        logger.info(<span class=\"hljs-string\">&apos;load param from retrain model&apos;</span>)\n        fluid.io.load_persistables(executor=exe,\n                                   dirname=train_params[<span class=\"hljs-string\">&apos;save_model_dir&apos;</span>],\n                                   main_program=program) <span class=\"hljs-comment\"># &#x52a0;&#x8f7d;&#x589e;&#x91cf;&#x6a21;&#x578b;</span>\n    <span class=\"hljs-keyword\">elif</span> train_params[<span class=\"hljs-string\">&apos;pretrained&apos;</span>] <span class=\"hljs-keyword\">and</span> os.path.exists(train_params[<span class=\"hljs-string\">&apos;pretrained_model_dir&apos;</span>]):\n        logger.info(<span class=\"hljs-string\">&apos;load param from pretrained model&apos;</span>)\n\n        <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">if_exist</span>(<span class=\"hljs-params\">var</span>):\n            <span class=\"hljs-keyword\">return</span> os.path.exists(os.path.join(train_params[<span class=\"hljs-string\">&apos;pretrained_model_dir&apos;</span>], var.name))\n\n        fluid.io.load_vars(exe, train_params[<span class=\"hljs-string\">&apos;pretrained_model_dir&apos;</span>], main_program=program,\n                           predicate=if_exist)\n\n\n<span class=\"hljs-comment\"># &#x6267;&#x884c;&#x8bad;&#x7ec3;</span>\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">train</span>():\n    init_log_config() <span class=\"hljs-comment\"># &#x521d;&#x59cb;&#x5316;&#x65e5;&#x5fd7;</span>\n    init_train_parameters() <span class=\"hljs-comment\"># &#x521d;&#x59cb;&#x5316;&#x53c2;&#x6570;</span>\n\n    logger.info(<span class=\"hljs-string\">&quot;start train YOLOv3, train params:%s&quot;</span>, <span class=\"hljs-built_in\">str</span>(train_params))\n    logger.info(<span class=\"hljs-string\">&quot;create place, use gpu:&quot;</span> + <span class=\"hljs-built_in\">str</span>(train_params[<span class=\"hljs-string\">&apos;use_gpu&apos;</span>]))\n\n    place = fluid.CUDAPlace(<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">if</span> train_params[<span class=\"hljs-string\">&apos;use_gpu&apos;</span>] <span class=\"hljs-keyword\">else</span> fluid.CPUPlace() <span class=\"hljs-comment\"># &#x9009;&#x62e9;&#x8bbe;&#x5907;</span>\n\n    logger.info(<span class=\"hljs-string\">&quot;build network and program&quot;</span>)\n    <span class=\"hljs-comment\"># &#x521b;&#x5efa;&#x4e24;&#x4e2a;Program</span>\n    train_program = fluid.Program()\n    start_program = fluid.Program()\n    <span class=\"hljs-comment\"># &#x8bbe;&#x7f6e;main program&#x548c;startup program</span>\n    feeder, reader, loss = build_program_with_feeder(train_program, start_program, place)\n\n    logger.info(<span class=\"hljs-string\">&quot;build executor and init params&quot;</span>)\n\n    <span class=\"hljs-comment\"># &#x521b;&#x5efa;exe, &#x52a0;&#x8f7d;&#x589e;&#x91cf;&#x6a21;&#x578b;</span>\n    exe = fluid.Executor(place)\n    exe.run(start_program)\n    train_fetch_list = [loss.name]\n    load_pretrained_params(exe, train_program)  <span class=\"hljs-comment\"># &#x52a0;&#x8f7d;&#x6a21;&#x578b;&#x53ca;&#x53c2;&#x6570;</span>\n\n    stop_strategy = train_params[<span class=\"hljs-string\">&apos;early_stop&apos;</span>]\n    successive_limit = stop_strategy[<span class=\"hljs-string\">&apos;successive_limit&apos;</span>]\n    sample_freq = stop_strategy[<span class=\"hljs-string\">&apos;sample_frequency&apos;</span>]\n    min_curr_map = stop_strategy[<span class=\"hljs-string\">&apos;min_curr_map&apos;</span>]\n    min_loss = stop_strategy[<span class=\"hljs-string\">&apos;min_loss&apos;</span>]\n    stop_train = <span class=\"hljs-literal\">False</span>\n    successive_count = <span class=\"hljs-number\">0</span>\n    total_batch_count = <span class=\"hljs-number\">0</span>\n    valid_thresh = train_params[<span class=\"hljs-string\">&apos;valid_thresh&apos;</span>]\n    nms_thresh = train_params[<span class=\"hljs-string\">&apos;nms_thresh&apos;</span>]\n    current_best_loss = <span class=\"hljs-number\">10000000000.0</span>\n\n    <span class=\"hljs-comment\"># &#x5f00;&#x59cb;&#x8fed;&#x4ee3;&#x8bad;&#x7ec3;</span>\n    <span class=\"hljs-keyword\">for</span> pass_id <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(train_params[<span class=\"hljs-string\">&quot;num_epochs&quot;</span>]):\n        logger.info(<span class=\"hljs-string\">&quot;current pass: {}, start read image&quot;</span>.<span class=\"hljs-built_in\">format</span>(pass_id))\n        batch_id = <span class=\"hljs-number\">0</span>\n        total_loss = <span class=\"hljs-number\">0.0</span>\n\n        <span class=\"hljs-keyword\">for</span> batch_id, data <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">enumerate</span>(reader()):\n            t1 = time.time()\n\n            loss = exe.run(train_program,\n                           feed=feeder.feed(data),\n                           fetch_list=train_fetch_list)  <span class=\"hljs-comment\"># &#x6267;&#x884c;&#x8bad;&#x7ec3;</span>\n\n            period = time.time() - t1\n            loss = np.mean(np.array(loss))\n            total_loss += loss\n            batch_id += <span class=\"hljs-number\">1</span>\n            total_batch_count += <span class=\"hljs-number\">1</span>\n\n            <span class=\"hljs-keyword\">if</span> batch_id % <span class=\"hljs-number\">20</span> == <span class=\"hljs-number\">0</span>:  <span class=\"hljs-comment\"># &#x8c03;&#x6574;&#x65e5;&#x5fd7;&#x8f93;&#x51fa;&#x7684;&#x9891;&#x7387;</span>\n                logger.info(<span class=\"hljs-string\">&quot;pass {}, trainbatch {}, loss {} time {}&quot;</span>.<span class=\"hljs-built_in\">format</span>(pass_id, batch_id, loss, <span class=\"hljs-string\">&quot;%2.2f sec&quot;</span> % period))\n\n        pass_mean_loss = total_loss / batch_id\n        logger.info(<span class=\"hljs-string\">&quot;pass {0} train result, current pass mean loss: {1}&quot;</span>.<span class=\"hljs-built_in\">format</span>(pass_id, pass_mean_loss))\n\n        <span class=\"hljs-comment\"># &#x91c7;&#x7528;&#x6bcf;&#x8bad;&#x7ec3;&#x5b8c;&#x4e00;&#x8f6e;&#x505c;&#x6b62;&#x529e;&#x6cd5;&#xff0c;&#x53ef;&#x4ee5;&#x8c03;&#x6574;&#x4e3a;&#x66f4;&#x7cbe;&#x7ec6;&#x7684;&#x4fdd;&#x5b58;&#x7b56;&#x7565;</span>\n        <span class=\"hljs-keyword\">if</span> pass_mean_loss &lt; current_best_loss:\n            logger.info(<span class=\"hljs-string\">&quot;temp save {} epcho train result, current best pass loss {}&quot;</span>.<span class=\"hljs-built_in\">format</span>(pass_id, pass_mean_loss))\n            fluid.io.save_persistables(dirname=train_params[<span class=\"hljs-string\">&apos;save_model_dir&apos;</span>], main_program=train_program,\n                                       executor=exe)\n            current_best_loss = pass_mean_loss\n\n    logger.info(<span class=\"hljs-string\">&quot;training till last epcho, end training&quot;</span>)\n    fluid.io.save_persistables(dirname=train_params[<span class=\"hljs-string\">&apos;save_model_dir&apos;</span>], main_program=train_program, executor=exe)\n\n\n<span class=\"hljs-keyword\">if</span> __name__ == <span class=\"hljs-string\">&apos;__main__&apos;</span>:\n    train()\n\n<span class=\"hljs-comment\">###############################################################################</span>\n<span class=\"hljs-comment\"># &#x56fa;&#x5316;&#x4fdd;&#x5b58;&#x6a21;&#x578b;</span>\n<span class=\"hljs-keyword\">import</span> paddle\n<span class=\"hljs-keyword\">import</span> paddle.fluid <span class=\"hljs-keyword\">as</span> fluid\n<span class=\"hljs-keyword\">import</span> codecs\n\ninit_train_parameters()\n\n\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">freeze_model</span>():\n    exe = fluid.Executor(fluid.CPUPlace())\n\n    ues_tiny = train_params[<span class=\"hljs-string\">&apos;use_tiny&apos;</span>]\n    yolo_config = train_params[<span class=\"hljs-string\">&apos;yolo_tiny_cfg&apos;</span>] <span class=\"hljs-keyword\">if</span> ues_tiny <span class=\"hljs-keyword\">else</span> train_params[<span class=\"hljs-string\">&apos;yolo_cfg&apos;</span>]\n    path = train_params[<span class=\"hljs-string\">&apos;save_model_dir&apos;</span>]\n\n    model = get_yolo(ues_tiny, train_params[<span class=\"hljs-string\">&apos;class_dim&apos;</span>],\n                     yolo_config[<span class=\"hljs-string\">&apos;anchors&apos;</span>], yolo_config[<span class=\"hljs-string\">&apos;anchor_mask&apos;</span>])\n    image = fluid.layers.data(name=<span class=\"hljs-string\">&apos;image&apos;</span>, shape=yolo_config[<span class=\"hljs-string\">&apos;input_size&apos;</span>], dtype=<span class=\"hljs-string\">&apos;float32&apos;</span>)\n    image_shape = fluid.layers.data(name=<span class=\"hljs-string\">&quot;image_shape&quot;</span>, shape=[<span class=\"hljs-number\">2</span>], dtype=<span class=\"hljs-string\">&apos;int32&apos;</span>)\n\n    boxes = []\n    scores = []\n    outputs = model.net(image)\n    downsample_ratio = model.get_downsample_ratio()\n\n    <span class=\"hljs-keyword\">for</span> i, out <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">enumerate</span>(outputs):\n        box, score = fluid.layers.yolo_box(x=out,\n                                           img_size=image_shape,\n                                           anchors=model.get_yolo_anchors()[i],\n                                           class_num=model.get_class_num(),\n                                           conf_thresh=train_params[<span class=\"hljs-string\">&apos;valid_thresh&apos;</span>],\n                                           downsample_ratio=downsample_ratio,\n                                           name=<span class=\"hljs-string\">&quot;yolo_box_&quot;</span> + <span class=\"hljs-built_in\">str</span>(i))\n        boxes.append(box)\n        scores.append(fluid.layers.transpose(score, perm=[<span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">1</span>]))\n        downsample_ratio //= <span class=\"hljs-number\">2</span>\n\n    pred = fluid.layers.multiclass_nms(bboxes=fluid.layers.concat(boxes, axis=<span class=\"hljs-number\">1</span>),\n                                       scores=fluid.layers.concat(scores, axis=<span class=\"hljs-number\">2</span>),\n                                       score_threshold=train_params[<span class=\"hljs-string\">&apos;valid_thresh&apos;</span>],\n                                       nms_top_k=train_params[<span class=\"hljs-string\">&apos;nms_top_k&apos;</span>],\n                                       keep_top_k=train_params[<span class=\"hljs-string\">&apos;nms_pos_k&apos;</span>],\n                                       nms_threshold=train_params[<span class=\"hljs-string\">&apos;nms_thresh&apos;</span>],\n                                       background_label=-<span class=\"hljs-number\">1</span>,\n                                       name=<span class=\"hljs-string\">&quot;multiclass_nms&quot;</span>)\n\n    freeze_program = fluid.default_main_program()\n\n    fluid.io.load_persistables(exe, path, freeze_program)\n    freeze_program = freeze_program.clone(for_test=<span class=\"hljs-literal\">True</span>)\n    <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">&quot;freeze out: {0}, pred layout: {1}&quot;</span>.<span class=\"hljs-built_in\">format</span>(train_params[<span class=\"hljs-string\">&apos;freeze_dir&apos;</span>], pred))\n    <span class=\"hljs-comment\"># &#x4fdd;&#x5b58;&#x6a21;&#x578b;</span>\n    fluid.io.save_inference_model(train_params[<span class=\"hljs-string\">&apos;freeze_dir&apos;</span>],\n                                  [<span class=\"hljs-string\">&apos;image&apos;</span>, <span class=\"hljs-string\">&apos;image_shape&apos;</span>],\n                                  pred, exe, freeze_program)\n    <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">&quot;freeze end&quot;</span>)\n\n\n<span class=\"hljs-keyword\">if</span> __name__ == <span class=\"hljs-string\">&apos;__main__&apos;</span>:\n    freeze_model()\n\n<span class=\"hljs-comment\">######################################################################</span>\n<span class=\"hljs-comment\"># &#x9884;&#x6d4b;</span>\n<span class=\"hljs-keyword\">import</span> codecs\n<span class=\"hljs-keyword\">import</span> sys\n<span class=\"hljs-keyword\">import</span> numpy <span class=\"hljs-keyword\">as</span> np\n<span class=\"hljs-keyword\">import</span> time\n<span class=\"hljs-keyword\">import</span> paddle\n<span class=\"hljs-keyword\">import</span> paddle.fluid <span class=\"hljs-keyword\">as</span> fluid\n<span class=\"hljs-keyword\">import</span> math\n<span class=\"hljs-keyword\">import</span> functools\n\n<span class=\"hljs-keyword\">from</span> IPython.display <span class=\"hljs-keyword\">import</span> display\n<span class=\"hljs-keyword\">from</span> PIL <span class=\"hljs-keyword\">import</span> Image\n<span class=\"hljs-keyword\">from</span> PIL <span class=\"hljs-keyword\">import</span> ImageFont\n<span class=\"hljs-keyword\">from</span> PIL <span class=\"hljs-keyword\">import</span> ImageDraw\n<span class=\"hljs-keyword\">from</span> collections <span class=\"hljs-keyword\">import</span> namedtuple\n\ninit_train_parameters()\nues_tiny = train_params[<span class=\"hljs-string\">&apos;use_tiny&apos;</span>]\nyolo_config = train_params[<span class=\"hljs-string\">&apos;yolo_tiny_cfg&apos;</span>] <span class=\"hljs-keyword\">if</span> ues_tiny <span class=\"hljs-keyword\">else</span> train_params[<span class=\"hljs-string\">&apos;yolo_cfg&apos;</span>]\n\ntarget_size = yolo_config[<span class=\"hljs-string\">&apos;input_size&apos;</span>]\nanchors = yolo_config[<span class=\"hljs-string\">&apos;anchors&apos;</span>]\nanchor_mask = yolo_config[<span class=\"hljs-string\">&apos;anchor_mask&apos;</span>]\nlabel_dict = train_params[<span class=\"hljs-string\">&apos;num_dict&apos;</span>]\nclass_dim = train_params[<span class=\"hljs-string\">&apos;class_dim&apos;</span>]\n<span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">&quot;label_dict:{} class dim:{}&quot;</span>.<span class=\"hljs-built_in\">format</span>(label_dict, class_dim))\n\nplace = fluid.CUDAPlace(<span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">if</span> train_params[<span class=\"hljs-string\">&apos;use_gpu&apos;</span>] <span class=\"hljs-keyword\">else</span> fluid.CPUPlace()\nexe = fluid.Executor(place)\n\npath = train_params[<span class=\"hljs-string\">&apos;freeze_dir&apos;</span>]\n[inference_program, feed_target_names, fetch_targets] = \\\n    fluid.io.load_inference_model(dirname=path, executor=exe)\n\n\n<span class=\"hljs-comment\"># &#x7ed9;&#x56fe;&#x7247;&#x753b;&#x4e0a;&#x5916;&#x63a5;&#x77e9;&#x5f62;&#x6846;</span>\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">draw_bbox_image</span>(<span class=\"hljs-params\">img, boxes, labels, save_name</span>):\n    img_width, img_height = img.size\n\n    draw = ImageDraw.Draw(img)  <span class=\"hljs-comment\"># &#x56fe;&#x50cf;&#x7ed8;&#x5236;&#x5bf9;&#x8c61;</span>\n    <span class=\"hljs-keyword\">for</span> box, label <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">zip</span>(boxes, labels):\n        xmin, ymin, xmax, ymax = box[<span class=\"hljs-number\">0</span>], box[<span class=\"hljs-number\">1</span>], box[<span class=\"hljs-number\">2</span>], box[<span class=\"hljs-number\">3</span>]\n        draw.rectangle((xmin, ymin, xmax, ymax), <span class=\"hljs-literal\">None</span>, <span class=\"hljs-string\">&apos;red&apos;</span>)  <span class=\"hljs-comment\"># &#x7ed8;&#x5236;&#x77e9;&#x5f62;</span>\n        draw.text((xmin, ymin), label_dict[<span class=\"hljs-built_in\">int</span>(label)], (<span class=\"hljs-number\">255</span>, <span class=\"hljs-number\">255</span>, <span class=\"hljs-number\">0</span>))  <span class=\"hljs-comment\"># &#x7ed8;&#x5236;&#x6807;&#x7b7e;</span>\n    img.save(save_name)\n    display(img)\n\n\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">resize_img</span>(<span class=\"hljs-params\">img, target_size</span>):\n    <span class=\"hljs-string\">&quot;&quot;&quot;\n    &#x4fdd;&#x6301;&#x6bd4;&#x4f8b;&#x7684;&#x7f29;&#x653e;&#x56fe;&#x7247;\n    :param img:\n    :param target_size:\n    :return:\n    &quot;&quot;&quot;</span>\n    img = img.resize(target_size[<span class=\"hljs-number\">1</span>:], Image.BILINEAR)\n    <span class=\"hljs-keyword\">return</span> img\n\n\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">read_image</span>(<span class=\"hljs-params\">img_path</span>):\n    <span class=\"hljs-string\">&quot;&quot;&quot;\n    &#x8bfb;&#x53d6;&#x56fe;&#x7247;\n    :param img_path:\n    :return:\n    &quot;&quot;&quot;</span>\n    origin = Image.<span class=\"hljs-built_in\">open</span>(img_path)\n    img = resize_img(origin, target_size)\n    resized_img = img.copy()\n    <span class=\"hljs-keyword\">if</span> img.mode != <span class=\"hljs-string\">&apos;RGB&apos;</span>:\n        img = img.convert(<span class=\"hljs-string\">&apos;RGB&apos;</span>)\n    img = np.array(img).astype(<span class=\"hljs-string\">&apos;float32&apos;</span>).transpose((<span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">1</span>))  <span class=\"hljs-comment\"># HWC to CHW</span>\n    img -= <span class=\"hljs-number\">127.5</span>\n    img *= <span class=\"hljs-number\">0.007843</span>\n    img = img[np.newaxis, :]\n    <span class=\"hljs-keyword\">return</span> origin, img, resized_img\n\n\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">infer</span>(<span class=\"hljs-params\">image_path</span>):\n    <span class=\"hljs-string\">&quot;&quot;&quot;\n    &#x9884;&#x6d4b;&#xff0c;&#x5c06;&#x7ed3;&#x679c;&#x4fdd;&#x5b58;&#x5230;&#x4e00;&#x526f;&#x65b0;&#x7684;&#x56fe;&#x7247;&#x4e2d;\n    :param image_path:\n    :return:\n    &quot;&quot;&quot;</span>\n    origin, tensor_img, resized_img = read_image(image_path)\n    input_w, input_h = origin.size[<span class=\"hljs-number\">0</span>], origin.size[<span class=\"hljs-number\">1</span>]\n    image_shape = np.array([input_h, input_w], dtype=<span class=\"hljs-string\">&apos;int32&apos;</span>)\n    <span class=\"hljs-comment\"># print(&quot;image shape high:{0}, width:{1}&quot;.format(input_h, input_w))</span>\n\n    t1 = time.time()\n    <span class=\"hljs-comment\"># &#x6267;&#x884c;&#x9884;&#x6d4b;</span>\n    batch_outputs = exe.run(inference_program,\n                            feed={feed_target_names[<span class=\"hljs-number\">0</span>]: tensor_img,\n                                  feed_target_names[<span class=\"hljs-number\">1</span>]: image_shape[np.newaxis, :]},\n                            fetch_list=fetch_targets,\n                            return_numpy=<span class=\"hljs-literal\">False</span>)\n    period = time.time() - t1\n    <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">&quot;predict cost time:{0}&quot;</span>.<span class=\"hljs-built_in\">format</span>(<span class=\"hljs-string\">&quot;%2.2f sec&quot;</span> % period))\n    bboxes = np.array(batch_outputs[<span class=\"hljs-number\">0</span>])  <span class=\"hljs-comment\"># &#x9884;&#x6d4b;&#x7ed3;&#x679c;</span>\n    <span class=\"hljs-comment\"># print(bboxes)</span>\n\n    <span class=\"hljs-keyword\">if</span> bboxes.shape[<span class=\"hljs-number\">1</span>] != <span class=\"hljs-number\">6</span>:\n        <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">&quot;No object found in {}&quot;</span>.<span class=\"hljs-built_in\">format</span>(image_path))\n        <span class=\"hljs-keyword\">return</span>\n    labels = bboxes[:, <span class=\"hljs-number\">0</span>].astype(<span class=\"hljs-string\">&apos;int32&apos;</span>)  <span class=\"hljs-comment\"># &#x7c7b;&#x522b;</span>\n    scores = bboxes[:, <span class=\"hljs-number\">1</span>].astype(<span class=\"hljs-string\">&apos;float32&apos;</span>)  <span class=\"hljs-comment\"># &#x6982;&#x7387;</span>\n    boxes = bboxes[:, <span class=\"hljs-number\">2</span>:].astype(<span class=\"hljs-string\">&apos;float32&apos;</span>)  <span class=\"hljs-comment\"># &#x8fb9;&#x6846;</span>\n\n    last_dot_index = image_path.rfind(<span class=\"hljs-string\">&apos;.&apos;</span>)\n    out_path = image_path[:last_dot_index]\n    out_path += <span class=\"hljs-string\">&apos;-result.jpg&apos;</span>\n    draw_bbox_image(origin, boxes, labels, out_path)\n\n\n<span class=\"hljs-keyword\">if</span> __name__ == <span class=\"hljs-string\">&apos;__main__&apos;</span>:\n    image_name = sys.argv[<span class=\"hljs-number\">1</span>]\n    image_path = image_name\n    image_path = <span class=\"hljs-string\">&quot;data/data6045/lslm-test/2.jpg&quot;</span>\n    infer(image_path)\n\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"267,1469"}}],"payload":{"tag":"h5","lines":"4,5"}}],"payload":{"tag":"h3","lines":"0,1"}},{})</script>
</body>
</html>
