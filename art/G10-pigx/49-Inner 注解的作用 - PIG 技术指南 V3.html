<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.10/dist/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.11.1/styles/default.min.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.18.10/dist/browser/index.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.10/dist/index.js"></script><script>(r => {
              setTimeout(r);
            })(function renderToolbar() {
  const {
    markmap,
    mm
  } = window;
  const {
    el
  } = markmap.Toolbar.create(mm);
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, root2, jsonOptions) => {
              const markmap = getMarkmap();
              window.mm = markmap.Markmap.create(
                "svg#mindmap",
                (getOptions || markmap.deriveOptions)(jsonOptions),
                root2
              );
            })(() => window.markmap,null,{"content":"","children":[{"content":"Inner &#x6ce8;&#x89e3;&#x7684;&#x4f5c;&#x7528;","children":[{"content":"<pre data-lines=\"3,10\"><code>Pig &#x4e2d; Url &#x7684;&#x8bbf;&#x95ee;&#x5927;&#x81f4;&#x5206;&#x4e3a;&#x4e24;&#x79cd;&#xff0c;&#x4e00;&#x79cd;&#x662f;&#x7531; Gateway &#x7f51;&#x5173;&#x4ece;&#x5916;&#x7f51;&#x8def;&#x7531;&#x8fdb;&#x6765;&#xff0c;&#x4e00;&#x79cd;&#x662f;&#x5185;&#x7f51;&#x901a;&#x8fc7; Feign &#x8fdb;&#x884c;&#x5185;&#x90e8;&#x670d;&#x52a1;&#x8c03;&#x7528;&#x3002;&#x90a3;&#x6211;&#x4eec;&#x7ed3;&#x5408; Security &#x5c31;&#x5b58;&#x5728;&#x4ee5;&#x4e0b;&#x51e0;&#x79cd;&#x5e94;&#x7528;&#x573a;&#x666f;&#xff1a;\n\n1.  &#x5916;&#x90e8;&#x4ece; Gateway &#x8bbf;&#x95ee;&#xff0c;&#x9700;&#x8981;&#x9274;&#x6743;&#xff08;eg.CURD &#x64cd;&#x4f5c;&#xff09;&#x3002;&#x8fd9;&#x79cd;&#x662f;&#x6700;&#x5e38;&#x4f7f;&#x7528;&#x7684;&#xff0c;&#x7528;&#x6237;&#x767b;&#x5f55;&#x540e;&#x6b63;&#x5e38;&#x8bbf;&#x95ee;&#x63a5;&#x53e3;&#xff0c;&#x4e0d;&#x9700;&#x8981;&#x6211;&#x4eec;&#x505a;&#x4ec0;&#x4e48;&#x5904;&#x7406;&#xff08;&#x53ef;&#x80fd;&#x6709;&#x7684;&#x63a5;&#x53e3;&#x9700;&#x8981;&#x52a0;&#x6743;&#x9650;&#x5b57;&#x6bb5;&#xff09;&#x3002;\n2.  &#x5916;&#x90e8;&#x4ece; Gateway &#x8bbf;&#x95ee;&#xff0c;&#x4e0d;&#x9700;&#x8981;&#x9274;&#x6743;&#xff08;eg.&#x77ed;&#x4fe1;&#x9a8c;&#x8bc1;&#x7801;&#xff09;&#x3002;&#x9700;&#x8981;&#x6211;&#x4eec;&#x5c06; uri &#x52a0;&#x5165;&#x5230; security.oauth2.client.ignore-urls &#x914d;&#x7f6e;&#x4e2d;&#xff0c;&#x53ef;&#x4ee5;&#x4e0d;&#x9700;&#x8981;&#x9274;&#x6743;&#x8bbf;&#x95ee;\n3.  &#x5185;&#x90e8;&#x670d;&#x52a1;&#x95f4;&#x7528; Feign &#x8bbf;&#x95ee;&#xff0c;&#x4e0d;&#x9700;&#x8981;&#x9274;&#x6743;&#xff08;eg.Auth &#x67e5;&#x8be2;&#x7528;&#x6237;&#x4fe1;&#x606f;&#xff09;&#x3002;&#x4e5f;&#x662f;&#x9700;&#x8981;&#x6211;&#x4eec;&#x5c06; uri &#x52a0;&#x5165;&#x5230; security.oauth2.client.ignore-urls &#x914d;&#x7f6e;&#x4e2d;&#xff0c;&#x90a3;&#x4e0e;&#x7b2c;&#x4e8c;&#x79cd;&#x7684;&#x533a;&#x522b;&#x5c31;&#x662f;&#x8fd9;&#x79cd;&#x60c5;&#x51b5;&#x4e0b;&#x5927;&#x591a;&#x6570;&#x90fd;&#x662f;&#x670d;&#x52a1;&#x53ef;&#x4ee5;&#x8bf7;&#x6c42;&#x53e6;&#x4e00;&#x4e2a;&#x670d;&#x52a1;&#x7684;&#x6240;&#x6709;&#x6570;&#x636e;&#xff0c;&#x4e0d;&#x53d7;&#x7ea6;&#x675f;&#xff0c;&#x90a3;&#x6211;&#x4eec;&#x5982;&#x679c;&#x4ec5;&#x4ec5;&#x53ea;&#x914d;&#x7f6e; ignore-url &#x7684;&#x8bdd;&#xff0c;&#x5916;&#x90e8;&#x6240;&#x6709;&#x4eba;&#x90fd;&#x53ef;&#x4ee5;&#x901a;&#x8fc7; url &#x8bf7;&#x6c42;&#x5230;&#x6211;&#x4eec;&#x5185;&#x90e8;&#x7684;&#x94fe;&#x63a5;&#xff0c;&#x5b89;&#x5168;&#x8fbe;&#x4e0d;&#x5230;&#x4fdd;&#x969c;&#x3002;\n\n&#x9274;&#x4e8e;&#x4e0a;&#x8ff0;&#x7b2c;&#x4e09;&#x79cd;&#x60c5;&#x51b5;&#xff0c;&#x6211;&#x4eec;&#x914d;&#x7f6e;&#x4e86; ignore-url &#x548c; Feign&#xff0c;&#x6b64;&#x65f6;&#x8be5;&#x63a5;&#x53e3;&#x4e0d;&#x9700;&#x8981;&#x9274;&#x6743;&#xff0c;&#x670d;&#x52a1;&#x5185;&#x90e8;&#x901a;&#x8fc7; Feign &#x8bbf;&#x95ee;&#xff0c;&#x670d;&#x52a1;&#x5916;&#x90e8;&#x901a;&#x8fc7; url &#x4e5f;&#x53ef;&#x4ee5;&#x8bbf;&#x95ee;&#xff0c;&#x6240;&#x4ee5; Pig &#x4e2d;&#xff0c;&#x52a0;&#x5165;&#x4e86;&#x4e00;&#x79cd;`@RequestHeader(SecurityConstants.FROM)`&#x7684;&#x5904;&#x7406;&#x65b9;&#x5f0f;&#x3002;&#x5373;&#x5728;&#x63a5;&#x53e3;&#x65b9;&#x6cd5;&#x4e2d;&#xff0c;&#x5bf9;&#x5934;&#x90e8;&#x8fdb;&#x884c;&#x5224;&#x65ad;&#xff0c;&#x53ea;&#x6709;&#x8bf7;&#x6c42;&#x5e26;&#x4e0a;&#x76f8;&#x5e94;&#x7684; Header &#x53c2;&#x6570;&#x65f6;&#xff0c;&#x624d;&#x5141;&#x8bb8;&#x901a;&#x8fc7;&#x8bbf;&#x95ee;&#xff0c;&#x5426;&#x5219;&#x629b;&#x51fa;&#x5f02;&#x5e38;&#x3002;&#x90a3;&#x8fd9;&#x65f6;&#x5019;&#x5176;&#x5b9e;&#x6211;&#x4eec;&#x5728;&#x5916;&#x7f51;&#x901a;&#x8fc7; Gateway &#x8bbf;&#x95ee;&#x7684;&#x65f6;&#x5019;&#xff0c;&#x4e5f;&#x53ef;&#x4ee5;&#x624b;&#x52a8;&#x5e26;&#x4e0a;&#x8fd9;&#x4e2a; Header &#x53c2;&#x6570;&#xff0c;&#x6765;&#x8fbe;&#x5230;&#x8fd9;&#x4e2a;&#x76ee;&#x7684;&#x3002;&#x6240;&#x4ee5;&#x6211;&#x4eec;&#x4fbf;&#x5728; Gateway &#x4e2d;&#x8bbe;&#x7f6e;&#x4e86;&#x4e00;&#x4e2a; GlobalFilter &#x8fc7;&#x6ee4;&#x5668;&#xff0c;&#x5bf9;&#x6765;&#x81ea;&#x5916;&#x7f51;&#x901a;&#x8fc7; Gateway &#x624b;&#x52a8;&#x62fc;&#x63a5;&#x7684;&#x53c2;&#x6570;&#x8fdb;&#x884c;&#x8fc7;&#x6ee4;&#x4e0e;&#x6e05;&#x6d17;&#xff0c;&#x5177;&#x4f53;&#x4ee3;&#x7801;&#x89c1; com.pig4cloud.pig.gateway.filter.PigRequestGlobalFilter&#xff1a;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"3,10"}},{"content":"<pre data-lines=\"13,31\"><code data-lines=\"13,31\"> @Override\n public Mono&lt;Void&gt; filter<span class=\"hljs-params\">(ServerWebExchange exchange, GatewayFilterChain chain)</span> {\n <span class=\"hljs-string\">//</span> 1. &#x6e05;&#x6d17;&#x8bf7;&#x6c42;&#x5934;&#x4e2d; from &#x53c2;&#x6570;\n ServerHttpRequest request = exchange.getRequest<span class=\"hljs-params\">()</span><span class=\"hljs-string\">.mutate</span><span class=\"hljs-params\">()</span>\n <span class=\"hljs-string\">.headers</span><span class=\"hljs-params\">(httpHeaders -&gt; httpHeaders.remove(SecurityConstants.FROM)</span>)<span class=\"hljs-string\">.build</span><span class=\"hljs-params\">()</span>;\n\n <span class=\"hljs-string\">//</span> 2. &#x91cd;&#x5199; StripPrefix\n addOriginalRequestUrl<span class=\"hljs-params\">(exchange, request.getURI()</span>);\n String rawPath = request.getURI<span class=\"hljs-params\">()</span><span class=\"hljs-string\">.getRawPath</span><span class=\"hljs-params\">()</span>;\n String newPath = <span class=\"hljs-string\">&quot;/&quot;</span> + Arrays.stream<span class=\"hljs-params\">(StringUtils.tokenizeToStringArray(rawPath, &quot;/&quot;)</span>)<span class=\"hljs-string\">.skip</span><span class=\"hljs-params\">(1L)</span>\n <span class=\"hljs-string\">.collect</span><span class=\"hljs-params\">(Collectors.joining(&quot;/&quot;)</span>);\n ServerHttpRequest newRequest = request.mutate<span class=\"hljs-params\">()</span><span class=\"hljs-string\">.path</span><span class=\"hljs-params\">(newPath)</span><span class=\"hljs-string\">.build</span><span class=\"hljs-params\">()</span>;\n exchange.getAttributes<span class=\"hljs-params\">()</span><span class=\"hljs-string\">.put</span><span class=\"hljs-params\">(GATEWAY_REQUEST_URL_ATTR, newRequest.getURI()</span>);\n\n return chain.filter<span class=\"hljs-params\">(exchange.mutate()</span><span class=\"hljs-string\">.request</span><span class=\"hljs-params\">(newRequest.mutate()</span><span class=\"hljs-string\">.build</span><span class=\"hljs-params\">()</span>)<span class=\"hljs-string\">.build</span><span class=\"hljs-params\">()</span>);\n } \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"13,31"}}],"payload":{"tag":"h1","lines":"0,2"}},{"content":"Inner &#x7684;&#x5904;&#x7406;&#x6d41;&#x7a0b;","children":[{"content":"&#x7edf;&#x4e00;&#x7684; ignore-url &#x5904;&#x7406;","children":[{"content":"<pre data-lines=\"41,42\"><code>&#x9996;&#x5148;&#x6211;&#x4eec;&#x6765;&#x770b;&#x770b;&#x8fd9;&#x4e2a;&#x6ce8;&#x89e3;&#x7684;&#x4ee3;&#x7801;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"41,42"}},{"content":"<pre data-lines=\"45,65\"><code data-lines=\"45,65\"><span class=\"hljs-variable\">@Target</span>({ElementType.METHOD, ElementType.TYPE})\n<span class=\"hljs-variable\">@Retention</span>(RetentionPolicy.RUNTIME)\n<span class=\"hljs-variable\">@Documented</span>\npublic <span class=\"hljs-variable\">@interface</span> Inner {\n <span class=\"hljs-comment\">/**\n * &#x662f;&#x5426; AOP &#x7edf;&#x4e00;&#x5904;&#x7406; (&#x53ef;&#x4ee5;&#x7406;&#x89e3;&#x4e3a;&#x662f;&#x5426;&#x4ec5;&#x5141;&#x8bb8; Feign &#x4e4b;&#x95f4;&#x8c03;&#x7528;)\n *\n * @return false, true\n */</span>\n <span class=\"hljs-selector-tag\">boolean</span> <span class=\"hljs-selector-tag\">value</span>() <span class=\"hljs-selector-tag\">default</span> <span class=\"hljs-selector-tag\">true</span>;\n\n <span class=\"hljs-comment\">/**\n * &#x9700;&#x8981;&#x7279;&#x6b8a;&#x5224;&#x7a7a;&#x7684;&#x5b57;&#x6bb5; (&#x9884;&#x7559;)\n *\n * @return {}\n */</span>\n <span class=\"hljs-selector-tag\">String</span><span class=\"hljs-selector-attr\">[]</span> <span class=\"hljs-selector-tag\">field</span>() <span class=\"hljs-selector-tag\">default</span> {};\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"45,65"}},{"content":"<pre data-lines=\"66,67\"><code>&#x9996;&#x5148;&#xff0c;&#x5728;&#x6211;&#x4eec;&#x9879;&#x76ee;&#x52a0;&#x8f7d;&#x9636;&#x6bb5;&#xff0c;&#x6211;&#x4eec;&#x83b7;&#x53d6;&#x6709; Inner &#x6ce8;&#x89e3;&#x7684;&#x7c7b;&#x548c;&#x65b9;&#x6cd5;&#xff0c;&#x7136;&#x540e;&#x83b7;&#x53d6;&#x6211;&#x4eec;&#x914d;&#x7f6e;&#x7684; uri&#xff0c;&#x7ecf;&#x8fc7;&#x6b63;&#x5219;&#x66ff;&#x6362;&#x540e;&#x9762;&#x7684;&#x53ef;&#x53d8;&#x53c2;&#x6570;&#x4e3a;\\*&#xff0c;&#x7136;&#x540e;&#x5c06;&#x6b64; uri &#x52a0;&#x5165;&#x5230; ignore-url &#x4e2d;&#x3002;&#x6b64;&#x65f6;&#x6211;&#x4eec;&#x5c31;&#x80fd;&#x8fbe;&#x5230;&#x6240;&#x6709; Inner &#x914d;&#x7f6e;&#x7684;&#x65b9;&#x6cd5;/&#x7c7b;&#x4e0a;&#x7684;&#x63a5;&#x53e3;&#x5730;&#x5740;&#xff0c;&#x90fd;&#x7edf;&#x4e00;&#x5728;&#x9879;&#x76ee;&#x52a0;&#x8f7d;&#x9636;&#x6bb5;&#x81ea;&#x52a8;&#x5e2e;&#x6211;&#x4eec;&#x52a0;&#x5230; ignore-url &#x4e2d;&#xff0c;&#x4e0d;&#x9700;&#x8981;&#x6211;&#x4eec;&#x624b;&#x52a8;&#x914d;&#x7f6e;&#xff0c;&#x514d;&#x53bb;&#x4e86;&#x5f88;&#x591a;&#x5f00;&#x53d1;&#x5de5;&#x4f5c;&#xff0c;&#x540c;&#x65f6;&#x4e5f;&#x80fd;&#x907f;&#x514d;&#x6211;&#x4eec;&#x5fd8;&#x8bb0;&#x914d;&#x7f6e;&#xff0c;&#x800c;&#x6d6a;&#x8d39;&#x5f00;&#x53d1;&#x65f6;&#x95f4;&#x3002;&#x6838;&#x5fc3;&#x4ee3;&#x7801;&#x5982;&#x4e0b;&#xff1a;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"66,67"}},{"content":"<pre data-lines=\"70,102\"><code data-lines=\"70,102\">@Slf4j\n@<span class=\"hljs-keyword\">Configuration</span>\n@ConditionalOnExpression(&quot;!&apos;&#x24;{security.oauth2.client.ignore-urls}&apos;.isEmpty()&quot;)\n@ConfigurationProperties(prefix = &quot;security.oauth2.client&quot;)\n<span class=\"hljs-built_in\">public</span> <span class=\"hljs-keyword\">class</span> PermitAllUrlProperties implements InitializingBean {\n private static final Pattern PATTERN = Pattern.compile(&quot;\\\\{(.*?)\\\\}&quot;);\n @Autowired\n private WebApplicationContext applicationContext;\n @Getter\n @Setter\n private List&lt;String&gt; ignoreUrls = <span class=\"hljs-built_in\">new</span> ArrayList&lt;&gt;();\n @Override\n <span class=\"hljs-built_in\">public</span> <span class=\"hljs-type\">void</span> afterPropertiesSet() {\n RequestMappingHandlerMapping <span class=\"hljs-keyword\">mapping</span> = applicationContext.getBean(RequestMappingHandlerMapping.<span class=\"hljs-keyword\">class</span>);\n Map&lt;RequestMappingInfo, HandlerMethod&gt; map = <span class=\"hljs-keyword\">mapping</span>.getHandlerMethods();\n map.keySet().<span class=\"hljs-keyword\">forEach</span>(<span class=\"hljs-keyword\">info</span> -&gt; {\n HandlerMethod handlerMethod = map.<span class=\"hljs-keyword\">get</span>(<span class=\"hljs-keyword\">info</span>);\n // &#x83b7;&#x53d6;&#x65b9;&#x6cd5;&#x4e0a;&#x8fb9;&#x7684;&#x6ce8;&#x89e3; &#x66ff;&#x4ee3; <span class=\"hljs-type\">path</span> variable &#x4e3a; *\n <span class=\"hljs-keyword\">Inner</span> <span class=\"hljs-keyword\">method</span> = AnnotationUtils.findAnnotation(handlerMethod.getMethod(), <span class=\"hljs-keyword\">Inner</span>.<span class=\"hljs-keyword\">class</span>);\n Optional.ofNullable(<span class=\"hljs-keyword\">method</span>)\n .ifPresent(<span class=\"hljs-keyword\">inner</span> -&gt; <span class=\"hljs-keyword\">info</span>.getPatternsCondition().getPatterns()\n .<span class=\"hljs-keyword\">forEach</span>(url -&gt; ignoreUrls.<span class=\"hljs-keyword\">add</span>(ReUtil.replaceAll(url, PATTERN, StringPool.ASTERISK))));\n // &#x83b7;&#x53d6;&#x7c7b;&#x4e0a;&#x8fb9;&#x7684;&#x6ce8;&#x89e3;&#xff0c;&#x66ff;&#x4ee3; <span class=\"hljs-type\">path</span> variable &#x4e3a; *\n <span class=\"hljs-keyword\">Inner</span> controller = AnnotationUtils.findAnnotation(handlerMethod.getBeanType(), <span class=\"hljs-keyword\">Inner</span>.<span class=\"hljs-keyword\">class</span>);\n Optional.ofNullable(controller)\n .ifPresent(<span class=\"hljs-keyword\">inner</span> -&gt; <span class=\"hljs-keyword\">info</span>.getPatternsCondition().getPatterns()\n .<span class=\"hljs-keyword\">forEach</span>(url -&gt; ignoreUrls.<span class=\"hljs-keyword\">add</span>(ReUtil.replaceAll(url, PATTERN, StringPool.ASTERISK))));\n });\n }\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"70,102"}}],"payload":{"tag":"h2","lines":"38,40"}},{"content":"&#x7edf;&#x4e00;&#x7684;&#x5b89;&#x5168;&#x6027;&#x5904;&#x7406;","children":[{"content":"<pre data-lines=\"108,111\"><code>&#x90a3;&#x4e0a;&#x9762;&#x8bb2;&#x5230;&#x7684;&#xff0c;&#x5982;&#x679c;&#x6211;&#x4eec;&#x4e0d;&#x5e0c;&#x671b;&#x8fd9;&#x4e2a; url &#x53ef;&#x4ee5;&#x76f4;&#x63a5;&#x88ab;&#x5916;&#x7f51;&#x8c03;&#x7528;&#xff0c;&#x4ec5;&#x80fd;&#x5728; Feign &#x670d;&#x52a1;&#x4e2d;&#x8c03;&#x7528;&#xff0c;&#x8be5;&#x5982;&#x4f55;&#x7edf;&#x4e00;&#x5904;&#x7406;&#x5462;&#xff1f;\n\n&#x6211;&#x4eec;&#x4f7f;&#x7528;&#x4e00;&#x4e2a; Spring-AOP&#xff0c;&#x5728;&#x5bf9;&#x6240;&#x6709; Inner &#x6ce8;&#x89e3;&#x7684;&#x65b9;&#x6cd5;&#x505a;&#x4e00;&#x4e2a;&#x73af;&#x7ed5;&#x589e;&#x5f3a;&#x7684;&#x5207;&#x70b9;&#xff0c;&#x8fdb;&#x884c;&#x7edf;&#x4e00;&#x7684;&#x5904;&#x7406;&#x3002;&#x5728;&#x4e0a;&#x9762;&#x6211;&#x4eec;&#x63d0;&#x5230;&#x7684; Inner &#x7684; value &#x53c2;&#x6570;&#xff0c;&#x5f53;&#x8be5;&#x53c2;&#x6570;&#x4e3a; true &#x65f6;&#xff0c;&#x6211;&#x4eec;&#x5bf9;&#x65b9;&#x6cd5;&#x7684;&#x5165;&#x53c2;&#x8fdb;&#x884c;&#x5224;&#x65ad;&#xff0c;&#x4ec5;&#x5f53;&#x7b26;&#x5408;&#x6211;&#x4eec;&#x5b9a;&#x5236;&#x7684;&#x5165;&#x53c2;&#x89c4;&#x5219;&#x65f6;&#xff08;Pigx &#x8fd9;&#x91cc;&#x662f;&#x7528;&#x7684;`@RequestHeader(SecurityConstants.FROM)` &#x4e0e;`SecurityConstants.FROM_IN`&#x505a;&#x6bd4;&#x8f83;&#xff09;,&#x6211;&#x4eec;&#x5bf9;&#x5b83;&#x8fdb;&#x884c;&#x653e;&#x884c;&#xff0c;&#x4e0d;&#x7b26;&#x5408;&#x65f6;&#xff0c;&#x629b;&#x51fa;&#x5f02;&#x5e38;&#xff1b;&#x5f53; value &#x4e3a; false &#x65f6;&#xff0c;&#x54b1;&#x4e0d;&#x505a;&#x4efb;&#x4f55;&#x5904;&#x7406;&#xff0c;&#x6b64;&#x65f6; Inner &#x4ec5;&#x8d77;&#x5230;&#x4e86;&#x4e00;&#x4e2a; ignore-url &#x7684;&#x4f5c;&#x7528;&#x3002;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"108,111"}},{"content":"<pre data-lines=\"114,133\"><code data-lines=\"114,133\"><span class=\"hljs-meta\">@Slf4j</span>\n<span class=\"hljs-meta\">@Aspect</span>\n<span class=\"hljs-meta\">@AllArgsConstructor</span>\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">PigSecurityInnerAspect</span> {\n <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">final</span> HttpServletRequest request;\n\n <span class=\"hljs-meta\">@SneakyThrows</span>\n <span class=\"hljs-meta\">@Around(<span class=\"hljs-string\">&quot;@annotation(inner)&quot;</span>)</span>\n <span class=\"hljs-keyword\">public</span> Object around(ProceedingJoinPoint point, Inner <span class=\"hljs-keyword\">inner</span>) {\n String header = request.getHeader(SecurityConstants.FROM);\n <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">inner</span>.value() &amp;&amp; !StrUtil.equals(SecurityConstants.FROM_IN, header)) {\n log.warn(<span class=\"hljs-string\">&quot;&#x8bbf;&#x95ee;&#x63a5;&#x53e3; {} &#x6ca1;&#x6709;&#x6743;&#x9650;&quot;</span>, point.getSignature().getName());\n <span class=\"hljs-keyword\">throw</span> new AccessDeniedException(<span class=\"hljs-string\">&quot;Access is denied&quot;</span>);\n }\n <span class=\"hljs-keyword\">return</span> point.proceed();\n }\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"114,133"}},{"content":"<pre data-lines=\"134,135\"><code>&#x901a;&#x8fc7;&#x8fd9;&#x4e24;&#x6b65;&#x5462;&#xff0c;&#x6211;&#x4eec;&#x9996;&#x5148;&#x662f;&#x5728;&#x52a0;&#x8f7d;&#x65f6;&#x901a;&#x8fc7;&#x627e;&#x5230; Inner &#x6ce8;&#x89e3;&#xff0c;&#x5c06;&#x76f8;&#x5e94;&#x7684; uri &#x52a0;&#x5165;&#x5230; ignore-url &#x4e2d;&#xff0c;&#x8fbe;&#x5230;&#x81ea;&#x52a8;&#x5316;&#x914d;&#x7f6e;&#x7684;&#x76ee;&#x7684;&#xff1b;&#x4e4b;&#x540e;&#x6211;&#x4eec;&#x53c8;&#x4f7f;&#x7528;&#x5207;&#x9762;&#x5bf9; Inner &#x7684;&#x65b9;&#x6cd5;&#x8fdb;&#x884c;&#x73af;&#x7ed5;&#x5904;&#x7406;&#xff0c;&#x8fbe;&#x5230;&#x5b89;&#x5168;&#x63a7;&#x5236;&#x3002;&#x5bf9;&#x6bd4;&#x4e4b;&#x524d;&#x7684;&#x5904;&#x7406;&#x65b9;&#x5f0f;&#xff0c;&#x73b0;&#x5728;&#x6211;&#x4eec;&#x4f7f;&#x7528;&#x4e00;&#x4e2a;`@Inner`&#x6ce8;&#x89e3;&#xff0c;&#x5c31;&#x80fd;&#x5f88;&#x5feb;&#x7684;&#x6ee1;&#x8db3;&#x4e0a;&#x9762;&#x8bf4;&#x7684;&#x4e24;&#x79cd;&#x573a;&#x666f;&#xff0c;&#x5927;&#x5927;&#x8282;&#x7701;&#x4e86;&#x6211;&#x4eec;&#x7684;&#x5f00;&#x53d1;&#x65f6;&#x95f4;&#x3002;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"134,135"}}],"payload":{"tag":"h2","lines":"105,107"}}],"payload":{"tag":"h1","lines":"34,36"}},{"content":"&#x5408;&#x7406;&#x7684;&#x4f7f;&#x7528;@Inner &#x6ce8;&#x89e3;","children":[{"content":"<pre data-lines=\"141,144\"><code>&#x4e0a;&#x9762;&#x63d0;&#x5230;&#x7684;&#x4e24;&#x79cd;&#x5e94;&#x7528;&#x573a;&#x666f;&#xff0c;&#x5728;&#x6211;&#x4eec;&#x7684;&#x4ee3;&#x7801;&#x4e2d;&#xff0c;&#x5176;&#x5b9e;&#x90fd;&#x662f;&#x53ef;&#x4ee5;&#x4f7f;&#x7528; Inner &#x6ce8;&#x89e3;&#x7684;&#xff0c;&#x4e0b;&#x9762;&#x7ed3;&#x5408; Feign &#x505a;&#x4e00;&#x4e2a;&#x7b80;&#x5355;&#x7684;&#x793a;&#x4f8b;&#xff0c;&#x793a;&#x4f8b;&#x573a;&#x666f;&#x5c31;&#x662f;&#x6211;&#x4eec;&#x7684;&#x7528;&#x6237;&#x5bc6;&#x7801;&#x767b;&#x5f55;&#x4e2d;&#x7684;&#x4e00;&#x73af;&#xff1a;\n\n1.  &#x5728;&#x63a5;&#x53e3;&#x4e0a;&#x4f7f;&#x7528;`@Inner`&#x6ce8;&#x89e3;&#xff0c;&#x4f7f;&#x5f97; url &#x65e0;&#x9700;&#x9274;&#x6743;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"141,144"}},{"content":"<pre data-lines=\"147,164\"><code data-lines=\"147,164\"> <span class=\"hljs-comment\">/**\n * &#x83b7;&#x53d6;&#x6307;&#x5b9a;&#x7528;&#x6237;&#x5168;&#x90e8;&#x4fe1;&#x606f;\n *\n * <span class=\"hljs-doctag\">@return</span> &#x7528;&#x6237;&#x4fe1;&#x606f;\n */</span>\n <span class=\"hljs-meta\">@Inner</span>\n <span class=\"hljs-meta\">@GetMapping</span>(<span class=\"hljs-string\">&quot;/info/{username}&quot;</span>)\n <span class=\"hljs-keyword\">public</span> R <span class=\"hljs-title function_\">info</span>(<span class=\"hljs-params\"><span class=\"hljs-meta\">@PathVariable</span> <span class=\"hljs-title class_\">String</span> username</span>) {\n <span class=\"hljs-title class_\">SysUser</span> user = userService.<span class=\"hljs-title function_\">getOne</span>(<span class=\"hljs-title class_\">Wrappers</span>.&lt;<span class=\"hljs-title class_\">SysUser</span>&gt;<span class=\"hljs-title function_\">query</span>()\n .<span class=\"hljs-title function_\">lambda</span>().<span class=\"hljs-title function_\">eq</span>(<span class=\"hljs-title class_\">SysUser</span>::getUsername, username));\n <span class=\"hljs-keyword\">if</span> (user == <span class=\"hljs-literal\">null</span>) {\n <span class=\"hljs-keyword\">return</span> R.<span class=\"hljs-title function_\">failed</span>(<span class=\"hljs-literal\">null</span>, <span class=\"hljs-title class_\">String</span>.<span class=\"hljs-title function_\">format</span>(<span class=\"hljs-string\">&quot;&#x7528;&#x6237;&#x4fe1;&#x606f;&#x4e3a;&#x7a7a; %s&quot;</span>, username));\n }\n <span class=\"hljs-keyword\">return</span> R.<span class=\"hljs-title function_\">ok</span>(userService.<span class=\"hljs-title function_\">findUserInfo</span>(user));\n } \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"147,164"}},{"content":"<pre data-lines=\"165,166\"><code>2.  &#x7f16;&#x5199; Feign &#x63a5;&#x53e3;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"165,166"}},{"content":"<pre data-lines=\"169,184\"><code data-lines=\"169,184\"><span class=\"hljs-variable\">@FeignClient</span>(contextId = <span class=\"hljs-string\">&quot;remoteUserService&quot;</span>, value = ServiceNameConstants.UMPS_SERVICE)\npublic interface RemoteUserService {\n <span class=\"hljs-comment\">/**\n * &#x901a;&#x8fc7;&#x7528;&#x6237;&#x540d;&#x67e5;&#x8be2;&#x7528;&#x6237;&#x3001;&#x89d2;&#x8272;&#x4fe1;&#x606f;\n *\n * @param username &#x7528;&#x6237;&#x540d;\n * @param from     &#x8c03;&#x7528;&#x6807;&#x5fd7;\n * @return R\n */</span>\n <span class=\"hljs-variable\">@GetMapping</span>(<span class=\"hljs-string\">&quot;/user/info/{username}&quot;</span>)\n R&lt;UserInfo&gt; <span class=\"hljs-built_in\">info</span>(<span class=\"hljs-variable\">@PathVariable</span>(<span class=\"hljs-string\">&quot;username&quot;</span>) String username\n , <span class=\"hljs-variable\">@RequestHeader</span>(SecurityConstants.FROM) String from);\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"169,184"}},{"content":"<pre data-lines=\"185,186\"><code>3.  Feign-Client &#x4e2d;&#x8c03;&#x7528;&#x63a5;&#x53e3;&#xff0c;&#x5e26;&#x4e0a;`SecurityConstants.FROM_IN`&#x53c2;&#x6570;&#x4e3a;&#x5185;&#x90e8;&#x8bc6;&#x522b;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"185,186"}},{"content":"<pre data-lines=\"189,210\"><code data-lines=\"189,210\"> <span class=\"hljs-comment\">/**\n * &#x7528;&#x6237;&#x5bc6;&#x7801;&#x767b;&#x5f55;\n *\n * <span class=\"hljs-doctag\">@param</span> username &#x7528;&#x6237;&#x540d;\n * <span class=\"hljs-doctag\">@return</span>\n * <span class=\"hljs-doctag\">@throws</span> UsernameNotFoundException\n */</span>\n <span class=\"hljs-meta\">@Override</span>\n <span class=\"hljs-meta\">@SneakyThrows</span>\n <span class=\"hljs-keyword\">public</span> UserDetails loadUserByUsername(String username) {\n Cache cache = cacheManager.getCache(CacheConstants.USER_DETAILS);\n <span class=\"hljs-keyword\">if</span> (cache != <span class=\"hljs-literal\">null</span> &amp;&amp; cache.<span class=\"hljs-keyword\">get</span>(username) != <span class=\"hljs-literal\">null</span>) {\n <span class=\"hljs-keyword\">return</span> (PigxUser) cache.<span class=\"hljs-keyword\">get</span>(username).<span class=\"hljs-keyword\">get</span>();\n }\n R&lt;UserInfo&gt; result = remoteUserService.info(username, SecurityConstants.FROM_IN);\n UserDetails userDetails = getUserDetails(result);\n cache.put(username, userDetails);\n <span class=\"hljs-keyword\">return</span> userDetails;\n } \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"189,210"}},{"content":"<pre data-lines=\"211,212\"><code>&#x73b0;&#x5728;&#x201d;/info/&#x201d; &#x8fd9;&#x4e2a; uri &#x4ece;&#x7f51;&#x5173;&#x5916;&#x90e8;&#x6211;&#x4eec;&#x8bbf;&#x95ee;&#x662f;&#x62a5;&#x9519;&#x7684;&#xff08;&#x4e00;&#x822c;&#x6765;&#x8bf4;&#x670d;&#x52a1;&#x90fd;&#x662f;&#x8d70;&#x7f51;&#x5173;&#x66b4;&#x9732;&#x63a5;&#x53e3;&#xff09;&#xff0c;&#x800c; Feign &#x5185;&#x90e8;&#x5e26;&#x4e0a;&#x53c2;&#x6570;&#x662f;&#x53ef;&#x4ee5;&#x6b63;&#x5e38;&#x8bbf;&#x95ee;&#x7684;&#x3002;&#x5927;&#x529f;&#x544a;&#x6210;&#x559d;&#x676f;&#x5564;&#x9152;&#x3002;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"211,212"}}],"payload":{"tag":"h1","lines":"138,140"}}]},{})</script>
</body>
</html>
