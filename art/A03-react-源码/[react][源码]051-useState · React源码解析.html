<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.10/dist/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.11.1/styles/default.min.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.18.10/dist/browser/index.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.10/dist/index.js"></script><script>(r => {
              setTimeout(r);
            })(function renderToolbar() {
  const {
    markmap,
    mm
  } = window;
  const {
    el
  } = markmap.Toolbar.create(mm);
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, root2, jsonOptions) => {
              const markmap = getMarkmap();
              window.mm = markmap.Markmap.create(
                "svg#mindmap",
                (getOptions || markmap.deriveOptions)(jsonOptions),
                root2
              );
            })(() => window.markmap,null,{"content":"useState","children":[{"content":"useReducer","children":[{"content":"<pre data-lines=\"25,26\"><code>&#x6700;&#x5f00;&#x59cb;&#x7684;&#x4e24;&#x53e5;&#x4ee3;&#x7801;&#x662f;&#x6bcf;&#x4e2a;Hooks&#x90fd;&#x4f1a;&#x505a;&#x7684;&#x7edf;&#x4e00;&#x4ee3;&#x7801;&#xff1a;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"25,26"}},{"content":"<pre data-lines=\"27,32\"><code data-lines=\"27,32\"><span class=\"hljs-attribute\">currentlyRenderingFiber</span> <span class=\"hljs-operator\">=</span> resolveCurrentlyRenderingFiber()<span class=\"hljs-comment\">;</span>\n<span class=\"hljs-attribute\">workInProgressHook</span> <span class=\"hljs-operator\">=</span> createWorkInProgressHook()<span class=\"hljs-comment\">;</span>\n\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"27,32"}},{"content":"<pre data-lines=\"33,37\"><code>*   [`currentlyRenderingFiber`](https://react.jokcy.me/book/hooks/hooks-common.html)\n*   [`createWorkInProgressHook`](https://react.jokcy.me/book/hooks/hooks-common.html)\n\n&#x8fd9;&#x91cc;&#x5206;&#x4e24;&#x79cd;&#x60c5;&#x51b5;&#xff1a;_&#x7b2c;&#x4e00;&#x6b21;&#x6e32;&#x67d3;_&#x548c;_&#x66f4;&#x65b0;_&#xff0c;&#x5982;&#x679c;`workInProgressHook.queue`&#x5b58;&#x5728;&#x5219;&#x4e3a;_&#x66f4;&#x65b0;_&#xff0c;&#x5426;&#x5219;&#x662f;_&#x7b2c;&#x4e00;&#x6b21;&#x6e32;&#x67d3;_\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"33,37"}}],"payload":{"tag":"h3","lines":"23,24"}},{"content":"&#x7b2c;&#x4e00;&#x6b21;&#x6e32;&#x67d3;","children":[{"content":"<pre data-lines=\"40,41\"><code>&#x7b2c;&#x4e00;&#x6b21;&#x6e32;&#x67d3;&#x4e3b;&#x8981;&#x5c31;&#x662f;&#x521d;&#x59cb;&#x5316;&#x64cd;&#x4f5c;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"40,41"}},{"content":"<pre data-lines=\"42,55\"><code data-lines=\"42,55\">\n<span class=\"hljs-keyword\">if</span> (reducer === basicStateReducer) {\n  \n  <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> initialState === <span class=\"hljs-string\">&apos;function&apos;</span>) {\n    initialState = initialState();\n  }\n} <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (initialAction !== <span class=\"hljs-literal\">undefined</span> &amp;&amp; initialAction !== <span class=\"hljs-literal\">null</span>) {\n  initialState = reducer(initialState, initialAction);\n}\nworkInProgressHook.memoizedState = workInProgressHook.baseState = initialState;\n\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"42,55"}},{"content":"<pre data-lines=\"56,59\"><code>&#x8fd9;&#x91cc;&#x521d;&#x59cb;&#x5316;`initialState`&#xff0c;&#x5e76;&#x4e14;&#x8bb0;&#x5f55;&#x5728;`workInProgressHook.memoizedState`&#x548c;`workInProgressHook.baseState`&#x4e0a;\n\n&#x7136;&#x540e;&#x521b;&#x5efa;`queue`&#x5bf9;&#x8c61;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"56,59"}},{"content":"<pre data-lines=\"60,67\"><code data-lines=\"60,67\">q<span class=\"hljs-attr\">ueue</span> <span class=\"hljs-operator\">=</span> workInProgressHook.queue <span class=\"hljs-operator\">=</span> {\n  <span class=\"hljs-params\">last:</span> <span class=\"hljs-literal\">null</span>,\n  <span class=\"hljs-params\">dispatch:</span> <span class=\"hljs-literal\">null</span>,\n};\n\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"60,67"}},{"content":"<pre data-lines=\"68,69\"><code>&#x8fd9;&#x4e00;&#x770b;&#x5230;`queue`&#x7684;&#x7ed3;&#x6784;&#x975e;&#x5e38;&#x7b80;&#x5355;&#xff0c;&#x53ea;&#x6709;&#x4e00;&#x4e2a;`last`&#x6307;&#x9488;&#x548c;`dispatch`&#xff0c;`dispatch`&#x662f;&#x7528;&#x6765;&#x8bb0;&#x5f55;**&#x66f4;&#x65b0;`state`&#x7684;&#x65b9;&#x6cd5;&#x7684;**&#xff0c;&#x63a5;&#x4e0b;&#x53bb;&#x6211;&#x4eec;&#x5c31;&#x8981;&#x521b;&#x5efa;`dispatch`&#x65b9;&#x6cd5;&#x4e86;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"68,69"}},{"content":"<pre data-lines=\"70,78\"><code data-lines=\"70,78\"><span class=\"hljs-keyword\">const</span> dispatch: Dispatch<span class=\"hljs-variable\">&lt;A&gt;</span> = (<span class=\"hljs-keyword\">queue</span>.dispatch = (dispatchAction.bind(\n  null,\n  currentlyRenderingFiber,\n  <span class=\"hljs-keyword\">queue</span>,\n): <span class=\"hljs-literal\">any</span>));\n\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"70,78"}},{"content":"<pre data-lines=\"79,80\"><code>&#x53ef;&#x4ee5;&#x770b;&#x5230;&#x8fd9;&#x4e2a;`dispatch`&#x5c31;&#x662f;`dispatchAction`&#x7ed1;&#x5b9a;&#x4e86;&#x5bf9;&#x5e94;&#x7684;`Fiber`&#x548c;`queue`&#x3002;&#x6700;&#x540e;`return`&#xff1a;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"79,80"}},{"content":"<pre data-lines=\"81,85\"><code data-lines=\"81,85\"><span class=\"hljs-keyword\">return</span> [workInProgressHook.memoizedState, dispatch];\n\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"81,85"}},{"content":"<pre data-lines=\"86,87\"><code>&#x5bf9;&#x5e94;&#x4e86;&#x6211;&#x4eec;`const [state, updateState] = useState(&apos;default&apos;)`&#x7684;&#x7528;&#x6cd5;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"86,87"}}],"payload":{"tag":"h3","lines":"38,39"}},{"content":"&#x66f4;&#x65b0;","children":[{"content":"<pre data-lines=\"90,95\"><code>&#x5206;&#x4e24;&#x79cd;&#x60c5;&#x51b5;&#xff0c;**&#x662f;&#x5426;&#x662f;`reRender`**&#xff0c;&#x6240;&#x8c13;`reRender`&#x5c31;&#x662f;&#x8bf4;&#x5728;**&#x5f53;&#x524d;&#x66f4;&#x65b0;&#x5468;&#x671f;&#x4e2d;&#x53c8;&#x4ea7;&#x751f;&#x4e86;&#x65b0;&#x7684;&#x66f4;&#x65b0;&#xff0c;&#x5c31;&#x7ee7;&#x7eed;&#x6267;&#x884c;&#x8fd9;&#x4e9b;&#x66f4;&#x65b0;&#x77e5;&#x9053;&#x5f53;&#x524d;&#x6e32;&#x67d3;&#x5468;&#x671f;&#x4e2d;&#x6ca1;&#x6709;&#x66f4;&#x65b0;&#x4e3a;&#x6b62;**\n\n&#x4ed6;&#x4eec;&#x57fa;&#x672c;&#x7684;&#x64cd;&#x4f5c;&#x662f;&#x4e00;&#x81f4;&#x7684;&#xff0c;&#x5c31;&#x662f;&#x6839;&#x636e;`reducer`&#x548c;`update.action`&#x6765;&#x521b;&#x5efa;&#x65b0;&#x7684;`state`&#xff0c;&#x5e76;&#x8d4b;&#x503c;&#x7ed9;`Hook.memoizedState`&#x4ee5;&#x53ca;`Hook.baseState`&#x3002;\n\n&#x6ce8;&#x610f;&#x8fd9;&#x91cc;&#xff0c;&#x5bf9;&#x4e8e;&#x975e;`reRender`&#x5f97;&#x60c5;&#x51b5;&#xff0c;&#x6211;&#x4eec;&#x4f1a;&#x5bf9;&#x6bcf;&#x4e2a;&#x66f4;&#x65b0;&#x5224;&#x65ad;&#x5176;&#x4f18;&#x5148;&#x7ea7;&#xff0c;&#x5982;&#x679c;&#x4e0d;&#x662f;&#x5f53;&#x524d;&#x6574;&#x4f53;&#x66f4;&#x65b0;&#x4f18;&#x5148;&#x7ea7;&#x5185;&#x5f97;&#x66f4;&#x65b0;&#x4f1a;&#x8df3;&#x8fc7;&#xff0c;&#x7b2c;&#x4e00;&#x4e2a;&#x8df3;&#x8fc7;&#x5f97;`Update`&#x4f1a;&#x53d8;&#x6210;&#x65b0;&#x7684;`baseUpdate`&#xff0c;**&#x4ed6;&#x8bb0;&#x5f55;&#x4e86;&#x5728;&#x4e4b;&#x540e;&#x6240;&#x6709;&#x5f97;`Update`&#xff0c;&#x5373;&#x4fbf;&#x662f;&#x4f18;&#x5148;&#x7ea7;&#x6bd4;&#x4ed6;&#x9ad8;&#x5f97;&#xff0c;&#x56e0;&#x4e3a;&#x5728;&#x4ed6;&#x88ab;&#x6267;&#x884c;&#x5f97;&#x65f6;&#x5019;&#xff0c;&#x9700;&#x8981;&#x4fdd;&#x8bc1;&#x540e;&#x7eed;&#x7684;&#x66f4;&#x65b0;&#x8981;&#x5728;&#x4ed6;&#x66f4;&#x65b0;&#x4e4b;&#x540e;&#x7684;&#x57fa;&#x7840;&#x4e0a;&#x518d;&#x6b21;&#x6267;&#x884c;&#xff0c;&#x56e0;&#x4e3a;&#x7ed3;&#x679c;&#x53ef;&#x80fd;&#x4f1a;&#x4e0d;&#x4e00;&#x6837;&#x3002;** \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"90,95"}},{"content":"<pre data-lines=\"96,229\"><code data-lines=\"96,229\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">function</span> useReducer&lt;S, A&gt;(\n  <span class=\"hljs-attr\">reducer</span>: <span class=\"hljs-function\">(<span class=\"hljs-params\">S, A</span>) =&gt;</span> S,\n  <span class=\"hljs-attr\">initialState</span>: S,\n  <span class=\"hljs-attr\">initialAction</span>: A | <span class=\"hljs-built_in\">void</span> | <span class=\"hljs-literal\">null</span>,\n): [S, <span class=\"hljs-title class_\">Dispatch</span>&lt;A&gt;] {\n  currentlyRenderingFiber = <span class=\"hljs-title function_\">resolveCurrentlyRenderingFiber</span>();\n  workInProgressHook = <span class=\"hljs-title function_\">createWorkInProgressHook</span>();\n  <span class=\"hljs-keyword\">let</span> <span class=\"hljs-attr\">queue</span>: <span class=\"hljs-title class_\">UpdateQueue</span>&lt;A&gt; | <span class=\"hljs-literal\">null</span> = (workInProgressHook.<span class=\"hljs-property\">queue</span>: <span class=\"hljs-built_in\">any</span>);\n  <span class=\"hljs-keyword\">if</span> (queue !== <span class=\"hljs-literal\">null</span>) {\n    <span class=\"hljs-comment\">// Already have a queue, so this is an update.</span>\n    <span class=\"hljs-keyword\">if</span> (isReRender) {\n      <span class=\"hljs-comment\">// This is a re-render. Apply the new render phase updates to the previous</span>\n      <span class=\"hljs-comment\">// work-in-progress hook.</span>\n      <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">dispatch</span>: <span class=\"hljs-title class_\">Dispatch</span>&lt;A&gt; = (queue.<span class=\"hljs-property\">dispatch</span>: <span class=\"hljs-built_in\">any</span>);\n      <span class=\"hljs-keyword\">if</span> (renderPhaseUpdates !== <span class=\"hljs-literal\">null</span>) {\n        <span class=\"hljs-comment\">// Render phase updates are stored in a map of queue -&gt; linked list</span>\n        <span class=\"hljs-keyword\">const</span> firstRenderPhaseUpdate = renderPhaseUpdates.<span class=\"hljs-title function_\">get</span>(queue);\n        <span class=\"hljs-keyword\">if</span> (firstRenderPhaseUpdate !== <span class=\"hljs-literal\">undefined</span>) {\n          renderPhaseUpdates.<span class=\"hljs-title function_\">delete</span>(queue);\n          <span class=\"hljs-keyword\">let</span> newState = workInProgressHook.<span class=\"hljs-property\">memoizedState</span>;\n          <span class=\"hljs-keyword\">let</span> update = firstRenderPhaseUpdate;\n          <span class=\"hljs-keyword\">do</span> {\n            <span class=\"hljs-comment\">// Process this render phase update. We don&apos;t have to check the</span>\n            <span class=\"hljs-comment\">// priority because it will always be the same as the current</span>\n            <span class=\"hljs-comment\">// render&apos;s.</span>\n            <span class=\"hljs-keyword\">const</span> action = update.<span class=\"hljs-property\">action</span>;\n            newState = <span class=\"hljs-title function_\">reducer</span>(newState, action);\n            update = update.<span class=\"hljs-property\">next</span>;\n          } <span class=\"hljs-keyword\">while</span> (update !== <span class=\"hljs-literal\">null</span>);\n\n          workInProgressHook.<span class=\"hljs-property\">memoizedState</span> = newState;\n\n          <span class=\"hljs-comment\">// Don&apos;t persist the state accumlated from the render phase updates to</span>\n          <span class=\"hljs-comment\">// the base state unless the queue is empty.</span>\n          <span class=\"hljs-comment\">// <span class=\"hljs-doctag\">TODO:</span> Not sure if this is the desired semantics, but it&apos;s what we</span>\n          <span class=\"hljs-comment\">// do for gDSFP. I can&apos;t remember why.</span>\n          <span class=\"hljs-keyword\">if</span> (workInProgressHook.<span class=\"hljs-property\">baseUpdate</span> === queue.<span class=\"hljs-property\">last</span>) {\n            workInProgressHook.<span class=\"hljs-property\">baseState</span> = newState;\n          }\n\n          <span class=\"hljs-keyword\">return</span> [newState, dispatch];\n        }\n      }\n      <span class=\"hljs-keyword\">return</span> [workInProgressHook.<span class=\"hljs-property\">memoizedState</span>, dispatch];\n    }\n\n    <span class=\"hljs-comment\">// The last update in the entire queue</span>\n    <span class=\"hljs-keyword\">const</span> last = queue.<span class=\"hljs-property\">last</span>;\n    <span class=\"hljs-comment\">// The last update that is part of the base state.</span>\n    <span class=\"hljs-keyword\">const</span> baseUpdate = workInProgressHook.<span class=\"hljs-property\">baseUpdate</span>;\n\n    <span class=\"hljs-comment\">// Find the first unprocessed update.</span>\n    <span class=\"hljs-keyword\">let</span> first;\n    <span class=\"hljs-keyword\">if</span> (baseUpdate !== <span class=\"hljs-literal\">null</span>) {\n      <span class=\"hljs-keyword\">if</span> (last !== <span class=\"hljs-literal\">null</span>) {\n        <span class=\"hljs-comment\">// For the first update, the queue is a circular linked list where</span>\n        <span class=\"hljs-comment\">// `queue.last.next = queue.first`. Once the first update commits, and</span>\n        <span class=\"hljs-comment\">// the `baseUpdate` is no longer empty, we can unravel the list.</span>\n        last.<span class=\"hljs-property\">next</span> = <span class=\"hljs-literal\">null</span>;\n      }\n      first = baseUpdate.<span class=\"hljs-property\">next</span>;\n    } <span class=\"hljs-keyword\">else</span> {\n      first = last !== <span class=\"hljs-literal\">null</span> ? last.<span class=\"hljs-property\">next</span> : <span class=\"hljs-literal\">null</span>;\n    }\n    <span class=\"hljs-keyword\">if</span> (first !== <span class=\"hljs-literal\">null</span>) {\n      <span class=\"hljs-keyword\">let</span> newState = workInProgressHook.<span class=\"hljs-property\">baseState</span>;\n      <span class=\"hljs-keyword\">let</span> newBaseState = <span class=\"hljs-literal\">null</span>;\n      <span class=\"hljs-keyword\">let</span> newBaseUpdate = <span class=\"hljs-literal\">null</span>;\n      <span class=\"hljs-keyword\">let</span> prevUpdate = baseUpdate;\n      <span class=\"hljs-keyword\">let</span> update = first;\n      <span class=\"hljs-keyword\">let</span> didSkip = <span class=\"hljs-literal\">false</span>;\n      <span class=\"hljs-keyword\">do</span> {\n        <span class=\"hljs-keyword\">const</span> updateExpirationTime = update.<span class=\"hljs-property\">expirationTime</span>;\n        <span class=\"hljs-keyword\">if</span> (updateExpirationTime &lt; renderExpirationTime) {\n          <span class=\"hljs-comment\">// Priority is insufficient. Skip this update. If this is the first</span>\n          <span class=\"hljs-comment\">// skipped update, the previous update/state is the new base</span>\n          <span class=\"hljs-comment\">// update/state.</span>\n          <span class=\"hljs-keyword\">if</span> (!didSkip) {\n            didSkip = <span class=\"hljs-literal\">true</span>;\n            newBaseUpdate = prevUpdate;\n            newBaseState = newState;\n          }\n          <span class=\"hljs-comment\">// Update the remaining priority in the queue.</span>\n          <span class=\"hljs-keyword\">if</span> (updateExpirationTime &gt; remainingExpirationTime) {\n            remainingExpirationTime = updateExpirationTime;\n          }\n        } <span class=\"hljs-keyword\">else</span> {\n          <span class=\"hljs-comment\">// Process this update.</span>\n          <span class=\"hljs-keyword\">const</span> action = update.<span class=\"hljs-property\">action</span>;\n          newState = <span class=\"hljs-title function_\">reducer</span>(newState, action);\n        }\n        prevUpdate = update;\n        update = update.<span class=\"hljs-property\">next</span>;\n      } <span class=\"hljs-keyword\">while</span> (update !== <span class=\"hljs-literal\">null</span> &amp;&amp; update !== first);\n\n      <span class=\"hljs-keyword\">if</span> (!didSkip) {\n        newBaseUpdate = prevUpdate;\n        newBaseState = newState;\n      }\n\n      workInProgressHook.<span class=\"hljs-property\">memoizedState</span> = newState;\n      workInProgressHook.<span class=\"hljs-property\">baseUpdate</span> = newBaseUpdate;\n      workInProgressHook.<span class=\"hljs-property\">baseState</span> = newBaseState;\n    }\n\n    <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">dispatch</span>: <span class=\"hljs-title class_\">Dispatch</span>&lt;A&gt; = (queue.<span class=\"hljs-property\">dispatch</span>: <span class=\"hljs-built_in\">any</span>);\n    <span class=\"hljs-keyword\">return</span> [workInProgressHook.<span class=\"hljs-property\">memoizedState</span>, dispatch];\n  }\n\n  <span class=\"hljs-comment\">// There&apos;s no existing queue, so this is the initial render.</span>\n  <span class=\"hljs-keyword\">if</span> (reducer === basicStateReducer) {\n    <span class=\"hljs-comment\">// Special case for `useState`.</span>\n    <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">typeof</span> initialState === <span class=\"hljs-string\">&apos;function&apos;</span>) {\n      initialState = <span class=\"hljs-title function_\">initialState</span>();\n    }\n  } <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (initialAction !== <span class=\"hljs-literal\">undefined</span> &amp;&amp; initialAction !== <span class=\"hljs-literal\">null</span>) {\n    initialState = <span class=\"hljs-title function_\">reducer</span>(initialState, initialAction);\n  }\n  workInProgressHook.<span class=\"hljs-property\">memoizedState</span> = workInProgressHook.<span class=\"hljs-property\">baseState</span> = initialState;\n  queue = workInProgressHook.<span class=\"hljs-property\">queue</span> = {\n    <span class=\"hljs-attr\">last</span>: <span class=\"hljs-literal\">null</span>,\n    <span class=\"hljs-attr\">dispatch</span>: <span class=\"hljs-literal\">null</span>,\n  };\n  <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">dispatch</span>: <span class=\"hljs-title class_\">Dispatch</span>&lt;A&gt; = (queue.<span class=\"hljs-property\">dispatch</span> = (dispatchAction.<span class=\"hljs-title function_\">bind</span>(\n    <span class=\"hljs-literal\">null</span>,\n    currentlyRenderingFiber,\n    queue,\n  ): <span class=\"hljs-built_in\">any</span>));\n  <span class=\"hljs-keyword\">return</span> [workInProgressHook.<span class=\"hljs-property\">memoizedState</span>, dispatch];\n}\n\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"96,229"}}],"payload":{"tag":"h3","lines":"88,89"}},{"content":"dispatchAction","children":[{"content":"<pre data-lines=\"234,235\"><code>&#x9996;&#x5148;&#x770b;&#x8fd9;&#x4e2a;&#x5224;&#x65ad;&#xff1a;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"234,235"}},{"content":"<pre data-lines=\"236,243\"><code data-lines=\"236,243\">if (\n  <span class=\"hljs-name\">fiber</span> === currentlyRenderingFiber ||\n  (<span class=\"hljs-name\">alternate</span> !== null <span class=\"hljs-symbol\">&amp;&amp;</span> alternate === currentlyRenderingFiber)\n)\n\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"236,243"}},{"content":"<pre data-lines=\"244,249\"><code>&#x8fd9;&#x5176;&#x5b9e;&#x5c31;&#x662f;&#x5224;&#x65ad;&#x8fd9;&#x4e2a;&#x66f4;&#x65b0;&#x662f;&#x5426;&#x662f;&#x5728;**&#x6e32;&#x67d3;&#x8fc7;&#x7a0b;&#x4e2d;&#x4ea7;&#x751f;&#x7684;**&#xff0c;`currentlyRenderingFiber`&#x53ea;&#x6709;&#x5728;`FunctionalComponent`&#x66f4;&#x65b0;&#x7684;&#x8fc7;&#x7a0b;&#x4e2d;&#x624d;&#x4f1a;&#x88ab;&#x8bbe;&#x7f6e;&#xff0c;&#x5728;&#x79bb;&#x5f00;&#x66f4;&#x65b0;&#x7684;&#x65f6;&#x5019;&#x8bbe;&#x7f6e;&#x4e3a;`null`&#xff0c;&#x6240;&#x4ee5;&#x53ea;&#x8981;&#x5b58;&#x5728;&#x5e76;&#x66f4;&#x4ea7;&#x751f;&#x66f4;&#x65b0;&#x7684;`Fiber`&#x76f8;&#x7b49;&#xff0c;&#x8bf4;&#x660e;&#x8fd9;&#x4e2a;&#x66f4;&#x65b0;&#x662f;&#x5728;&#x5f53;&#x524d;&#x6e32;&#x67d3;&#x4e2d;&#x4ea7;&#x751f;&#x7684;&#xff0c;&#x5219;&#x8fd9;&#x662f;&#x4e00;&#x6b21;`reRender`&#x3002;\n\n&#x6240;&#x6709;&#x66f4;&#x65b0;&#x8fc7;&#x7a0b;&#x4e2d;&#x4ea7;&#x751f;&#x7684;&#x66f4;&#x65b0;&#x8bb0;&#x5f55;&#x5728;`renderPhaseUpdates`&#x8fd9;&#x4e2a;Map&#x4e0a;&#xff0c;&#x4ee5;&#x6bcf;&#x4e2a;`Hook`&#x7684;`queue`&#x4e3a;`key`&#x3002;\n\n&#x5bf9;&#x4e8e;&#x4e0d;&#x662f;&#x66f4;&#x65b0;&#x8fc7;&#x7a0b;&#x4e2d;&#x4ea7;&#x751f;&#x7684;&#x66f4;&#x65b0;&#xff0c;&#x5219;&#x76f4;&#x63a5;&#x5728;`queue`&#x4e0a;&#x6267;&#x884c;&#x64cd;&#x4f5c;&#x5c31;&#x884c;&#x4e86;&#xff0c;&#x6ce8;&#x610f;&#x5728;&#x6700;&#x540e;&#x4f1a;&#x53d1;&#x8d77;&#x4e00;&#x6b21;`scheduleWork`&#x7684;&#x8c03;&#x5ea6;&#x3002;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"244,249"}},{"content":"<pre data-lines=\"250,314\"><code data-lines=\"250,314\"><span class=\"hljs-keyword\">function</span> dispatchAction&lt;A&gt;(fiber: Fiber, queue: UpdateQueue&lt;A&gt;, action: A) {\n  invariant(\n    numberOfReRenders &lt; RE_RENDER_LIMIT,\n    <span class=\"hljs-comment\">&apos;Too many re-renders. React limits the number of renders to prevent &apos; +</span>\n      <span class=\"hljs-comment\">&apos;an infinite loop.&apos;,</span>\n  );\n\n  <span class=\"hljs-keyword\">const</span> alternate = fiber.alternate;\n  <span class=\"hljs-keyword\">if</span> (\n    fiber === currentlyRenderingFiber ||\n    (alternate !== <span class=\"hljs-literal\">null</span> &amp;&amp; alternate === currentlyRenderingFiber)\n  ) {\n    \n    \n    \n    didScheduleRenderPhaseUpdate = <span class=\"hljs-literal\">true</span>;\n    <span class=\"hljs-keyword\">const</span> update: Update&lt;A&gt; = {\n      expirationTime: renderExpirationTime,\n      action,\n      <span class=\"hljs-keyword\">next</span>: <span class=\"hljs-literal\">null</span>,\n    };\n    <span class=\"hljs-keyword\">if</span> (renderPhaseUpdates === <span class=\"hljs-literal\">null</span>) {\n      renderPhaseUpdates = <span class=\"hljs-keyword\">new</span> Map();\n    }\n    <span class=\"hljs-keyword\">const</span> firstRenderPhaseUpdate = renderPhaseUpdates.<span class=\"hljs-keyword\">get</span>(queue);\n    <span class=\"hljs-keyword\">if</span> (firstRenderPhaseUpdate === undefined) {\n      renderPhaseUpdates.<span class=\"hljs-keyword\">set</span>(queue, update);\n    } <span class=\"hljs-keyword\">else</span> {\n      \n      <span class=\"hljs-keyword\">let</span> lastRenderPhaseUpdate = firstRenderPhaseUpdate;\n      <span class=\"hljs-keyword\">while</span> (lastRenderPhaseUpdate.<span class=\"hljs-keyword\">next</span> !== <span class=\"hljs-literal\">null</span>) {\n        lastRenderPhaseUpdate = lastRenderPhaseUpdate.<span class=\"hljs-keyword\">next</span>;\n      }\n      lastRenderPhaseUpdate.<span class=\"hljs-keyword\">next</span> = update;\n    }\n  } <span class=\"hljs-keyword\">else</span> {\n    <span class=\"hljs-keyword\">const</span> currentTime = requestCurrent<span class=\"hljs-built_in\">Time</span>();\n    <span class=\"hljs-keyword\">const</span> expirationTime = computeExpirationForFiber(currentTime, fiber);\n    <span class=\"hljs-keyword\">const</span> update: Update&lt;A&gt; = {\n      expirationTime,\n      action,\n      <span class=\"hljs-keyword\">next</span>: <span class=\"hljs-literal\">null</span>,\n    };\n    flushPassiveEffects();\n    \n    <span class=\"hljs-keyword\">const</span> last = queue.last;\n    <span class=\"hljs-keyword\">if</span> (last === <span class=\"hljs-literal\">null</span>) {\n      \n      update.<span class=\"hljs-keyword\">next</span> = update;\n    } <span class=\"hljs-keyword\">else</span> {\n      <span class=\"hljs-keyword\">const</span> first = last.<span class=\"hljs-keyword\">next</span>;\n      <span class=\"hljs-keyword\">if</span> (first !== <span class=\"hljs-literal\">null</span>) {\n        \n        update.<span class=\"hljs-keyword\">next</span> = first;\n      }\n      last.<span class=\"hljs-keyword\">next</span> = update;\n    }\n    queue.last = update;\n    scheduleWork(fiber, expirationTime);\n  }\n}\n\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"250,314"}},{"content":"<img src=\"https://static.coursebetter.com/202112/Jokcy%E7%9A%84%E4%BA%8C%E7%BB%B4%E7%A0%81.png\" alt>","children":[],"payload":{"tag":"img","lines":"315,316"}},{"content":"<img src=\"https://static.coursebetter.com/202112/Jokcy%E7%9A%84%E4%BA%8C%E7%BB%B4%E7%A0%81.png\" alt>","children":[],"payload":{"tag":"img","lines":"319,320"}}],"payload":{"tag":"h3","lines":"232,233"}}],"payload":{"tag":"h1","lines":"0,1"}},{})</script>
</body>
</html>
