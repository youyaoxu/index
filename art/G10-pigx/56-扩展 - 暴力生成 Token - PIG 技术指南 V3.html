<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.10/dist/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.11.1/styles/default.min.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.18.10/dist/browser/index.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.10/dist/index.js"></script><script>(r => {
              setTimeout(r);
            })(function renderToolbar() {
  const {
    markmap,
    mm
  } = window;
  const {
    el
  } = markmap.Toolbar.create(mm);
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, root2, jsonOptions) => {
              const markmap = getMarkmap();
              window.mm = markmap.Markmap.create(
                "svg#mindmap",
                (getOptions || markmap.deriveOptions)(jsonOptions),
                root2
              );
            })(() => window.markmap,null,{"content":"&#x6269;&#x5c55; - &#x66b4;&#x529b;&#x751f;&#x6210; Token","children":[{"content":"&#x4e1a;&#x52a1;&#x80cc;&#x666f;","children":[{"content":"<pre data-lines=\"7,14\"><code>*   &#x672c;&#x6587;&#x4e3b;&#x8981;&#x4ecb;&#x7ecd;&#x5982;&#x4f55;&#x81ea;&#x5b9a;&#x4e49; Token &#x751f;&#x6210;&#x903b;&#x8f91;&#xff0c;\n    \n    &#x4e0d;&#x4f9d;&#x8d56;&#x4e8e; OAuth2 &#x534f;&#x8bae;&#x7684;&#x4e25;&#x683c;&#x53c2;&#x6570;&#x8981;&#x6c42;\n    \n    &#x3002;&#x6bd4;&#x5982;&#x53ea;&#x63d0;&#x4f9b;&#x7528;&#x6237;&#x540d;&#xff0c;&#x5373;&#x53ef;&#x751f;&#x6210;&#x6307;&#x5b9a;&#x7528;&#x6237;&#x7684; Token&#xff0c;&#x4f7f;&#x4e1a;&#x52a1;&#x6d41;&#x7a0b;&#x66f4;&#x52a0;&#x7075;&#x6d3b;&#x3001;&#x7b80;&#x4fbf;&#x3002;\n*   &#x5728;&#x5b9e;&#x9645;&#x4e1a;&#x52a1;&#x4e2d;&#xff0c;&#x901a;&#x5e38;&#x5728;&#x7528;&#x6237;&#x6ce8;&#x518c;&#x5b8c;&#x6210;&#x540e;&#x9700;&#x8981;&#x76f4;&#x63a5;&#x751f;&#x6210; Token&#xff0c;&#x65b9;&#x4fbf;&#x7528;&#x6237;&#x5728;&#x6ce8;&#x518c;&#x540e;&#x5373;&#x523b;&#x767b;&#x5f55;&#x3002;&#x6b64;&#x65f6;&#x53ef;&#x4ee5;&#x901a;&#x8fc7;&#x5b9a;&#x5236;&#x5316;&#x7684; Token &#x751f;&#x6210;&#x903b;&#x8f91;&#xff0c;&#x6839;&#x636e;&#x4e1a;&#x52a1;&#x89c4;&#x5219;&#x7075;&#x6d3b;&#x5730;&#x751f;&#x6210; Token&#xff0c;&#x4ee5;&#x6ee1;&#x8db3;&#x4e1a;&#x52a1;&#x6d41;&#x7a0b;&#x9700;&#x6c42;&#x3002;\n*   &#x5f53;&#x7136;&#x8fd9;&#x79cd;&#x65b9;&#x5f0f;&#x8fc7;&#x4e8e;&#x66b4;&#x529b;&#xff0c;&#x7ed5;&#x8fc7;&#x4e86; Spring Security &#x8ba4;&#x8bc1;&#x670d;&#x52a1;&#x5668;&#x7684;&#x5404;&#x79cd;&#x6821;&#x9a8c;&#xff0c;&#x6240;&#x4ee5;&#x5728;&#x4f7f;&#x7528;&#x65f6;&#x9700;&#x8981;&#x8c28;&#x614e;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"7,14"}},{"content":"<img src=\"https://mintlify.s3.us-west-1.amazonaws.com/xzcxz/images/1730361988944-f5096ea3-2917-4fd9-a7d4-503f2855a193.png\" alt>","children":[],"payload":{"tag":"img","lines":"16,17"}}],"payload":{"tag":"h2","lines":"4,6"}},{"content":"&#x624b;&#x52a8;&#x751f;&#x6210; Token &#x6d41;&#x7a0b;&#x56fe;","children":[{"content":"<img src=\"https://minio.pigx.top/oss/202305/1683870985.jpeg\" alt>","children":[],"payload":{"tag":"img","lines":"22,23"}}],"payload":{"tag":"h2","lines":"19,21"}},{"content":"&#x5b9a;&#x4e49;&#x670d;&#x52a1;&#x8c03;&#x7528; Feign &#x548c;&#x5b9e;&#x4f53;","children":[{"content":"<pre data-lines=\"29,30\"><code>&#x5728; upms-api &#x6a21;&#x5757;&#x65b0;&#x589e;&#x5982;&#x4e0b;&#x5b9e;&#x4f53;&#x548c; feign client\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"29,30"}},{"content":"<pre data-lines=\"33,47\"><code data-lines=\"33,47\"><span class=\"hljs-meta\">@Data</span>\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-title class_\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">UserTokenDTO</span> </span>{\n <span class=\"hljs-comment\">/**\n * &#x7528;&#x6237;&#x540d;\n */</span>\n <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">String</span> username;\n    \n <span class=\"hljs-comment\">/**\n * &#x6743;&#x9650;&#x5217;&#x8868;\n */</span>\n <span class=\"hljs-keyword\">private</span> List&lt;<span class=\"hljs-keyword\">String</span>&gt; authorities = <span class=\"hljs-keyword\">new</span><span class=\"hljs-type\"></span> ArrayList&lt;&gt;();\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"33,47"}},{"content":"<pre data-lines=\"50,59\"><code data-lines=\"50,59\"><span class=\"hljs-variable\">@FeignClient</span>(contextId = <span class=\"hljs-string\">&quot;remoteTokenService&quot;</span>, value = ServiceNameConstants.AUTH_SERVICE)\npublic interface RemoteTokenService {\n\n <span class=\"hljs-variable\">@NoToken</span>\n <span class=\"hljs-variable\">@PostMapping</span>(<span class=\"hljs-string\">&quot;/token/generate-token&quot;</span>)\n R <span class=\"hljs-built_in\">generateToken</span>(<span class=\"hljs-variable\">@RequestBody</span> UserTokenDTO userTokenDTO);\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"50,59"}}],"payload":{"tag":"h2","lines":"26,28"}},{"content":"&#x8ba4;&#x8bc1;&#x4e2d;&#x5fc3;&#x63d0;&#x4f9b;&#x751f;&#x6210;&#x4ee4;&#x724c;&#x7aef;&#x70b9;","children":[{"content":"<pre data-lines=\"65,66\"><code>&#x5728; PigTokenEndpoint &#x4f53;&#x9762;&#x6dfb;&#x52a0;&#x5982;&#x4e0b;&#x63a5;&#x53e3;&#x4ee3;&#x7801;&#xff0c;&#x65b9;&#x4fbf; feign &#x8c03;&#x7528;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"65,66"}},{"content":"<pre data-lines=\"69,140\"><code data-lines=\"69,140\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">final</span> OAuth2TokenGenerator&lt;? <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title class_\">OAuth2Token</span>&gt; tokenGenerator;\n\n<span class=\"hljs-meta\">@Inner</span>\n<span class=\"hljs-meta\">@SneakyThrows</span>\n<span class=\"hljs-meta\">@PostMapping(&quot;/generate-token&quot;)</span>\n<span class=\"hljs-keyword\">public</span> R <span class=\"hljs-title function_\">generateToken</span><span class=\"hljs-params\">(<span class=\"hljs-meta\">@RequestBody</span> UserTokenDTO userTokenDTO)</span> {\n <span class=\"hljs-comment\">// &#x6784;&#x5efa;&#x6388;&#x6743;&#x4fe1;&#x606f;</span>\n <span class=\"hljs-type\">RegisteredClient</span> <span class=\"hljs-variable\">registeredClient</span> <span class=\"hljs-operator\">=</span> RegisteredClient.withId(SecurityConstants.FROM).clientId(SecurityConstants.FROM)\n .authorizationGrantType(AuthorizationGrantType.PASSWORD)\n .tokenSettings(TokenSettings.builder()\n .accessTokenTimeToLive(Duration.ofHours(<span class=\"hljs-number\">24</span>)) <span class=\"hljs-comment\">// token &#x6709;&#x6548;&#x671f; 24 &#x5c0f;&#x65f6;</span>\n .refreshTokenTimeToLive(Duration.ofDays(<span class=\"hljs-number\">7</span>))  <span class=\"hljs-comment\">// refresh token &#x6709;&#x6548;&#x671f; 7 &#x5929;</span>\n .accessTokenFormat(OAuth2TokenFormat.REFERENCE)\n .build())\n .build();\n\n <span class=\"hljs-comment\">// &#x6784;&#x5efa;&#x7528;&#x6237;&#x4fe1;&#x606f; , &#x8fd9;&#x91cc;&#x53ea;&#x62fc;&#x63a5;&#x4e86;  UserTokenDTO &#x4e2d;&#x7684; username &#x548c; authorities&#xff0c;&#x5176;&#x4ed6;&#x5b57;&#x6bb5;&#x5199;&#x6b7b;&#xff0c;&#x53ef;&#x4ee5;&#x81ea;&#x884c;&#x573a;&#x5730;&#xff1b;</span>\n <span class=\"hljs-type\">PigUser</span> <span class=\"hljs-variable\">pigUser</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">PigUser</span>(<span class=\"hljs-number\">1L</span>, <span class=\"hljs-number\">1L</span>, userTokenDTO.getUsername(), StrUtil.EMPTY, StrUtil.EMPTY\n , <span class=\"hljs-literal\">true</span>, <span class=\"hljs-literal\">true</span>, <span class=\"hljs-literal\">true</span>, <span class=\"hljs-literal\">true</span>, userTokenDTO.getAuthorities()\n .stream().map(SimpleGrantedAuthority::<span class=\"hljs-keyword\">new</span>).collect(Collectors.toList()));\n\n <span class=\"hljs-type\">Authentication</span> <span class=\"hljs-variable\">usernamePasswordAuthentication</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">UsernamePasswordAuthenticationToken</span>(pigUser, StrUtil.EMPTY);\n\n DefaultOAuth2TokenContext.<span class=\"hljs-type\">Builder</span> <span class=\"hljs-variable\">tokenContextBuilder</span> <span class=\"hljs-operator\">=</span> DefaultOAuth2TokenContext.builder()\n .registeredClient(registeredClient)\n .principal(usernamePasswordAuthentication)\n .authorizationServerContext(AuthorizationServerContextHolder.getContext());\n\n OAuth2Authorization.<span class=\"hljs-type\">Builder</span> <span class=\"hljs-variable\">authorizationBuilder</span> <span class=\"hljs-operator\">=</span> OAuth2Authorization\n .withRegisteredClient(registeredClient)\n .principalName(usernamePasswordAuthentication.getName());\n\n <span class=\"hljs-comment\">// ----- Access token -----</span>\n <span class=\"hljs-type\">OAuth2TokenContext</span> <span class=\"hljs-variable\">tokenContext</span> <span class=\"hljs-operator\">=</span> tokenContextBuilder.tokenType(OAuth2TokenType.ACCESS_TOKEN)\n .authorizationGrantType(AuthorizationGrantType.PASSWORD)\n .authorizationGrant(<span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">OAuth2ClientAuthenticationToken</span>(registeredClient, ClientAuthenticationMethod.CLIENT_SECRET_BASIC, <span class=\"hljs-literal\">null</span>))\n .build();\n <span class=\"hljs-type\">OAuth2Token</span> <span class=\"hljs-variable\">generatedAccessToken</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-built_in\">this</span>.tokenGenerator.generate(tokenContext);\n\n <span class=\"hljs-type\">OAuth2AccessToken</span> <span class=\"hljs-variable\">accessToken</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">OAuth2AccessToken</span>(OAuth2AccessToken.TokenType.BEARER,\n generatedAccessToken.getTokenValue(), generatedAccessToken.getIssuedAt(),\n generatedAccessToken.getExpiresAt(), tokenContext.getAuthorizedScopes());\n\n <span class=\"hljs-keyword\">if</span> (generatedAccessToken <span class=\"hljs-keyword\">instanceof</span> ClaimAccessor) {\n authorizationBuilder.id(accessToken.getTokenValue())\n .token(accessToken,\n (metadata) -&gt; metadata.put(OAuth2Authorization.Token.CLAIMS_METADATA_NAME,\n ((ClaimAccessor) generatedAccessToken).getClaims()))\n .attribute(Principal.class.getName(), usernamePasswordAuthentication);\n } <span class=\"hljs-keyword\">else</span> {\n authorizationBuilder.id(accessToken.getTokenValue()).accessToken(accessToken);\n }\n\n <span class=\"hljs-comment\">// ----- Refresh token -----</span>\n OAuth2RefreshToken refreshToken;\n tokenContext = tokenContextBuilder.tokenType(OAuth2TokenType.REFRESH_TOKEN).build();\n <span class=\"hljs-type\">OAuth2Token</span> <span class=\"hljs-variable\">generatedRefreshToken</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-built_in\">this</span>.tokenGenerator.generate(tokenContext);\n refreshToken = (OAuth2RefreshToken) generatedRefreshToken;\n authorizationBuilder.refreshToken(refreshToken);\n\n <span class=\"hljs-type\">OAuth2Authorization</span> <span class=\"hljs-variable\">authorization</span> <span class=\"hljs-operator\">=</span> authorizationBuilder\n .authorizationGrantType(AuthorizationGrantType.PASSWORD)\n .build();\n\n <span class=\"hljs-built_in\">this</span>.authorizationService.save(authorization);\n\n <span class=\"hljs-keyword\">return</span> R.ok(<span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">OAuth2AccessTokenAuthenticationToken</span>(registeredClient, usernamePasswordAuthentication, accessToken,\n refreshToken, authorization.getAccessToken().getClaims()));\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"69,140"}}],"payload":{"tag":"h2","lines":"62,64"}},{"content":"&#x4e1a;&#x52a1;&#x4ee3;&#x7801;&#x8c03;&#x7528;&#x7b7e;&#x53d1; token","children":[{"content":"<pre data-lines=\"147,164\"><code data-lines=\"147,164\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">final</span> RemoteTokenService remoteTokenService;\n\n<span class=\"hljs-comment\">// &#x62fc;&#x63a5;&#x8bf7;&#x6c42;&#x53c2;&#x6570;</span>\n<span class=\"hljs-type\">UserTokenDTO</span> <span class=\"hljs-variable\">userTokenDTO</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">UserTokenDTO</span>();\nuserTokenDTO.setUsername(<span class=\"hljs-string\">&quot;admin&quot;</span>);  <span class=\"hljs-comment\">// &#x53ea;&#x9700;&#x8981;&#x7528;&#x6237;&#x540d;&#xff0c;&#x5c31;&#x53ef;&#x4ee5;&#x751f;&#x6210; token</span>\nuserTokenDTO.setAuthorities(List.of(<span class=\"hljs-string\">&quot;sys_user_add&quot;</span>)); <span class=\"hljs-comment\">// &#x6743;&#x9650;&#x5217;&#x8868;&#x7684;&#x5b57;&#x7b26;&#x4e32;&#xff0c;&#x80fd;&#x8c03;&#x7528;&#x7684;&#x63a5;&#x53e3;&#x8303;&#x56f4;</span>\n\n<span class=\"hljs-comment\">// feign &#x8c03;&#x7528; auth &#x6a21;&#x5757;&#x751f;&#x6210; token</span>\nR&lt;OAuth2AccessTokenAuthenticationToken&gt; authenticationTokenR = remoteTokenService.generateToken(userTokenDTO);\n<span class=\"hljs-comment\">// token &#x4fe1;&#x606f;</span>\n<span class=\"hljs-type\">OAuth2AccessToken</span> <span class=\"hljs-variable\">accessToken</span> <span class=\"hljs-operator\">=</span> authenticationTokenR.getData().getAccessToken();\n<span class=\"hljs-comment\">// &#x5237;&#x65b0; token &#x4fe1;&#x606f;</span>\n<span class=\"hljs-type\">OAuth2RefreshToken</span> <span class=\"hljs-variable\">refreshToken</span> <span class=\"hljs-operator\">=</span> authenticationTokenR.getData().getRefreshToken();\n<span class=\"hljs-comment\">// &#x5ba2;&#x6237;&#x7aef;&#x4fe1;&#x606f;</span>\n<span class=\"hljs-type\">RegisteredClient</span> <span class=\"hljs-variable\">registeredClient</span> <span class=\"hljs-operator\">=</span> authenticationTokenR.getData().getRegisteredClient(); \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"147,164"}}],"payload":{"tag":"h2","lines":"143,145"}},{"content":"&#x6821;&#x9a8c;&#x4ee4;&#x724c;&#x5fae;&#x8c03;","children":[{"content":"<pre data-lines=\"169,174\"><code>&#x901a;&#x8fc7;&#x5982;&#x4e0a;&#x4ee3;&#x7801;&#xff0c;&#x6211;&#x4eec;&#x5df2;&#x7ecf;&#x5b9e;&#x73b0;&#x4e86; token &#x7684;&#x65b9;&#x6cd5;&#xff1b;&#x63a5;&#x4e0b;&#x6765;&#x6211;&#x4eec;\n\n&#x9700;&#x8981;&#x5bf9;&#x6821;&#x9a8c;&#x4ee4;&#x724c;&#x7684;&#x903b;&#x8f91;&#x8fdb;&#x884c;&#x5fae;&#x8c03;&#xff0c;&#x4ee5;&#x4fbf;&#x8d44;&#x6e90;&#x670d;&#x52a1;&#x5668;&#x80fd;&#x591f;&#x8bc6;&#x522b;&#x54b1;&#x8fd9;&#x4e2a;&#x66b4;&#x529b; token&#x3002;\n\nPigCustomOpaqueTokenIntrospector &#x8c03;&#x6574;&#xff0c;&#x5982;&#x679c;&#x662f;&#x81ea;&#x5b9a;&#x4e49;&#x7b7e;&#x53d1;&#x7684; token&#xff0c;&#x76f4;&#x63a5;&#x8fd4;&#x56de;&#x7528;&#x6237;&#x4fe1;&#x606f;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"169,174"}},{"content":"<pre data-lines=\"177,182\"><code data-lines=\"177,182\">if (SecurityConstants.FROM.equals(oldAuthorization.getRegisteredClientId())){\n return (PigUser) ((UsernamePasswordAuthenticationToken) <span class=\"hljs-selector-class\">.requireNonNull</span>(oldAuthorization)<span class=\"hljs-selector-class\">.getAttributes</span>()<span class=\"hljs-selector-class\">.get</span>(Principal.class.getName()))<span class=\"hljs-selector-class\">.getPrincipal</span>();\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"177,182"}},{"content":"<img src=\"https://mintlify.s3.us-west-1.amazonaws.com/xzcxz/images/1730361982619-55fb5a98-468e-4ba5-9b75-0f77a7a0cbe0.png\" alt>","children":[],"payload":{"tag":"img","lines":"183,184"}}],"payload":{"tag":"h2","lines":"166,168"}}],"payload":{"tag":"h1","lines":"0,2"}},{})</script>
</body>
</html>
