<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.10/dist/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.11.1/styles/default.min.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.18.10/dist/browser/index.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.10/dist/index.js"></script><script>(r => {
              setTimeout(r);
            })(function renderToolbar() {
  const {
    markmap,
    mm
  } = window;
  const {
    el
  } = markmap.Toolbar.create(mm);
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, root2, jsonOptions) => {
              const markmap = getMarkmap();
              window.mm = markmap.Markmap.create(
                "svg#mindmap",
                (getOptions || markmap.deriveOptions)(jsonOptions),
                root2
              );
            })(() => window.markmap,null,{"content":"<a href=\"#%E6%B4%BE%E5%8F%91%E6%9B%B4%E6%96%B0\">#</a> &#x6d3e;&#x53d1;&#x66f4;&#x65b0;","children":[{"content":"<a href=\"#%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90\">#</a> &#x8fc7;&#x7a0b;&#x5206;&#x6790;","children":[{"content":"<pre data-lines=\"64,65\"><code>&#x5f53;&#x6211;&#x4eec;&#x5728;&#x7ec4;&#x4ef6;&#x4e2d;&#x5bf9;&#x54cd;&#x5e94;&#x7684;&#x6570;&#x636e;&#x505a;&#x4e86;&#x4fee;&#x6539;&#xff0c;&#x5c31;&#x4f1a;&#x89e6;&#x53d1; setter &#x7684;&#x903b;&#x8f91;&#xff0c;&#x6700;&#x540e;&#x8c03;&#x7528; `dep.notify()` &#x65b9;&#x6cd5;&#xff0c; &#x5b83;&#x662f; `Dep` &#x7684;&#x4e00;&#x4e2a;&#x5b9e;&#x4f8b;&#x65b9;&#x6cd5;&#xff0c;&#x5b9a;&#x4e49;&#x5728; `src/core/observer/dep.js` &#x4e2d;&#xff1a;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"64,65"}},{"content":"<pre data-lines=\"66,78\"><code data-lines=\"66,78\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">Dep</span> {\n  <span class=\"hljs-comment\">// ...</span>\n  notify () {\n  <span class=\"hljs-comment\">// stabilize the subscriber list first</span>\n    <span class=\"hljs-keyword\">const</span> subs = <span class=\"hljs-keyword\">this</span>.subs.slice()\n    <span class=\"hljs-keyword\">for</span> (let i = <span class=\"hljs-number\">0</span>, l = subs.length; i &lt; l; i++) {\n      subs[i].update()\n    }\n  }\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"66,78"}},{"content":"<pre data-lines=\"79,80\"><code>&#x8fd9;&#x91cc;&#x7684;&#x903b;&#x8f91;&#x975e;&#x5e38;&#x7b80;&#x5355;&#xff0c;&#x904d;&#x5386;&#x6240;&#x6709;&#x7684; `subs`&#xff0c;&#x4e5f;&#x5c31;&#x662f; `Watcher` &#x7684;&#x5b9e;&#x4f8b;&#x6570;&#x7ec4;&#xff0c;&#x7136;&#x540e;&#x8c03;&#x7528;&#x6bcf;&#x4e00;&#x4e2a; `watcher` &#x7684; `update` &#x65b9;&#x6cd5;&#xff0c;&#x5b83;&#x7684;&#x5b9a;&#x4e49;&#x5728; `src/core/observer/watcher.js` &#x4e2d;&#xff1a;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"79,80"}},{"content":"<pre data-lines=\"81,112\"><code data-lines=\"81,112\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">Watcher</span> {\n  <span class=\"hljs-comment\">// ...</span>\n  update () {\n    <span class=\"hljs-comment\">/* istanbul ignore else */</span>\n    <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">this</span>.computed) {\n      <span class=\"hljs-comment\">// A computed property watcher has two modes: lazy and activated.</span>\n      <span class=\"hljs-comment\">// It initializes as lazy by default, and only becomes activated when</span>\n      <span class=\"hljs-comment\">// it is depended on by at least one subscriber, which is typically</span>\n      <span class=\"hljs-comment\">// another computed property or a component&apos;s render function.</span>\n      <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">this</span>.dep.subs.length === <span class=\"hljs-number\">0</span>) {\n        <span class=\"hljs-comment\">// In lazy mode, we don&apos;t want to perform computations until necessary,</span>\n        <span class=\"hljs-comment\">// so we simply mark the watcher as dirty. The actual computation is</span>\n        <span class=\"hljs-comment\">// performed just-in-time in this.evaluate() when the computed property</span>\n        <span class=\"hljs-comment\">// is accessed.</span>\n        <span class=\"hljs-keyword\">this</span>.dirty = <span class=\"hljs-literal\">true</span>\n      } <span class=\"hljs-keyword\">else</span> {\n        <span class=\"hljs-comment\">// In activated mode, we want to proactively perform the computation</span>\n        <span class=\"hljs-comment\">// but only notify our subscribers when the value has indeed changed.</span>\n        <span class=\"hljs-keyword\">this</span>.getAndInvoke(() =&gt; {\n          <span class=\"hljs-keyword\">this</span>.dep.notify()\n        })\n      }\n    } <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">this</span>.sync) {\n      <span class=\"hljs-keyword\">this</span>.run()\n    } <span class=\"hljs-keyword\">else</span> {\n      queueWatcher(<span class=\"hljs-keyword\">this</span>)\n    }\n  }\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"81,112"}},{"content":"<pre data-lines=\"113,114\"><code>&#x8fd9;&#x91cc;&#x5bf9;&#x4e8e; `Watcher` &#x7684;&#x4e0d;&#x540c;&#x72b6;&#x6001;&#xff0c;&#x4f1a;&#x6267;&#x884c;&#x4e0d;&#x540c;&#x7684;&#x903b;&#x8f91;&#xff0c;`computed` &#x548c; `sync` &#x7b49;&#x72b6;&#x6001;&#x7684;&#x5206;&#x6790;&#x6211;&#x4f1a;&#x4e4b;&#x540e;&#x62bd;&#x4e00;&#x5c0f;&#x8282;&#x8be6;&#x7ec6;&#x4ecb;&#x7ecd;&#xff0c;&#x5728;&#x4e00;&#x822c;&#x7ec4;&#x4ef6;&#x6570;&#x636e;&#x66f4;&#x65b0;&#x7684;&#x573a;&#x666f;&#xff0c;&#x4f1a;&#x8d70;&#x5230;&#x6700;&#x540e;&#x4e00;&#x4e2a; `queueWatcher(this)` &#x7684;&#x903b;&#x8f91;&#xff0c;`queueWatcher` &#x7684;&#x5b9a;&#x4e49;&#x5728; `src/core/observer/scheduler.js` &#x4e2d;&#xff1a;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"113,114"}},{"content":"<pre data-lines=\"115,148\"><code data-lines=\"115,148\"><span class=\"hljs-keyword\">const</span> queue: Array&lt;Watcher&gt; = []\n<span class=\"hljs-keyword\">let</span> has: { [key: number]: ?<span class=\"hljs-literal\">true</span> } = {}\n<span class=\"hljs-keyword\">let</span> waiting = <span class=\"hljs-literal\">false</span>\n<span class=\"hljs-keyword\">let</span> flushing = <span class=\"hljs-literal\">false</span>\n<span class=\"hljs-comment\">/**\n * Push a watcher into the watcher queue.\n * Jobs with duplicate IDs will be skipped unless it&apos;s\n * pushed when the queue is being flushed.\n */</span>\n<span class=\"hljs-function\">export function <span class=\"hljs-title\">queueWatcher</span> (<span class=\"hljs-params\">watcher: Watcher</span>)</span> {\n  <span class=\"hljs-keyword\">const</span> id = watcher.<span class=\"hljs-function\">id\n  <span class=\"hljs-title\">if</span> (<span class=\"hljs-params\">has[id] == <span class=\"hljs-literal\">null</span></span>)</span> {\n    has[id] = <span class=\"hljs-function\"><span class=\"hljs-literal\">true</span>\n    <span class=\"hljs-title\">if</span> (<span class=\"hljs-params\">!flushing</span>)</span> {\n      queue.push(watcher)\n    } <span class=\"hljs-keyword\">else</span> {\n      <span class=\"hljs-comment\">// if already flushing, splice the watcher based on its id</span>\n      <span class=\"hljs-comment\">// if already past its id, it will be run next immediately.</span>\n      <span class=\"hljs-keyword\">let</span> i = queue.length - <span class=\"hljs-number\">1</span>\n      <span class=\"hljs-keyword\">while</span> (i &gt; index &amp;&amp; queue[i].id &gt; watcher.id) {\n        i--\n      }\n      queue.splice(i + <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">0</span>, watcher)\n    }\n    <span class=\"hljs-comment\">// queue the flush</span>\n    <span class=\"hljs-keyword\">if</span> (!waiting) {\n      waiting = <span class=\"hljs-function\"><span class=\"hljs-literal\">true</span>\n      <span class=\"hljs-title\">nextTick</span>(<span class=\"hljs-params\">flushSchedulerQueue</span>)\n    }\n  }\n} \n</span></code></pre>","children":[],"payload":{"tag":"pre","lines":"115,148"}},{"content":"<pre data-lines=\"149,154\"><code>&#x8fd9;&#x91cc;&#x5f15;&#x5165;&#x4e86;&#x4e00;&#x4e2a;&#x961f;&#x5217;&#x7684;&#x6982;&#x5ff5;&#xff0c;&#x8fd9;&#x4e5f;&#x662f; Vue &#x5728;&#x505a;&#x6d3e;&#x53d1;&#x66f4;&#x65b0;&#x7684;&#x65f6;&#x5019;&#x7684;&#x4e00;&#x4e2a;&#x4f18;&#x5316;&#x7684;&#x70b9;&#xff0c;&#x5b83;&#x5e76;&#x4e0d;&#x4f1a;&#x6bcf;&#x6b21;&#x6570;&#x636e;&#x6539;&#x53d8;&#x90fd;&#x89e6;&#x53d1; `watcher` &#x7684;&#x56de;&#x8c03;&#xff0c;&#x800c;&#x662f;&#x628a;&#x8fd9;&#x4e9b; `watcher` &#x5148;&#x6dfb;&#x52a0;&#x5230;&#x4e00;&#x4e2a;&#x961f;&#x5217;&#x91cc;&#xff0c;&#x7136;&#x540e;&#x5728; `nextTick` &#x540e;&#x6267;&#x884c; `flushSchedulerQueue`&#x3002;\n\n&#x8fd9;&#x91cc;&#x6709;&#x51e0;&#x4e2a;&#x7ec6;&#x8282;&#x8981;&#x6ce8;&#x610f;&#x4e00;&#x4e0b;&#xff0c;&#x9996;&#x5148;&#x7528; `has` &#x5bf9;&#x8c61;&#x4fdd;&#x8bc1;&#x540c;&#x4e00;&#x4e2a; `Watcher` &#x53ea;&#x6dfb;&#x52a0;&#x4e00;&#x6b21;&#xff1b;&#x63a5;&#x7740;&#x5bf9; `flushing` &#x7684;&#x5224;&#x65ad;&#xff0c;else &#x90e8;&#x5206;&#x7684;&#x903b;&#x8f91;&#x7a0d;&#x540e;&#x6211;&#x4f1a;&#x8bb2;&#xff1b;&#x6700;&#x540e;&#x901a;&#x8fc7; `waiting` &#x4fdd;&#x8bc1;&#x5bf9; `nextTick(flushSchedulerQueue)` &#x7684;&#x8c03;&#x7528;&#x903b;&#x8f91;&#x53ea;&#x6709;&#x4e00;&#x6b21;&#xff0c;&#x53e6;&#x5916; `nextTick` &#x7684;&#x5b9e;&#x73b0;&#x6211;&#x4e4b;&#x540e;&#x4f1a;&#x62bd;&#x4e00;&#x5c0f;&#x8282;&#x4e13;&#x95e8;&#x53bb;&#x8bb2;&#xff0c;&#x76ee;&#x524d;&#x5c31;&#x53ef;&#x4ee5;&#x7406;&#x89e3;&#x5b83;&#x662f;&#x5728;&#x4e0b;&#x4e00;&#x4e2a; tick&#xff0c;&#x4e5f;&#x5c31;&#x662f;&#x5f02;&#x6b65;&#x7684;&#x53bb;&#x6267;&#x884c; `flushSchedulerQueue`&#x3002;\n\n&#x63a5;&#x4e0b;&#x6765;&#x6211;&#x4eec;&#x6765;&#x770b; `flushSchedulerQueue` &#x7684;&#x5b9e;&#x73b0;&#xff0c;&#x5b83;&#x7684;&#x5b9a;&#x4e49;&#x5728; `src/core/observer/scheduler.js` &#x4e2d;&#x3002;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"149,154"}},{"content":"<pre data-lines=\"155,219\"><code data-lines=\"155,219\">let flushing = <span class=\"hljs-literal\">false</span>\nlet index = <span class=\"hljs-number\">0</span>\n<span class=\"hljs-comment\">/**\n * Flush both queues and run the watchers.\n */</span>\n<span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">flushSchedulerQueue</span> (<span class=\"hljs-params\"></span>) {\n  flushing = <span class=\"hljs-literal\">true</span>\n  let watcher, id\n\n  <span class=\"hljs-comment\">// Sort queue before flush.</span>\n  <span class=\"hljs-comment\">// This ensures that:</span>\n  <span class=\"hljs-comment\">// 1. Components are updated from parent to child. (because parent is always</span>\n  <span class=\"hljs-comment\">//    created before the child)</span>\n  <span class=\"hljs-comment\">// 2. A component&apos;s user watchers are run before its render watcher (because</span>\n  <span class=\"hljs-comment\">//    user watchers are created before the render watcher)</span>\n  <span class=\"hljs-comment\">// 3. If a component is destroyed during a parent component&apos;s watcher run,</span>\n  <span class=\"hljs-comment\">//    its watchers can be skipped.</span>\n  queue.<span class=\"hljs-built_in\">sort</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">a, b</span>) =&gt;</span> a.id - b.id)\n\n  <span class=\"hljs-comment\">// do not cache length because more watchers might be pushed</span>\n  <span class=\"hljs-comment\">// as we run existing watchers</span>\n  <span class=\"hljs-keyword\">for</span> (index = <span class=\"hljs-number\">0</span>; index &lt; queue.<span class=\"hljs-built_in\">length</span>; index++) {\n    watcher = queue[index]\n    <span class=\"hljs-keyword\">if</span> (watcher.before) {\n      watcher.before()\n    }\n    id = watcher.id\n    has[id] = <span class=\"hljs-literal\">null</span>\n    watcher.run()\n    <span class=\"hljs-comment\">// in dev build, check and stop circular updates.</span>\n    <span class=\"hljs-keyword\">if</span> (process.env.NODE_ENV !== <span class=\"hljs-string\">&apos;production&apos;</span> &amp;&amp; has[id] != <span class=\"hljs-literal\">null</span>) {\n      circular[id] = (circular[id] || <span class=\"hljs-number\">0</span>) + <span class=\"hljs-number\">1</span>\n      <span class=\"hljs-keyword\">if</span> (circular[id] &gt; MAX_UPDATE_COUNT) {\n        warn(\n          <span class=\"hljs-string\">&apos;You may have an infinite update loop &apos;</span> + (\n            watcher.user\n              ? <span class=\"hljs-string\">`in watcher with expression &quot;<span class=\"hljs-subst\">&#x24;{watcher.expression}</span>&quot;`</span>\n              : <span class=\"hljs-string\">`in a component render function.`</span>\n          ),\n          watcher.vm\n        )\n        <span class=\"hljs-keyword\">break</span>\n      }\n    }\n  }\n\n  <span class=\"hljs-comment\">// keep copies of post queues before resetting state</span>\n  const activatedQueue = activatedChildren.<span class=\"hljs-built_in\">slice</span>()\n  const updatedQueue = queue.<span class=\"hljs-built_in\">slice</span>()\n\n  resetSchedulerState()\n\n  <span class=\"hljs-comment\">// call component updated and activated hooks</span>\n  callActivatedHooks(activatedQueue)\n  callUpdatedHooks(updatedQueue)\n\n  <span class=\"hljs-comment\">// devtool hook</span>\n  <span class=\"hljs-comment\">/* istanbul ignore if */</span>\n  <span class=\"hljs-keyword\">if</span> (devtools &amp;&amp; config.devtools) {\n    devtools.emit(<span class=\"hljs-string\">&apos;flush&apos;</span>)\n  }\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"155,219"}},{"content":"<pre data-lines=\"220,235\"><code>&#x8fd9;&#x91cc;&#x6709;&#x51e0;&#x4e2a;&#x91cd;&#x8981;&#x7684;&#x903b;&#x8f91;&#x8981;&#x68b3;&#x7406;&#x4e00;&#x4e0b;&#xff0c;&#x5bf9;&#x4e8e;&#x4e00;&#x4e9b;&#x5206;&#x652f;&#x903b;&#x8f91;&#x5982; `keep-alive` &#x7ec4;&#x4ef6;&#x76f8;&#x5173;&#x548c;&#x4e4b;&#x524d;&#x63d0;&#x5230;&#x8fc7;&#x7684; `updated` &#x94a9;&#x5b50;&#x51fd;&#x6570;&#x7684;&#x6267;&#x884c;&#x4f1a;&#x7565;&#x8fc7;&#x3002;\n\n*   &#x961f;&#x5217;&#x6392;&#x5e8f;\n\n`queue.sort((a, b) =&gt; a.id - b.id)` &#x5bf9;&#x961f;&#x5217;&#x505a;&#x4e86;&#x4ece;&#x5c0f;&#x5230;&#x5927;&#x7684;&#x6392;&#x5e8f;&#xff0c;&#x8fd9;&#x4e48;&#x505a;&#x4e3b;&#x8981;&#x6709;&#x4ee5;&#x4e0b;&#x8981;&#x786e;&#x4fdd;&#x4ee5;&#x4e0b;&#x51e0;&#x70b9;&#xff1a;\n\n1.&#x7ec4;&#x4ef6;&#x7684;&#x66f4;&#x65b0;&#x7531;&#x7236;&#x5230;&#x5b50;&#xff1b;&#x56e0;&#x4e3a;&#x7236;&#x7ec4;&#x4ef6;&#x7684;&#x521b;&#x5efa;&#x8fc7;&#x7a0b;&#x662f;&#x5148;&#x4e8e;&#x5b50;&#x7684;&#xff0c;&#x6240;&#x4ee5; `watcher` &#x7684;&#x521b;&#x5efa;&#x4e5f;&#x662f;&#x5148;&#x7236;&#x540e;&#x5b50;&#xff0c;&#x6267;&#x884c;&#x987a;&#x5e8f;&#x4e5f;&#x5e94;&#x8be5;&#x4fdd;&#x6301;&#x5148;&#x7236;&#x540e;&#x5b50;&#x3002;\n\n2.&#x7528;&#x6237;&#x7684;&#x81ea;&#x5b9a;&#x4e49; `watcher` &#x8981;&#x4f18;&#x5148;&#x4e8e;&#x6e32;&#x67d3; `watcher` &#x6267;&#x884c;&#xff1b;&#x56e0;&#x4e3a;&#x7528;&#x6237;&#x81ea;&#x5b9a;&#x4e49; `watcher` &#x662f;&#x5728;&#x6e32;&#x67d3; `watcher` &#x4e4b;&#x524d;&#x521b;&#x5efa;&#x7684;&#x3002;\n\n3.&#x5982;&#x679c;&#x4e00;&#x4e2a;&#x7ec4;&#x4ef6;&#x5728;&#x7236;&#x7ec4;&#x4ef6;&#x7684; `watcher` &#x6267;&#x884c;&#x671f;&#x95f4;&#x88ab;&#x9500;&#x6bc1;&#xff0c;&#x90a3;&#x4e48;&#x5b83;&#x5bf9;&#x5e94;&#x7684; `watcher` &#x6267;&#x884c;&#x90fd;&#x53ef;&#x4ee5;&#x88ab;&#x8df3;&#x8fc7;&#xff0c;&#x6240;&#x4ee5;&#x7236;&#x7ec4;&#x4ef6;&#x7684; `watcher` &#x5e94;&#x8be5;&#x5148;&#x6267;&#x884c;&#x3002;\n\n*   &#x961f;&#x5217;&#x904d;&#x5386;\n\n&#x5728;&#x5bf9; `queue` &#x6392;&#x5e8f;&#x540e;&#xff0c;&#x63a5;&#x7740;&#x5c31;&#x662f;&#x8981;&#x5bf9;&#x5b83;&#x505a;&#x904d;&#x5386;&#xff0c;&#x62ff;&#x5230;&#x5bf9;&#x5e94;&#x7684; `watcher`&#xff0c;&#x6267;&#x884c; `watcher.run()`&#x3002;&#x8fd9;&#x91cc;&#x9700;&#x8981;&#x6ce8;&#x610f;&#x4e00;&#x4e2a;&#x7ec6;&#x8282;&#xff0c;&#x5728;&#x904d;&#x5386;&#x7684;&#x65f6;&#x5019;&#x6bcf;&#x6b21;&#x90fd;&#x4f1a;&#x5bf9; `queue.length` &#x6c42;&#x503c;&#xff0c;&#x56e0;&#x4e3a;&#x5728; `watcher.run()` &#x7684;&#x65f6;&#x5019;&#xff0c;&#x5f88;&#x53ef;&#x80fd;&#x7528;&#x6237;&#x4f1a;&#x518d;&#x6b21;&#x6dfb;&#x52a0;&#x65b0;&#x7684; `watcher`&#xff0c;&#x8fd9;&#x6837;&#x4f1a;&#x518d;&#x6b21;&#x6267;&#x884c;&#x5230; `queueWatcher`&#xff0c;&#x5982;&#x4e0b;&#xff1a;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"220,235"}},{"content":"<pre data-lines=\"236,256\"><code data-lines=\"236,256\">export <span class=\"hljs-keyword\">function</span> queueWatcher (watcher<span class=\"hljs-operator\">:</span> Watcher) {\n  const <span class=\"hljs-built_in\">id</span> <span class=\"hljs-operator\">=</span> watcher.<span class=\"hljs-built_in\">id</span>\n  <span class=\"hljs-keyword\">if</span> (has[<span class=\"hljs-built_in\">id</span>] <span class=\"hljs-operator\">==</span> <span class=\"hljs-literal\">null</span>) {\n    has[<span class=\"hljs-built_in\">id</span>] <span class=\"hljs-operator\">=</span> <span class=\"hljs-literal\">true</span>\n    <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-operator\">!</span>flushing) {\n      queue.push(watcher)\n    } <span class=\"hljs-keyword\">else</span> {\n      <span class=\"hljs-comment\">// if already flushing, splice the watcher based on its id</span>\n      <span class=\"hljs-comment\">// if already past its id, it will be run next immediately.</span>\n      <span class=\"hljs-keyword\">let</span> i <span class=\"hljs-operator\">=</span> queue.length <span class=\"hljs-operator\">-</span> <span class=\"hljs-number\">1</span>\n      <span class=\"hljs-keyword\">while</span> (i <span class=\"hljs-operator\">&gt;</span> index <span class=\"hljs-operator\">&amp;&amp;</span> queue[i].<span class=\"hljs-built_in\">id</span> <span class=\"hljs-operator\">&gt;</span> watcher.<span class=\"hljs-built_in\">id</span>) {\n        i<span class=\"hljs-operator\">--</span>\n      }\n      queue.splice(i <span class=\"hljs-operator\">+</span> <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">0</span>, watcher)\n    }\n    <span class=\"hljs-comment\">// ...</span>\n  }\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"236,256"}},{"content":"<pre data-lines=\"257,262\"><code>&#x53ef;&#x4ee5;&#x770b;&#x5230;&#xff0c;&#x8fd9;&#x65f6;&#x5019; `flushing` &#x4e3a; true&#xff0c;&#x5c31;&#x4f1a;&#x6267;&#x884c;&#x5230; else &#x7684;&#x903b;&#x8f91;&#xff0c;&#x7136;&#x540e;&#x5c31;&#x4f1a;&#x4ece;&#x540e;&#x5f80;&#x524d;&#x627e;&#xff0c;&#x627e;&#x5230;&#x7b2c;&#x4e00;&#x4e2a;&#x5f85;&#x63d2;&#x5165; `watcher` &#x7684; id &#x6bd4;&#x5f53;&#x524d;&#x961f;&#x5217;&#x4e2d; `watcher` &#x7684; id &#x5927;&#x7684;&#x4f4d;&#x7f6e;&#x3002;&#x628a; `watcher` &#x6309;&#x7167; `id`&#x7684;&#x63d2;&#x5165;&#x5230;&#x961f;&#x5217;&#x4e2d;&#xff0c;&#x56e0;&#x6b64; `queue` &#x7684;&#x957f;&#x5ea6;&#x53d1;&#x751f;&#x4e86;&#x53d8;&#x5316;&#x3002;\n\n*   &#x72b6;&#x6001;&#x6062;&#x590d;\n\n&#x8fd9;&#x4e2a;&#x8fc7;&#x7a0b;&#x5c31;&#x662f;&#x6267;&#x884c; `resetSchedulerState` &#x51fd;&#x6570;&#xff0c;&#x5b83;&#x7684;&#x5b9a;&#x4e49;&#x5728; `src/core/observer/scheduler.js` &#x4e2d;&#x3002;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"257,262"}},{"content":"<pre data-lines=\"263,282\"><code data-lines=\"263,282\">const <span class=\"hljs-params\">queue:</span> Array<span class=\"hljs-symbol\">&lt;Watcher&gt;</span> <span class=\"hljs-operator\">=</span> []\n<span class=\"hljs-keyword\">let</span> <span class=\"hljs-params\">has:</span> { [<span class=\"hljs-params\">key:</span> number]: <span class=\"hljs-operator\">?</span><span class=\"hljs-literal\">true</span> } <span class=\"hljs-operator\">=</span> {}\n<span class=\"hljs-keyword\">let</span> <span class=\"hljs-params\">circular:</span> { [<span class=\"hljs-params\">key:</span> number]: number } <span class=\"hljs-operator\">=</span> {}\n<span class=\"hljs-keyword\">let</span> waiting <span class=\"hljs-operator\">=</span> <span class=\"hljs-literal\">false</span>\n<span class=\"hljs-keyword\">let</span> flushing <span class=\"hljs-operator\">=</span> <span class=\"hljs-literal\">false</span>\n<span class=\"hljs-keyword\">let</span> index <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">0</span>\n<span class=\"hljs-comment\">/**\n * Reset the scheduler&apos;s state.\n */</span>\nfunction resetSchedulerState () {\n  <span class=\"hljs-attr\">index</span> <span class=\"hljs-operator\">=</span> queue.length <span class=\"hljs-operator\">=</span> activatedChildren.length <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">0</span>\n  <span class=\"hljs-attr\">has</span> <span class=\"hljs-operator\">=</span> {}\n  <span class=\"hljs-keyword\">if</span> (process.env.NODE_ENV <span class=\"hljs-operator\">!=</span><span class=\"hljs-operator\">=</span> &apos;production&apos;) {\n    <span class=\"hljs-attr\">circular</span> <span class=\"hljs-operator\">=</span> {}\n  }\n  <span class=\"hljs-attr\">waiting</span> <span class=\"hljs-operator\">=</span> flushing <span class=\"hljs-operator\">=</span> <span class=\"hljs-literal\">false</span>\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"263,282"}},{"content":"<pre data-lines=\"283,286\"><code>&#x903b;&#x8f91;&#x975e;&#x5e38;&#x7b80;&#x5355;&#xff0c;&#x5c31;&#x662f;&#x628a;&#x8fd9;&#x4e9b;&#x63a7;&#x5236;&#x6d41;&#x7a0b;&#x72b6;&#x6001;&#x7684;&#x4e00;&#x4e9b;&#x53d8;&#x91cf;&#x6062;&#x590d;&#x5230;&#x521d;&#x59cb;&#x503c;&#xff0c;&#x628a; `watcher` &#x961f;&#x5217;&#x6e05;&#x7a7a;&#x3002;\n\n&#x63a5;&#x4e0b;&#x6765;&#x6211;&#x4eec;&#x7ee7;&#x7eed;&#x5206;&#x6790; `watcher.run()` &#x7684;&#x903b;&#x8f91;&#xff0c;&#x5b83;&#x7684;&#x5b9a;&#x4e49;&#x5728; `src/core/observer/watcher.js` &#x4e2d;&#x3002;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"283,286"}},{"content":"<pre data-lines=\"287,326\"><code data-lines=\"287,326\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">Watcher</span> {\n  <span class=\"hljs-comment\">/**\n   * Scheduler job interface.\n   * Will be called by the scheduler.\n   */</span>\n  run () {\n    <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">this</span>.active) {\n      <span class=\"hljs-keyword\">this</span>.getAndInvoke(<span class=\"hljs-keyword\">this</span>.cb)\n    }\n  }\n\n  getAndInvoke (cb: Function) {\n    <span class=\"hljs-keyword\">const</span> value = <span class=\"hljs-keyword\">this</span>.<span class=\"hljs-keyword\">get</span>()\n    <span class=\"hljs-keyword\">if</span> (\n      value !== <span class=\"hljs-keyword\">this</span>.value ||\n      <span class=\"hljs-comment\">// Deep watchers and watchers on Object/Arrays should fire even</span>\n      <span class=\"hljs-comment\">// when the value is the same, because the value may</span>\n      <span class=\"hljs-comment\">// have mutated.</span>\n      isObject(value) ||\n      <span class=\"hljs-keyword\">this</span>.deep\n    ) {\n      <span class=\"hljs-comment\">// set new value</span>\n      <span class=\"hljs-keyword\">const</span> oldValue = <span class=\"hljs-keyword\">this</span>.value\n      <span class=\"hljs-keyword\">this</span>.value = value\n      <span class=\"hljs-keyword\">this</span>.dirty = <span class=\"hljs-literal\">false</span>\n      <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">this</span>.user) {\n        <span class=\"hljs-keyword\">try</span> {\n          cb.call(<span class=\"hljs-keyword\">this</span>.vm, value, oldValue)\n        } <span class=\"hljs-keyword\">catch</span> (e) {\n          handleError(e, <span class=\"hljs-keyword\">this</span>.vm, `callback <span class=\"hljs-keyword\">for</span> watcher <span class=\"hljs-string\">&quot;<span class=\"hljs-subst\">&#x24;{this.expression}</span>&quot;</span>`)\n        }\n      } <span class=\"hljs-keyword\">else</span> {\n        cb.call(<span class=\"hljs-keyword\">this</span>.vm, value, oldValue)\n      }\n    }\n  }\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"287,326"}},{"content":"<pre data-lines=\"327,330\"><code>`run` &#x51fd;&#x6570;&#x5b9e;&#x9645;&#x4e0a;&#x5c31;&#x662f;&#x6267;&#x884c; `this.getAndInvoke` &#x65b9;&#x6cd5;&#xff0c;&#x5e76;&#x4f20;&#x5165; `watcher` &#x7684;&#x56de;&#x8c03;&#x51fd;&#x6570;&#x3002;`getAndInvoke` &#x51fd;&#x6570;&#x903b;&#x8f91;&#x4e5f;&#x5f88;&#x7b80;&#x5355;&#xff0c;&#x5148;&#x901a;&#x8fc7; `this.get()` &#x5f97;&#x5230;&#x5b83;&#x5f53;&#x524d;&#x7684;&#x503c;&#xff0c;&#x7136;&#x540e;&#x505a;&#x5224;&#x65ad;&#xff0c;&#x5982;&#x679c;&#x6ee1;&#x8db3;&#x65b0;&#x65e7;&#x503c;&#x4e0d;&#x7b49;&#x3001;&#x65b0;&#x503c;&#x662f;&#x5bf9;&#x8c61;&#x7c7b;&#x578b;&#x3001;`deep` &#x6a21;&#x5f0f;&#x4efb;&#x4f55;&#x4e00;&#x4e2a;&#x6761;&#x4ef6;&#xff0c;&#x5219;&#x6267;&#x884c; `watcher` &#x7684;&#x56de;&#x8c03;&#xff0c;&#x6ce8;&#x610f;&#x56de;&#x8c03;&#x51fd;&#x6570;&#x6267;&#x884c;&#x7684;&#x65f6;&#x5019;&#x4f1a;&#x628a;&#x7b2c;&#x4e00;&#x4e2a;&#x548c;&#x7b2c;&#x4e8c;&#x4e2a;&#x53c2;&#x6570;&#x4f20;&#x5165;&#x65b0;&#x503c; `value` &#x548c;&#x65e7;&#x503c; `oldValue`&#xff0c;&#x8fd9;&#x5c31;&#x662f;&#x5f53;&#x6211;&#x4eec;&#x6dfb;&#x52a0;&#x81ea;&#x5b9a;&#x4e49; `watcher` &#x7684;&#x65f6;&#x5019;&#x80fd;&#x5728;&#x56de;&#x8c03;&#x51fd;&#x6570;&#x7684;&#x53c2;&#x6570;&#x4e2d;&#x62ff;&#x5230;&#x65b0;&#x65e7;&#x503c;&#x7684;&#x539f;&#x56e0;&#x3002;\n\n&#x90a3;&#x4e48;&#x5bf9;&#x4e8e;&#x6e32;&#x67d3; `watcher` &#x800c;&#x8a00;&#xff0c;&#x5b83;&#x5728;&#x6267;&#x884c; `this.get()` &#x65b9;&#x6cd5;&#x6c42;&#x503c;&#x7684;&#x65f6;&#x5019;&#xff0c;&#x4f1a;&#x6267;&#x884c; `getter` &#x65b9;&#x6cd5;&#xff1a;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"327,330"}},{"content":"<pre data-lines=\"331,336\"><code data-lines=\"331,336\"><span class=\"hljs-function\"><span class=\"hljs-title\">updateComponent</span> = <span class=\"hljs-params\">()</span> =&gt;</span> {\n  vm._update(vm._render(), hydrating)\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"331,336"}},{"content":"<pre data-lines=\"337,338\"><code>&#x6240;&#x4ee5;&#x8fd9;&#x5c31;&#x662f;&#x5f53;&#x6211;&#x4eec;&#x53bb;&#x4fee;&#x6539;&#x7ec4;&#x4ef6;&#x76f8;&#x5173;&#x7684;&#x54cd;&#x5e94;&#x5f0f;&#x6570;&#x636e;&#x7684;&#x65f6;&#x5019;&#xff0c;&#x4f1a;&#x89e6;&#x53d1;&#x7ec4;&#x4ef6;&#x91cd;&#x65b0;&#x6e32;&#x67d3;&#x7684;&#x539f;&#x56e0;&#xff0c;&#x63a5;&#x7740;&#x5c31;&#x4f1a;&#x91cd;&#x65b0;&#x6267;&#x884c; `patch` &#x7684;&#x8fc7;&#x7a0b;&#xff0c;&#x4f46;&#x5b83;&#x548c;&#x9996;&#x6b21;&#x6e32;&#x67d3;&#x6709;&#x6240;&#x4e0d;&#x540c;&#xff0c;&#x4e4b;&#x540e;&#x6211;&#x4eec;&#x4f1a;&#x82b1;&#x4e00;&#x5c0f;&#x8282;&#x53bb;&#x8be6;&#x7ec6;&#x4ecb;&#x7ecd;&#x3002;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"337,338"}}],"payload":{"tag":"h2","lines":"61,63"}},{"content":"<a href=\"#%E6%80%BB%E7%BB%93\">#</a> &#x603b;&#x7ed3;","children":[],"payload":{"tag":"h2","lines":"339,341"}}],"payload":{"tag":"h1","lines":"0,2"}},{})</script>
</body>
</html>
