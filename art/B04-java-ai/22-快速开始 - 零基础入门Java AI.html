<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://unpkg.com/markmap-toolbar@0.18.10/dist/style.css"><link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.11.1/styles/default.min.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://unpkg.com/d3@7.9.0/dist/d3.min.js"></script><script src="https://unpkg.com/markmap-view@0.18.10/dist/browser/index.js"></script><script src="https://unpkg.com/markmap-toolbar@0.18.10/dist/index.js"></script><script>(r => {
              setTimeout(r);
            })(function renderToolbar() {
  const {
    markmap,
    mm
  } = window;
  const {
    el
  } = markmap.Toolbar.create(mm);
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, root2, jsonOptions) => {
              const markmap = getMarkmap();
              window.mm = markmap.Markmap.create(
                "svg#mindmap",
                (getOptions || markmap.deriveOptions)(jsonOptions),
                root2
              );
            })(() => window.markmap,null,{"content":"&#x5feb;&#x901f;&#x5f00;&#x59cb;","children":[{"content":"Maven &#x4f9d;&#x8d56;","children":[{"content":"<pre data-lines=\"7,8\"><code>&#x5728;&#x4f60;&#x7684; `pom.xml` &#x4e2d;&#x6dfb;&#x52a0;&#x4ee5;&#x4e0b;&#x4f9d;&#x8d56;&#xff1a; [![](https://img.shields.io/maven-central/v/io.github.pig-mesh.ai/deepseek4j.svg?style=flat-square)\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"7,8"}},{"content":"<pre data-lines=\"13,20\"><code data-lines=\"13,20\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span>\n <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>io.github.pig-mesh.ai<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span>\n <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>deepseek-spring-boot-starter<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span>\n <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>1.4.3<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span> \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"13,20"}}],"payload":{"tag":"h2","lines":"4,6"}},{"content":"&#x57fa;&#x7840;&#x914d;&#x7f6e;","children":[{"content":"<pre data-lines=\"25,26\"><code>&#x5728; `application.yml` &#x6216; `application.properties` &#x4e2d;&#x6dfb;&#x52a0;&#x5fc5;&#x8981;&#x7684;&#x914d;&#x7f6e;&#xff1a;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"25,26"}},{"content":"<pre data-lines=\"29,35\"><code data-lines=\"29,35\"><span class=\"hljs-params\">deepseek:</span>\n <span class=\"hljs-params\">api-key:</span> your-api-key-here  <span class=\"hljs-comment\"># &#x5fc5;&#x586b;&#x9879;&#xff1a;&#x4f60;&#x7684; API &#x5bc6;&#x94a5;</span>\n <span class=\"hljs-params\">model:</span> deepseek-reasoner\n <span class=\"hljs-params\">base-url:</span> https:<span class=\"hljs-symbol\">//api.deepseek.com</span>  <span class=\"hljs-comment\"># &#x53ef;&#x9009;&#xff0c;&#x9ed8;&#x8ba4;&#x4e3a;&#x5b98;&#x65b9; API &#x5730;&#x5740; </span>\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"29,35"}}],"payload":{"tag":"h2","lines":"22,24"}},{"content":"&#x57fa;&#x7840;&#x4f7f;&#x7528;&#x793a;&#x4f8b;","children":[{"content":"1. &#x6d41;&#x5f0f;&#x8fd4;&#x56de;&#x793a;&#x4f8b;","children":[{"content":"<pre data-lines=\"44,53\"><code data-lines=\"44,53\"><span class=\"hljs-meta\">@Autowired</span>\n<span class=\"hljs-keyword\">private</span> <span class=\"hljs-title class_\">DeepSeekClient</span> deepSeekClient;\n\n<span class=\"hljs-meta\">@GetMapping</span>(value = <span class=\"hljs-string\">&quot;/chat&quot;</span>, produces = <span class=\"hljs-title class_\">MediaType</span>.<span class=\"hljs-property\">TEXT_EVENT_STREAM_VALUE</span>)\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-title class_\">Flux</span>&lt;<span class=\"hljs-title class_\">ChatCompletionResponse</span>&gt; <span class=\"hljs-title function_\">chat</span>(<span class=\"hljs-params\"><span class=\"hljs-title class_\">String</span> prompt</span>) {\n <span class=\"hljs-keyword\">return</span> deepSeekClient.<span class=\"hljs-title function_\">chatFluxCompletion</span>(prompt);\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"44,53"}}],"payload":{"tag":"h3","lines":"40,41"}},{"content":"2. &#x8fdb;&#x9636;&#x914d;&#x7f6e;&#x793a;&#x4f8b;","children":[{"content":"<pre data-lines=\"56,57\"><code>*   ChatCompletionRequest &#x914d;&#x7f6e;&#x6784;&#x9020;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"56,57"}},{"content":"<pre data-lines=\"60,79\"><code data-lines=\"60,79\">@GetMapping<span class=\"hljs-params\">(<span class=\"hljs-attr\">value</span> = &quot;/chat/advanced&quot;, <span class=\"hljs-attr\">produces</span> = MediaType.TEXT_EVENT_STREAM_VALUE)</span>\npublic Flux&lt;ChatCompletionResponse&gt; chatAdvanced<span class=\"hljs-params\">(String prompt)</span> {\n ChatCompletionRequest request = ChatCompletionRequest.builder<span class=\"hljs-params\">()</span>\n <span class=\"hljs-string\">//</span> &#x6a21;&#x578b;&#x9009;&#x62e9;&#xff0c;&#x652f;&#x6301; DEEPSEEK_CHAT&#x3001;DEEPSEEK_REASONER &#x7b49;\n <span class=\"hljs-string\">.model</span><span class=\"hljs-params\">(ChatCompletionModel.DEEPSEEK_REASONER)</span>\n <span class=\"hljs-string\">//</span> &#x6dfb;&#x52a0;&#x7528;&#x6237;&#x6d88;&#x606f;\n <span class=\"hljs-string\">.addUserMessage</span><span class=\"hljs-params\">(prompt)</span>\n <span class=\"hljs-string\">//</span> &#x8bbe;&#x7f6e;&#x6700;&#x5927;&#x751f;&#x6210; token &#x6570;&#xff0c;&#x9ed8;&#x8ba4; 2048\n <span class=\"hljs-string\">.maxTokens</span><span class=\"hljs-params\">(1000)</span>\n <span class=\"hljs-string\">//</span> &#x8bbe;&#x7f6e;&#x54cd;&#x5e94;&#x683c;&#x5f0f;&#xff0c;&#x652f;&#x6301; JSON &#x7ed3;&#x6784;&#x5316;&#x8f93;&#x51fa;\n <span class=\"hljs-string\">.responseFormat</span><span class=\"hljs-params\">(...)</span> <span class=\"hljs-string\">//</span> &#x53ef;&#x9009;\n <span class=\"hljs-string\">//</span> function calling\n <span class=\"hljs-string\">.tools</span><span class=\"hljs-params\">(...)</span> <span class=\"hljs-string\">//</span> &#x53ef;&#x9009;\n <span class=\"hljs-string\">.build</span><span class=\"hljs-params\">()</span>;\n        \n return deepSeekClient.chatFluxCompletion<span class=\"hljs-params\">(request)</span>;\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"60,79"}},{"content":"<pre data-lines=\"80,81\"><code>*   &#x591a;&#x8f6e;&#x4f1a;&#x8bdd;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"80,81"}},{"content":"<pre data-lines=\"84,110\"><code data-lines=\"84,110\"> <span class=\"hljs-keyword\">public</span> final static HashMap&lt;<span class=\"hljs-built_in\">String</span>, <span class=\"hljs-built_in\">String</span>&gt; <span class=\"hljs-keyword\">cache</span> = <span class=\"hljs-literal\">new</span> HashMap&lt;&gt;();\n\n @GetMapping(value = <span class=\"hljs-string\">&quot;/chat/advanced&quot;</span>, produces = MediaType.TEXT_EVENT_STREAM_VALUE)\n <span class=\"hljs-keyword\">public</span> Flux&lt;ChatCompletionResponse&gt; chatAdvanced(<span class=\"hljs-built_in\">String</span> prompt, <span class=\"hljs-built_in\">String</span> cacheCode) {\n <span class=\"hljs-keyword\">log</span>.info(<span class=\"hljs-string\">&quot;cacheCode {}&quot;</span>, cacheCode);\n\n ChatCompletionRequest request = ChatCompletionRequest.builder().model(deepSeekProperties.getModel())\n .addUserMessage(prompt)\n .addAssistantMessage(elt.apply(<span class=\"hljs-keyword\">cache</span>.getOrDefault(cacheCode, <span class=\"hljs-string\">&quot;&quot;</span>)))\n .addSystemMessage(<span class=\"hljs-string\">&quot;&#x4f60;&#x662f;&#x4e00;&#x4e2a;&#x4e13;&#x4e1a;&#x7684;&#x52a9;&#x624b;&quot;</span>).maxCompletionTokens(<span class=\"hljs-number\">5000</span>).build();\n <span class=\"hljs-keyword\">log</span>.info(<span class=\"hljs-string\">&quot;request {}&quot;</span>, Json.toJson(request));\n <span class=\"hljs-comment\">// &#x53ea;&#x4fdd;&#x7559;&#x4e0a;&#x4e00;&#x6b21;&#x56de;&#x7b54;&#x5185;&#x5bb9;</span>\n <span class=\"hljs-keyword\">cache</span>.remove(cacheCode);\n <span class=\"hljs-keyword\">return</span> deepSeekClient.chatFluxCompletion(request).doOnNext(i -&gt; {\n <span class=\"hljs-built_in\">String</span> content = choicesProcess.apply(i.choices());\n <span class=\"hljs-comment\">// &#x5176;&#x4ed6;ELT&#x6d41;&#x7a0b;</span>\n <span class=\"hljs-keyword\">cache</span>.merge(cacheCode, content, <span class=\"hljs-built_in\">String</span><span class=\"hljs-type\">::concat</span>);\n }).doOnError(e -&gt; <span class=\"hljs-keyword\">log</span>.error(<span class=\"hljs-string\">&quot;/chat/advanced error:{}&quot;</span>, e.getMessage()));\n }\n\n Function&lt;<span class=\"hljs-built_in\">List</span>&lt;ChatCompletionChoice&gt;, <span class=\"hljs-built_in\">String</span>&gt; choicesProcess = <span class=\"hljs-built_in\">list</span> -&gt; <span class=\"hljs-built_in\">list</span>.stream().<span class=\"hljs-built_in\">map</span>(e -&gt; e.delta().content())\n .collect(Collectors.joining());\n\n Function&lt;<span class=\"hljs-built_in\">String</span>, <span class=\"hljs-built_in\">String</span>&gt; elt = s -&gt; s.replaceAll(<span class=\"hljs-string\">&quot;&lt;think&gt;[\\\\s\\\\S]*?&lt;/think&gt;&quot;</span>, <span class=\"hljs-string\">&quot;&quot;</span>).replaceAll(<span class=\"hljs-string\">&quot;\\n&quot;</span>, <span class=\"hljs-string\">&quot;&quot;</span>); \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"84,110"}}],"payload":{"tag":"h3","lines":"54,55"}},{"content":"3. &#x540c;&#x6b65;&#x8f93;&#x51fa; &#xff08;&#x975e;&#x5b9e;&#x65f6;&#x54cd;&#x5e94;&#x6d41;&#xff09;","children":[{"content":"<pre data-lines=\"113,114\"><code>&#x4e0d;&#x63a8;&#x8350;&#x4f7f;&#x7528;&#x540c;&#x6b65;&#x963b;&#x585e;&#x8c03;&#x7528;&#x65b9;&#x5f0f;&#xff0c;R1&#x6a21;&#x578b;&#x63a8;&#x7406;&#x8017;&#x65f6;&#x8f83;&#x957f;&#x6613;&#x5bfc;&#x81f4;&#x5ba2;&#x6237;&#x7aef;&#x8fde;&#x63a5;&#x8d85;&#x65f6;&#xff0c;&#x4e14;&#x54cd;&#x5e94;&#x5ef6;&#x8fdf;&#x4f1a;&#x5f71;&#x54cd;&#x7528;&#x6237;&#x4f53;&#x9a8c;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"113,114"}},{"content":"<pre data-lines=\"117,128\"><code data-lines=\"117,128\"><span class=\"hljs-meta\">@GetMapping</span>(value = <span class=\"hljs-string\">&quot;/sync/chat&quot;</span>)\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-title class_\">ChatCompletionResponse</span> <span class=\"hljs-title function_\">syncChat</span>(<span class=\"hljs-params\"><span class=\"hljs-title class_\">String</span> prompt</span>) {\n <span class=\"hljs-title class_\">ChatCompletionRequest</span> request = <span class=\"hljs-title class_\">ChatCompletionRequest</span>.<span class=\"hljs-title function_\">builder</span>()\n <span class=\"hljs-comment\">// &#x6839;&#x636e;&#x6e20;&#x9053;&#x6a21;&#x578b;&#x540d;&#x79f0;&#x52a8;&#x6001;&#x4fee;&#x6539;&#x8fd9;&#x4e2a;&#x53c2;&#x6570;</span>\n .<span class=\"hljs-title function_\">model</span>(deepSeekProperties.<span class=\"hljs-title function_\">getModel</span>())\n .<span class=\"hljs-title function_\">addUserMessage</span>(prompt).<span class=\"hljs-title function_\">build</span>();\n\n <span class=\"hljs-keyword\">return</span> deepSeekClient.<span class=\"hljs-title function_\">chatCompletion</span>(request).<span class=\"hljs-title function_\">execute</span>();\n} \n</code></pre>","children":[],"payload":{"tag":"pre","lines":"117,128"}}],"payload":{"tag":"h3","lines":"111,112"}}],"payload":{"tag":"h2","lines":"37,39"}}],"payload":{"tag":"h1","lines":"0,2"}},{})</script>
</body>
</html>
