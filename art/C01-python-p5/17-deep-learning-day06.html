<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.10/dist/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.11.1/styles/default.min.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.18.10/dist/browser/index.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.10/dist/index.js"></script><script>(r => {
              setTimeout(r);
            })(function renderToolbar() {
  const {
    markmap,
    mm
  } = window;
  const {
    el
  } = markmap.Toolbar.create(mm);
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, root2, jsonOptions) => {
              const markmap = getMarkmap();
              window.mm = markmap.Markmap.create(
                "svg#mindmap",
                (getOptions || markmap.deriveOptions)(jsonOptions),
                root2
              );
            })(() => window.markmap,null,{"content":"Deep-Learning","children":[{"content":"&#x793a;&#x4f8b;","children":[{"content":"<pre data-lines=\"6,31\"><code class=\"language-python\"><span class=\"hljs-comment\"># 01_reader.py</span>\n<span class=\"hljs-comment\"># &#x6587;&#x4ef6;&#x8bfb;&#x53d6;&#x793a;&#x4f8b;</span>\n<span class=\"hljs-string\">&quot;&quot;&quot;\n1. &#x81ea;&#x5b9a;&#x4e49;&#x4e00;&#x4e2a;&#x6587;&#x4ef6;&#x8bfb;&#x53d6;&#x5668;&#xff0c;&#x8bfb;&#x53d6;&#x6587;&#x672c;&#x6587;&#x4ef6;&#x4e2d;&#x7684;&#x5185;&#x5bb9;\n2. &#x5c06;&#x81ea;&#x5b9a;&#x4e49;&#x8bfb;&#x53d6;&#x5668;&#x5305;&#x88c5;&#x6210;&#x968f;&#x673a;&#x8bfb;&#x53d6;&#x5668;\n3. &#x5c06;&#x968f;&#x673a;&#x8bfb;&#x53d6;&#x5668;&#x5305;&#x88c5;&#x6210;&#x6279;&#x91cf;&#x8bfb;&#x53d6;&#x5668;\n&quot;&quot;&quot;</span>\n<span class=\"hljs-keyword\">import</span> paddle\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">reader_creator</span>(<span class=\"hljs-params\">file_path</span>):\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">reader</span>():\n        <span class=\"hljs-keyword\">with</span> <span class=\"hljs-built_in\">open</span>(file_path, <span class=\"hljs-string\">&quot;r&quot;</span>) <span class=\"hljs-keyword\">as</span> f:\n            lines = f.readlines()\n            <span class=\"hljs-keyword\">for</span> line <span class=\"hljs-keyword\">in</span> lines:\n                <span class=\"hljs-keyword\">yield</span> line.replace(<span class=\"hljs-string\">&quot;\\n&quot;</span>, <span class=\"hljs-string\">&quot;&quot;</span>)\n    <span class=\"hljs-keyword\">return</span> reader\n\nreader = reader_creator(<span class=\"hljs-string\">&quot;test.txt&quot;</span>) <span class=\"hljs-comment\"># &#x539f;&#x59cb;reader</span>\nshuffle_reader = paddle.reader.shuffle(reader, <span class=\"hljs-number\">32</span>) <span class=\"hljs-comment\"># &#x5305;&#x88c5;&#x968f;&#x673a;&#x8bfb;&#x53d6;&#x5668;</span>\nbatch_reader = paddle.batch(shuffle_reader, <span class=\"hljs-number\">3</span>) <span class=\"hljs-comment\"># &#x5305;&#x88c5;&#x6210;&#x6279;&#x91cf;&#x8bfb;&#x53d6;&#x5668;&#xff0c;&#x6279;&#x6b21;&#x5927;&#x5c0f;&#x4e3a;3</span>\n<span class=\"hljs-comment\"># for data in reader():</span>\n<span class=\"hljs-comment\"># for data in shuffle_reader():</span>\n<span class=\"hljs-keyword\">for</span> data <span class=\"hljs-keyword\">in</span> batch_reader():\n    <span class=\"hljs-built_in\">print</span>(data, end=<span class=\"hljs-string\">&quot;&quot;</span>)\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"6,31"}},{"content":"<pre data-lines=\"32,170\"><code class=\"language-python\"><span class=\"hljs-comment\"># 02_uci_housing.py</span>\n<span class=\"hljs-string\">&apos;&apos;&apos; &#x6570;&#x636e;&#x96c6;&#x4ecb;&#x7ecd;:\n 1) &#x5171;506&#x884c;&#xff0c;&#x6bcf;&#x884c;14&#x5217;&#xff0c;&#x524d;13&#x5217;&#x63cf;&#x8ff0;&#x623f;&#x5c4b;&#x7279;&#x5f81;&#x4fe1;&#x606f;&#xff0c;&#x6700;&#x540e;&#x4e00;&#x5217;&#x4e3a;&#x4ef7;&#x683c;&#x4e2d;&#x4f4d;&#x6570;\n 2) &#x8003;&#x8651;&#x4e86;&#x72af;&#x7f6a;&#x7387;&#xff08;CRIM&#xff09;        &#x5b85;&#x7528;&#x5730;&#x5360;&#x6bd4;&#xff08;ZN&#xff09;\n    &#x975e;&#x5546;&#x4e1a;&#x7528;&#x5730;&#x6240;&#x5360;&#x5c3a;&#x5bf8;&#xff08;INDUS&#xff09;  &#x67e5;&#x5c14;&#x65af;&#x6cb3;&#x865a;&#x62df;&#x53d8;&#x91cf;&#xff08;CHAS&#xff09;\n    &#x73af;&#x4fdd;&#x6307;&#x6570;&#xff08;NOX&#xff09;            &#x6bcf;&#x680b;&#x4f4f;&#x5b85;&#x7684;&#x623f;&#x95f4;&#x6570;&#xff08;RM&#xff09;\n    1940&#x5e74;&#x4ee5;&#x524d;&#x5efa;&#x6210;&#x7684;&#x81ea;&#x5efa;&#x5355;&#x4f4d;&#x6bd4;&#x4f8b;&#xff08;AGE&#xff09;   &#x8ddd;&#x79bb;5&#x4e2a;&#x6ce2;&#x58eb;&#x987f;&#x5c31;&#x4e1a;&#x4e2d;&#x5fc3;&#x7684;&#x52a0;&#x6743;&#x8ddd;&#x79bb;&#xff08;DIS&#xff09;\n    &#x8ddd;&#x79bb;&#x9ad8;&#x901f;&#x516c;&#x8def;&#x4fbf;&#x5229;&#x6307;&#x6570;&#xff08;RAD&#xff09;          &#x6bcf;&#x4e00;&#x4e07;&#x5143;&#x4e0d;&#x52a8;&#x4ea7;&#x7a0e;&#x7387;&#xff08;TAX&#xff09;\n    &#x6559;&#x5e08;&#x5b66;&#x751f;&#x6bd4;&#xff08;PTRATIO&#xff09;              &#x9ed1;&#x4eba;&#x6bd4;&#x4f8b;&#xff08;B&#xff09;\n    &#x623f;&#x4e1c;&#x5c5e;&#x4e8e;&#x4e2d;&#x4f4e;&#x6536;&#x5165;&#x6bd4;&#x4f8b;&#xff08;LSTAT&#xff09;\n&apos;&apos;&apos;</span>\n<span class=\"hljs-keyword\">import</span> paddle\n<span class=\"hljs-keyword\">import</span> paddle.fluid <span class=\"hljs-keyword\">as</span> fluid\n<span class=\"hljs-keyword\">import</span> numpy <span class=\"hljs-keyword\">as</span> np\n<span class=\"hljs-keyword\">import</span> math\n<span class=\"hljs-keyword\">import</span> os\n<span class=\"hljs-keyword\">import</span> matplotlib.pyplot <span class=\"hljs-keyword\">as</span> plt\n\nBUF_SIZE = <span class=\"hljs-number\">500</span> <span class=\"hljs-comment\"># &#x7f13;&#x51b2;&#x533a;&#x5927;&#x5c0f;</span>\nBATCH_SIZE = <span class=\"hljs-number\">20</span> <span class=\"hljs-comment\"># &#x6279;&#x6b21;&#x5927;&#x5c0f;</span>\n\n<span class=\"hljs-comment\"># &#x7b2c;&#x4e00;&#x6b65;&#xff1a;&#x6570;&#x636e;&#x51c6;&#x5907;(&#x5229;&#x7528;&#x5c01;&#x88c5;&#x597d;API&#x4ece;&#x6570;&#x636e;&#x96c6;&#x4e2d;&#x8bfb;&#x53d6;&#x6570;&#x636e;)</span>\nrandom_reader = paddle.reader.shuffle(paddle.dataset.uci_housing.train(), <span class=\"hljs-comment\"># &#x8bad;&#x7ec3;&#x96c6;</span>\n                                      buf_size=BUF_SIZE)\ntrain_reader = paddle.batch(random_reader, batch_size=BATCH_SIZE) <span class=\"hljs-comment\"># &#x6279;&#x91cf;&#x8bfb;&#x53d6;&#x5668;</span>\n\n<span class=\"hljs-comment\"># &#x6253;&#x5370;&#x6837;&#x672c;&#x6570;&#x636e;</span>\n<span class=\"hljs-comment\"># for sample in train_reader():</span>\n<span class=\"hljs-comment\">#     print(sample)</span>\n\n<span class=\"hljs-comment\"># &#x7b2c;&#x4e8c;&#x6b65;&#xff1a;&#x642d;&#x5efa;&#x7f51;&#x7edc;(fc)&#xff0c;&#x635f;&#x5931;&#x51fd;&#x6570;&#xff0c;&#x4f18;&#x5316;&#x5668;</span>\nx = fluid.layers.data(name=<span class=\"hljs-string\">&quot;x&quot;</span>, shape=[<span class=\"hljs-number\">13</span>], dtype=<span class=\"hljs-string\">&quot;float32&quot;</span>) <span class=\"hljs-comment\"># 13&#x4e2a;&#x7279;&#x5f81;&#x503c;</span>\ny = fluid.layers.data(name=<span class=\"hljs-string\">&quot;y&quot;</span>, shape=[<span class=\"hljs-number\">1</span>], dtype=<span class=\"hljs-string\">&quot;float32&quot;</span>) <span class=\"hljs-comment\"># &#x4ef7;&#x683c;&#x4e2d;&#x4f4d;&#x6570;(&#x6807;&#x7b7e;)</span>\n<span class=\"hljs-comment\"># &#x6a21;&#x578b;(&#x5168;&#x8fde;&#x63a5;)</span>\ny_predict = fluid.layers.fc(<span class=\"hljs-built_in\">input</span>=x, <span class=\"hljs-comment\"># &#x8f93;&#x5165;</span>\n                            size=<span class=\"hljs-number\">1</span>, <span class=\"hljs-comment\"># &#x8f93;&#x51fa;&#x503c;&#x4e2a;&#x6570;</span>\n                            act=<span class=\"hljs-literal\">None</span>) <span class=\"hljs-comment\"># &#x6fc0;&#x6d3b;&#x51fd;&#x6570;</span>\n\n<span class=\"hljs-comment\"># &#x635f;&#x5931;&#x51fd;&#x6570;</span>\ncost = fluid.layers.square_error_cost(<span class=\"hljs-built_in\">input</span>=y_predict, <span class=\"hljs-comment\"># &#x9884;&#x6d4b;&#x503c;</span>\n                                      label=y) <span class=\"hljs-comment\"># &#x771f;&#x5b9e;&#x503c;</span>\navg_cost = fluid.layers.mean(cost) <span class=\"hljs-comment\"># &#x5747;&#x65b9;&#x5dee;</span>\n<span class=\"hljs-comment\"># &#x4f18;&#x5316;&#x5668;</span>\noptimizer = fluid.optimizer.SGD(learning_rate=<span class=\"hljs-number\">0.001</span>)\nopts = optimizer.minimize(avg_cost)\n\n<span class=\"hljs-comment\"># &#x7b2c;&#x4e09;&#x6b65;&#xff1a;&#x6a21;&#x578b;&#x8bad;&#x7ec3;</span>\nplace = fluid.CPUPlace()\nexe = fluid.Executor(place)\nexe.run(fluid.default_startup_program())\n\nfeeder = fluid.DataFeeder(place=place, feed_list=[x, y]) <span class=\"hljs-comment\"># &#x6570;&#x636e;&#x5582;&#x5165;&#x5668;&#xff0c;&#x80fd;&#x5c06;x,y&#x8f6c;&#x6362;&#x6210;&#x5f20;&#x91cf;&#x683c;&#x5f0f;</span>\n\n<span class=\"hljs-built_in\">iter</span> = <span class=\"hljs-number\">0</span>\niters = []\ntrain_costs = []\nmodel_save_dir = <span class=\"hljs-string\">&quot;model/fit_a_line.model&quot;</span> <span class=\"hljs-comment\"># &#x6a21;&#x578b;&#x4fdd;&#x5b58;&#x8def;&#x5f84;</span>\n\n<span class=\"hljs-keyword\">for</span> epoch_id <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(<span class=\"hljs-number\">20</span>):\n    train_cost = <span class=\"hljs-number\">0</span>\n    i = <span class=\"hljs-number\">0</span>\n    <span class=\"hljs-keyword\">for</span> data <span class=\"hljs-keyword\">in</span> train_reader(): <span class=\"hljs-comment\"># &#x8bfb;&#x53d6;&#x4e00;&#x4e2a;&#x6279;&#x6b21;&#x6570;&#x636e;</span>\n        i += <span class=\"hljs-number\">1</span>\n        train_cost = exe.run(program=fluid.default_main_program(), <span class=\"hljs-comment\"># &#x6267;&#x884c;&#x7684;program</span>\n                             feed=feeder.feed(data), <span class=\"hljs-comment\"># &#x5582;&#x5165;&#x6570;&#x636e;</span>\n                             fetch_list=[avg_cost]) <span class=\"hljs-comment\"># &#x6307;&#x5b9a;&#x83b7;&#x53d6;&#x7ed3;&#x679c;</span>\n        <span class=\"hljs-keyword\">if</span> i % <span class=\"hljs-number\">20</span> == <span class=\"hljs-number\">0</span>:\n            <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">&quot;epoch:%d, cost:%f&quot;</span> % (epoch_id, train_cost[<span class=\"hljs-number\">0</span>][<span class=\"hljs-number\">0</span>]))\n        <span class=\"hljs-built_in\">iter</span> = <span class=\"hljs-built_in\">iter</span> + BATCH_SIZE <span class=\"hljs-comment\"># &#x8ba1;&#x7b97;&#x8bad;&#x7ec3;&#x6b21;&#x6570;</span>\n        iters.append(<span class=\"hljs-built_in\">iter</span>) <span class=\"hljs-comment\"># &#x8bb0;&#x5f55;&#x6b21;&#x6570;</span>\n        train_costs.append(train_cost[<span class=\"hljs-number\">0</span>][<span class=\"hljs-number\">0</span>])\n<span class=\"hljs-comment\"># &#x4fdd;&#x5b58;&#x6a21;&#x578b;</span>\n<span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">not</span> os.path.exists(model_save_dir): <span class=\"hljs-comment\"># &#x5982;&#x679c;&#x76ee;&#x5f55;&#x4e0d;&#x5b58;&#x5728;&#xff0c;&#x5219;&#x521b;&#x5efa;</span>\n    os.makedirs(model_save_dir)\nfluid.io.save_inference_model(model_save_dir, <span class=\"hljs-comment\"># &#x6307;&#x5b9a;&#x4fdd;&#x5b58;&#x5230;&#x54ea;&#x4e2a;&#x76ee;&#x5f55;</span>\n                              [<span class=\"hljs-string\">&quot;x&quot;</span>], <span class=\"hljs-comment\"># &#x4f7f;&#x7528;&#x6a21;&#x578b;&#x65f6;&#x4f20;&#x5165;&#x4ec0;&#x4e48;&#x53c2;&#x6570;</span>\n                              [y_predict], <span class=\"hljs-comment\"># &#x4f7f;&#x7528;&#x6a21;&#x578b;&#x65f6;&#xff0c;&#x9884;&#x6d4b;&#x7ed3;&#x679c;&#x4ece;&#x54ea;&#x91cc;&#x83b7;&#x53d6;</span>\n                              exe) <span class=\"hljs-comment\"># &#x6a21;&#x578b;&#x4f4d;&#x4e8e;&#x54ea;&#x4e2a;&#x6267;&#x884c;&#x5668;</span>\n<span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">&quot;&#x6a21;&#x578b;&#x4fdd;&#x5b58;&#x6210;&#x529f;.&quot;</span>)\n\n<span class=\"hljs-comment\"># &#x8bad;&#x7ec3;&#x8fc7;&#x7a0b;&#x53ef;&#x89c6;&#x5316;</span>\nplt.figure(<span class=\"hljs-string\">&quot;Training Cost&quot;</span>, facecolor=<span class=\"hljs-string\">&quot;gray&quot;</span>)\nplt.title(<span class=\"hljs-string\">&quot;Training Cost&quot;</span>, fontsize=<span class=\"hljs-number\">24</span>)\nplt.xlabel(<span class=\"hljs-string\">&quot;iter&quot;</span>, fontsize=<span class=\"hljs-number\">14</span>)\nplt.ylabel(<span class=\"hljs-string\">&quot;cost&quot;</span>, fontsize=<span class=\"hljs-number\">14</span>)\nplt.plot(iters, train_costs, color=<span class=\"hljs-string\">&quot;red&quot;</span>, label=<span class=\"hljs-string\">&quot;Training Cost&quot;</span>)\nplt.grid()\n<span class=\"hljs-comment\"># plt.show()</span>\nplt.savefig(<span class=\"hljs-string\">&quot;train.png&quot;</span>)\n\n<span class=\"hljs-comment\"># &#x7b2c;&#x56db;&#x6b65;&#xff1a;&#x9884;&#x6d4b;&#xff0c;&#x5e76;&#x5c06;&#x7ed3;&#x679c;&#x53ef;&#x89c6;&#x5316;</span>\ninfer_exe = fluid.Executor(place)\ninfer_result = [] <span class=\"hljs-comment\"># &#x9884;&#x6d4b;&#x7ed3;&#x679c;&#x5217;&#x8868;</span>\nground_truths = [] <span class=\"hljs-comment\"># &#x771f;&#x5b9e;&#x7ed3;&#x679c;&#x5217;&#x8868;</span>\n\n<span class=\"hljs-comment\"># &#x52a0;&#x8f7d;&#x6a21;&#x578b;</span>\n<span class=\"hljs-comment\"># infer_program: &#x8fd4;&#x56de;&#x7684;program&#x5bf9;&#x8c61;&#xff08;&#x5305;&#x542b;&#x4e86;&#x6570;&#x636e;&#x3001;&#x8ba1;&#x7b97;&#xff09;</span>\n<span class=\"hljs-comment\"># feed_target_names&#xff1a;&#x4f7f;&#x7528;&#x6a21;&#x578b;&#x9884;&#x6d4b;&#x65f6;&#xff0c;&#x9700;&#x8981;&#x4f20;&#x5165;&#x54ea;&#x4e9b;&#x53d8;&#x91cf;</span>\n<span class=\"hljs-comment\"># fetch_targets&#xff1a;&#x6a21;&#x578b;&#x9884;&#x6d4b;&#x7ed3;&#x679c;&#x4ece;&#x54ea;&#x91cc;&#x83b7;&#x53d6;</span>\ninfer_program, feed_target_names, fetch_targets = \\\n    fluid.io.load_inference_model(model_save_dir, <span class=\"hljs-comment\"># &#x6a21;&#x578b;&#x8def;&#x5f84;</span>\n                                  infer_exe) <span class=\"hljs-comment\"># &#x52a0;&#x8f7d;&#x5230;&#x54ea;&#x4e2a;&#x6267;&#x884c;&#x5668;</span>\ninfer_reader = paddle.batch(paddle.dataset.uci_housing.test(), <span class=\"hljs-comment\"># &#x6d4b;&#x8bd5;&#x96c6;reader</span>\n                            batch_size=<span class=\"hljs-number\">200</span>) <span class=\"hljs-comment\"># &#x6279;&#x6b21;&#x5927;&#x5c0f;</span>\ntest_data = <span class=\"hljs-built_in\">next</span>(infer_reader()) <span class=\"hljs-comment\"># &#x901a;&#x8fc7;next&#x51fd;&#x6570;&#x4ece;&#x53ef;&#x8fed;&#x4ee3;&#x5bf9;&#x8c61;&#x4e2d;&#x83b7;&#x53d6;&#x4e0b;&#x4e00;&#x4e2a;&#x5143;&#x7d20;</span>\ntest_x = np.array([data[<span class=\"hljs-number\">0</span>] <span class=\"hljs-keyword\">for</span> data <span class=\"hljs-keyword\">in</span> test_data]).astype(<span class=\"hljs-string\">&quot;float32&quot;</span>) <span class=\"hljs-comment\"># &#x83b7;&#x53d6;13&#x4e2a;&#x7279;&#x5f81;&#x503c;</span>\ntest_y = np.array([data[<span class=\"hljs-number\">1</span>] <span class=\"hljs-keyword\">for</span> data <span class=\"hljs-keyword\">in</span> test_data]).astype(<span class=\"hljs-string\">&quot;float32&quot;</span>) <span class=\"hljs-comment\"># &#x83b7;&#x53d6;&#x6807;&#x7b7e;&#x503c;</span>\n\nx_name = feed_target_names[<span class=\"hljs-number\">0</span>] <span class=\"hljs-comment\"># &#x83b7;&#x53d6;&#x8981;&#x4f20;&#x5165;&#x53c2;&#x6570;&#x7684;&#x540d;&#x79f0;</span>\n\nresults = infer_exe.run(infer_program,\n                        feed={x_name: test_x},\n                        fetch_list=fetch_targets)\n\n<span class=\"hljs-comment\"># &#x9884;&#x6d4b;&#x503c;</span>\n<span class=\"hljs-keyword\">for</span> idx, val <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">enumerate</span>(results[<span class=\"hljs-number\">0</span>]):\n    <span class=\"hljs-comment\"># print(&quot;%d: %.2f&quot; % (idx, val))</span>\n    infer_result.append(val)\n\n<span class=\"hljs-comment\"># &#x771f;&#x5b9e;&#x503c;</span>\n<span class=\"hljs-keyword\">for</span> idx, val <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">enumerate</span>(test_y):\n    <span class=\"hljs-comment\"># print(&quot;%d: %.2f&quot; % (idx, val))</span>\n    ground_truths.append(val)\n\n<span class=\"hljs-comment\"># &#x53ef;&#x89c6;&#x5316;</span>\nplt.figure(<span class=\"hljs-string\">&apos;scatter&apos;</span>, facecolor=<span class=\"hljs-string\">&apos;lightgray&apos;</span>)\nplt.title(<span class=\"hljs-string\">&quot;TestFigure&quot;</span>, fontsize=<span class=\"hljs-number\">24</span>)\nx = np.arange(<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">30</span>)\ny = x\nplt.plot(x, y)\nplt.xlabel(<span class=\"hljs-string\">&quot;ground truth&quot;</span>, fontsize=<span class=\"hljs-number\">14</span>)\nplt.ylabel(<span class=\"hljs-string\">&quot;infer result&quot;</span>, fontsize=<span class=\"hljs-number\">14</span>)\nplt.scatter(ground_truths, infer_result, color=<span class=\"hljs-string\">&quot;green&quot;</span>, label=<span class=\"hljs-string\">&quot;Test&quot;</span>)\nplt.grid()\nplt.savefig(<span class=\"hljs-string\">&quot;predict.png&quot;</span>)\nplt.show()\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"32,170"}},{"content":"<pre data-lines=\"171,416\"><code class=\"language-python\"><span class=\"hljs-comment\"># 03_fruits.py</span>\n<span class=\"hljs-comment\"># &#x5229;&#x7528;CNN&#x5b9e;&#x73b0;&#x6c34;&#x679c;&#x8bc6;&#x522b;</span>\n<span class=\"hljs-string\">&quot;&quot;&quot; &#x6570;&#x636e;&#x96c6;&#xff1a;\n&#x722c;&#x866b;&#x4ece;&#x767e;&#x5ea6;&#x56fe;&#x7247;&#x641c;&#x7d22;&#x7ed3;&#x679c;&#x722c;&#x53d6;\n&#x5305;&#x542b;1036&#x5f20;&#x6c34;&#x679c;&#x56fe;&#x7247;\n&#x5171;5&#x4e2a;&#x7c7b;&#x522b;&#xff08;&#x82f9;&#x679c;288&#x5f20;&#x3001;&#x9999;&#x8549;275&#x5f20;&#x3001;&#x8461;&#x8404;216&#x5f20;&#x3001;&#x6a59;&#x5b50;276&#x5f20;&#x3001;&#x68a8;251&#x5f20;&#xff09;\n&quot;&quot;&quot;</span>\n<span class=\"hljs-comment\">####################### &#x6570;&#x636e;&#x9884;&#x5904;&#x7406; ##########################</span>\n<span class=\"hljs-comment\"># &#x5bf9;&#x6570;&#x636e;&#x8fdb;&#x884c;&#x6807;&#x6ce8;&#xff0c;&#x5212;&#x5206;&#x8bad;&#x7ec3;&#x96c6;&#x3001;&#x6d4b;&#x8bd5;&#x96c6;</span>\n<span class=\"hljs-keyword\">import</span> os\n\n<span class=\"hljs-comment\"># &#x5b9a;&#x4e49;&#x516c;&#x5171;&#x53d8;&#x91cf;</span>\nname_dict = {<span class=\"hljs-string\">&quot;apple&quot;</span>: <span class=\"hljs-number\">0</span>, <span class=\"hljs-string\">&quot;banana&quot;</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&quot;grape&quot;</span>: <span class=\"hljs-number\">2</span>, <span class=\"hljs-string\">&quot;orange&quot;</span>: <span class=\"hljs-number\">3</span>, <span class=\"hljs-string\">&quot;pear&quot;</span>: <span class=\"hljs-number\">4</span>}  <span class=\"hljs-comment\"># &#x540d;&#x79f0;-&#x503c;&#x6620;&#x5c04;&#x5b57;&#x5178;</span>\ndata_root_path = <span class=\"hljs-string\">&quot;data/fruits/&quot;</span>  <span class=\"hljs-comment\"># &#x6837;&#x672c;&#x6570;&#x636e;&#x6240;&#x5728;&#x76ee;&#x5f55;</span>\ntest_file_path = data_root_path + <span class=\"hljs-string\">&quot;test.txt&quot;</span>  <span class=\"hljs-comment\"># &#x6d4b;&#x8bd5;&#x96c6;&#x6587;&#x4ef6;&#x8def;&#x5f84;</span>\ntrain_file_path = data_root_path + <span class=\"hljs-string\">&quot;train.txt&quot;</span>  <span class=\"hljs-comment\"># &#x8bad;&#x7ec3;&#x96c6;&#x6587;&#x4ef6;&#x8def;&#x5f84;</span>\nname_dict_list = {}  <span class=\"hljs-comment\"># &#x8bb0;&#x5f55;&#x6bcf;&#x4e2a;&#x7c7b;&#x522b;&#x6709;&#x54ea;&#x4e9b;&#x56fe;&#x7247; key:&#x6c34;&#x679c;&#x540d;&#x79f0;  value:&#x56fe;&#x7247;&#x8def;&#x5f84;&#x5217;&#x8868;</span>\n\n\n<span class=\"hljs-comment\"># &#x5c06;&#x56fe;&#x7247;&#x8def;&#x5f84;&#x5b58;&#x5165;&#x5230;name_dict_list&#x5b57;&#x5178;&#x4e2d;</span>\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">save_train_test_file</span>(<span class=\"hljs-params\">path, name</span>):\n    <span class=\"hljs-keyword\">if</span> name <span class=\"hljs-keyword\">not</span> <span class=\"hljs-keyword\">in</span> name_dict_list:  <span class=\"hljs-comment\"># &#x8be5;&#x7c7b;&#x6c34;&#x679c;&#x4e0d;&#x5728;&#x5b57;&#x5178;&#x4e2d;&#xff0c;&#x5219;&#x65b0;&#x5efa;&#x4e00;&#x4e2a;&#x5217;&#x8868;&#x63d2;&#x5165;</span>\n        img_list = []\n        img_list.append(path)  <span class=\"hljs-comment\"># &#x5c06;&#x56fe;&#x7247;&#x8def;&#x5f84;&#x6dfb;&#x52a0;&#x5230;&#x5217;&#x8868;</span>\n        name_dict_list[name] = img_list  <span class=\"hljs-comment\"># &#x5c06;&quot;&#x7c7b;&#x522b;-&#x6587;&#x4ef6;&#x5217;&#x8868;&quot;&#x952e;&#x503c;&#x5bf9;&#x6dfb;&#x52a0;&#x5230;&#x5b57;&#x5178;</span>\n    <span class=\"hljs-keyword\">else</span>:  <span class=\"hljs-comment\"># &#x8be5;&#x7c7b;&#x6c34;&#x679c;&#x5728;&#x5b57;&#x5178;&#x4e2d;&#xff0c;&#x5219;&#x76f4;&#x63a5;&#x5c06;&#x56fe;&#x50cf;&#x8def;&#x5f84;&#x6dfb;&#x52a0;&#x5230;&#x5217;&#x8868;</span>\n        name_dict_list[name].append(path)\n\n\n<span class=\"hljs-comment\"># &#x904d;&#x5386;&#x6570;&#x636e;&#x96c6;&#x4e0b;&#x7684;&#x6bcf;&#x4e2a;&#x5b50;&#x76ee;&#x5f55;&#xff0c;&#x5c06;&#x56fe;&#x7247;&#x8def;&#x5f84;&#x586b;&#x5165;name_dict_list&#x5b57;&#x5178;&#x4e2d;</span>\ndirs = os.listdir(data_root_path)\n<span class=\"hljs-keyword\">for</span> d <span class=\"hljs-keyword\">in</span> dirs:\n    full_path = data_root_path + d  <span class=\"hljs-comment\"># &#x5b8c;&#x6574;&#x8def;&#x5f84;</span>\n\n    <span class=\"hljs-keyword\">if</span> os.path.isdir(full_path):  <span class=\"hljs-comment\"># &#x662f;&#x76ee;&#x5f55;, &#x53d6;&#x51fa;&#x5176;&#x4e2d;&#x7684;&#x56fe;&#x7247;&#x8def;&#x5f84;</span>\n        imgs = os.listdir(full_path)  <span class=\"hljs-comment\"># &#x5217;&#x51fa;&#x5b50;&#x76ee;&#x5f55;&#x4e0b;&#x6240;&#x6709;&#x7684;&#x5185;&#x5bb9;</span>\n        <span class=\"hljs-keyword\">for</span> img <span class=\"hljs-keyword\">in</span> imgs:\n            save_train_test_file(full_path + <span class=\"hljs-string\">&quot;/&quot;</span> + img,  <span class=\"hljs-comment\"># &#x62fc;&#x56fe;&#x7247;&#x5b8c;&#x6574;&#x8def;&#x5f84;</span>\n                                 d)  <span class=\"hljs-comment\"># &#x7c7b;&#x522b;&#x540d;&#x79f0;(&#x91c7;&#x7528;&#x5b50;&#x76ee;&#x5f55;&#x4f5c;&#x4e3a;&#x7c7b;&#x522b;&#x540d;&#x79f0;)</span>\n    <span class=\"hljs-keyword\">else</span>:  <span class=\"hljs-comment\"># &#x6587;&#x4ef6;</span>\n        <span class=\"hljs-keyword\">pass</span>\n\n<span class=\"hljs-comment\"># &#x5c06;name_dict_list&#x5b57;&#x5178;&#x4e2d;&#x5185;&#x5bb9;&#x5199;&#x5165;&#x6d4b;&#x8bd5;&#x96c6;&#x3001;&#x8bad;&#x7ec3;&#x96c6;</span>\n<span class=\"hljs-keyword\">with</span> <span class=\"hljs-built_in\">open</span>(test_file_path, <span class=\"hljs-string\">&quot;w&quot;</span>) <span class=\"hljs-keyword\">as</span> f:  <span class=\"hljs-comment\"># &#x6e05;&#x7a7a;&#x6d4b;&#x8bd5;&#x96c6;&#x6587;&#x4ef6;</span>\n    <span class=\"hljs-keyword\">pass</span>\n\n<span class=\"hljs-keyword\">with</span> <span class=\"hljs-built_in\">open</span>(train_file_path, <span class=\"hljs-string\">&quot;w&quot;</span>) <span class=\"hljs-keyword\">as</span> f:  <span class=\"hljs-comment\"># &#x6e05;&#x7a7a;&#x8bad;&#x7ec3;&#x96c6;&#x6587;&#x4ef6;</span>\n    <span class=\"hljs-keyword\">pass</span>\n\n<span class=\"hljs-comment\"># &#x904d;&#x5386;&#x5b57;&#x5178;&#xff0c;&#x5c06;&#x5176;&#x4e2d;&#x7684;&#x5185;&#x5bb9;&#x5199;&#x5165;&#x6587;&#x4ef6;</span>\n<span class=\"hljs-keyword\">for</span> name, img_list <span class=\"hljs-keyword\">in</span> name_dict_list.items():\n    i = <span class=\"hljs-number\">0</span>\n    num = <span class=\"hljs-built_in\">len</span>(img_list)\n    <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">&quot;%s: %d&#x5f20;&quot;</span> % (name, num))\n\n    <span class=\"hljs-comment\"># &#x5199;&#x6d4b;&#x8bd5;&#x96c6;&#x3001;&#x8bad;&#x7ec3;&#x96c6;</span>\n    <span class=\"hljs-keyword\">for</span> img <span class=\"hljs-keyword\">in</span> img_list:\n        <span class=\"hljs-keyword\">if</span> i % <span class=\"hljs-number\">10</span> == <span class=\"hljs-number\">0</span>:  <span class=\"hljs-comment\"># &#x6bcf;10&#x7b14;&#x5199;&#x4e00;&#x7b14;&#x6d4b;&#x8bd5;&#x96c6;</span>\n            <span class=\"hljs-keyword\">with</span> <span class=\"hljs-built_in\">open</span>(test_file_path, <span class=\"hljs-string\">&quot;a&quot;</span>) <span class=\"hljs-keyword\">as</span> f:  <span class=\"hljs-comment\"># &#x8ffd;&#x52a0;&#x6a21;&#x5f0f;&#x6253;&#x5f00;&#x6587;&#x4ef6;</span>\n                line = <span class=\"hljs-string\">&quot;%s\\t%d\\n&quot;</span> % (img, name_dict[name])\n                f.write(line)\n        <span class=\"hljs-keyword\">else</span>:  <span class=\"hljs-comment\"># &#x5199;&#x8bad;&#x7ec3;&#x96c6;</span>\n            <span class=\"hljs-keyword\">with</span> <span class=\"hljs-built_in\">open</span>(train_file_path, <span class=\"hljs-string\">&quot;a&quot;</span>) <span class=\"hljs-keyword\">as</span> f:  <span class=\"hljs-comment\"># &#x8ffd;&#x52a0;&#x6a21;&#x5f0f;&#x6253;&#x5f00;&#x6587;&#x4ef6;</span>\n                line = <span class=\"hljs-string\">&quot;%s\\t%d\\n&quot;</span> % (img, name_dict[name])\n                f.write(line)\n        i += <span class=\"hljs-number\">1</span>  <span class=\"hljs-comment\"># &#x8ba1;&#x6570;&#x5668;+1</span>\n\n<span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">&quot;&#x6570;&#x636e;&#x9884;&#x5904;&#x7406;&#x5b8c;&#x6210;!&quot;</span>)\n\n<span class=\"hljs-comment\">##################### &#x6a21;&#x578b;&#x642d;&#x5efa;/&#x8bad;&#x7ec3; #########################</span>\n<span class=\"hljs-keyword\">import</span> paddle\n<span class=\"hljs-keyword\">import</span> paddle.fluid <span class=\"hljs-keyword\">as</span> fluid\n<span class=\"hljs-keyword\">import</span> numpy\n<span class=\"hljs-keyword\">import</span> sys\n<span class=\"hljs-keyword\">import</span> os\n<span class=\"hljs-keyword\">from</span> multiprocessing <span class=\"hljs-keyword\">import</span> cpu_count\n<span class=\"hljs-keyword\">import</span> time\n<span class=\"hljs-keyword\">import</span> matplotlib.pyplot <span class=\"hljs-keyword\">as</span> plt\n\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">train_mapper</span>(<span class=\"hljs-params\">sample</span>):\n    <span class=\"hljs-string\">&quot;&quot;&quot;\n    &#x4f20;&#x5165;&#x4e00;&#x884c;&#x6837;&#x672c;&#x6570;&#x636e;(&#x4e00;&#x884c;&#x6587;&#x672c;), &#x8bfb;&#x53d6;&#x56fe;&#x50cf;&#x6570;&#x636e;&#x3001;&#x7edf;&#x4e00;&#x8bbe;&#x7f6e;&#x6210;&#x56fa;&#x5b9a;&#x5927;&#x5c0f;&#x3001;&#x5f52;&#x4e00;&#x5316;&#x5e76;&#x8fd4;&#x56de;\n    :param sample: &#x5143;&#x7ec4;, &#x5f62;&#x5982;&#xff1a; (data/fruits/apple/0.jpg, 0)\n    :return: &#x8fd4;&#x56de;&#x56fe;&#x50cf;&#x6570;&#x636e;&#x548c;&#x6240;&#x5c5e;&#x7684;&#x7c7b;&#x522b;\n    &quot;&quot;&quot;</span>\n    img_path, label = sample  <span class=\"hljs-comment\"># &#x5c06;&#x5143;&#x7ec4;&#x8d4b;&#x503c;&#x7ed9;&#x4e24;&#x4e2a;&#x53d8;&#x91cf;,img_path&#x4ee3;&#x8868;&#x56fe;&#x50cf;&#x8def;&#x5f84;, label&#x7c7b;&#x522b;</span>\n    <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">not</span> os.path.exists(img_path):\n        <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">&quot;&#x56fe;&#x7247;&#x4e0d;&#x5b58;&#x5728;:&quot;</span>, img_path)\n\n    <span class=\"hljs-comment\"># &#x8bfb;&#x53d6;&#x56fe;&#x50cf;&#x6570;&#x636e;</span>\n    img = paddle.dataset.image.load_image(img_path)\n    <span class=\"hljs-comment\"># &#x5c06;&#x56fe;&#x50cf;&#x6570;&#x636e;&#x8bbe;&#x7f6e;&#x6210;&#x7edf;&#x4e00;&#x5927;&#x5c0f;</span>\n    img = paddle.dataset.image.simple_transform(im=img, <span class=\"hljs-comment\"># &#x539f;&#x59cb;&#x56fe;&#x50cf;&#x6570;&#x636e;</span>\n                                        resize_size=<span class=\"hljs-number\">100</span>, <span class=\"hljs-comment\"># &#x56fe;&#x50cf;&#x91cd;&#x7f6e;&#x4e3a;100*100(&#x56fe;&#x50cf;&#x4e0d;&#x80fd;&#x592a;&#x5927;)</span>\n                                        crop_size=<span class=\"hljs-number\">100</span>, <span class=\"hljs-comment\"># &#x88c1;&#x526a;&#x56fe;&#x50cf;&#x5927;&#x5c0f;</span>\n                                        is_color=<span class=\"hljs-literal\">True</span>, <span class=\"hljs-comment\"># &#x5f69;&#x8272;&#x56fe;&#x50cf;</span>\n                                        is_train=<span class=\"hljs-literal\">True</span>) <span class=\"hljs-comment\"># is_train&#x5f71;&#x54cd;&#x88c1;&#x526a;&#x7b56;&#x7565;</span>\n    <span class=\"hljs-comment\"># &#x5f52;&#x4e00;&#x5316;,&#x5c06;&#x50cf;&#x7d20;&#x7684;&#x7070;&#x5ea6;&#x503c;&#x7531;0~255&#x8f6c;&#x6362;&#x4e3a;0~1&#x4e4b;&#x95f4;</span>\n    <span class=\"hljs-comment\"># &#x76ee;&#x7684;&#x662f;&#x8ba9;&#x6574;&#x4e2a;CNN&#x8ba1;&#x7b97;&#x66f4;&#x7a33;&#x5b9a;</span>\n    img = img.astype(<span class=\"hljs-string\">&quot;float32&quot;</span>) / <span class=\"hljs-number\">255.0</span>\n\n    <span class=\"hljs-keyword\">return</span> img, label\n\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">train_r</span>(<span class=\"hljs-params\">train_list, buffered_size=<span class=\"hljs-number\">1024</span></span>):\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">reader</span>():\n        <span class=\"hljs-keyword\">with</span> <span class=\"hljs-built_in\">open</span>(train_list, <span class=\"hljs-string\">&quot;r&quot;</span>) <span class=\"hljs-keyword\">as</span> f:\n            lines = [line.strip() <span class=\"hljs-keyword\">for</span> line <span class=\"hljs-keyword\">in</span> f] <span class=\"hljs-comment\"># &#x8bfb;&#x53d6;&#x6240;&#x6709;&#x884c;&#xff0c;&#x5e76;&#x53bb;&#x9664;&#x7a7a;&#x683c;</span>\n            <span class=\"hljs-keyword\">for</span> line <span class=\"hljs-keyword\">in</span> lines:\n                img_path, lab = line.replace(<span class=\"hljs-string\">&quot;\\n&quot;</span>, <span class=\"hljs-string\">&quot;&quot;</span>).split(<span class=\"hljs-string\">&quot;\\t&quot;</span>)\n                <span class=\"hljs-keyword\">yield</span> img_path, <span class=\"hljs-built_in\">int</span>(lab)\n    <span class=\"hljs-keyword\">return</span> paddle.reader.xmap_readers(train_mapper, <span class=\"hljs-comment\"># &#x5c06;reader&#x8bfb;&#x53d6;&#x5230;&#x7684;&#x6570;&#x636e;&#x4ea4;&#x7ed9;&#x8be5;&#x51fd;&#x6570;&#x8fdb;&#x4e00;&#x6b65;&#x5904;&#x7406;</span>\n                                      reader, <span class=\"hljs-comment\"># &#x539f;&#x59cb;&#x8bfb;&#x53d6;&#x5668;&#xff0c;&#x8bfb;&#x53d6;&#x7684;&#x6570;&#x636e;&#x4ea4;&#x7ed9;train_mapper&#x5904;&#x7406;</span>\n                                      cpu_count(), <span class=\"hljs-comment\"># &#x7ebf;&#x7a0b;&#x6570;&#x91cf;(&#x548c;&#x903b;&#x8f91;CPU&#x6570;&#x91cf;&#x4e00;&#x81f4;)</span>\n                                      buffered_size) <span class=\"hljs-comment\"># &#x7f13;&#x51b2;&#x533a;&#x5927;&#x5c0f;</span>\n\n\n<span class=\"hljs-comment\"># &#x51c6;&#x5907;&#x6570;&#x636e;</span>\nBATCH_SIZE = <span class=\"hljs-number\">32</span> <span class=\"hljs-comment\"># &#x6279;&#x6b21;&#x5927;&#x5c0f;</span>\n\ntrain_reader = train_r(train_list=train_file_path) <span class=\"hljs-comment\"># &#x539f;&#x59cb;reader</span>\nrandom_train_reader = paddle.reader.shuffle(reader=train_reader,\n                                            buf_size=<span class=\"hljs-number\">1300</span>) <span class=\"hljs-comment\"># &#x968f;&#x673a;&#x8bfb;&#x53d6;&#x5668;</span>\nbatch_train_reader = paddle.batch(random_train_reader,\n                                  batch_size=BATCH_SIZE) <span class=\"hljs-comment\"># &#x6279;&#x91cf;&#x8bfb;&#x53d6;&#x5668;</span>\n<span class=\"hljs-comment\"># &#x53d8;&#x91cf;</span>\nimage = fluid.layers.data(name=<span class=\"hljs-string\">&quot;image&quot;</span>, shape=[<span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">100</span>, <span class=\"hljs-number\">100</span>], dtype=<span class=\"hljs-string\">&quot;float32&quot;</span>)\nlabel = fluid.layers.data(name=<span class=\"hljs-string\">&quot;label&quot;</span>, shape=[<span class=\"hljs-number\">1</span>], dtype=<span class=\"hljs-string\">&quot;int64&quot;</span>)\n\n<span class=\"hljs-comment\"># &#x7ed3;&#x6784;&#xff1a;&#x8f93;&#x5165;&#x5c42; --&gt; &#x5377;&#x79ef;/&#x6fc0;&#x6d3b;/&#x6c60;&#x5316;/dropuout --&gt; &#x5377;&#x79ef;/&#x6fc0;&#x6d3b;/&#x6c60;&#x5316;dropuou --&gt;</span>\n<span class=\"hljs-comment\">#                &#x5377;&#x79ef;/&#x6fc0;&#x6d3b;/&#x6c60;&#x5316;dropuou --&gt; fc --&gt; dropout --&gt; fc(softmax)</span>\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">convolution_neural_network</span>(<span class=\"hljs-params\">image, type_size</span>):\n    <span class=\"hljs-string\">&quot;&quot;&quot;\n    &#x642d;&#x5efa;CNN&#x51fd;&#x6570;\n    :param image: &#x56fe;&#x50cf;&#x6570;&#x636e;\n    :param type_size: &#x8f93;&#x51fa;&#x7c7b;&#x522b;&#x7684;&#x6570;&#x91cf;\n    :return: &#x8fd4;&#x56de;&#x4e00;&#x7ec4;&#x9884;&#x6d4b;&#x6982;&#x7387;\n    &quot;&quot;&quot;</span>\n    <span class=\"hljs-comment\"># &#x7b2c;&#x4e00;&#x7ec4; &#x5377;&#x79ef;/&#x6fc0;&#x6d3b;/&#x6c60;&#x5316;/dropuout</span>\n    conv_pool_1 = fluid.nets.simple_img_conv_pool(<span class=\"hljs-built_in\">input</span>=image, <span class=\"hljs-comment\"># &#x56fe;&#x50cf;&#x6570;&#x636e;</span>\n                                                  filter_size=<span class=\"hljs-number\">3</span>, <span class=\"hljs-comment\"># &#x5377;&#x79ef;&#x6838;&#x5927;&#x5c0f; 3*3</span>\n                                                  num_filters=<span class=\"hljs-number\">32</span>, <span class=\"hljs-comment\"># &#x5377;&#x79ef;&#x6838;&#x6570;&#x91cf;</span>\n                                                  pool_size=<span class=\"hljs-number\">2</span>, <span class=\"hljs-comment\"># &#x6c60;&#x5316;&#x533a;&#x57df;&#x5927;&#x5c0f; 2*2</span>\n                                                  pool_stride=<span class=\"hljs-number\">2</span>, <span class=\"hljs-comment\"># &#x6c60;&#x5316;&#x6b65;&#x957f;&#x503c;</span>\n                                                  act=<span class=\"hljs-string\">&quot;relu&quot;</span>) <span class=\"hljs-comment\"># &#x6fc0;&#x6d3b;&#x51fd;&#x6570;</span>\n    drop = fluid.layers.dropout(x=conv_pool_1, dropout_prob=<span class=\"hljs-number\">0.5</span>)\n\n    <span class=\"hljs-comment\"># &#x7b2c;&#x4e8c;&#x7ec4; &#x5377;&#x79ef;/&#x6fc0;&#x6d3b;/&#x6c60;&#x5316;/dropuout</span>\n    conv_pool_2 = fluid.nets.simple_img_conv_pool(<span class=\"hljs-built_in\">input</span>=drop, <span class=\"hljs-comment\"># &#x56fe;&#x50cf;&#x6570;&#x636e;</span>\n                                                  filter_size=<span class=\"hljs-number\">3</span>, <span class=\"hljs-comment\"># &#x5377;&#x79ef;&#x6838;&#x5927;&#x5c0f; 3*3</span>\n                                                  num_filters=<span class=\"hljs-number\">64</span>, <span class=\"hljs-comment\"># &#x5377;&#x79ef;&#x6838;&#x6570;&#x91cf;</span>\n                                                  pool_size=<span class=\"hljs-number\">2</span>, <span class=\"hljs-comment\"># &#x6c60;&#x5316;&#x533a;&#x57df;&#x5927;&#x5c0f; 2*2</span>\n                                                  pool_stride=<span class=\"hljs-number\">2</span>, <span class=\"hljs-comment\"># &#x6c60;&#x5316;&#x6b65;&#x957f;&#x503c;</span>\n                                                  act=<span class=\"hljs-string\">&quot;relu&quot;</span>) <span class=\"hljs-comment\"># &#x6fc0;&#x6d3b;&#x51fd;&#x6570;</span>\n    drop = fluid.layers.dropout(x=conv_pool_2, dropout_prob=<span class=\"hljs-number\">0.5</span>)\n\n    <span class=\"hljs-comment\"># &#x7b2c;&#x4e09;&#x7ec4; &#x5377;&#x79ef;/&#x6fc0;&#x6d3b;/&#x6c60;&#x5316;/dropuout</span>\n    conv_pool_3 = fluid.nets.simple_img_conv_pool(<span class=\"hljs-built_in\">input</span>=drop,  <span class=\"hljs-comment\"># &#x56fe;&#x50cf;&#x6570;&#x636e;</span>\n                                                  filter_size=<span class=\"hljs-number\">3</span>,  <span class=\"hljs-comment\"># &#x5377;&#x79ef;&#x6838;&#x5927;&#x5c0f; 3*3</span>\n                                                  num_filters=<span class=\"hljs-number\">64</span>,  <span class=\"hljs-comment\"># &#x5377;&#x79ef;&#x6838;&#x6570;&#x91cf;</span>\n                                                  pool_size=<span class=\"hljs-number\">2</span>,  <span class=\"hljs-comment\"># &#x6c60;&#x5316;&#x533a;&#x57df;&#x5927;&#x5c0f; 2*2</span>\n                                                  pool_stride=<span class=\"hljs-number\">2</span>,  <span class=\"hljs-comment\"># &#x6c60;&#x5316;&#x6b65;&#x957f;&#x503c;</span>\n                                                  act=<span class=\"hljs-string\">&quot;relu&quot;</span>)  <span class=\"hljs-comment\"># &#x6fc0;&#x6d3b;&#x51fd;&#x6570;</span>\n    drop = fluid.layers.dropout(x=conv_pool_3, dropout_prob=<span class=\"hljs-number\">0.5</span>)\n\n    <span class=\"hljs-comment\"># &#x5168;&#x8fde;&#x63a5;</span>\n    fc = fluid.layers.fc(<span class=\"hljs-built_in\">input</span>=drop, size=<span class=\"hljs-number\">512</span>, act=<span class=\"hljs-string\">&quot;relu&quot;</span>)\n    <span class=\"hljs-comment\"># dropout</span>\n    drop = fluid.layers.dropout(x=fc, dropout_prob=<span class=\"hljs-number\">0.5</span>)\n    <span class=\"hljs-comment\"># &#x8f93;&#x51fa;&#x5c42;</span>\n    predict = fluid.layers.fc(<span class=\"hljs-built_in\">input</span>=drop,\n                              size=type_size, <span class=\"hljs-comment\"># &#x8f93;&#x51fa;5&#x4e2a;&#x503c;</span>\n                              act=<span class=\"hljs-string\">&quot;softmax&quot;</span>) <span class=\"hljs-comment\"># &#x8f93;&#x51fa;&#x5c42;&#x91c7;&#x7528;softmax&#x4f5c;&#x4e3a;&#x6fc0;&#x6d3b;&#x51fd;&#x6570;</span>\n    <span class=\"hljs-keyword\">return</span> predict\n\n<span class=\"hljs-comment\"># &#x8c03;&#x7528;&#x51fd;&#x6570;&#xff0c;&#x521b;&#x5efa;CNN</span>\npredict = convolution_neural_network(image=image, <span class=\"hljs-comment\"># &#x8f93;&#x5165;</span>\n                                     type_size=<span class=\"hljs-number\">5</span>) <span class=\"hljs-comment\"># &#x8f93;&#x51fa;5&#x4e2a;&#x7c7b;&#x522b;</span>\n<span class=\"hljs-comment\"># &#x635f;&#x5931;&#x51fd;&#x6570;&#xff1a;&#x4ea4;&#x53c9;&#x71b5;</span>\ncost = fluid.layers.cross_entropy(<span class=\"hljs-built_in\">input</span>=predict, <span class=\"hljs-comment\"># &#x9884;&#x6d4b;&#x503c;</span>\n                                  label=label) <span class=\"hljs-comment\"># &#x771f;&#x5b9e;&#x503c;</span>\navg_cost = fluid.layers.mean(cost) <span class=\"hljs-comment\"># &#x6c42;&#x5747;&#x503c;</span>\n<span class=\"hljs-comment\"># &#x51c6;&#x786e;&#x7387;</span>\naccuracy = fluid.layers.accuracy(<span class=\"hljs-built_in\">input</span>=predict, <span class=\"hljs-comment\"># &#x9884;&#x6d4b;&#x503c;</span>\n                                label=label) <span class=\"hljs-comment\"># &#x771f;&#x5b9e;&#x503c;</span>\n<span class=\"hljs-comment\"># &#x4f18;&#x5316;&#x5668;</span>\noptimizer = fluid.optimizer.Adam(learning_rate=<span class=\"hljs-number\">0.001</span>)\noptimizer.minimize(avg_cost) <span class=\"hljs-comment\"># &#x5c06;&#x635f;&#x5931;&#x51fd;&#x6570;&#x5747;&#x503c;&#x4f18;&#x5316;&#x5230;&#x6700;&#x5c0f;</span>\n\n<span class=\"hljs-comment\"># &#x6267;&#x884c;&#x5668;</span>\nplace = fluid.CUDAPlace(<span class=\"hljs-number\">0</span>) <span class=\"hljs-comment\"># GPU&#x8bad;&#x7ec3;</span>\n<span class=\"hljs-comment\"># place = fluid.CPUPlace() # CPU</span>\nexe = fluid.Executor(place)\nexe.run(fluid.default_startup_program())\n\n<span class=\"hljs-comment\"># feeder</span>\nfeeder = fluid.DataFeeder(feed_list=[image, label],\n                          place=place)\n\nmodel_save_dir = <span class=\"hljs-string\">&quot;model/fruits/&quot;</span> <span class=\"hljs-comment\"># &#x6a21;&#x578b;&#x4fdd;&#x5b58;&#x8def;&#x5f84;</span>\ncosts = [] <span class=\"hljs-comment\"># &#x4fdd;&#x5b58;&#x8bad;&#x7ec3;&#x8fc7;&#x7a0b;&#x4e2d;&#x7684;&#x635f;&#x5931;&#x503c;</span>\naccs = []  <span class=\"hljs-comment\"># &#x4fdd;&#x5b58;&#x8bad;&#x7ec3;&#x8fc7;&#x7a0b;&#x4e2d;&#x7684;&#x51c6;&#x786e;&#x7387;</span>\ntimes = <span class=\"hljs-number\">0</span>\nbatches = [] <span class=\"hljs-comment\"># &#x8fed;&#x4ee3;&#x6b21;&#x6570;</span>\n\n<span class=\"hljs-comment\"># &#x5f00;&#x59cb;&#x8bad;&#x7ec3;</span>\n<span class=\"hljs-keyword\">for</span> pass_id <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(<span class=\"hljs-number\">3</span>):\n    train_cost = <span class=\"hljs-number\">0</span> <span class=\"hljs-comment\"># &#x4e34;&#x65f6;&#x53d8;&#x91cf;&#xff0c;&#x4fdd;&#x5b58;&#x6bcf;&#x6b21;&#x8bad;&#x7ec3;&#x7684;&#x635f;&#x5931;&#x503c;</span>\n\n    <span class=\"hljs-keyword\">for</span> batch_id, data <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">enumerate</span>(batch_train_reader()): <span class=\"hljs-comment\"># batch_train_reader&#x6279;&#x91cf;&#x8bfb;&#x53d6;&#x5668;</span>\n        times += <span class=\"hljs-number\">1</span>\n        train_cost, train_acc = exe.run(program=fluid.default_main_program(),\n                                        feed=feeder.feed(data),\n                                        fetch_list=[avg_cost, accuracy])<span class=\"hljs-comment\">#&#x83b7;&#x53d6;&#x635f;&#x5931;&#x503c;&#x3001;&#x51c6;&#x786e;&#x7387;</span>\n        <span class=\"hljs-keyword\">if</span> batch_id % <span class=\"hljs-number\">20</span> == <span class=\"hljs-number\">0</span>:\n            <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">&quot;pass_id:%d, step:%d, cost:%f, acc:%f&quot;</span> %\n                  (pass_id, batch_id, train_cost[<span class=\"hljs-number\">0</span>], train_acc[<span class=\"hljs-number\">0</span>]))\n            accs.append(train_acc[<span class=\"hljs-number\">0</span>]) <span class=\"hljs-comment\"># &#x8bb0;&#x5f55;&#x51c6;&#x786e;&#x7387;</span>\n            costs.append(train_cost[<span class=\"hljs-number\">0</span>]) <span class=\"hljs-comment\"># &#x8bb0;&#x5f55;&#x635f;&#x5931;&#x503c;</span>\n            batches.append(times) <span class=\"hljs-comment\"># &#x8bb0;&#x5f55;&#x8fed;&#x4ee3;&#x6b21;&#x6570;</span>\n\n<span class=\"hljs-comment\"># &#x8bad;&#x7ec3;&#x7ed3;&#x675f;&#x540e;&#xff0c;&#x4fdd;&#x5b58;&#x6a21;&#x578b;</span>\n<span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">not</span> os.path.exists(model_save_dir):\n    os.makedirs(model_save_dir)\nfluid.io.save_inference_model(dirname=model_save_dir,\n                              feeded_var_names=[<span class=\"hljs-string\">&quot;image&quot;</span>],\n                              target_vars=[predict],\n                              executor=exe)\n<span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">&quot;&#x8bad;&#x7ec3;&#x4fdd;&#x5b58;&#x6a21;&#x578b;&#x5b8c;&#x6210;!&quot;</span>)\n\n<span class=\"hljs-comment\"># &#x8bad;&#x7ec3;&#x8fc7;&#x7a0b;&#x53ef;&#x89c6;&#x5316;</span>\nplt.title(<span class=\"hljs-string\">&quot;training&quot;</span>, fontsize=<span class=\"hljs-number\">24</span>)\nplt.xlabel(<span class=\"hljs-string\">&quot;iter&quot;</span>, fontsize=<span class=\"hljs-number\">20</span>)\nplt.ylabel(<span class=\"hljs-string\">&quot;cost/acc&quot;</span>, fontsize=<span class=\"hljs-number\">20</span>)\nplt.plot(batches, costs, color=<span class=\"hljs-string\">&apos;red&apos;</span>, label=<span class=\"hljs-string\">&quot;Training Cost&quot;</span>)\nplt.plot(batches, accs, color=<span class=\"hljs-string\">&apos;green&apos;</span>, label=<span class=\"hljs-string\">&quot;Training Acc&quot;</span>)\nplt.legend()\nplt.grid()\nplt.show()\nplt.savefig(<span class=\"hljs-string\">&quot;train.png&quot;</span>)\n\n\n<span class=\"hljs-comment\">######################### &#x9884;&#x6d4b; #############################</span>\n\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"171,416"}}],"payload":{"tag":"h5","lines":"4,5"}}],"payload":{"tag":"h3","lines":"0,1"}},{})</script>
</body>
</html>
