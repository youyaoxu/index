<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.10/dist/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.11.1/styles/default.min.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.18.10/dist/browser/index.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.10/dist/index.js"></script><script>(r => {
              setTimeout(r);
            })(function renderToolbar() {
  const {
    markmap,
    mm
  } = window;
  const {
    el
  } = markmap.Toolbar.create(mm);
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, root2, jsonOptions) => {
              const markmap = getMarkmap();
              window.mm = markmap.Markmap.create(
                "svg#mindmap",
                (getOptions || markmap.deriveOptions)(jsonOptions),
                root2
              );
            })(() => window.markmap,null,{"content":"scheduleWork","children":[{"content":"markPendingPriorityLevel","children":[{"content":"<pre data-lines=\"49,55\"><code>&#x8fd9;&#x4e2a;&#x65b9;&#x6cd5;&#x4f1a;&#x8bb0;&#x5f55;&#x5f53;&#x524d;&#x7684;`expirationTime`&#x5230;`pendingTime`&#xff0c;&#x8ba9;`expirationTime`&#x5904;&#x4e8e;`earliestPendingTime`&#x548c;`latestPendingTime`&#x4e4b;&#x95f4;\n\n&#x5e76;&#x4e14;&#x4f1a;&#x8bbe;&#x7f6e;`root.nextExpirationTimeToWorkOn`&#x548c;`root.expirationTime = expirationTime`&#x5206;&#x522b;&#x662f;&#xff1a;\n\n*   &#x6700;&#x65e9;&#x7684;`pendingTime`&#x6216;&#x8005;`pingedTime`&#xff0c;&#x5982;&#x679c;&#x90fd;&#x6ca1;&#x6709;&#x5219;&#x662f;`lastestSuspendTime`\n*   `suspendedTime`&#x548c;`nextExpirationTimeToWorkOn`&#x4e2d;&#x8f83;&#x65e9;&#x7684;&#x4e00;&#x4e2a;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"49,55"}}],"payload":{"tag":"h5","lines":"47,48"}},{"content":"&#x8c03;&#x7528; requestWork","children":[{"content":"<pre data-lines=\"58,66\"><code data-lines=\"58,66\">if (\n  !isWorking ||\n  isCommitting ||\n  nextRoot !== root\n)\n\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"58,66"}},{"content":"<pre data-lines=\"67,70\"><code>&#x8fd9;&#x4e2a;&#x5224;&#x65ad;&#x6761;&#x4ef6;&#x5c31;&#x6bd4;&#x8f83;&#x7b80;&#x5355;&#x4e86;&#xff0c;`!isWorking || isCommitting`&#x7b80;&#x5355;&#x6765;&#x8bf4;&#x5c31;&#x662f;&#x8981;&#x4e48;&#x5904;&#x4e8e;&#x6ca1;&#x6709; work &#x7684;&#x72b6;&#x6001;&#xff0c;&#x8981;&#x4e48;&#x53ea;&#x80fd;&#x5728; render &#x9636;&#x6bb5;&#xff0c;&#x4e0d;&#x80fd;&#x5904;&#x4e8e; commit &#x9636;&#x6bb5;&#xff08;&#x6bd4;&#x8f83;&#x597d;&#x5947;&#x4ec0;&#x4e48;&#x65f6;&#x5019;&#x4f1a;&#x5728; commit &#x9636;&#x6bb5;&#x6709;&#x65b0;&#x7684;&#x4efb;&#x52a1;&#x8fdb;&#x6765;&#xff0c;commit &#x90fd;&#x662f;&#x540c;&#x6b65;&#x7684;&#x65e0;&#x6cd5;&#x6253;&#x65ad;&#xff09;&#x3002;&#x8fd8;&#x6709;&#x4e00;&#x4e2a;&#x9009;&#x9879;`nextRoot !== root`&#xff0c;&#x8fd9;&#x4e2a;&#x7684;&#x610f;&#x601d;&#x5c31;&#x662f;&#x4f60;&#x7684; APP &#x5982;&#x679c;&#x6709;&#x4e24;&#x4e2a;&#x4e0d;&#x540c;&#x7684; root&#xff0c;&#x8fd9;&#x65f6;&#x5019;&#x4e5f;&#x7b26;&#x5408;&#x6761;&#x4ef6;&#x3002;\n\n&#x5728;&#x7b26;&#x5408;&#x6761;&#x4ef6;&#x4e4b;&#x540e;&#x5c31;`requestWork`&#x4e86;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"67,70"}},{"content":"<pre data-lines=\"71,169\"><code data-lines=\"71,169\"><span class=\"hljs-function\">function <span class=\"hljs-title\">scheduleWork</span>(<span class=\"hljs-params\">fiber: Fiber, expirationTime: ExpirationTime</span>)</span> {\n  <span class=\"hljs-keyword\">const</span> root = scheduleWorkToRoot(fiber, expirationTime)\n\n  <span class=\"hljs-keyword\">if</span> (enableSchedulerTracing) {\n    storeInteractionsForExpirationTime(root, expirationTime, <span class=\"hljs-literal\">true</span>)\n  }\n\n  <span class=\"hljs-keyword\">if</span> (\n    !isWorking &amp;&amp;\n    nextRenderExpirationTime !== NoWork &amp;&amp;\n    expirationTime &lt; nextRenderExpirationTime\n  ) {\n    \n    interruptedBy = <span class=\"hljs-function\">fiber\n    <span class=\"hljs-title\">resetStack</span>()\n  }\n  <span class=\"hljs-title\">markPendingPriorityLevel</span>(<span class=\"hljs-params\">root, expirationTime</span>)\n  <span class=\"hljs-title\">if</span> (<span class=\"hljs-params\">\n    \n    \n    !isWorking ||\n    isCommitting ||\n    \n    nextRoot !== root\n  </span>)</span> {\n    <span class=\"hljs-keyword\">const</span> rootExpirationTime = root.<span class=\"hljs-function\">expirationTime\n    <span class=\"hljs-title\">requestWork</span>(<span class=\"hljs-params\">root, rootExpirationTime</span>)\n  }\n}\n\nfunction <span class=\"hljs-title\">scheduleWorkToRoot</span>(<span class=\"hljs-params\">fiber: Fiber, expirationTime</span>): FiberRoot | <span class=\"hljs-literal\">null</span></span> {\n  \n  <span class=\"hljs-keyword\">if</span> (\n    fiber.expirationTime === NoWork ||\n    fiber.expirationTime &gt; expirationTime\n  ) {\n    fiber.expirationTime = expirationTime\n  }\n  <span class=\"hljs-keyword\">let</span> alternate = fiber.<span class=\"hljs-function\">alternate\n  <span class=\"hljs-title\">if</span> (<span class=\"hljs-params\">\n    alternate !== <span class=\"hljs-literal\">null</span> &amp;&amp;\n    (alternate.expirationTime === NoWork ||\n      alternate.expirationTime &gt; expirationTime</span>)\n  )</span> {\n    alternate.expirationTime = expirationTime\n  }\n  \n  <span class=\"hljs-keyword\">let</span> node = fiber.<span class=\"hljs-function\"><span class=\"hljs-keyword\">return</span>\n  <span class=\"hljs-title\">if</span> (<span class=\"hljs-params\">node === <span class=\"hljs-literal\">null</span> &amp;&amp; fiber.tag === HostRoot</span>)</span> {\n    <span class=\"hljs-keyword\">return</span> fiber.stateNode\n  }\n  <span class=\"hljs-keyword\">while</span> (node !== <span class=\"hljs-literal\">null</span>) {\n    alternate = node.<span class=\"hljs-function\">alternate\n    <span class=\"hljs-title\">if</span> (<span class=\"hljs-params\">\n      node.childExpirationTime === NoWork ||\n      node.childExpirationTime &gt; expirationTime\n    </span>)</span> {\n      node.childExpirationTime = <span class=\"hljs-function\">expirationTime\n      <span class=\"hljs-title\">if</span> (<span class=\"hljs-params\">\n        alternate !== <span class=\"hljs-literal\">null</span> &amp;&amp;\n        (alternate.childExpirationTime === NoWork ||\n          alternate.childExpirationTime &gt; expirationTime</span>)\n      )</span> {\n        alternate.childExpirationTime = expirationTime\n      }\n    } <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (\n      alternate !== <span class=\"hljs-literal\">null</span> &amp;&amp;\n      (alternate.childExpirationTime === NoWork ||\n        alternate.childExpirationTime &gt; expirationTime)\n    ) {\n      alternate.childExpirationTime = expirationTime\n    }\n    <span class=\"hljs-keyword\">if</span> (node.<span class=\"hljs-keyword\">return</span> === <span class=\"hljs-literal\">null</span> &amp;&amp; node.tag === HostRoot) {\n      <span class=\"hljs-keyword\">return</span> node.stateNode\n    }\n    node = node.<span class=\"hljs-keyword\">return</span>\n  }\n  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">null</span>\n}\n\n<span class=\"hljs-function\">function <span class=\"hljs-title\">resetStack</span>()</span> {\n  <span class=\"hljs-keyword\">if</span> (nextUnitOfWork !== <span class=\"hljs-literal\">null</span>) {\n    <span class=\"hljs-keyword\">let</span> interruptedWork = nextUnitOfWork.<span class=\"hljs-function\"><span class=\"hljs-keyword\">return</span>\n    <span class=\"hljs-title\">while</span> (<span class=\"hljs-params\">interruptedWork !== <span class=\"hljs-literal\">null</span></span>)</span> {\n      unwindInterruptedWork(interruptedWork)\n      interruptedWork = interruptedWork.<span class=\"hljs-keyword\">return</span>\n    }\n  }\n\n  nextRoot = <span class=\"hljs-literal\">null</span>\n  nextRenderExpirationTime = NoWork\n  nextLatestAbsoluteTimeoutMs = <span class=\"hljs-number\">-1</span>\n  nextRenderDidError = <span class=\"hljs-literal\">false</span>\n  nextUnitOfWork = <span class=\"hljs-literal\">null</span>\n}\n\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"71,169"}},{"content":"<pre data-lines=\"170,183\"><code>`addRootToSchedule`&#x628a; root &#x52a0;&#x5165;&#x5230;&#x8c03;&#x5ea6;&#x961f;&#x5217;&#xff0c;&#x4f46;&#x662f;&#x8981;&#x6ce8;&#x610f;&#x4e00;&#x70b9;&#xff0c;&#x4e0d;&#x4f1a;&#x5b58;&#x5728;&#x4e24;&#x4e2a;&#x76f8;&#x540c;&#x7684; root &#x524d;&#x540e;&#x51fa;&#x73b0;&#x5728;&#x961f;&#x5217;&#x4e2d;\n\n&#x53ef;&#x4ee5;&#x770b;&#x51fa;&#x6765;&#xff0c;&#x5982;&#x679c;&#x7b2c;&#x4e00;&#x6b21;&#x8c03;&#x7528;`addRootToSchedule`&#x7684;&#x65f6;&#x5019;&#xff0c;`nextScheduledRoot`&#x662f;`null`&#xff0c;&#x8fd9;&#x65f6;&#x5019;&#x516c;&#x5171;&#x53d8;&#x91cf;`firstScheduledRoot`&#x548c;`lastScheduledRoot`&#x4e5f;&#x662f;`null`&#xff0c;&#x6240;&#x4ee5;&#x4f1a;&#x628a;&#x4ed6;&#x4eec;&#x90fd;&#x8d4b;&#x503c;&#x6210;`root`&#xff0c;&#x540c;&#x65f6;`root.nextScheduledRoot = root`&#x3002;&#x7136;&#x540e;&#x7b2c;&#x4e8c;&#x6b21;&#x8fdb;&#x6765;&#x7684;&#x65f6;&#x5019;&#xff0c;&#x5982;&#x679c;&#x524d;&#x540e;`root`&#x662f;&#x540c;&#x4e00;&#x4e2a;&#xff0c;&#x90a3;&#x4e48;&#x4e4b;&#x524d;&#x7684;`firstScheduledRoot`&#x548c;`lastScheduledRoot`&#x90fd;&#x662f; root&#xff0c;&#x6240;&#x4ee5;`lastScheduledRoot.nextScheduledRoot = root`&#x5c31;&#x7b49;&#x4e8e;`root.nextScheduledRoot = root`\n\n&#x8fd9;&#x4e48;&#x505a;&#x662f;&#x56e0;&#x4e3a;&#x540c;&#x4e00;&#x4e2a;`root`&#x4e0d;&#x9700;&#x8981;&#x5b58;&#x5728;&#x4e24;&#x4e2a;&#xff0c;&#x56e0;&#x4e3a;&#x524d;&#x4e00;&#x6b21;&#x8c03;&#x5ea6;&#x5982;&#x679c;&#x4e2d;&#x9014;&#x88ab;&#x6253;&#x65ad;&#xff0c;&#x4e0b;&#x4e00;&#x6b21;&#x8c03;&#x5ea6;&#x8fdb;&#x5165;&#x8fd8;&#x662f;&#x4ece;&#x540c;&#x4e00;&#x4e2a;`root`&#x5f00;&#x59cb;&#xff0c;&#x5c31;&#x4f1a;&#x628a;&#x65b0;&#x7684;&#x4efb;&#x52a1;&#x4e00;&#x8d77;&#x6267;&#x884c;&#x4e86;&#x3002;\n\n&#x4e4b;&#x540e;&#x6839;&#x636e;`expirationTime`&#x8c03;&#x7528;`performSyncWork`&#x8fd8;&#x662f;`scheduleCallbackWithExpirationTime`\n\n`scheduleCallbackWithExpirationTime`&#x662f;&#x6839;&#x636e;&#x65f6;&#x95f4;&#x7247;&#x6765;&#x6267;&#x884c;&#x4efb;&#x52a1;&#x7684;&#xff0c;&#x4f1a;&#x6d89;&#x53ca;&#x5230;`requestIdleCallback`&#xff0c;&#x8be6;&#x7ec6;&#x89e3;&#x6790;&#x770b;[&#x8fd9;&#x91cc;](https://react.jokcy.me/book/flow/react-scheduler.md)\n\n`isBatchingUpdates`&#x548c;`isUnbatchingUpdates`&#x6d89;&#x53ca;&#x5230;&#x4e8b;&#x4ef6;&#x7cfb;&#x7edf;&#xff0c;&#x770b;[React &#x4e8b;&#x4ef6;&#x7cfb;&#x7edf;](https://react.jokcy.me/book/event-system/README.md)\n\n&#x4ed6;&#x4eec;&#x6700;&#x7ec8;&#x90fd;&#x8981;&#x8c03;&#x7528;`performWork`\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"170,183"}},{"content":"<pre data-lines=\"184,238\"><code data-lines=\"184,238\"><span class=\"hljs-keyword\">function</span> requestWork<span class=\"hljs-built_in\">(root</span>: FiberRoot, expirationTime: ExpirationTime) {\n  addRootToSchedule<span class=\"hljs-built_in\">(root</span>, expirationTime)\n  <span class=\"hljs-keyword\">if</span> (isRendering) {\n    \n    \n    <span class=\"hljs-keyword\">return</span>\n  }\n\n  <span class=\"hljs-keyword\">if</span> (isBatchingUpdates) {\n    \n    <span class=\"hljs-keyword\">if</span> (isUnbatchingUpdates) {\n      nextFlushedRoot =<span class=\"hljs-built_in\"> root</span>\n      nextFlushedExpirationTime = Sync\n      performWorkOnRoot<span class=\"hljs-built_in\">(root</span>, Sync,<span class=\"hljs-built_in\"> true</span>)\n    }\n    <span class=\"hljs-keyword\">return</span>\n  }\n\n  <span class=\"hljs-keyword\">if</span> (expirationTime === Sync) {\n    performSyncWork()\n  } <span class=\"hljs-keyword\">else</span> {\n    scheduleCallbackWithExpirationTime<span class=\"hljs-built_in\">(root</span>, expirationTime)\n  }\n}\n\n<span class=\"hljs-keyword\">function</span> addRootToSchedule<span class=\"hljs-built_in\">(root</span>: FiberRoot, expirationTime: ExpirationTime) {\n  \n  \n  <span class=\"hljs-keyword\">if</span> <span class=\"hljs-built_in\">(root</span>.nextScheduledRoot === null) {\n    \n   <span class=\"hljs-built_in\"> root</span>.expirationTime = expirationTime\n    <span class=\"hljs-keyword\">if</span> (lastScheduledRoot === null) {\n      firstScheduledRoot = lastScheduledRoot =<span class=\"hljs-built_in\"> root</span>\n     <span class=\"hljs-built_in\"> root</span>.nextScheduledRoot =<span class=\"hljs-built_in\"> root</span>\n    } <span class=\"hljs-keyword\">else</span> {\n      lastScheduledRoot.nextScheduledRoot =<span class=\"hljs-built_in\"> root</span>\n      lastScheduledRoot =<span class=\"hljs-built_in\"> root</span>\n      lastScheduledRoot.nextScheduledRoot = firstScheduledRoot\n    }\n  } <span class=\"hljs-keyword\">else</span> {\n    \n    const remainingExpirationTime =<span class=\"hljs-built_in\"> root</span>.expirationTime\n    <span class=\"hljs-keyword\">if</span> (\n      remainingExpirationTime === NoWork ||\n      expirationTime &lt; remainingExpirationTime\n    ) {\n      \n     <span class=\"hljs-built_in\"> root</span>.expirationTime = expirationTime\n    }\n  }\n}\n\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"184,238"}},{"content":"<pre data-lines=\"239,242\"><code>&#x5173;&#x4e8e;`scheduleCallbackWithExpirationTime`&#x7684;&#x770b;[&#x8fd9;&#x91cc;](https://react.jokcy.me/book/flow/scheduler-pkg.html)\n\n&#x63a5;&#x4e0b;&#x53bb;&#x5c31;&#x8fdb;&#x5165;&#x4e86;[`performWork`&#x9636;&#x6bb5;](https://react.jokcy.me/book/flow/perform-work.html)\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"239,242"}},{"content":"<img src=\"https://static.coursebetter.com/202112/Jokcy%E7%9A%84%E4%BA%8C%E7%BB%B4%E7%A0%81.png\" alt>","children":[],"payload":{"tag":"img","lines":"243,244"}},{"content":"<pre data-lines=\"245,246\"><code>&#x626b;&#x7801;&#x6dfb;&#x52a0;Jokcy&#xff0c;&#x66f4;&#x591a;&#x66f4;&#x65b0;&#x66f4;&#x4f18;&#x8d28;&#x7684;&#x524d;&#x7aef;&#x5b66;&#x4e60;&#x5185;&#x5bb9;&#x4e0d;&#x65ad;&#x66f4;&#x65b0;&#x4e2d;&#xff0c;&#x671f;&#x5f85;&#x4e0e;&#x4f60;&#x4e00;&#x8d77;&#x6210;&#x957f;&#xff01;\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"245,246"}},{"content":"<img src=\"https://static.coursebetter.com/202112/Jokcy%E7%9A%84%E4%BA%8C%E7%BB%B4%E7%A0%81.png\" alt>","children":[],"payload":{"tag":"img","lines":"247,248"}}],"payload":{"tag":"h5","lines":"56,57"}}],"payload":{"tag":"h1","lines":"0,1"}},{})</script>
</body>
</html>
